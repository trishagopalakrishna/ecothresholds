```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, include=FALSE}
library(RColorBrewer)
library(lattice)
library(tidyverse)
library(here)


library(ggplot2)
library(ggpubr)
library(sf)
library(terra)

library(tmap)
library(tmaptools)

library(viridis)

terraOptions(memfrac=0.8, tempdir = here("Scratch"), progress=10)
```
#Introduction
In this script, I evaluate the floristic regions that the different trajectories fall into. 
The floristic regions are from Francoso et al 2020 
(1) Read final trajectory type results for all indices, aggregated trajectories for all indices and floristic regions GIS files
(2) Data analyses of the distribution of seperate trajectories and aggregated trajectories across all indices ine ach of the floristic zones 
(3) Visualization of above results


#Step 1- read data- seperate trajectories, aggregated trajectories for all indices at annual and monthly time steps
```{r}
#separate trajectories 
monthly_input_file_path <- here("Outputs", "TrendsResults", "results_rasters", "monthly")
monthly_file_list<- list.files(path = paste0(monthly_input_file_path, "/"), pattern = paste0("*","_monthly_swin11","*"), all.files = T, full.names = T)
monthly_file_list <- gtools::mixedsort(monthly_file_list)

monthly_rds_list<- lapply(monthly_file_list, rast)
names(monthly_rds_list[[2]])<- "evi_swin11_monthly"
names(monthly_rds_list[[3]])<- "ndvi_swin11_monthly"
names(monthly_rds_list[[1]])<- "aniso_swin11_monthly"

annual_input_file_path <- here("Outputs", "TrendsResults", "results_rasters", "annual")
annual_file_list<- list.files(path = paste0(annual_input_file_path, "/"), pattern = paste0("*","_annual_swin11","*"), all.files = T, full.names = T)
annual_file_list <- gtools::mixedsort(annual_file_list)

annual_rds_list<- lapply(annual_file_list, rast)
names(annual_rds_list[[2]])<- "evi_swin11_annual"
names(annual_rds_list[[3]])<- "ndvi_swin11_annual"
names(annual_rds_list[[1]])<- "aniso_swin11_annual"

remove(monthly_input_file_path, monthly_file_list, annual_input_file_path, annual_file_list)

#aggregate trajectories
aggregate_results_input_file_path <- here("Outputs", "TrendsResults", "aggregate_trajectory_results")
aggregate_file_list <- list.files(path = paste0(aggregate_results_input_file_path, "/"), pattern = ".tif", all.files = T, full.names = T)

aggregate_rds_list <- lapply(aggregate_file_list, rast)
names(aggregate_rds_list[[1]])<- "annual_aniso1km_agg"
names(aggregate_rds_list[[2]])<- "annual_evi1km_agg"
names(aggregate_rds_list[[3]])<- "annual_ndvi1km_agg"
names(aggregate_rds_list[[4]])<- "monthly_aniso1km_agg"
names(aggregate_rds_list[[5]])<- "monthly_evi1km_agg"
names(aggregate_rds_list[[6]])<- "monthly_ndvi1km_agg"

remove(aggregate_results_input_file_path , aggregate_file_list)

#floristic regions
floristic_regions <- st_read(here("Data", "FloristicRegions_Francosoetal","Cerrado2019_BDs.shp"))
proj_floristic_regions <- sf::st_set_crs(floristic_regions, crs(aggregate_rds_list[[1]]))

d_trans<- st_read(here ("Data", "Cattelanetal_Clustering", "cerrado_climate_zones.shp"))
d_trans<- st_transform(d_trans, crs = 4326)
d_trans<- d_trans %>% mutate(area_km= terra::expanse(vect(d_trans), unit="km"))
cerrado<- d_trans %>% st_union()

proj_floristic_regions <- proj_floristic_regions %>% mutate(Region = c("Central_East", "Central_West", "North_East", "North_West", "South","South_East", "South_West", "external_North" ))
remove(floristic_regions)

```

#Step 2- data analyses
```{r}
area_separate_trajectory_calculation <- function (trajectory_results_raster){
    totalarea_raster <- cellSize(trajectory_results_raster, unit ="km", mask= T)
  total_area <- sum(values(totalarea_raster), na.rm= T)
  split_trajectory <- terra::segregate(trajectory_results_raster, other = NA)
  trajectory_names <- c("Lin_dec", "Lin_inc", "No_trend", "Step_dec", "Step_inc", "Quad_dec_acc", "Quad_dec_dec", "Quad_inc_acc", "Quad_inc_dec")

  df_for_histogram<- list()
   for (i in 1:9){
     list_area <- list()
     for (j in 1:length(proj_floristic_regions$Region)){
       x_region_raster <- terra::crop(split_trajectory[[i]], vect(proj_floristic_regions$geometry[[j]]))
       x_region_raster <- terra::mask(x_region_raster, vect(proj_floristic_regions$geometry[[j]]))
       area_raster <- terra::cellSize(x_region_raster, unit = "km", mask= T)
       x_area <- sum(values(area_raster), na.rm = T)
       x_area <- as.data.frame(x_area)
       names(x_area) <- "area_sqkm"
       x_area <- x_area %>% mutate(TrajectoryType = trajectory_names[i], Region = proj_floristic_regions$Region[j])
       x_area <- x_area %>% mutate(Percentage = (area_sqkm/total_area)*100)
       list_area[[j]]<- x_area
     }
    particular_region <- bind_rows(list_area)
    df_for_histogram[[i]]<- particular_region
  }
   total_df <- bind_rows(df_for_histogram)
    total_df
}

Sys.time(); monthly_seperate_aniso_area <- area_separate_trajectory_calculation(monthly_rds_list[[1]]); Sys.time()
Sys.time(); monthly_seperate_evi_area <- area_separate_trajectory_calculation(monthly_rds_list[[2]]); Sys.time()
Sys.time(); monthly_seperate_ndvi_area <- area_separate_trajectory_calculation(monthly_rds_list[[3]]); Sys.time()

Sys.time(); annual_seperate_aniso_area <- area_separate_trajectory_calculation(annual_rds_list[[1]]); Sys.time()
Sys.time(); annual_seperate_evi_area <- area_separate_trajectory_calculation(annual_rds_list[[2]]); Sys.time()
Sys.time(); annual_seperate_ndvi_area <- area_separate_trajectory_calculation(annual_rds_list[[3]]); Sys.time()

area_agg_trajectory_calculation <- function (trajectory_results_raster){
   totalarea_raster <- cellSize(trajectory_results_raster, unit ="km", mask= T)
  total_area <- sum(values(totalarea_raster), na.rm= T)
  split_trajectory <- terra::segregate(trajectory_results_raster, other = NA)
  trajectory_names <- c("Decrease", "Increase", "No_trend")
  df_for_histogram<- list()
   for (i in 1:3){
     list_area <- list()
     for (j in 1:length(proj_floristic_regions$Region)){
       x_region_raster <- terra::crop(split_trajectory[[i]], vect(proj_floristic_regions$geometry[[j]]))
       x_region_raster <- terra::mask(x_region_raster, vect(proj_floristic_regions$geometry[[j]]))
       area_raster <- terra::cellSize(x_region_raster, unit = "km", mask= T)
       x_area <- sum(values(area_raster), na.rm = T)
       x_area <- as.data.frame(x_area)
       names(x_area) <- "area_sqkm"
       x_area <- x_area %>% mutate(TrajectoryType = trajectory_names[i], Region = proj_floristic_regions$Region[j])
       x_area <- x_area %>% mutate(Percentage = (area_sqkm/total_area)*100)
       list_area[[j]]<- x_area
     }
    particular_region <- bind_rows(list_area)
    df_for_histogram[[i]]<- particular_region
  }
  total_df <- bind_rows(df_for_histogram)
  total_df
}

Sys.time(); annual_agg_aniso_area <- area_agg_trajectory_calculation(aggregate_rds_list[[1]]); Sys.time()
Sys.time(); annual_agg_evi_area <- area_agg_trajectory_calculation(aggregate_rds_list[[2]]); Sys.time()
Sys.time(); annual_agg_ndvi_area <- area_agg_trajectory_calculation(aggregate_rds_list[[3]]); Sys.time()
Sys.time(); monthly_agg_aniso_area <- area_agg_trajectory_calculation(aggregate_rds_list[[4]]); Sys.time()
Sys.time(); monthly_agg_evi_area <- area_agg_trajectory_calculation(aggregate_rds_list[[5]]); Sys.time()
Sys.time(); monthly_agg_ndvi_area <- area_agg_trajectory_calculation(aggregate_rds_list[[6]]); Sys.time()

```


#Step 4- visualization of results - violin plots
```{r}
plotting_function <- function (df){
  
  ggplot(df, aes(x = Region, y= Percentage, fill =Region)) + 
   geom_bar(stat = "identity") + theme_classic() +
    scale_fill_brewer(palette="Dark2")+
  facet_grid( .~ TrajectoryType) + 
  theme(axis.title.x = element_blank(),
    axis.ticks.x = element_blank(), 
    axis.text.x = element_blank()) + ylab ("Percentage of Study Area") +
    xlab ("Floristic Regions")
  
}  

Sys.time(); plot_monthly_ndvi_agg <- plotting_function(monthly_agg_ndvi_area) 
ggsave(here("Outputs", "TrendsResults", "barplot_agg_ndvi_monthly_floristicregions.png"),
      plot_monthly_ndvi_agg ,dpi = 700, height = 20, width = 20, units = "cm")
Sys.time(); plot_annual_ndvi_agg <- plotting_function(annual_agg_ndvi_area)
ggsave(here("Outputs", "TrendsResults", "barplot_agg_ndvi_annual_floristicregions.png"),
      plot_annual_ndvi_agg ,dpi = 700, height = 20, width = 20, units = "cm")

#aggregated, cross timesteps and indices
Sys.time(); monthly_agg_aniso_area <- monthly_agg_aniso_area %>% mutate(TimeStep ="monthly", Index = "anisotropic EVI"); Sys.time()
Sys.time(); monthly_agg_evi_area <- monthly_agg_evi_area %>% mutate(TimeStep ="monthly", Index = "EVI"); Sys.time()
Sys.time(); monthly_agg_ndvi_area <- monthly_agg_ndvi_area %>% mutate(TimeStep ="monthly", Index = "NDVI") ; Sys.time()

Sys.time(); annual_agg_aniso_area  <- annual_agg_aniso_area  %>% mutate(TimeStep ="annual", Index = "anisotropic EVI"); Sys.time()
Sys.time(); annual_agg_evi_area <- annual_agg_evi_area %>% mutate(TimeStep ="annual", Index = "EVI"); Sys.time()
Sys.time(); annual_agg_ndvi_area <- annual_agg_ndvi_area %>% mutate(TimeStep ="annual", Index = "NDVI") ; Sys.time()

df_agg <- bind_rows(monthly_agg_aniso_area, monthly_agg_evi_area, monthly_agg_ndvi_area, 
                    annual_agg_evi_area, annual_agg_evi_area, annual_agg_ndvi_area)
agg_barplot <- ggplot(df_agg, aes(y = Percentage, x = Region, fill =Region)) +
  geom_bar(position ="dodge", stat = "identity", aes(alpha = factor(Index))) + 
  scale_alpha_discrete(range = c(0.3, 0.6, 1), guide = guide_legend(override.aes = list(fill = "black"))) +
  facet_grid(TimeStep~TrajectoryType) +
  theme_classic() +
  theme(legend.title=element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())+ 
  scale_fill_brewer(palette="Dark2") +
  xlab("Floristic Region") + ylab("Percentage of Study Area")
ggsave(here("Outputs", "TrendsResults", "barplot_agg_floristicregions_indices_timestep.png"),
      agg_barplot  ,dpi = 700, height = 20, width = 20, units = "cm")

```
