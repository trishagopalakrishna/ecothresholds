```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, include=FALSE}
library(RColorBrewer)
library(lattice)
library(tidyverse)
library(here)


library(ggplot2)
library(ggpubr)
library(sf)
library(terra)

library(tmap)
library(tmaptools)

library(viridis)

terraOptions(memfrac=0.8, tempdir = here("Scratch"), progress=10)
```
#Introduction
In this script, I compile results for the stl decomposition (sensitivity) for annual and monthly time step results. 
(1) Read in all results rasters for seperate trajectories for each index (4 tif each)
(2) Convert to df and compile
(3) Make barplot of results across all indices, stl settings and timesteps
(4) Repeat above for aggregated trajectories
(5) Additional results extraction for manuscript preparation

#Step 1- read in all seperate trajectories results (monthly and annual timestep results) rasters
```{r}
monthly_input_file_path <- here("Outputs", "TrendsResults", "results_rasters", "monthly")
monthly_file_list<- list.files(path = paste0(monthly_input_file_path, "/"), pattern = ".tif", all.files = T, full.names = T)
monthly_file_list <- gtools::mixedsort(monthly_file_list)

monthly_rds_list<- lapply(monthly_file_list, rast)
monthly_ndvi_list<- list(monthly_rds_list[[9]], monthly_rds_list[[10]], monthly_rds_list[[11]], monthly_rds_list[[12]])
names(monthly_ndvi_list[[1]])<-"swin7"
names(monthly_ndvi_list[[2]])<-"swin11"
names(monthly_ndvi_list[[3]])<-"nostl"
names(monthly_ndvi_list[[4]])<-"swinperiodic"

monthly_evi_list<- list(monthly_rds_list[[5]], monthly_rds_list[[6]], monthly_rds_list[[7]], monthly_rds_list[[8]])
names(monthly_evi_list[[1]])<-"swin7"
names(monthly_evi_list[[2]])<-"swin11"
names(monthly_evi_list[[3]])<-"nostl"
names(monthly_evi_list[[4]])<-"swinperiodic"

monthly_aniso_list<- list(monthly_rds_list[[1]], monthly_rds_list[[2]], monthly_rds_list[[3]], monthly_rds_list[[4]])
names(monthly_aniso_list[[1]])<-"swin7"
names(monthly_aniso_list[[2]])<-"swin11"
names(monthly_aniso_list[[3]])<-"nostl"
names(monthly_aniso_list[[4]])<-"swinperiodic"

annual_input_file_path <- here("Outputs", "TrendsResults", "results_rasters", "annual")
annual_file_list<- list.files(path = paste0(annual_input_file_path, "/"), pattern = ".tif", all.files = T, full.names = T)
annual_file_list <- gtools::mixedsort(annual_file_list)

annual_rds_list<- lapply(annual_file_list, rast)
annual_ndvi_list<- list(annual_rds_list[[9]], annual_rds_list[[10]], annual_rds_list[[11]], annual_rds_list[[12]])
names(annual_ndvi_list[[1]])<-"swin7"
names(annual_ndvi_list[[2]])<-"swin11"
names(annual_ndvi_list[[3]])<-"nostl"
names(annual_ndvi_list[[4]])<-"swinperiodic"

annual_evi_list<- list(annual_rds_list[[5]], annual_rds_list[[6]], annual_rds_list[[7]], annual_rds_list[[8]])
names(annual_evi_list[[1]])<-"swin7"
names(annual_evi_list[[2]])<-"swin11"
names(annual_evi_list[[3]])<-"nostl"
names(annual_evi_list[[4]])<-"swinperiodic"

annual_aniso_list<- list(annual_rds_list[[1]], annual_rds_list[[2]], annual_rds_list[[3]], annual_rds_list[[4]])
names(annual_aniso_list[[1]])<-"swin7"
names(annual_aniso_list[[2]])<-"swin11"
names(annual_aniso_list[[3]])<-"nostl"
names(annual_aniso_list[[4]])<-"swinperiodic"

remove(annual_file_list, annual_input_file_path, monthly_file_list, monthly_input_file_path)
remove(monthly_rds_list, annual_rds_list)

```

#Step 2- convert above to df and compile 
```{r}
df_prep_function<- function (results_raster){
  x_df<- terra::as.data.frame(results_raster, cell = TRUE, xy= TRUE)
  x_df<- x_df %>% mutate(stl_setting = names(x_df)[4])
  names(x_df)[4]<- "value"
  percentage_df <- x_df %>% group_by(value, stl_setting) %>% summarise(count= n()) %>% mutate(percentage= (count/nrow(x_df))*100) 
  percentage_df
}

plot_df_prep_function <- function (results_raster_list){
  percentage_results_df_list<- list()
  for ( i in 1:length(results_raster_list)){
    percentage_results_df_list[[i]]<- df_prep_function(results_raster_list[[i]])
  }
  all_percentage_results <- bind_rows(percentage_results_df_list)
  all_percentage_results <- all_percentage_results %>% mutate(value = case_when(value== 1~ "Linear decrease",
                                                                                value==2~ "Linear increase",
                                                                                value==4~ "Step decrease",
                                                                                value==5~"Step increase",
                                                                                value==6~"Quadratic decrease (accelerated)",
                                                                                value==7~"Quadratic decrease (decelerated)",
                                                                                value==8~"Quadratic increase (accelerated)",
                                                                                value==9~"Quadratic increase (decelerated)",
                                                                                TRUE~"No trend"))
  all_percentage_results
}  


Sys.time(); monthly_ndvi_percentage_results_df <- plot_df_prep_function(monthly_ndvi_list); Sys.time()
monthly_ndvi_percentage_results_df <- monthly_ndvi_percentage_results_df %>% mutate(Index ="NDVI", TimeStep ="monthly")
Sys.time(); monthly_evi_percentage_results_df <- plot_df_prep_function(monthly_evi_list); Sys.time()
monthly_evi_percentage_results_df <- monthly_evi_percentage_results_df %>% mutate(Index ="EVI", TimeStep ="monthly")
Sys.time(); monthly_aniso_percentage_results_df <- plot_df_prep_function(monthly_aniso_list); Sys.time()
monthly_aniso_percentage_results_df <- monthly_aniso_percentage_results_df %>% mutate(Index ="anisoEVI", TimeStep ="monthly")

Sys.time(); annual_ndvi_percentage_results_df <- plot_df_prep_function(annual_ndvi_list); Sys.time()
annual_ndvi_percentage_results_df  <- annual_ndvi_percentage_results_df  %>% mutate(Index ="NDVI", TimeStep ="annual")
Sys.time(); annual_evi_percentage_results_df <- plot_df_prep_function(annual_evi_list); Sys.time()
annual_evi_percentage_results_df  <- annual_evi_percentage_results_df  %>% mutate(Index ="EVI", TimeStep ="annual")
Sys.time(); annual_aniso_percentage_results_df <- plot_df_prep_function(annual_aniso_list); Sys.time()
annual_aniso_percentage_results_df  <- annual_aniso_percentage_results_df  %>% mutate(Index ="anisoEVI", TimeStep ="annual")

main_df<- bind_rows(monthly_ndvi_percentage_results_df, monthly_evi_percentage_results_df, monthly_aniso_percentage_results_df,
                   annual_ndvi_percentage_results_df, annual_evi_percentage_results_df, annual_aniso_percentage_results_df)

```
#Step 3- barplot comparing results of annual and monthly timestep within each stl parameter 
```{r}
Set1palette<- c("#332288", "#117733", "lightgrey", "#AA4499", "#882255", "#44AA99", "#CC6677",  "#994F00",   "#88CCEE" ) 
barplot_function <- function (results_df, title){
   x_plot <- results_df %>% 
    ggplot(aes(value, percentage, fill = value, alpha=as.factor(TimeStep))) +
    geom_col(position = position_dodge(), color = "black") + 
     theme_classic(base_size = 18) +
    theme(axis.text.x=element_blank(), axis.ticks.x = element_blank()) + 
    xlab("Trajectory Shape")+ ylab ("Percentage of study area") +
    scale_fill_manual(values=Set1palette) + 
    theme(legend.title=element_blank()) +
    facet_grid(.~stl_setting, scales='free') +ggtitle(title)
}
 
Sys.time(); ndvi<-barplot_function(main_df %>% filter(Index =="NDVI"), "NDVI"); Sys.time()
Sys.time(); evi<-barplot_function(main_df %>% filter(Index =="EVI"), "EVI"); Sys.time()
Sys.time(); anisoevi<-barplot_function(main_df %>% filter(Index =="anisoEVI"), "anisoEVI"); Sys.time()

x<- ggpubr::ggarrange(ndvi, evi, anisoevi, nrow = 3, ncol = 1, common.legend = TRUE )
ggsave(here("Outputs","TrendsResults","annual_monthly_comparison","sep_trajectories_barplot_timstep_stlsetting_indicex.png"),
       x,dpi = 700, height = 50, width=100, units = "cm")

```

Clear workspace before running next chunk. Note that df_prep_function() is from Step 2
#Step 4- above for aggregated trajectories
```{r}
monthly_input_file_path <- here("Outputs", "TrendsResults", "aggregate_trajectory_results", "monthly")
monthly_file_list<- list.files(path = paste0(monthly_input_file_path, "/"), pattern = ".tif", all.files = T, full.names = T)
monthly_file_list <- gtools::mixedsort(monthly_file_list)

monthly_rds_list<- lapply(monthly_file_list, rast)
monthly_ndvi_list<- list(monthly_rds_list[[9]], monthly_rds_list[[10]], monthly_rds_list[[11]], monthly_rds_list[[12]])
names(monthly_ndvi_list[[1]])<-"swin7"
names(monthly_ndvi_list[[2]])<-"swin11"
names(monthly_ndvi_list[[3]])<-"nostl"
names(monthly_ndvi_list[[4]])<-"swinperiodic"

monthly_evi_list<- list(monthly_rds_list[[5]], monthly_rds_list[[6]], monthly_rds_list[[7]], monthly_rds_list[[8]])
names(monthly_evi_list[[1]])<-"swin7"
names(monthly_evi_list[[2]])<-"swin11"
names(monthly_evi_list[[3]])<-"nostl"
names(monthly_evi_list[[4]])<-"swinperiodic"

monthly_aniso_list<- list(monthly_rds_list[[1]], monthly_rds_list[[2]], monthly_rds_list[[3]], monthly_rds_list[[4]])
names(monthly_aniso_list[[1]])<-"swin7"
names(monthly_aniso_list[[2]])<-"swin11"
names(monthly_aniso_list[[3]])<-"nostl"
names(monthly_aniso_list[[4]])<-"swinperiodic"

annual_input_file_path <- here("Outputs", "TrendsResults", "aggregate_trajectory_results", "annual")
annual_file_list<- list.files(path = paste0(annual_input_file_path, "/"), pattern = ".tif", all.files = T, full.names = T)
annual_file_list <- gtools::mixedsort(annual_file_list)

annual_rds_list<- lapply(annual_file_list, rast)
annual_ndvi_list<- list(annual_rds_list[[9]], annual_rds_list[[10]], annual_rds_list[[11]], annual_rds_list[[12]])
names(annual_ndvi_list[[1]])<-"swin7"
names(annual_ndvi_list[[2]])<-"swin11"
names(annual_ndvi_list[[3]])<-"nostl"
names(annual_ndvi_list[[4]])<-"swinperiodic"

annual_evi_list<- list(annual_rds_list[[5]], annual_rds_list[[6]], annual_rds_list[[7]], annual_rds_list[[8]])
names(annual_evi_list[[1]])<-"swin7"
names(annual_evi_list[[2]])<-"swin11"
names(annual_evi_list[[3]])<-"nostl"
names(annual_evi_list[[4]])<-"swinperiodic"

annual_aniso_list<- list(annual_rds_list[[1]], annual_rds_list[[2]], annual_rds_list[[3]], annual_rds_list[[4]])
names(annual_aniso_list[[1]])<-"swin7"
names(annual_aniso_list[[2]])<-"swin11"
names(annual_aniso_list[[3]])<-"nostl"
names(annual_aniso_list[[4]])<-"swinperiodic"

remove(annual_file_list, annual_input_file_path, monthly_file_list, monthly_input_file_path)
remove(monthly_rds_list, annual_rds_list)

plot_df_prep_function2 <- function (results_raster_list){
  percentage_results_df_list<- list()
  for ( i in 1:length(results_raster_list)){
    percentage_results_df_list[[i]]<- df_prep_function(results_raster_list[[i]])
  }
  all_percentage_results <- bind_rows(percentage_results_df_list)
  all_percentage_results <- all_percentage_results %>% mutate(value = case_when(value== 1~ "Decrease",
                                                                                value== 2~ "Increase",
                                                                                value== 3~ "No trend"))
  all_percentage_results
}  

Sys.time(); monthly_ndvi_percentage_results_df <- plot_df_prep_function2(monthly_ndvi_list); Sys.time()
monthly_ndvi_percentage_results_df <- monthly_ndvi_percentage_results_df %>% mutate(Index ="NDVI", TimeStep ="monthly")
Sys.time(); monthly_evi_percentage_results_df <- plot_df_prep_function2(monthly_evi_list); Sys.time()
monthly_evi_percentage_results_df <- monthly_evi_percentage_results_df %>% mutate(Index ="EVI", TimeStep ="monthly")
Sys.time(); monthly_aniso_percentage_results_df <- plot_df_prep_function2(monthly_aniso_list); Sys.time()
monthly_aniso_percentage_results_df <- monthly_aniso_percentage_results_df %>% mutate(Index ="anisoEVI", TimeStep ="monthly")

Sys.time(); annual_ndvi_percentage_results_df <- plot_df_prep_function2(annual_ndvi_list); Sys.time()
annual_ndvi_percentage_results_df  <- annual_ndvi_percentage_results_df  %>% mutate(Index ="NDVI", TimeStep ="annual")
Sys.time(); annual_evi_percentage_results_df <- plot_df_prep_function2(annual_evi_list); Sys.time()
annual_evi_percentage_results_df  <- annual_evi_percentage_results_df  %>% mutate(Index ="EVI", TimeStep ="annual")
Sys.time(); annual_aniso_percentage_results_df <- plot_df_prep_function2(annual_aniso_list); Sys.time()
annual_aniso_percentage_results_df  <- annual_aniso_percentage_results_df  %>% mutate(Index ="anisoEVI", TimeStep ="annual")

main_df<- bind_rows(monthly_ndvi_percentage_results_df, monthly_evi_percentage_results_df, monthly_aniso_percentage_results_df,
                   annual_ndvi_percentage_results_df, annual_evi_percentage_results_df, annual_aniso_percentage_results_df)

aggregate_trajectory_palette <- c("#F7BF2A", "#61A36A", "#7C7083")

barplot_function2 <- function (results_df, title){
   x_plot <- results_df %>% 
    ggplot(aes(value, percentage, fill = value, alpha=as.factor(TimeStep))) +
    geom_col(position = position_dodge(), color = "black") + 
     theme_classic(base_size = 18) +
    theme(axis.text.x=element_blank(), axis.ticks.x = element_blank()) + 
    xlab("Trajectory Shape")+ ylab ("Percentage of study area") +
    scale_fill_manual(values=aggregate_trajectory_palette) + 
    theme(legend.title=element_blank()) +
    facet_grid(.~stl_setting, scales='free') +ggtitle(title)
}
 
Sys.time(); ndvi<-barplot_function2(main_df %>% filter(Index =="NDVI"), "NDVI"); Sys.time()
Sys.time(); evi<-barplot_function2(main_df %>% filter(Index =="EVI"), "EVI"); Sys.time()
Sys.time(); anisoevi<-barplot_function2(main_df %>% filter(Index =="anisoEVI"), "anisoEVI"); Sys.time()

x<- ggpubr::ggarrange(ndvi, evi, anisoevi, nrow = 3, ncol = 1, common.legend = TRUE )
ggsave(here("Outputs","TrendsResults","annual_monthly_comparison","aggtrajectories_barplot_timstep_stlsetting_indicex.png"),
       x,dpi = 700, height = 50, width=100, units = "cm")

```

#Step 5- (for results section) - calculating average difference in results (aggregated trajectories) between nostl and swin11 for monthly and annual timesteps across all indices.
```{r}
#Read fourth chunk without the mapping component
difference_function <- function (timestep, trajectory_type, index){
  numerator <- main_df$percentage[main_df$TimeStep ==timestep & main_df$value==trajectory_type & main_df$Index==index & main_df$stl_setting=="swin11"] -
                main_df$percentage[main_df$TimeStep ==timestep & main_df$value==trajectory_type & main_df$Index==index & main_df$stl_setting=="nostl"]
  
  dec_diff_percentage <- (numerator/ main_df$percentage[main_df$TimeStep ==timestep & main_df$value==trajectory_type & main_df$Index==index & main_df$stl_setting=="swin11"])*100
  dec_diff_percentage
}

monthly_dec_ndvi <- difference_function("monthly","Decrease","NDVI")
monthly_dec_evi <- difference_function("monthly","Decrease","EVI")
monthly_dec_aniso <- difference_function("monthly","Decrease","anisoEVI")
mean_monthly_dec_all_indices <- mean(c(monthly_dec_ndvi , monthly_dec_evi, monthly_dec_aniso))

annual_dec_ndvi <- difference_function("annual","Decrease","NDVI")
annual_dec_evi <- difference_function("annual","Decrease","EVI")
annual_dec_aniso <- difference_function("annual","Decrease","anisoEVI")
mean_annual_dec_all_indices <- mean(c(annual_dec_ndvi , annual_dec_evi, annual_dec_aniso))

monthly_inc_ndvi <- difference_function("monthly","Increase","NDVI")
monthly_inc_evi <- difference_function("monthly","Increase","EVI")
monthly_inc_aniso <- difference_function("monthly","Increase","anisoEVI")
mean_monthly_inc_all_indices <- mean(c(monthly_inc_ndvi , monthly_inc_evi, monthly_inc_aniso))

annual_inc_ndvi <- difference_function("annual","Increase","NDVI")
annual_inc_evi <- difference_function("annual","Increase","EVI")
annual_inc_aniso <- difference_function("annual","Increase","anisoEVI")
mean_annual_inc_all_indices <- mean(c(annual_inc_ndvi , annual_inc_evi, annual_inc_aniso))

difference_function2 <- function (timestep, trajectory_type, index){
  numerator <- main_df$percentage[main_df$TimeStep ==timestep & main_df$value==trajectory_type & main_df$Index==index & main_df$stl_setting=="nostl"] -
                main_df$percentage[main_df$TimeStep ==timestep & main_df$value==trajectory_type & main_df$Index==index & main_df$stl_setting=="swin11"]
  
  dec_diff_percentage <- (numerator/ main_df$percentage[main_df$TimeStep ==timestep & main_df$value==trajectory_type & main_df$Index==index & main_df$stl_setting=="nostl"])*100
  dec_diff_percentage
}


notrend_ndvi <- difference_function2("monthly","No trend","NDVI")
notrend_evi <- difference_function2("monthly","No trend","EVI")
notrend_aniso <- difference_function2("monthly","No trend","anisoEVI")
mean_notrend_all_indices <- mean(c(notrend_ndvi, notrend_evi, notrend_aniso))

notrend_ndvi2 <- difference_function2("annual","No trend","NDVI")
notrend_evi2 <- difference_function2("annual","No trend","EVI")
notrend_aniso2 <- difference_function2("annual","No trend","anisoEVI")
mean_notrend_all_indices2 <- mean(c(notrend_ndvi2, notrend_evi2, notrend_aniso2))

```