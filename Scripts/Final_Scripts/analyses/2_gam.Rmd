```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, include=FALSE}
library(RColorBrewer)
library(terra)
library(lattice)
library(tidyverse)
library(here)
library(ggplot2)
library(mgcv)
library(mgcViz)
library(rgl)
library(gratia)
library(gtools)

```

##Introduction
In this script, I do GAMs to understand the relationship between different trajectories (from NDVI stl swindow = 11) and 
various predictor variables. 

#Step 1- data input- predictors
```{r}
#response- binary trajectory (all 9) from NDVI swin 11 stl setting
monthly_input_file_path <- here("Outputs", "TrendsResults", "results_rasters", "monthly", "binary_count_5km")
monthly_file_list<- list.files(path = monthly_input_file_path, pattern = paste0("*","ndvi_","*"), all.files = T, full.names = T)
monthly_file_list <- gtools::mixedsort(monthly_file_list)
monthly_ndvi_trajectories<- lapply(monthly_file_list, rast)

#drivers
anthropic_dist<- rast(here("Outputs", "OtherVariables", "AnthropicDist", "5km_meandist_20thresholdsanthropicpixel.tif"))
burnedarea<- rast(here("Outputs", "OtherVariables", "Fire", "theilsen_burnedarea_5km.tif"))
hand<- rast(here("Outputs", "OtherVariables","HAND", "cerrado_hand_5km.tif"))
re<- rast(here("Outputs", "OtherVariables", "Climate", "theilsen_re.tif"))
at<- rast(here("Outputs", "OtherVariables", "Climate", "theilsen_at_5km.tif"))
#spei<- rast(here("Outputs", "OtherVariables", "Climate", "annualspei_2002_2021.tif"))
heatwave<- rast(here("Outputs", "OtherVariables", "Climate", "theilsen_heatwaves.tif"))
forestpercentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "theilsen_forestpercentage.tif"))
savannapercentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "theilsen_savannapercentage.tif"))
grasspercentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "theilsen_grasspercentage.tif"))
mat <- rast(here("Outputs", "OtherVariables", "Climate", "mat_1981_2021_5km.tif"))
mean_heatwave <- rast(here("Outputs", "OtherVariables", "Climate", "mean_annual_heatwaves_2002_2021.tif"))
mean_burnedarea<- rast(here("Outputs", "OtherVariables", "Fire", "mean_burnedarea_5km_2002_2021.tif"))
mean_annual_re <- rast(here("Outputs", "OtherVariables", "Climate","mean_annual_relative_entropy_1981_2021.tif") )
mean_savannaperentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "mean_savanna_percentage_5km_2002_2021.tif"))

```

#Step 2- data structuring and applying anthropic threshold mask to predictors
```{r}
drivers<- c(anthropic_dist, burnedarea, hand, re, at, heatwave, forestpercentage, savannapercentage, grasspercentage, mat, mean_heatwave, mean_burnedarea, mean_annual_re, mean_savannaperentage )

drivers_masked <- terra::mask(drivers, monthly_ndvi_trajectories[[1]])

all_data<- c(monthly_ndvi_trajectories[[1]], drivers_masked)
names(all_data)<- c("ndvi_monthly_lin_dec", 
                    "ndvi_monthly_lin_inc",
                    "ndvi_monthly_stable",
                    "ndvi_monthly_step_dec",
                    "ndvi_monthly_step_inc",
                    "ndvi_monthly_quad_dec_acc",
                    "ndvi_monthly_quad_dec_decc",
                    "ndvi_monthly_quad_inc_acc",
                    "ndvi_monthly_quad_inc_dec",
                    "anthropic_dist", 
                    "trend_burnedarea", 
                    "hand", 
                    "trend_re", 
                    "trend_annualtemp", 
                    "trend_heatwave", 
                    "trend_forestpercentage", 
                    "trend_savannapercentage", 
                    "trend_grasspercentage",
                    "mat",
                    "mean_heatwave",
                    "mean_burnedarea",
                    "mean_re",
                    "mean_savannapercentage")

analyses_df<- terra::as.data.frame(all_data, xy = TRUE)

remove(monthly_ndvi_trajectories, anthropic_dist, burnedarea, hand, re, mat,at, heatwave, forestpercentage, savannapercentage, grasspercentage)
remove(drivers_masked, drivers)
remove(monthly_file_list, monthly_input_file_path)
remove(mean_annual_re, mean_burnedarea, mean_heatwave, mean_savannaperentage)
```

#Step 3- eda - understanding the correlations and distributions of all the variables 
```{r}
analyses_df
summary(analyses_df)
analyses_df_noNA <- analyses_df %>% drop_na() #Removing rows with NA values
summary(analyses_df_noNA)

library(PerformanceAnalytics)
chart.Correlation(analyses_df_noNA, histogram = TRUE, method = "spearman", pch= 19)


#Removing outliers considering distribution of HAND
no_outliers_sample_df <- analyses_df_noNA %>% 
          mutate (IQR = IQR(hand),
                  O_upper = quantile (hand, probs= c(0.75), na.rm= FALSE)+ 1.5*IQR,
                  O_lower = quantile(hand, probs= c(0.25), na.rm= FALSE) - 1.5*IQR
                  ) %>% 
          filter(O_lower <= hand & hand <= O_upper) %>%
          dplyr::select(-c(IQR, O_upper, O_lower))

chart.Correlation(no_outliers_sample_df %>% dplyr::select(-c(trend_forestpercentage, trend_grasspercentage)), histogram = TRUE, method = "spearman",  pch= 19)

#plot
pivot_df <- no_outliers_sample_df %>% dplyr::select(-c(x,y, trend_forestpercentage, trend_grasspercentage)) %>%
  pivot_longer(1:21)
distribution_plot <- ggplot(data = pivot_df, aes(value)) +
  geom_histogram() +facet_wrap(~name, scales = "free", labeller = label_wrap_gen(4)) +
  theme_classic(base_size = 16)

#for_theo_pivot <-  no_outliers_sample_df %>% dplyr::select(c(ndvi_monthly_step_inc, anthropic_dist,
#                                                             trend_burnedarea, hand, re, trend_annualtemp,
#                                                             trend_heatwave, trend_savannapercentage, mat)) %>%
#  pivot_longer(1:9)
#for_theo_fig <- ggplot(data = for_theo_pivot, aes(value)) +
#  geom_histogram() +facet_wrap(~name, scales = "free", labeller = label_wrap_gen(4)) +
#  theme_classic(base_size = 16)

```
Firstly, the response variable instability % area (from NDVI) is right skewed. There are significant large correlations (>0.7) between predictor variables anthropic distance and trends in annual temperature, trends in burned area% and forest area%m HAND and RE, HAND and MAT, RE and trends in heatwaves, RE and trends in grass area%, trends in annual temperature and heatwaves, trends in forest area% and grass area%. 


#Step 4- data partitioning to testing and training (OPTIONAL FOR NOW- DO NOT RUN)
```{r}
#set.seed(1234)
###1 Data partition
#fractionTraining   <- 0.80
#fractionTest       <- 0.20

###2 Compute sample sizes.
#sampleSizeTraining_all   <- floor(fractionTraining   * nrow(no_outliers_sample_df))
#sampleSizeTest_all       <- floor(fractionTest       * nrow(no_outliers_sample_df))

###3 Create the randomly-sampled indices for the dataframe. Use setdiff() to
# avoid overlapping subsets of indices.
#indicesTraining_all    <- sort(sample(seq_len(nrow(no_outliers_sample_df)), size=sampleSizeTraining_all))
#indicesTest_all <- setdiff(seq_len(nrow(no_outliers_sample_df)), indicesTraining_all)

###4 Finally, output the dataframes for training, validation and test.
#set.seed(12345)
#dfTraining_all   <- no_outliers_sample_df[indicesTraining_all, ] 
#dfTest_all       <- no_outliers_sample_df[indicesTest_all, ]

#remove(fractionTraining, fractionTest, indicesTraining_all, indicesTest_all, sampleSizeTraining_all, sampleSizeTest_all)
```

#Step 5- regression analyses
The response variables are the trajectory counts i.e. the count is basically the number of pixels 
within a 5x5km pixel that is a particular trajectory (range 0-25). So this can be considered
to be a binomial distribution with the overarching question being what is the probability of the selected
trajectory or not. 

So I will use binomial distribution (logit link) with a two column integer matrix of 
count of that trajectory, count of not that trajectory i.e. count r, 25-r because
25 is the highest possible number of cells having the selected trajectory.

(a) considering "no trend" response
```{r}

############################################# No trend analyses ######################################################
library(mgcv)
#basic model without xy
Sys.time(); model_no_xy<- mgcv::bam( cbind(ndvi_monthly_stable, 25- ndvi_monthly_stable) ~ 
                             s(re, bs = "ts") +
                             s(trend_annualtemp, bs= "ts") +
                             s(heatwave, bs= "ts") +
                             s(burnedarea,  bs= "ts") +
                             s(anthropic_dist, bs= "ts") +
                             s(savannapercentage, bs= "ts"), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_step_inc,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              forestpercentage, grasspercentage, mat)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time() #dev explained = 11.5%

summary(model_no_xy)
plot(model_no_xy, pages = 1, all.terms = TRUE, rug = TRUE, shade = TRUE)
gam.check(model_no_xy)
concurvity(model_no_xy)

#basic model with xy
Sys.time(); model_with_xy <- mgcv::bam( cbind(ndvi_monthly_stable, 25- ndvi_monthly_stable) ~ 
                             s(re, bs = "ts") +
                             s(trend_annualtemp, bs= "ts") +
                             s(heatwave, bs= "ts") +
                             s(burnedarea,  bs= "ts") +
                             s(anthropic_dist, bs= "ts") +
                             s(savannapercentage,  bs= "ts") +
                             te(x,y, bs= "ts"),
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_step_inc,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              forestpercentage, grasspercentage, mat)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time() #default

summary(model_with_xy)
plot(model_with_xy, pages = 1, all.terms = TRUE, rug = TRUE, shade = TRUE)
gam.check(model_with_xy)
concurvity(model_with_xy)
concurvity(model_with_xy, full = FALSE)

#basic model with xy with k=12
Sys.time(); model2 <- mgcv::bam( cbind(ndvi_monthly_stable, 25- ndvi_monthly_stable) ~ 
                             s(re, bs = "ts") +
                             s(trend_annualtemp, bs= "ts") +
                             s(heatwave, bs= "ts") +
                             s(burnedarea,  bs= "ts") +
                             s(anthropic_dist, bs= "ts") +
                             s(savannapercentage,  bs= "ts") +
                             te(x,y, k= c(12,12), bs= "ts"),
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_step_inc,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              forestpercentage, grasspercentage, mat)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time() #medium k values for x,y

summary(model2)
plot(model2, pages = 1, all.terms = TRUE, rug = TRUE, shade = TRUE)
gam.check(model2)

#basic model with xy with k=20
Sys.time(); model3 <- mgcv::bam( cbind(ndvi_monthly_stable, 25- ndvi_monthly_stable) ~ 
                             s(re, bs = "ts") +
                             s(trend_annualtemp, bs= "ts") +
                             s(heatwave, bs= "ts") +
                             s(burnedarea,  bs= "ts") +
                             s(anthropic_dist, bs= "ts") +
                             s(savannapercentage,  bs= "ts") +
                             te(x,y, k= c(20, 20), bs= "ts"),
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_step_inc,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              forestpercentage, grasspercentage, mat)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time() #high k values for x,y

summary(model3)
plot(model3, pages = 1, all.terms = TRUE, rug = TRUE, shade = TRUE)
gam.check(model3)

#basic model with xy with k=5
Sys.time(); model4 <- mgcv::bam( cbind(ndvi_monthly_stable, 25- ndvi_monthly_stable) ~ 
                             s(re, bs = "ts") +
                             s(trend_annualtemp,  bs= "ts") +
                             s(heatwave, bs= "ts") +
                             s(burnedarea,  bs= "ts") +
                             s(anthropic_dist, bs= "ts") +
                             s(savannapercentage,  bs= "ts") +
                             te(x,y, k= c(5,5), bs= "ts"),
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_step_inc,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              forestpercentage, grasspercentage, mat)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time() #low k values for x,y

summary(model4)
plot(model4, pages = 1, all.terms = TRUE, rug = TRUE, shade = TRUE)
gam.check(model4)

#interaction 1 - annual temperature, no xy
Sys.time(); model_interact_mat_trend <- mgcv::bam( cbind(ndvi_monthly_stable, 25- ndvi_monthly_stable) ~ 
                             s(re, bs = "ts") +
                             s(trend_annualtemp) + s(mat, bs= "ts") +
                             ti(trend_annualtemp,mat, bs= "ts") +
                             s(heatwave, bs= "ts") +
                             s(burnedarea,  bs= "ts") +
                             s(anthropic_dist, bs= "ts") +
                             s(savannapercentage,  bs= "ts"),
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_step_inc,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              forestpercentage, grasspercentage)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time() #low k values for x,y

summary(model_interact_mat_trend)
plot(model_interact_mat_trend, pages = 1, all.terms = TRUE, rug = TRUE, shade = TRUE)
gam.check(model_interact_mat_trend)



```

(b) considering "step increase" response
```{r}
################################################ Considering means
#basic model without xy and no interactions
Sys.time(); model_no_interaction_xy<- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ 
                             s(trend_re,  bs = "ts") +
                             s(trend_annualtemp,  bs= "ts") +
                             s(trend_heatwave, bs= "ts") +
                             s(trend_burnedarea,  bs= "ts") +
                             s(anthropic_dist , bs= "ts") +
                             s(hand, bs= "ts")+
                             s(trend_savannapercentage,  bs= "ts")+
                               s(mat, bs= "ts") +
                               s(mean_heatwave,  bs= "ts")+
                               s(mean_burnedarea, bs= "ts") +
                               s(mean_re, bs= "ts")+
                               s(mean_savannapercentage, bs= "ts"), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML",
                 family = quasibinomial(link = "logit")); Sys.time()
summary(model_no_interaction_xy) #~14.1% deviance explained
gam.check(model_no_interaction_xy)
gratia::draw(model_no_interaction_xy, rug= F)
concurvity(model_no_interaction_xy, full= F)

##basic model without interactions
Sys.time(); model_no_interactions<- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ 
                             s(trend_re,  bs = "ts") +
                             s(trend_annualtemp,  bs= "ts") +
                             s(trend_heatwave, bs= "ts") +
                             s(trend_burnedarea, bs= "ts") +
                             s(anthropic_dist, bs= "ts") +
                             s(hand,  bs= "ts")+
                             s(trend_savannapercentage, bs= "ts")+
                               s(mat, bs= "ts") +
                               s(mean_heatwave,  bs= "ts")+
                               s(mean_burnedarea, bs= "ts") +
                               s(mean_re, bs= "ts")+
                               s(mean_savannapercentage, bs= "ts") +
                               te(x,y), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML",
                 family = quasibinomial(link = "logit")); Sys.time()
summary(model_no_interactions) #~17.2%
1-pchisq((model_no_interactions$deviance/8.2282),model_no_interactions$df.residual)
gratia::draw(model_no_interactions, rug= F)
mgcv::gam.check(model_no_interactions)

#basic model without interactions and only means
Sys.time(); model_no_interactions_onlymeans<- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ 
                             s(anthropic_dist,   bs= "ts") +
                                s(hand, bs= "ts") +
                             s(mean_savannapercentage,  bs= "ts")+
                               s(mean_re, bs= "ts")+
                               s(mat, bs= "ts") +
                               s(mean_heatwave, bs ="ts")+
                               s(mean_burnedarea, bs = "ts")+
                               te(x,y, bs= "ts"), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time()
summary(model_no_interactions_onlymeans) #~15.3%
gratia::draw(model_no_interactions_onlymeans, rug= F)
mgcv::gam.check(model_no_interactions_onlymeans)



##Interaction 1- mat, trend in annual temp
Sys.time(); model_interaction_temp<- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ 
                             s(trend_re, bs = "ts") +
                             ti(trend_annualtemp, mat, bs= "ts") +
                               s(trend_annualtemp, bs ="ts")+
                               s(mat, k=9,  bs = "ts")+
                             s(trend_heatwave, bs= "ts") +
                             s(trend_burnedarea,  bs= "ts") +
                             s(anthropic_dist, bs= "ts") +
                                s(hand, bs= "ts") +
                             s(trend_savannapercentage, bs= "ts")+
                               s(mean_re, bs= "ts")+
                               s(mean_savannapercentage, bs= "ts")+
                               s(mean_heatwave, k=9, bs = "ts")+
                               s(mean_burnedarea, bs = "ts")+
                               te(x,y, bs= "ts"), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML", select = T,
                 family = binomial(link = "logit")); Sys.time()
summary(model_interaction_temp) #default k ~17.2%
gratia::draw(model_interaction_temp, rug= F)
mgcv::gam.check(model_interaction_temp)
x_interaction_temp <- getViz(model_interaction_temp)
plotRGL(sm(x_interaction_temp , 2), fix = c("z" = 0), residuals = TRUE)


##Interaction 2- mat, trend in annual temp & mean heatwave, trend in heatwave
Sys.time(); model_interaction_temp_heatwave<- mgcv::bam( cbind(ndvi_monthly_step_inc, 25 - ndvi_monthly_step_inc) ~ 
                             s(trend_re, bs = "ts") +
                             ti(trend_annualtemp, mat, bs= "ts") +
                               s(trend_annualtemp, bs ="ts")+
                               s(mat, bs = "ts") +
                             ti(trend_heatwave, mean_heatwave, bs = "ts")+
                             s(trend_heatwave, bs= "ts") +
                              s(mean_heatwave, bs = "ts")+
                             s(trend_burnedarea,  bs= "ts") +
                             s(anthropic_dist, bs= "ts") +
                                s(hand, bs= "ts") +
                             s(trend_savannapercentage, bs= "ts")+
                               s(mean_burnedarea, bs = "ts")+
                               te(x,y, bs= "ts"), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time()
summary(model_interaction_temp_heatwave) #~17.7%
gratia::draw(model_interaction_temp_heatwave, scales = "fixed", rug = F)
mgcv::gam.check(model_interaction_temp_heatwave)
x_trial2 <- getViz(model_interaction_temp_heatwave)
plotRGL(sm(x_trial2, 2), fix = c("z" = 0), residuals = TRUE)
plotRGL(sm(x_trial2, 5), fix = c("z" = 0), residuals = TRUE)

##Interaction 3- mat, trend in annual temp & mean heatwave, trend in heatwave & mean burned area, trend in burned area
Sys.time(); model_interaction_temp_heatwave_burnedarea<- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ 
                             s(trend_re, bs = "ts") +
                             ti(trend_annualtemp, mat, bs= "ts") +
                               s(trend_annualtemp, bs ="ts")+
                               s(mat, bs = "ts") +
                             ti(trend_heatwave, mean_heatwave, bs = "ts")+
                              s(trend_heatwave, bs= "ts") +
                              s(mean_heatwave, bs = "ts") +
                             ti(trend_burnedarea, mean_burnedarea, bs = "ts")+
                              s(trend_burnedarea,  bs= "ts") +
                              s(mean_burnedarea, bs = "ts")+
                             s(anthropic_dist, bs= "ts") +
                                s(hand, bs= "ts") +
                             s(trend_savannapercentage, bs= "ts")+
                               te(x,y, bs= "ts"), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time()
summary(model_interaction_temp_heatwave_burnedarea) #~17.7%
gratia::draw(model_interaction_temp_heatwave_burnedarea, scales = "fixed", rug = F)
mgcv::gam.check(model_interaction_temp_heatwave)
x_trial3 <- getViz(model_interaction_temp_heatwave_burnedarea)
plotRGL(sm(x_trial3, 2), fix = c("z" = 0), residuals = TRUE)
plotRGL(sm(x_trial3, 5), fix = c("z" = 0), residuals = TRUE)
plotRGL(sm(x_trial3, 8), fix = c("z" = 0), residuals = TRUE)

################################################ Considering only trends ie no mean annual in any of the time series predictors
##Interaction 4- trends in re and at
Sys.time(); model_interaction_at_re_no_means <- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ 
                                ti(trend_annualtemp, trend_re, bs ="ts") +
                                s(trend_re, bs = "ts") +
                                s(trend_annualtemp, bs ="ts")+
                                s(trend_heatwave, bs= "ts") +
                                s(trend_burnedarea,  bs= "ts") +
                                s(anthropic_dist, bs= "ts") +
                                   s(hand, bs= "ts") +
                                s(trend_savannapercentage, bs= "ts")+
                                te(x,y, bs= "ts"), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time()
summary(model_interaction_at_re_no_means) #~16.2 %
mgcv::gam.check(model_interaction_at_re_no_means)
gratia::draw(model_interaction_at_re_no_means, scales = "fixed", rug = F)
x_interaction_at_re_no_means<- getViz(model_interaction_at_re_no_means)
plotRGL(sm(x_interaction_at_re_no_means, 1), fix = c("z" = 0), residuals = TRUE)

##Interaction 5- trends in re and burned area
Sys.time(); model_interaction_re_burnedarea_no_means <- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ 
                                ti(trend_re, trend_burnedarea, bs ="ts") +
                                s(trend_re, bs = "ts") +
                                s(trend_annualtemp, bs ="ts")+
                                s(trend_heatwave, bs= "ts") +
                                s(trend_burnedarea,  bs= "ts") +
                                s(anthropic_dist, bs= "ts") +
                                   s(hand, bs= "ts") +
                                s(trend_savannapercentage, bs= "ts")+
                                te(x,y, bs= "ts"), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time()
summary(model_interaction_re_burnedarea_no_means) #~15.6 %
mgcv::gam.check(model_interaction_re_burnedarea_no_means)
gratia::draw(model_interaction_re_burnedarea_no_means, scales = "fixed", rug = F)
x_interaction_re_burnedarea_no_means <- getViz(model_interaction_re_burnedarea_no_means)
plotRGL(sm(x_interaction_re_burnedarea_no_means, 1), fix = c("z" = 0), residuals = TRUE)

##Interaction 6- trends in temp and heatwaves
Sys.time(); model_interaction_at_heatwaves_no_means <- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ 
                                ti(trend_annualtemp, trend_heatwave, bs ="ts") +
                                s(trend_re, bs = "ts") +
                                s(trend_annualtemp, bs ="ts")+
                                s(trend_heatwave, bs= "ts") +
                                s(trend_burnedarea,  bs= "ts") +
                                s(anthropic_dist, bs= "ts") +
                                   s(hand, bs= "ts") +
                                s(trend_savannapercentage, bs= "ts")+
                                te(x,y, bs= "ts"), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time()
summary(model_interaction_at_heatwaves_no_means) #~15.9 %
mgcv::gam.check(model_interaction_at_heatwaves_no_means)
gratia::draw(model_interaction_at_heatwaves_no_means, scales = "fixed", rug = F)
x_interaction_at_heatwaves_no_means <- getViz(model_interaction_at_heatwaves_no_means)
plotRGL(sm(x_interaction_at_heatwaves_no_means, 1), fix = c("z" = 0), residuals = TRUE)

##Interaction 7- trends in re and heatwaves
Sys.time(); model_interaction_re_heatwaves_no_means <- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ 
                                ti(re, trend_heatwave, bs ="ts") +
                                s(re, bs = "ts") +
                                s(trend_annualtemp, bs ="ts")+
                                s(trend_heatwave, bs= "ts") +
                                s(trend_burnedarea,  bs= "ts") +
                                s(anthropic_dist, bs= "ts") +
                                   s(hand, bs= "ts") +
                                s(trend_savannapercentage, bs= "ts")+
                                te(x,y, bs= "ts"), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time()
summary(model_interaction_re_heatwaves_no_means) #~15.8 %
mgcv::gam.check(model_interaction_re_heatwaves_no_means)
gratia::draw(model_interaction_re_heatwaves_no_means, scales = "fixed", rug = F)
x_trial8<- getViz(model_interaction_re_heatwaves_no_means)
plotRGL(sm(x_trial8, 1), fix = c("z" = 0), residuals = TRUE)

##Interaction 8- anthropic distance and water table depth
Sys.time(); model_interaction_anthropic_hand_no_means <- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ 
                                ti(anthropic_dist, hand , bs ="ts") +
                                s(re, bs = "ts") +
                                s(trend_annualtemp, bs ="ts")+
                                s(trend_heatwave, bs= "ts") +
                                s(trend_burnedarea,  bs= "ts") +
                                s(anthropic_dist, bs= "ts") +
                                   s(hand, bs= "ts") +
                                s(trend_savannapercentage, bs= "ts")+
                                te(x,y, bs= "ts"), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time()
summary(model_interaction_anthropic_hand_no_means) #~15.5 %
mgcv::gam.check(model_interaction_anthropic_hand_no_means)
gratia::draw(model_interaction_anthropic_hand_no_means, scales = "fixed", rug = F)
x_trial9<- getViz(model_interaction_anthropic_hand_no_means)
plotRGL(sm(x_trial9, 1), fix = c("z" = 0), residuals = TRUE)

##Interaction 9- trends in at and savanna vegetation
Sys.time(); model_interaction_at_savannaveg_no_means <- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ 
                                ti(trend_annualtemp, trend_savannapercentage, bs ="ts") +
                                s(re, bs = "ts") +
                                s(trend_annualtemp, bs ="ts")+
                                s(trend_heatwave, bs= "ts") +
                                s(trend_burnedarea,  bs= "ts") +
                                s(anthropic_dist, bs= "ts") +
                                   s(hand, bs= "ts") +
                                s(trend_savannapercentage, bs= "ts")+
                                te(x,y, bs= "ts"), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time()
summary(model_interaction_at_savannaveg_no_means) #~15.5 %
mgcv::gam.check(model_interaction_at_savannaveg_no_means)
gratia::draw(model_interaction_at_savannaveg_no_means, scales = "fixed", rug = F)
x_trial10<- getViz(model_interaction_at_savannaveg_no_means)
plotRGL(sm(x_trial10, 1), fix = c("z" = 0), residuals = TRUE)

##Interaction 10- trends in heatwaves and savanna vegetation
Sys.time(); model_interaction_heatwave_savannaveg_no_means <- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ 
                                ti(trend_heatwave, trend_savannapercentage, bs ="ts") +
                                s(re, bs = "ts") +
                                s(trend_annualtemp, bs ="ts")+
                                s(trend_heatwave, bs= "ts") +
                                s(trend_burnedarea,  bs= "ts") +
                                s(anthropic_dist, bs= "ts") +
                                   s(hand, bs= "ts") +
                                s(trend_savannapercentage, bs= "ts")+
                                te(x,y, bs= "ts"), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time()
summary(model_interaction_heatwave_savannaveg_no_means) #~15.5 %
mgcv::gam.check(model_interaction_heatwave_savannaveg_no_means)
gratia::draw(model_interaction_heatwave_savannaveg_no_means, scales = "fixed", rug = F)
x_trial11<- getViz(model_interaction_heatwave_savannaveg_no_means)
plotRGL(sm(x_trial11, 1), fix = c("z" = 0), residuals = TRUE)

##Interaction 11- trends in re and savanna vegetation
Sys.time(); model_interaction_re_savannaveg_no_means <- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ 
                                ti(re, trend_savannapercentage, bs ="ts") +
                                s(re, bs = "ts") +
                                s(trend_annualtemp, bs ="ts")+
                                s(trend_heatwave, bs= "ts") +
                                s(trend_burnedarea,  bs= "ts") +
                                s(anthropic_dist, bs= "ts") +
                                   s(hand, bs= "ts") +
                                s(trend_savannapercentage, bs= "ts")+
                                te(x,y, bs= "ts"), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time()
summary(model_interaction_re_savannaveg_no_means) #~15.5 %
mgcv::gam.check(model_interaction_re_savannaveg_no_means)
gratia::draw(model_interaction_re_savannaveg_no_means, scales = "fixed", rug = F)
x_trial12<- getViz(model_interaction_re_savannaveg_no_means)
plotRGL(sm(x_trial12, 1), fix = c("z" = 0), residuals = TRUE)



```
