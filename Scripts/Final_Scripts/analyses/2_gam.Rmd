```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, include=FALSE}
library(RColorBrewer)
library(terra)
library(tidyverse)
library(tidyr)
library(here)
library(ggplot2)
library(mgcv)
library(mgcViz)
library(rgl)
library(gratia)
library(gtools)
library(scales)
library(patchwork)
library(purrr)
library(dplyr)

```

##Introduction
In this script, I do GAMs to understand the relationship between different trajectories (from NDVI stl swindow = 11 primarily) and 
various predictor variables. 
(1) Data input of NDVI derived %area of pixel of aggregate trajectories and predictors at 5km
(2) Data processing and structuring for analyses
(3) Exploratory data plots
(4) GAM modeling
(5) Plotting of GAM results

#Step 1- data input
```{r}
#response- binary trajectory (aggregated trajectory types) from NDVI monthly swin 11 stl setting
ndvi_agg_count <- rast (here("Outputs", "TrendsResults", "aggregate_trajectory_results", "monthly_ndvi_agg_count_5km.tif"))

#static drivers
anthropic_dist<- rast(here("Outputs", "OtherVariables", "AnthropicDist", "5km_meandist_20thresholdsanthropicpixel.tif"))
hand<- rast(here("Outputs", "OtherVariables","HAND", "cerrado_hand_5km.tif"))

#trend variables
trend_burnedarea<- rast(here("Outputs", "OtherVariables", "Fire", "theilsen_burnedarea_5km.tif"))
trend_re<- rast(here("Outputs", "OtherVariables", "Climate", "theilsen_re.tif"))
trend_at<- rast(here("Outputs", "OtherVariables", "Climate", "theilsen_at_5km.tif"))
trend_spei<-rast(here("Outputs", "OtherVariables", "Climate", "theilsen_spei.tif"))
trend_heatwave<- rast(here("Outputs", "OtherVariables", "Climate", "theilsen_heatwaves.tif"))

#mean variables
mean_burnedarea<- rast(here("Outputs", "OtherVariables", "Fire", "mean_burnedarea_5km_2002_2021.tif"))
mean_re <- rast(here("Outputs", "OtherVariables", "Climate","mean_annual_relative_entropy_1981_2021.tif") )
mean_at <- rast(here("Outputs", "OtherVariables", "Climate", "mat_1981_2021_5km.tif"))
mean_spei <- rast( here("Outputs", "OtherVariables", "Climate", "mean_annualspei.tif")) 
mean_heatwave <- rast(here("Outputs", "OtherVariables", "Climate", "mean_annual_heatwaves_2002_2021.tif"))

#mean %area of veg formation
mean_savannapercentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "mean_savanna_percentage_5km_2002_2021.tif"))
mean_grasspercentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "mean_grass_percentage_5km_2002_2021.tif"))
mean_forestpercentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "mean_forest_percentage_5km_2002_2021.tif"))

```


#Step 2- data structuring, applying anthropic threshold mask to predictors
```{r}
crop_mask_function <- function(raster_to_be_cropmask){
  x_mask <- terra::mask(raster_to_be_cropmask, ndvi_agg_count[[1]])
  x_mask
}

cm_anthropic_dist <- crop_mask_function(anthropic_dist)
cm_hand <- crop_mask_function(hand)

cm_trend_burnedarea <- crop_mask_function(trend_burnedarea)
cm_trend_re <- crop_mask_function(trend_re)
cm_trend_at <- crop_mask_function(trend_at)
cm_trend_spei <- crop_mask_function(trend_spei)
cm_trend_heatwave <- crop_mask_function(trend_heatwave)

cm_mean_burnedarea <- crop_mask_function(mean_burnedarea)
cm_mean_re <- crop_mask_function(mean_re)
cm_mean_at <- crop_mask_function(mean_at)
cm_mean_spei <- crop_mask_function(mean_spei)
cm_mean_heatwave <- crop_mask_function(mean_heatwave)

cm_mean_forest <- crop_mask_function(mean_forestpercentage)
cm_mean_grass <- crop_mask_function(mean_grasspercentage)
cm_mean_savanna <- crop_mask_function(mean_savannapercentage)

constantdrivers <- c(cm_anthropic_dist, cm_hand, 
                     cm_trend_burnedarea, cm_trend_re, cm_trend_at, cm_trend_spei, cm_trend_heatwave, 
                     cm_mean_burnedarea, cm_mean_re, cm_mean_at, cm_mean_spei, cm_mean_heatwave)

all_vars <- c(ndvi_agg_count, constantdrivers, cm_mean_savanna, cm_mean_grass, cm_mean_forest)
analyses_df <- terra::as.data.frame(all_vars, xy = TRUE)
names(analyses_df) <- c("x", "y", "decrease", 
                    "increase",
                    "notrend",
                    "anthropic_dist", 
                    "hand", 
                    "trend_burnedarea",
                    "trend_re", 
                    "trend_annualtemp", 
                    "trend_spei",
                    "trend_heatwave", 
                    "mean_burnedarea",
                    "mean_re",
                    "mean_at",
                    "mean_spei",
                    "mean_heatwave",
                    "mean_savanna_percentage",
                    "mean_grass_percentage",
                    "mean_forest_percentage")

remove(anthropic_dist, hand, trend_burnedarea, trend_re, trend_at, trend_spei, trend_heatwave,
             mean_burnedarea, mean_re, mean_at, mean_spei, mean_heatwave,
             mean_savannapercentage, mean_grasspercentage, mean_forestpercentage)
remove(cm_anthropic_dist, cm_hand, cm_trend_burnedarea, cm_trend_re, cm_trend_at, cm_trend_spei, cm_trend_heatwave,
             cm_mean_burnedarea, cm_mean_re, cm_mean_at, cm_mean_spei, cm_mean_heatwave,
             cm_mean_savanna, cm_mean_grass, cm_mean_forest)
remove(ndvi_agg_count)
remove(crop_mask_function)
```


#Step 3- eda - understanding the correlations and distributions of all the variables 
```{r}
summary(analyses_df)

remove_NA <- function (df_analyses){
  analyses_df_noNA <- df_analyses %>% drop_na() 
  analyses_df_noNA
}
analyses_df_NA <- remove_NA(analyses_df)

remove_HAND_outliers <- function (df_analyses_NA){
  no_outliers_sample_df <- df_analyses_NA %>% 
          mutate (IQR = IQR(hand),
                  O_upper = quantile (hand, probs= c(0.75), na.rm= FALSE)+ 1.5*IQR,
                  O_lower = quantile(hand, probs= c(0.25), na.rm= FALSE) - 1.5*IQR
                  ) %>% 
          filter(O_lower <= hand & hand <= O_upper) %>%
          dplyr::select(-c(IQR, O_upper, O_lower))
  no_outliers_sample_df
}
analyses_df_noNA_nooutliers <- remove_HAND_outliers(analyses_df_NA)

plot_df_function <- function (df_noNA_nooutliers){
  pivot_df <- df_noNA_nooutliers %>% 
  dplyr::select(-c(x,y)) %>%
  pivot_longer(1:18)
  
distribution_plot <- ggplot(data = pivot_df, aes(value)) +
  geom_histogram() +facet_wrap(~name, scales = "free", labeller = label_wrap_gen(4)) +
  theme_classic(base_size = 16)
distribution_plot
}
analyses_df_plot <- plot_df_function (analyses_df_noNA_nooutliers)

remove(plot_df_function, remove_HAND_outliers, remove_NA)

```

#Step 4- one model for all variables seperated as step inc and dec
```{r}
Sys.time(); step_inc_model <- mgcv::bam( cbind(increase, 25- increase) ~ s(anthropic_dist, bs= "ts") +
                                          s(hand, bs= "ts") +
                                          s(trend_re, bs= "ts") +
                                          s(trend_annualtemp, bs= "ts") +
                                          s(trend_heatwave, bs ="ts") +
                                          s(trend_spei, bs= "ts") +
                                          s(trend_burnedarea, bs = "ts") +
                                        
                                          s(mean_re, bs= "ts") +
                                          s(mean_at, bs= "ts") +
                                          s(mean_heatwave,  bs= "ts") +
                                          s(mean_spei, bs= "ts") +
                                          s(mean_burnedarea, bs= "ts") +
                                          s(mean_savanna_percentage, bs= "ts") +
                                          s(mean_grass_percentage, bs= "ts") +
                                          s(mean_forest_percentage, bs= "ts")+
                                          
                                          s(x,y, bs= "ts") +
                                          ti(mean_at, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          ti(trend_annualtemp, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          
                                          ti(trend_annualtemp, trend_re, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(trend_heatwave, trend_spei, bs=c("ts", "ts"), k=c(5,5)) +
                                          
                                          ti(anthropic_dist, mean_savanna_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(anthropic_dist, mean_grass_percentage, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(anthropic_dist, mean_forest_percentage, bs=c("ts", "ts"), k=c(5,5)) +  
                                           
                                          ti(anthropic_dist, trend_burnedarea, bs=c("ts", "ts"), k=c(5,5)) +
                                          
                                          ti(trend_burnedarea, mean_savanna_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(trend_burnedarea, mean_grass_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(trend_burnedarea, mean_forest_percentage, bs=c("ts", "ts"), k=c(5,5)) +  
                                          
                                          ti(mean_savanna_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_savanna_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_grass_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_grass_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_forest_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_forest_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                           
                                          ti(trend_burnedarea, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(trend_burnedarea, trend_heatwave, trend_spei, bs=c("ts", "ts", "ts"), k=c(3,3,3)) ,
                                         
                                        data = analyses_df_noNA_nooutliers %>% dplyr::select(-c(decrease, notrend)), 
                                        method = "fREML", 
                                        family = quasibinomial(link = "logit")); Sys.time() 
write_rds(step_inc_model, here("Scripts", "Final_Scripts", "analyses", "onemodel_inc.rds"))

Sys.time(); step_dec_model <- mgcv::bam( cbind(decrease, 25- decrease) ~ s(anthropic_dist, bs= "ts") +
                                          s(hand, bs= "ts") +
                                          s(trend_re, bs= "ts") +
                                          s(trend_annualtemp, bs= "ts") +
                                          s(trend_heatwave, bs ="ts") +
                                          s(trend_spei, bs= "ts") +
                                          s(trend_burnedarea, bs = "ts") +
                                        
                                          s(mean_re, bs= "ts") +
                                          s(mean_at, bs= "ts") +
                                          s(mean_heatwave,  bs= "ts") +
                                          s(mean_spei, bs= "ts") +
                                          s(mean_burnedarea, bs= "ts") +
                                          s(mean_savanna_percentage, bs= "ts") +
                                          s(mean_grass_percentage, bs= "ts") +
                                          s(mean_forest_percentage, bs= "ts")+
                                          
                                          s(x,y, bs= "ts") +
                                          ti(mean_at, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          ti(trend_annualtemp, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          
                                          ti(trend_annualtemp, trend_re, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(trend_heatwave, trend_spei, bs=c("ts", "ts"), k=c(5,5)) +
                                          
                                          ti(anthropic_dist, mean_savanna_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(anthropic_dist, mean_grass_percentage, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(anthropic_dist, mean_forest_percentage, bs=c("ts", "ts"), k=c(5,5)) +  
                                           
                                          ti(anthropic_dist, trend_burnedarea, bs=c("ts", "ts"), k=c(5,5)) +
                                          
                                          ti(trend_burnedarea, mean_savanna_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(trend_burnedarea, mean_grass_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(trend_burnedarea, mean_forest_percentage, bs=c("ts", "ts"), k=c(5,5)) +  
                                          
                                          ti(mean_savanna_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_savanna_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_grass_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_grass_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_forest_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_forest_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                           
                                          ti(trend_burnedarea, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(trend_burnedarea, trend_heatwave, trend_spei, bs=c("ts", "ts", "ts"), k=c(3,3,3)),
                                         
                                        data = analyses_df_noNA_nooutliers %>% dplyr::select(-c(increase, notrend)), 
                                        method = "fREML", 
                                        family = quasibinomial(link = "logit")); Sys.time()
write_rds(step_dec_model, here("Scripts", "Final_Scripts", "analyses", "onemodel_dec.rds"))

step_inc_model$converged
step_dec_model$converged
step_inc_model$mgcv.conv$message
step_dec_model$mgcv.conv$message
step_inc_model$boundary
step_dec_model$boundary

appraise(step_dec_model)
appraise(step_inc_model)

summary(step_inc_model)
summary(step_dec_model)
```

#Step 5a - Functions to visualize 2 way interactions
```{r}
inc_gam <- read_rds(here("Scripts", "Final_Scripts", "analyses", "onemodel_inc.rds"))
dec_gam <- read_rds(here("Scripts", "Final_Scripts", "analyses" ,"onemodel_dec.rds"))


grid_creation_prediction <- function (df_analyses, xaxis_variable_in_quotes, 
                                              line_variable_in_quotes, 
                                              gam_model){
  df_select <- df_analyses %>% dplyr::select(-c(notrend))
  
  var_x <- subset( df_select, select = xaxis_variable_in_quotes)
  var_line <- subset( df_select, select = line_variable_in_quotes)
  var_line <- as.vector(var_line) %>% unlist()
  
  xaxis_range <- seq(min(var_x),max(var_x),len = xaxis_range_len)
  line_range <- c((mean(var_line) - sd(var_line)),0, (mean(var_line) + sd(var_line)))
  
  df_means<- df_select %>% dplyr::select(-c(x,y,xaxis_variable_in_quotes, line_variable_in_quotes)) %>%
    summarise(across(where(is.numeric), ~mean(.x, na.rm= T)))
  
  newd <- data.frame(expand.grid(xaxis_range, line_range))
  names(newd) <- c(xaxis_variable_in_quotes, line_variable_in_quotes)
  newd <- newd %>% bind_cols(df_means) %>% mutate(x= x1, y=y1)
  pred <- mgcv::predict.bam(gam_model, newdata = newd, type="terms") 
  pred <- as.data.frame(pred)
  pred
}

select_effects_function <- function (df_analyses, xaxis_variable_in_quotes, 
                                     prediction_df, 
                                     effects_cols_indices,
                                     line_lower_plotting_in_quotes_name, 
                                     line_middle_plotting_in_quotes_name, 
                                     line_higher_plotting_in_quotes_name){
  
  df_select <- df_analyses %>% dplyr::select(-c(notrend))
  
  var_x <- subset( df_select, select = xaxis_variable_in_quotes)
  xaxis_range <- seq(min(var_x),max(var_x),len = xaxis_range_len)
  
  ind <- 1:xaxis_range_len
  ind2 <- (xaxis_range_len + 1):(xaxis_range_len*2)
  ind3 <- ((xaxis_range_len*2)+1):(xaxis_range_len*3)
  
  xy_interaction_effects <- grep("x,y",names(prediction_df),fixed = T)
  pred_without_xy_interaction_effects <- (subset(prediction_df, select = -xy_interaction_effects))
  
  x1Eff <- rowSums(pred_without_xy_interaction_effects [ind, effects_cols_indices] )
  x2Eff <- rowSums(pred_without_xy_interaction_effects [ind2, effects_cols_indices] )
  x3Eff <- rowSums(pred_without_xy_interaction_effects [ind3, effects_cols_indices] )
  
  plot_df <- data.frame(xaxis_colname = xaxis_range)
  plot_df <- plot_df %>% mutate(x1Eff_colname = x1Eff,
                              x2Eff_colname = x2Eff,
                              x3Eff_colname = x3Eff)
  
  names(plot_df)<- c(xaxis_variable_in_quotes,
                     line_lower_plotting_in_quotes_name,
                     line_middle_plotting_in_quotes_name, 
                     line_higher_plotting_in_quotes_name)
  pivot_plot_df <- plot_df %>% pivot_longer(2:4)
  pivot_plot_df
  
}


```

#Step 5a (i) Trends in annual temp and RE across veg formations ### DO NOT RUN 
```{r}
# location
x1 <- -43.2781
y1 <- -4.0213
xaxis_range_len <- 200


inc_pred_trend_at_re <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_annualtemp", "trend_re", 
                                                         inc_gam)
dec_pred_trend_at_re <- grid_creation_prediction(analyses_df, 
                                                         "trend_annualtemp", "trend_re", 
                                                         dec_gam)


plot_inc_trend_at_re <- select_effects_function(analyses_df, 
                                                        "trend_annualtemp", 
                                                        inc_pred_trend_at_re, 
                                                        c(4,16), #4,16 are column indices after removing s(x,y), ti (mean_at, x,y) and ti(trend_annualtemp, x,y)
                                                        "more_uniform_seasonality", "nochange", "less_uniform_seasonality")

plot_dec_trend_at_re <- select_effects_function(analyses_df, 
                                                        "trend_annualtemp", 
                                                        dec_pred_trend_at_re,
                                                        c(4,16),
                                                        "more_uniform_seasonality", "nochange", "less_uniform_seasonality")

combined_plot_df_prep <- function (inc_df, dec_df){
  inc_df <- inc_df %>% mutate(TrajType = "Step_Inc")
  dec_df <- dec_df %>% mutate(TrajType = "Step_Dec")
  plot_df <- bind_rows (inc_df, dec_df)
  plot_df
}

plot_df <- combined_plot_df_prep(plot_inc_trend_at_re, plot_dec_trend_at_re)

plot_function <- function (plot_df, xaxis_var){
  plot_interaction <- ggplot(plot_df, aes(x = .data[[xaxis_var]], y = value,
                                          color = name, linetype = TrajType,
                                          group = interaction(name, TrajType))) +
    geom_line(aes(color = name), linewidth = 1) + 
    theme_classic() +
    scale_color_manual(values=c("#990066", "#333333", "#336600")) + 
    ylab ("Partial Effect") + theme(legend.title=element_blank())
  plot_interaction
}

annualtemp_re <- plot_function(plot_df , "trend_annualtemp")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "TwoWay_InteractionResults", "trend_annualtemp_re.png"), annualtemp_re,
        dpi = 700, height = 25, width=25, units = "cm")

#remove(savanna_plot_df, grass_plot_df, forest_plot_df, plot_dec_grass_trend_at_re, plot_dec_forest_trend_at_re,plot_dec_savanna_trend_at_re,
#      plot_inc_grass_trend_at_re, plot_inc_forest_trend_at_re, plot_inc_savanna_trend_at_re,dec_pred_forest_trend_at_re, inc_pred_forest_trend_at_re,
#      dec_pred_grass_trend_at_re, inc_pred_grass_trend_at_re, dec_pred_savanna_trend_at_re, inc_pred_savanna_trend_at_re)
remove(plot_df, plot_dec_trend_at_re, plot_inc_trend_at_re, dec_pred_trend_at_re, inc_pred_trend_at_re)

```

#Step 5a (ii) Trends in heatwaves and SPEI across veg formations ### DO NOT RUN 
```{r}
inc_pred_trend_heatwave_spei <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_heatwave", "trend_spei", 
                                                         inc_gam)
dec_pred_trend_heatwave_spei <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_heatwave", "trend_spei", 
                                                         dec_gam)

plot_inc_trend_heatwave_spei <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                        "trend_heatwave", 
                                                        inc_pred_trend_heatwave_spei, 
                                                        c(5,17),
                                                        "more_dry", "nochange", "more_wet")

plot_dec_trend_heatwave_spei <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                        "trend_heatwave", 
                                                        dec_pred_trend_heatwave_spei,
                                                        c(5,17),
                                                        "more_dry", "nochange", "more_wet")


plot_df <- combined_plot_df_prep(plot_inc_trend_heatwave_spei , plot_dec_trend_heatwave_spei)


heatwave_spei_vegformation <- plot_function(plot_df , "trend_heatwave")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "TwoWay_InteractionResults", "trend_heatwaves_spei.png"), heatwave_spei_vegformation,
        dpi = 700, height = 25, width=25, units = "cm")
remove(plot_df, plot_dec_trend_heatwave_spei, plot_inc_trend_heatwave_spei, inc_pred_trend_heatwave_spei, dec_pred_trend_heatwave_spei)

```

#Step 5a (iii) Mean anthropic distance and trend in burnedarea ### DO NOT RUN 
```{r}
inc_pred_trend_anthropicdist_burnedarea <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "anthropic_dist", "trend_burnedarea", 
                                                         inc_gam)
dec_pred_trend_anthropicdist_burnedarea <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "anthropic_dist", "trend_burnedarea", 
                                                         dec_gam)



plot_inc_trend_anthropicdist_burnedarea <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                        "anthropic_dist", 
                                                        inc_pred_trend_anthropicdist_burnedarea , 
                                                        c(1,21),
                                                        "more_burnedarea", "nochange", "less_burnedarea")
plot_dec_trend_anthropicdist_burnedarea<- select_effects_function(analyses_df_noNA_nooutliers, 
                                                        "anthropic_dist", 
                                                        dec_pred_trend_anthropicdist_burnedarea,
                                                        c(1,21),
                                                        "more_burnedarea", "nochange", "less_burnedarea")


plot_df <- combined_plot_df_prep(plot_inc_trend_anthropicdist_burnedarea, plot_dec_trend_anthropicdist_burnedarea)

anthropicdist_burnedarea_vegformation <- plot_function(plot_df , "anthropic_dist")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "TwoWay_InteractionResults", "anthropicdist_trend_burnedarea.png"), anthropicdist_burnedarea_vegformation  ,
        dpi = 700, height = 25, width=25, units = "cm")

remove(plot_df, plot_inc_trend_anthropicdist_burnedarea , plot_dec_trend_anthropicdist_burnedarea, inc_pred_trend_anthropicdist_burnedarea , dec_pred_trend_anthropicdist_burnedarea)
```

#Step 5a (iv) Mean anthropic distance and mean veg formation
```{r}
# location
x1 <- -43.2781
y1 <- -4.0213
xaxis_range_len <- 200

grid_creation_prediction <- function (df_analyses, xaxis_variable_in_quotes, 
                                              line_variable_in_quotes, 
                                              gam_model){
  df_select <- df_analyses %>% dplyr::select(-c(notrend))
  
  var_x <- subset( df_select, select = xaxis_variable_in_quotes)
  var_line <- subset( df_select, select = line_variable_in_quotes)
  var_line <- as.vector(var_line) %>% unlist()
  
  xaxis_range <- seq(min(var_x),max(var_x),len = xaxis_range_len)
  line_range <- c((mean(var_line) - sd(var_line)),mean(var_line), (mean(var_line) + sd(var_line))) #changed middle scenario to be mean of veg formation area
  
  df_means<- df_select %>% dplyr::select(-c(x,y,xaxis_variable_in_quotes, line_variable_in_quotes)) %>%
    summarise(across(where(is.numeric), ~mean(.x, na.rm= T)))
  
  newd <- data.frame(expand.grid(xaxis_range, line_range))
  names(newd) <- c(xaxis_variable_in_quotes, line_variable_in_quotes)
  newd <- newd %>% bind_cols(df_means) %>% mutate(x= x1, y=y1)
  pred <- mgcv::predict.bam(gam_model, newdata = newd, type="terms") 
  pred <- as.data.frame(pred)
  pred
}

inc_pred_anthropicdist_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "anthropic_dist", "mean_savanna_percentage", 
                                                         inc_gam)
dec_pred_anthropicdist_savanna  <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "anthropic_dist", "mean_savanna_percentage", 
                                                         dec_gam)
inc_pred_anthropicdist_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "anthropic_dist", "mean_forest_percentage", 
                                                         inc_gam)
dec_pred_anthropicdist_forest  <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "anthropic_dist", "mean_forest_percentage", 
                                                         dec_gam)
inc_pred_anthropicdist_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "anthropic_dist", "mean_grass_percentage", 
                                                         inc_gam)
dec_pred_anthropicdist_grass  <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "anthropic_dist", "mean_grass_percentage", 
                                                         dec_gam)


plot_inc_savanna_anthropicdist <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                        "anthropic_dist", 
                                                        inc_pred_anthropicdist_savanna , 
                                                        c(1, 13, 18),
                                                        "low", "medium", "high")
plot_dec_savanna_anthropicdist <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                        "anthropic_dist", 
                                                        dec_pred_anthropicdist_savanna,
                                                        c(1, 13, 18),
                                                        "low", "medium", "high")
plot_inc_forest_anthropicdist <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                       "anthropic_dist", inc_pred_anthropicdist_forest,
                                                       c(1, 15, 20),
                                                       "low", "medium", "high")
plot_dec_forest_anthropicdist <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                       "anthropic_dist", 
                                                       dec_pred_anthropicdist_forest , 
                                                      c(1, 15, 20),
                                                       "low", "medium", "high")
plot_inc_grass_anthropicdist <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                      "anthropic_dist", 
                                                      inc_pred_anthropicdist_grass, 
                                                     c(1, 14, 19),
                                                      "low", "medium", "high")
plot_dec_grass_anthropicdist <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                      "anthropic_dist", 
                                                      dec_pred_anthropicdist_grass, 
                                                      c(1, 14, 19),
                                                      "low", "medium", "high")
combined_plot_df_prep <- function (inc_df, dec_df, veg_formation_in_quotes){
  inc_df <- inc_df %>% mutate(TrajType = "Step_Inc")
  dec_df <- dec_df %>% mutate(TrajType = "Step_Dec")
  plot_df <- bind_rows (inc_df, dec_df)
  plot_df <- plot_df %>% mutate(VegFormation = veg_formation_in_quotes)
  plot_df
}

savanna_plot_df <- combined_plot_df_prep(plot_inc_savanna_anthropicdist , plot_dec_savanna_anthropicdist, "Savanna")
grass_plot_df <- combined_plot_df_prep(plot_inc_grass_anthropicdist , plot_dec_grass_anthropicdist, "Grass")
forest_plot_df <- combined_plot_df_prep(plot_inc_forest_anthropicdist  , plot_dec_forest_anthropicdist , "Forest")

anthropicdist_vegformation_plot_df <- bind_rows(savanna_plot_df, grass_plot_df, forest_plot_df)

plot_function <- function (plot_df, xaxis_var){
  plot_interaction <- ggplot(plot_df, aes(x = .data[[xaxis_var]], y = value,
                                          color = name, linetype = TrajType,
                                          group = interaction(name, TrajType))) +
    geom_line(aes(color = name), linewidth = 1) + facet_wrap(~VegFormation)+
    theme_classic() +
    scale_color_manual(values=c("#E69F00", "#56B4E9", "#333333")) + 
    ylab ("Partial Effect") + theme(legend.title=element_blank())
  plot_interaction
}


anthropicdist_vegformation_vegformation <- plot_function(anthropicdist_vegformation_plot_df , "anthropic_dist")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "TwoWay_InteractionResults", "anthropicdist_meanvegformation3.png"), anthropicdist_vegformation_vegformation,
        dpi = 700, height = 25, width=25, units = "cm")

remove(savanna_plot_df, grass_plot_df, forest_plot_df, 
       inc_pred_anthropicdist_savanna, dec_pred_anthropicdist_savanna, inc_pred_anthropicdist_forest,
       dec_pred_anthropicdist_forest,inc_pred_anthropicdist_grass, dec_pred_anthropicdist_grass, 
       plot_inc_savanna_anthropicdist, plot_dec_savanna_anthropicdist, plot_inc_forest_anthropicdist, 
       plot_dec_forest_anthropicdist, plot_inc_grass_anthropicdist, plot_dec_grass_anthropicdist)     
```

#Step 5a (v) Trend in burnedarea and mean veg formation
```{r}
grid_creation_prediction <- function (df_analyses, xaxis_variable_in_quotes, 
                                              line_variable_in_quotes, 
                                              gam_model){
  df_select <- df_analyses %>% dplyr::select(-c(notrend))
  
  var_x <- subset( df_select, select = xaxis_variable_in_quotes)
  var_line <- subset( df_select, select = line_variable_in_quotes)
  var_line <- as.vector(var_line) %>% unlist()
  
  xaxis_range <- seq(min(var_x),max(var_x),len = xaxis_range_len)
  line_range <- c((mean(var_line) - sd(var_line)),mean(var_line), (mean(var_line) + sd(var_line))) #changed middle scenario to be mean of veg formation area
  
  df_means<- df_select %>% dplyr::select(-c(x,y,xaxis_variable_in_quotes, line_variable_in_quotes)) %>%
    summarise(across(where(is.numeric), ~mean(.x, na.rm= T)))
  
  newd <- data.frame(expand.grid(xaxis_range, line_range))
  names(newd) <- c(xaxis_variable_in_quotes, line_variable_in_quotes)
  newd <- newd %>% bind_cols(df_means) %>% mutate(x= x1, y=y1)
  pred <- mgcv::predict.bam(gam_model, newdata = newd, type="terms") 
  pred <- as.data.frame(pred)
  pred
}

inc_pred_trend_burnedarea_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_burnedarea", "mean_savanna_percentage", 
                                                         inc_gam)
dec_pred_trend_burnedarea_savanna  <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_burnedarea", "mean_savanna_percentage", 
                                                         dec_gam)
inc_pred_trend_burnedarea_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_burnedarea", "mean_forest_percentage", 
                                                         inc_gam)
dec_pred_trend_burnedarea_forest  <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_burnedarea", "mean_forest_percentage", 
                                                         dec_gam)
inc_pred_trend_burnedarea_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_burnedarea", "mean_grass_percentage", 
                                                         inc_gam)
dec_pred_trend_burnedarea_grass  <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_burnedarea", "mean_grass_percentage", 
                                                         dec_gam)

plot_inc_savanna_trend_burnedarea <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                        "trend_burnedarea", 
                                                        inc_pred_trend_burnedarea_savanna , 
                                                        c(7, 13, 22),
                                                        "low", "medium", "high")
plot_dec_savanna_trend_burnedarea <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                        "trend_burnedarea", 
                                                        dec_pred_trend_burnedarea_savanna,
                                                        c(7, 13, 22),
                                                        "low", "medium", "high")
plot_inc_forest_trend_burnedarea <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                       "trend_burnedarea", inc_pred_trend_burnedarea_forest,
                                                       c(7, 15, 24),
                                                       "low", "medium", "high")
plot_dec_forest_trend_burnedarea <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                       "trend_burnedarea", 
                                                       dec_pred_trend_burnedarea_forest , 
                                                      c(7, 15, 24),
                                                       "low", "medium", "high")
plot_inc_grass_trend_burnedarea <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                      "trend_burnedarea", 
                                                      inc_pred_trend_burnedarea_grass, 
                                                     c(7, 14, 23),
                                                      "low", "medium", "high")
plot_dec_grass_trend_burnedarea <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                      "trend_burnedarea", 
                                                      dec_pred_trend_burnedarea_grass, 
                                                      c(7, 14, 23),
                                                      "low", "medium", "high")

savanna_plot_df <- combined_plot_df_prep(plot_inc_savanna_trend_burnedarea , plot_dec_savanna_trend_burnedarea , "Savanna")
grass_plot_df <- combined_plot_df_prep(plot_inc_grass_trend_burnedarea , plot_dec_grass_trend_burnedarea, "Grass")
forest_plot_df <- combined_plot_df_prep(plot_inc_forest_trend_burnedarea  , plot_dec_forest_trend_burnedarea , "Forest")

trend_burnedarea_vegformation_plot_df <- bind_rows(savanna_plot_df, grass_plot_df, forest_plot_df)

trend_burnedarea_vegformation_vegformation <- plot_function(trend_burnedarea_vegformation_plot_df , "trend_burnedarea")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "TwoWay_InteractionResults", "trend_burnedarea_meanvegformation2.png"), trend_burnedarea_vegformation_vegformation,
        dpi = 700, height = 25, width=25, units = "cm")

remove(savanna_plot_df, grass_plot_df, forest_plot_df, 
       inc_pred_trend_burnedarea_savanna, dec_pred_trend_burnedarea_savanna, inc_pred_trend_burnedarea_forest, dec_pred_trend_burnedarea_forest,inc_pred_trend_burnedarea_grass,dec_pred_trend_burnedarea_grass, plot_inc_savanna_trend_burnedarea, plot_dec_savanna_trend_burnedarea, plot_inc_forest_trend_burnedarea, plot_dec_forest_trend_burnedarea, plot_inc_grass_trend_burnedarea, plot_dec_grass_trend_burnedarea) 
```

#Step 5b - Functions to visualize 3 way interactions
```{r}
# location
x1 <- -43.2781
y1 <- -4.0213
xaxis_range_len <- 200


inc_gam <- read_rds(here("Scripts", "Final_Scripts", "analyses", "onemodel_inc.rds"))
dec_gam <- read_rds(here("Scripts", "Final_Scripts", "analyses" ,"onemodel_dec.rds"))


grid_creation_prediction <- function (df_analyses, xaxis_variable_in_quotes, 
                                      line_variable_in_quotes, 
                                      panel_variable_in_quotes,
                                      gam_model){
  df_select <- df_analyses %>% dplyr::select(-c(notrend))
  
  var_x <- subset( df_select, select = xaxis_variable_in_quotes)
  var_line <- subset( df_select, select = line_variable_in_quotes)
  var_line <- as.vector(var_line) %>% unlist()
  
  xaxis_range <- seq(min(var_x),max(var_x),len = xaxis_range_len)
  line_range <- c((mean(var_line) - sd(var_line)), 0, (mean(var_line) + sd(var_line))) #0 trend indicating no change
  
  panel_decreasing <- mean(df_select[[panel_variable_in_quotes]]) +sd(df_select[[panel_variable_in_quotes]])
  panel_nochange <- mean(df_select[[panel_variable_in_quotes]]) #average in the middle panel of veg formation
  panel_increasing <- mean(df_select[[panel_variable_in_quotes]]) - sd(df_select[[panel_variable_in_quotes]])
  
  df_means<- df_select %>% dplyr::select(-c(x,y,xaxis_variable_in_quotes, line_variable_in_quotes, panel_variable_in_quotes)) %>%
    summarise(across(where(is.numeric), ~mean(.x, na.rm= T)))
  
  df_panel_dec <- data.frame(expand.grid(xaxis_range, line_range))
  names(df_panel_dec) <- c(xaxis_variable_in_quotes, line_variable_in_quotes)
  df_panel_dec <- df_panel_dec %>% bind_cols(df_means) %>% mutate(x= x1, y=y1, panel_variable_in_quotes = panel_decreasing)
  names(df_panel_dec)[dim(df_panel_dec)[2]]<- panel_variable_in_quotes
  
  df_panel_nochange <- data.frame(expand.grid(xaxis_range, line_range))
  names(df_panel_nochange) <- c(xaxis_variable_in_quotes, line_variable_in_quotes)
  df_panel_nochange <- df_panel_nochange %>% bind_cols(df_means) %>% mutate(x= x1, y=y1, panel_variable_in_quotes = panel_nochange)
  names(df_panel_nochange)[dim(df_panel_nochange)[2]]<- panel_variable_in_quotes
  
  df_panel_inc <- data.frame(expand.grid(xaxis_range, line_range))
  names(df_panel_inc) <- c(xaxis_variable_in_quotes, line_variable_in_quotes)
  df_panel_inc <- df_panel_inc %>% bind_cols(df_means) %>% mutate(x= x1, y=y1, panel_variable_in_quotes = panel_increasing)
  names(df_panel_inc)[dim(df_panel_inc)[2]]<- panel_variable_in_quotes

  pred_dec <- mgcv::predict.bam(gam_model, newdata = df_panel_dec, type="terms")
  pred_dec <- as.data.frame(pred_dec)
  pred_nochange <- mgcv::predict.bam(gam_model, newdata = df_panel_nochange, type="terms")
  pred_nochange <- as.data.frame(pred_nochange)
  pred_inc <- mgcv::predict.bam(gam_model, newdata = df_panel_inc, type="terms")
  pred_inc <- as.data.frame(pred_inc)
  
  pred_list <- list(pred_dec, pred_nochange, pred_inc)
  pred_list
}


select_effects_function <- function (df_analyses, xaxis_variable_in_quotes, 
                                     prediction_inc_df, prediction_nochange_df, prediction_dec_df, 
                                     effects_cols_indices,
                     paneldec_line_lower_plotting_in_quotes_name,
                     paneldec_line_middle_plotting_in_quotes_name, 
                     paneldec_line_higher_plotting_in_quotes_name,
                     panelnochange_line_lower_plotting_in_quotes_name,
                     panelnochange_line_middle_plotting_in_quotes_name, 
                     panelnochange_line_higher_plotting_in_quotes_name,
                     panelinc_line_lower_plotting_in_quotes_name,
                     panelinc_line_middle_plotting_in_quotes_name, 
                     panelinc_line_higher_plotting_in_quotes_name){
  
  df_select <- df_analyses %>% dplyr::select(-c(notrend))
  
  var_x <- subset( df_select, select = xaxis_variable_in_quotes)
  xaxis_range <- seq(min(var_x),max(var_x),len = xaxis_range_len)
  
  ind <- 1:xaxis_range_len
  ind2 <- (xaxis_range_len + 1):(xaxis_range_len*2)
  ind3 <- ((xaxis_range_len*2)+1):(xaxis_range_len*3)
  
  xy_interaction_effects <- grep("x,y",names(prediction_inc_df),fixed = T)
  inc_pred_without_xy_interaction_effects <- (subset(prediction_inc_df, select = -xy_interaction_effects))
  nochange_pred_without_xy_interaction_effects <- (subset(prediction_nochange_df, select = -xy_interaction_effects))
  dec_pred_without_xy_interaction_effects <- (subset(prediction_dec_df, select = -xy_interaction_effects))
  
  x1Eff <- rowSums(dec_pred_without_xy_interaction_effects [ind, effects_cols_indices] )
  x2Eff <- rowSums(dec_pred_without_xy_interaction_effects [ind2, effects_cols_indices] )
  x3Eff <- rowSums(dec_pred_without_xy_interaction_effects [ind3, effects_cols_indices] )
  
  x4Eff <- rowSums(nochange_pred_without_xy_interaction_effects [ind, effects_cols_indices] )
  x5Eff <- rowSums(nochange_pred_without_xy_interaction_effects [ind2, effects_cols_indices] )
  x6Eff <- rowSums(nochange_pred_without_xy_interaction_effects [ind3, effects_cols_indices] )
  
  x7Eff <- rowSums(inc_pred_without_xy_interaction_effects [ind, effects_cols_indices] )
  x8Eff <- rowSums(inc_pred_without_xy_interaction_effects [ind2, effects_cols_indices] )
  x9Eff <- rowSums(inc_pred_without_xy_interaction_effects [ind3, effects_cols_indices] )
  
  plot_df <- data.frame(xaxis_colname = xaxis_range)
  plot_df <- plot_df %>% mutate(x1Eff_colname = x1Eff,
                              x2Eff_colname = x2Eff,
                              x3Eff_colname = x3Eff,
                              x4Eff_colname = x4Eff,
                              x5Eff_colname = x5Eff,
                              x6Eff_colname = x6Eff,
                              x7Eff_colname = x7Eff,
                              x8Eff_colname = x8Eff,
                              x9Eff_colname = x9Eff)
  
  names(plot_df)<- c(xaxis_variable_in_quotes,
                     paneldec_line_lower_plotting_in_quotes_name,
                     paneldec_line_middle_plotting_in_quotes_name, 
                     paneldec_line_higher_plotting_in_quotes_name,
                     panelnochange_line_lower_plotting_in_quotes_name,
                     panelnochange_line_middle_plotting_in_quotes_name, 
                     panelnochange_line_higher_plotting_in_quotes_name,
                     panelinc_line_lower_plotting_in_quotes_name,
                     panelinc_line_middle_plotting_in_quotes_name, 
                     panelinc_line_higher_plotting_in_quotes_name)
  pivot_plot_df <- plot_df %>% pivot_longer(-1)
  pivot_plot_df <- pivot_plot_df %>% separate(name, into =c("panel_var_type", "lines_var_type"), sep = "_" )
  pivot_plot_df
}

combined_plot_df_prep <- function (inc_df, dec_df){
  inc_df <- inc_df %>% mutate(TrajType = "Step_Inc")
  dec_df <- dec_df %>% mutate(TrajType = "Step_Dec")
  plot_df <- bind_rows (inc_df, dec_df)
  plot_df
}


```

#Step 5b (i) - Trends in annual temp, RE across veg formations
```{r}
inc_pred_savanna_trend_at_re <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_annualtemp", "trend_re", "mean_savanna_percentage",
                                                         inc_gam)
dec_pred_savanna_trend_at_re <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_annualtemp", "trend_re", "mean_savanna_percentage",
                                                         dec_gam)
inc_pred_forest_trend_at_re<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_annualtemp", "trend_re", "mean_forest_percentage",
                                                         inc_gam)
dec_pred_forest_trend_at_re <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_annualtemp", "trend_re", "mean_forest_percentage", 
                                                         dec_gam)
inc_pred_grass_trend_at_re<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_annualtemp", "trend_re", "mean_grass_percentage",  
                                                         inc_gam)
dec_pred_grass_trend_at_re <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_annualtemp", "trend_re", "mean_grass_percentage", 
                                                         dec_gam)


plot_inc_savanna_trend_at_re <- select_effects_function(analyses_df_noNA_nooutliers, "trend_annualtemp", 
                                 inc_pred_savanna_trend_at_re[[3]], inc_pred_savanna_trend_at_re[[2]], inc_pred_savanna_trend_at_re[[1]],
                                 c(3, 4, 13, 16, 26),
                                "low_more.uniform.rainfall", "low_no.trend.rainfall.seasonality", "low_more.seasonal.rainfall",
                                "average_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "average_more.seasonal.rainfall",
                                "high_more.uniform.rainfall", "high_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall")
plot_dec_savanna_trend_at_re <- select_effects_function(analyses_df_noNA_nooutliers, "trend_annualtemp", 
                                 dec_pred_savanna_trend_at_re[[3]],dec_pred_savanna_trend_at_re[[2]], dec_pred_savanna_trend_at_re[[1]],
                                 c(3, 4, 13, 16, 26),
                                 "low_more.uniform.rainfall", "low_no.trend.rainfall.seasonality", "low_more.seasonal.rainfall",
                                "average_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "average_more.seasonal.rainfall",
                                "high_more.uniform.rainfall", "high_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall")
plot_inc_forest_trend_at_re <- select_effects_function(analyses_df_noNA_nooutliers, "trend_annualtemp", 
                                 inc_pred_forest_trend_at_re[[3]], inc_pred_forest_trend_at_re[[2]], inc_pred_forest_trend_at_re[[1]],
                                 c(3, 4, 15, 16, 30),
                                 "low_more.uniform.rainfall", "low_no.trend.rainfall.seasonality", "low_more.seasonal.rainfall",
                                "average_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "average_more.seasonal.rainfall",
                                "high_more.uniform.rainfall", "high_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall")
plot_dec_forest_trend_at_re <- select_effects_function(analyses_df_noNA_nooutliers, "trend_annualtemp", 
                                 dec_pred_forest_trend_at_re[[3]], dec_pred_forest_trend_at_re[[2]], dec_pred_forest_trend_at_re[[1]],
                                 c(3, 4, 15, 16, 30),
                                 "low_more.uniform.rainfall", "low_no.trend.rainfall.seasonality", "low_more.seasonal.rainfall",
                                "average_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "average_more.seasonal.rainfall",
                                "high_more.uniform.rainfall", "high_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall")
plot_inc_grass_trend_at_re <- select_effects_function(analyses_df_noNA_nooutliers, "trend_annualtemp", 
                                 inc_pred_grass_trend_at_re[[3]], inc_pred_grass_trend_at_re[[2]], inc_pred_grass_trend_at_re[[1]],
                                 c(3, 4, 14, 16, 28),
                                 "low_more.uniform.rainfall", "low_no.trend.rainfall.seasonality", "low_more.seasonal.rainfall",
                                "average_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "average_more.seasonal.rainfall",
                                "high_more.uniform.rainfall", "high_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall")
plot_dec_grass_trend_at_re <- select_effects_function(analyses_df_noNA_nooutliers, "trend_annualtemp", 
                                 dec_pred_grass_trend_at_re[[3]], dec_pred_grass_trend_at_re[[2]], dec_pred_grass_trend_at_re[[1]],
                                 c(3, 4, 14, 16, 28),
                                 "low_more.uniform.rainfall", "low_no.trend.rainfall.seasonality", "low_more.seasonal.rainfall",
                                "average_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "average_more.seasonal.rainfall",
                                "high_more.uniform.rainfall", "high_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall")

savanna_plot_df <- combined_plot_df_prep(plot_inc_savanna_trend_at_re , plot_dec_savanna_trend_at_re)
grass_plot_df <- combined_plot_df_prep(plot_inc_forest_trend_at_re, plot_dec_forest_trend_at_re)
forest_plot_df <- combined_plot_df_prep(plot_inc_grass_trend_at_re, plot_dec_grass_trend_at_re)

plot_function <- function (savanna_plot, forest_plot, grass_plot, xaxis_var){
  plot_savanna <- ggplot(savanna_plot, aes(x = .data[[xaxis_var]], y = value,
                                          color = lines_var_type, linetype = TrajType,
                                          group = interaction(lines_var_type, TrajType))) +
    geom_line(aes(color = lines_var_type), linewidth = 1) + facet_wrap(~factor(panel_var_type, c("low", "average", "high")))+
    theme_classic() +
    scale_color_manual(values=c("#E69F00", "#56B4E9", "#333333")) + 
    ylab ("Partial Effect") + theme(legend.title=element_blank())
  
  plot_forest <- ggplot(forest_plot, aes(x = .data[[xaxis_var]], y = value,
                                          color = lines_var_type, linetype = TrajType,
                                          group = interaction(lines_var_type, TrajType))) +
    geom_line(aes(color = lines_var_type), linewidth = 1) + facet_wrap(~factor(panel_var_type, c("low", "average", "high")))+
    theme_classic() +
    scale_color_manual(values=c("#E69F00", "#56B4E9", "#333333")) + 
    ylab ("Partial Effect") + theme(legend.title=element_blank()) 
  
    plot_grass <- ggplot(grass_plot, aes(x = .data[[xaxis_var]], y = value,
                                          color = lines_var_type, linetype = TrajType,
                                          group = interaction(lines_var_type, TrajType))) +
    geom_line(aes(color = lines_var_type), linewidth = 1) + facet_wrap(~factor(panel_var_type, c("low", "average", "high")))+
    theme_classic() +
    scale_color_manual(values=c("#E69F00", "#56B4E9", "#333333")) + 
    ylab ("Partial Effect") + theme(legend.title=element_blank())
  
    x <- ggpubr::ggarrange(plot_forest, plot_grass, plot_savanna, nrow = 3, ncol = 1, 
                           labels = c("Forest", "Grass", "Savanna"))
  
  x
}


annualtemp_re_vegformation <- plot_function(savanna_plot_df, forest_plot_df, grass_plot_df , "trend_annualtemp")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "ThreeWay_InteractionResults", "trend_annualtemp_re_vegformation.png"), annualtemp_re_vegformation,
        dpi = 700, height = 25, width=25, units = "cm")

remove(savanna_plot_df, grass_plot_df, forest_plot_df,
       plot_dec_grass_trend_at_re, plot_inc_grass_trend_at_re, plot_dec_forest_trend_at_re, plot_inc_forest_trend_at_re, plot_dec_savanna_trend_at_re, plot_inc_savanna_trend_at_re,
       dec_pred_grass_trend_at_re, inc_pred_grass_trend_at_re, dec_pred_forest_trend_at_re, inc_pred_forest_trend_at_re, dec_pred_savanna_trend_at_re, inc_pred_savanna_trend_at_re)

```

#Step 5b (ii) - Trends in heatwaves, SPEI across veg formations

```{r}
inc_pred_savanna_trend_heatwave_spei <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_heatwave", "trend_spei", "mean_savanna_percentage",
                                                         inc_gam)
dec_pred_savanna_trend_heatwave_spei <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_heatwave", "trend_spei", "mean_savanna_percentage",
                                                         dec_gam)
inc_pred_forest_trend_heatwave_spei <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_heatwave", "trend_spei", "mean_forest_percentage",
                                                         inc_gam)
dec_pred_forest_trend_heatwave_spei <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_heatwave", "trend_spei", "mean_forest_percentage", 
                                                         dec_gam)
inc_pred_grass_trend_heatwave_spei <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_heatwave", "trend_spei", "mean_grass_percentage",  
                                                         inc_gam)
dec_pred_grass_trend_heatwave_spei <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_heatwave", "trend_spei", "mean_grass_percentage", 
                                                         dec_gam)

plot_inc_savanna_trend_heatwave_spei <- select_effects_function(analyses_df_noNA_nooutliers, "trend_heatwave", 
                                 inc_pred_savanna_trend_heatwave_spei[[3]], inc_pred_savanna_trend_heatwave_spei[[2]], inc_pred_savanna_trend_heatwave_spei[[1]],
                                 c(5, 6, 13, 17, 25),
                                "low_dec.droughts", "low_no.trend.droughts", "low_inc.droughts",
                                "average_dec.droughts", "average_no.trend.droughts", "average_inc.droughts",
                                "high_dec.droughts", "high_no.trend.droughts", "high_inc.droughts")
plot_dec_savanna_trend_heatwave_spei <- select_effects_function(analyses_df_noNA_nooutliers, "trend_heatwave", 
                                 dec_pred_savanna_trend_heatwave_spei[[3]], dec_pred_savanna_trend_heatwave_spei[[2]], dec_pred_savanna_trend_heatwave_spei[[1]],
                                 c(5, 6, 13, 17, 25),
                               "low_dec.droughts", "low_no.trend.droughts", "low_inc.droughts",
                                "average_dec.droughts", "average_no.trend.droughts", "average_inc.droughts",
                                "high_dec.droughts", "high_no.trend.droughts", "high_inc.droughts")
plot_inc_forest_trend_heatwave_spei <- select_effects_function(analyses_df_noNA_nooutliers, "trend_heatwave", 
                                 inc_pred_forest_trend_heatwave_spei[[3]], inc_pred_forest_trend_heatwave_spei[[2]], inc_pred_forest_trend_heatwave_spei[[1]],
                                 c(5, 6, 15, 17, 29),
                              "low_dec.droughts", "low_no.trend.droughts", "low_inc.droughts",
                                "average_dec.droughts", "average_no.trend.droughts", "average_inc.droughts",
                                "high_dec.droughts", "high_no.trend.droughts", "high_inc.droughts")
plot_dec_forest_trend_heatwave_spei <- select_effects_function(analyses_df_noNA_nooutliers, "trend_heatwave", 
                                 dec_pred_forest_trend_heatwave_spei[[3]], dec_pred_forest_trend_heatwave_spei[[2]], dec_pred_forest_trend_heatwave_spei[[1]],
                                 c(5, 6, 15, 17, 29),
                                  "low_dec.droughts", "low_no.trend.droughts", "low_inc.droughts",
                                "average_dec.droughts", "average_no.trend.droughts", "average_inc.droughts",
                                "high_dec.droughts", "high_no.trend.droughts", "high_inc.droughts")
plot_inc_grass_trend_heatwave_spei <- select_effects_function(analyses_df_noNA_nooutliers, "trend_heatwave", 
                                 inc_pred_grass_trend_heatwave_spei[[3]], inc_pred_grass_trend_heatwave_spei[[2]], inc_pred_grass_trend_heatwave_spei[[1]],
                                 c(5, 6, 14, 17, 27),
                                  "low_dec.droughts", "low_no.trend.droughts", "low_inc.droughts",
                                "average_dec.droughts", "average_no.trend.droughts", "average_inc.droughts",
                                "high_dec.droughts", "high_no.trend.droughts", "high_inc.droughts")
plot_dec_grass_trend_heatwave_spei <- select_effects_function(analyses_df_noNA_nooutliers, "trend_heatwave", 
                                 dec_pred_grass_trend_heatwave_spei[[3]], dec_pred_grass_trend_heatwave_spei[[2]], dec_pred_grass_trend_heatwave_spei[[1]],
                                 c(5, 6, 14, 17, 27),
                                 "low_dec.droughts", "low_no.trend.droughts", "low_inc.droughts",
                                "average_dec.droughts", "average_no.trend.droughts", "average_inc.droughts",
                                "high_dec.droughts", "high_no.trend.droughts", "high_inc.droughts")


savanna_plot_df <- combined_plot_df_prep(plot_inc_savanna_trend_heatwave_spei , plot_dec_savanna_trend_heatwave_spei)
grass_plot_df <- combined_plot_df_prep(plot_inc_forest_trend_heatwave_spei, plot_dec_forest_trend_heatwave_spei)
forest_plot_df <- combined_plot_df_prep(plot_inc_grass_trend_heatwave_spei, plot_dec_grass_trend_heatwave_spei)


heatwave_spei_vegformation <- plot_function(savanna_plot_df, forest_plot_df, grass_plot_df , "trend_heatwave")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "ThreeWay_InteractionResults", "trend_heatwave_spei_vegformation.png"), heatwave_spei_vegformation,
        dpi = 700, height = 25, width=25, units = "cm")

remove(savanna_plot_df, grass_plot_df, forest_plot_df,
       plot_dec_grass_trend_heatwave_spei, plot_inc_grass_trend_heatwave_spei, plot_dec_forest_trend_heatwave_spei, plot_inc_forest_trend_heatwave_spei, plot_dec_savanna_trend_heatwave_spei, plot_inc_savanna_trend_heatwave_spei,
       dec_pred_grass_trend_heatwave_spei, inc_pred_grass_trend_heatwave_spei, dec_pred_forest_trend_heatwave_spei, inc_pred_forest_trend_heatwave_spei, dec_pred_savanna_trend_heatwave_spei, inc_pred_savanna_trend_heatwave_spei)
```

#Step 5b (iii) - Trends in burned area, annual temp and re  ### DO NOT RUN 

#Step 5c - Visualization of univariate relationships
```{r}
increase_model_extractsmooths <- function (gam_model, outputsmooth_file_name_in_quotes){
  significant_onevariable_smooths <- gratia::smooth_estimates(gam_model,
                                                select = c("s(anthropic_dist)", "s(trend_re)",
                                                           "s(trend_annualtemp)",  "s(trend_heatwave)", 
                                                           "s(trend_spei)", "s(trend_burnedarea)",
                                                           "s(mean_re)", "s(mean_at)", "s(mean_spei)", 
                                                           "s(mean_burnedarea)", "s(mean_savanna_percentage)",
                                                           "s(mean_grass_percentage)", "s(mean_forest_percentage)"),
                                                n=100, unconditional = TRUE) %>%
  mutate(ci_low= .estimate - .se * 1.96,
         ci_high = .estimate + .se * 1.96)
  significant_onevariable_smooths 
}
increase_significant_onevariablesmooths <- increase_model_extractsmooths(inc_gam)
increase_significant_onevariablesmooths <- increase_significant_onevariablesmooths %>% mutate(TrajType ="Increase")

decrease_model_extractsmooths <- function (gam_model, outputsmooth_file_name_in_quotes){
  significant_onevariable_smooths <- gratia::smooth_estimates(gam_model,
                                                select = c("s(anthropic_dist)", "s(trend_re)",
                                                           "s(trend_annualtemp)", "s(trend_spei)", "s(trend_burnedarea)",
                                                           "s(mean_re)", "s(mean_at)", "s(mean_heatwave)",
                                                           "s(mean_spei)", "s(mean_burnedarea)",
                                                           "s(mean_grass_percentage)", "s(mean_forest_percentage)"),
                                                n=100, unconditional = TRUE) %>%
  mutate(ci_low= .estimate - .se * 1.96,
         ci_high = .estimate + .se * 1.96)
  significant_onevariable_smooths
}
decrease_significant_onevariablesmooths <- decrease_model_extractsmooths(dec_gam)
decrease_significant_onevariablesmooths <- decrease_significant_onevariablesmooths %>% mutate(TrajType ="Decrease")


bothmodels_all_commonvar_labels <- read_csv(here("Outputs", "AnalysesResults", "GAMResults", "both_model_common_var_labels.csv"))
bothmodels_all_commonvar_list <- bothmodels_all_commonvar_labels$vars
bothmodels_all_commonvar_plots <- list(length = length(bothmodels_all_commonvar_list))

commonvar_plots <- purrr::map(bothmodels_all_commonvar_list, function(var){
  
   x_label <- bothmodels_all_commonvar_labels$label[bothmodels_all_commonvar_labels$vars == var]
    if (bothmodels_all_commonvar_labels$parse[bothmodels_all_commonvar_labels$vars == var]) {
      x_label <- parse(text = x_label)
    }
  
  data_df <- analyses_df_noNA_nooutliers %>%
      dplyr::select(all_of(var)) %>%
      dplyr::rename(z = 1)
  density <- ggplot(data_df, aes(x = z)) +
      geom_density(colour = "grey70", fill = "grey90", alpha = 0.6) +
      theme_void()
  
  increase_smooth_df <- increase_significant_onevariablesmooths  %>%
      dplyr::select(.smooth, .type, .estimate, .se, ci_low, ci_high, all_of(var), TrajType) %>%
      rename(var0 = 7) %>%
      drop_na()
  decrease_smooth_df <- decrease_significant_onevariablesmooths  %>%
      dplyr::select(.smooth, .type, .estimate, .se, ci_low, ci_high, all_of(var), TrajType) %>%
      rename(var0 = 7) %>%
      drop_na()
  smooth_df <- bind_rows(increase_smooth_df, decrease_smooth_df)  
  
  plot <- ggplot(smooth_df, aes(x = var0, y = .estimate, group = TrajType, colour = TrajType, fill = TrajType)) +
    geom_ribbon(aes(ymin = ci_low, ymax = ci_high), alpha = 0.7) + 
    geom_line(alpha = 0.8, lwd = 0.6) + 
  scale_fill_manual(values = c("#6699cc", "#8dbfa8"), name ="Trajectory Type") + 
  scale_color_manual(values = c("#3399ff", "#26897E")) +
  scale_x_continuous( labels = label_number()) +
  labs(x = x_label,
         y = "Partial effect") +
    theme_classic() + theme(legend.position="none")
  
  density + plot +
    patchwork::plot_layout(ncol = 1, nrow = 2, widths = 4, heights = c(1, 4))
})

#additional plots of variables significant only in one model
additional_plots <- function (var, model_smooth_df, x_label, fill_color, line_color){
  data_df <- analyses_df_noNA_nooutliers %>%
      dplyr::select(var) %>%
      dplyr::rename(z = 1)
  density <- ggplot(data_df, aes(x = z)) +
      geom_density(colour = "grey70", fill = "grey90", alpha = 0.6) +
      theme_void()
  
  smooth_df <- model_smooth_df  %>%
      dplyr::select(.smooth, .type, .estimate, .se, ci_low, ci_high, var, TrajType) %>%
      rename(var0 = 7) %>%
      drop_na()
  
  plot <- ggplot(smooth_df, aes(x = var0, y = .estimate, group = TrajType, colour = TrajType, fill = TrajType)) +
    geom_ribbon(aes(ymin = ci_low, ymax = ci_high), alpha = 0.7) + 
    geom_line(alpha = 0.8, lwd = 0.6) + 
  scale_fill_manual(values = fill_color, name ="Trajectory Type") + 
  scale_color_manual(values = line_color) +
  scale_x_continuous( labels = label_number()) +
  labs(x = x_label,
         y = "Partial effect") +
    theme_classic() + theme(legend.position="none")
  
  x <- density + plot +
    patchwork::plot_layout(ncol = 1, nrow = 2, widths = 4, heights = c(1, 4))
  x
}

mean_savanna_increase <- additional_plots("mean_savanna_percentage", increase_significant_onevariablesmooths, "mean savanna formation proportion (%)", "#8dbfa8","#26897E")
trend_heatwave_increase <- additional_plots("trend_heatwave", increase_significant_onevariablesmooths, "trend in heatwaves", "#8dbfa8","#26897E")
mean_heatwave_decrease <- additional_plots("mean_heatwave", decrease_significant_onevariablesmooths, "mean number of heatwaves", "#6699cc","#3399ff")

gam_plot1 <- ggpubr::ggarrange(plotlist = commonvar_plots[c(1,6:11)], labels=c("a)", "b)", "c)", "d)", "e)", "f)", "g)"),
                      ncol = 3, nrow = 3, common.legend = TRUE)
gam_plot2 <- ggpubr::ggarrange(plotlist = commonvar_plots[c(2:5)], trend_heatwave_increase, mean_savanna_increase, mean_heatwave_decrease, 
                               labels=c("a)", "b)", "c)", "d)", "e)", "f)", "g)"),
                      ncol = 3, nrow = 3, common.legend = TRUE)
ggsave(here("Outputs", "AnalysesResults", "GAMResults", "oneway_variablepartialeffects_means.png"),
       gam_plot1,dpi = 700, height = 40, width=40, units = "cm")
ggsave(here("Outputs", "AnalysesResults", "GAMResults", "oneway_variablepartialeffects_trends_others.png"),
       gam_plot2,dpi = 700, height = 40, width=40, units = "cm")

```
