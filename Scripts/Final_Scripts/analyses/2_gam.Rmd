```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, include=FALSE}
library(RColorBrewer)
library(terra)
library(tidyverse)
library(tidyr)
library(here)
library(ggplot2)
library(mgcv)
library(mgcViz)
library(rgl)
library(gratia)
library(gtools)
library(scales)
library(patchwork)
library(purrr)
library(dplyr)
library(ggpubr)

```

##Introduction
In this script, I do GAMs to understand the relationship between different trajectories (from NDVI stl swindow = 11 primarily) and 
various predictor variables. 
(1) Data input of NDVI derived %area of pixel of aggregate trajectories and predictors at 5km
(2) Data processing and structuring for analyses
(3) Exploratory data plots
(4) GAM modeling
(5) Plotting of GAM results

#Step 1- data input
```{r}
#response- binary trajectory (aggregated trajectory types) from NDVI monthly swin 11 stl setting
ndvi_agg_count <- rast (here("Outputs", "TrendsResults", "aggregate_trajectory_results", "monthly_ndvi_agg_count_5km.tif"))

#static drivers
anthropic_dist<- rast(here("Outputs", "OtherVariables", "AnthropicDist", "5km_meandist_20thresholdsanthropicpixel.tif"))
hand<- rast(here("Outputs", "OtherVariables","HAND", "cerrado_hand_5km.tif"))

#trend variables
trend_burnedarea<- rast(here("Outputs", "OtherVariables", "Fire", "theilsen_burnedarea_5km.tif"))
trend_re<- rast(here("Outputs", "OtherVariables", "Climate", "theilsen_re.tif"))
trend_at<- rast(here("Outputs", "OtherVariables", "Climate", "theilsen_at_5km.tif"))
trend_spei<-rast(here("Outputs", "OtherVariables", "Climate", "theilsen_spei.tif"))
trend_heatwave<- rast(here("Outputs", "OtherVariables", "Climate", "theilsen_heatwaves.tif"))

#mean variables
mean_burnedarea<- rast(here("Outputs", "OtherVariables", "Fire", "mean_burnedarea_5km_2002_2021.tif"))
mean_re <- rast(here("Outputs", "OtherVariables", "Climate","mean_annual_relative_entropy_1981_2021.tif") )
mean_at <- rast(here("Outputs", "OtherVariables", "Climate", "mat_1981_2021_5km.tif"))
mean_spei <- rast( here("Outputs", "OtherVariables", "Climate", "mean_annualspei.tif")) 
mean_heatwave <- rast(here("Outputs", "OtherVariables", "Climate", "mean_annual_heatwaves_2002_2021.tif"))

#mean %area of veg formation
mean_savannapercentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "mean_savanna_percentage_5km_2002_2021.tif"))
mean_grasspercentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "mean_grass_percentage_5km_2002_2021.tif"))
mean_forestpercentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "mean_forest_percentage_5km_2002_2021.tif"))

```

#Step 2- data structuring, applying anthropic threshold mask to predictors
```{r}
crop_mask_function <- function(raster_to_be_cropmask){
  x_mask <- terra::mask(raster_to_be_cropmask, ndvi_agg_count[[1]])
  x_mask
}

cm_anthropic_dist <- crop_mask_function(anthropic_dist)
cm_hand <- crop_mask_function(hand)

cm_trend_burnedarea <- crop_mask_function(trend_burnedarea)
cm_trend_re <- crop_mask_function(trend_re)
cm_trend_at <- crop_mask_function(trend_at)
cm_trend_spei <- crop_mask_function(trend_spei)
cm_trend_heatwave <- crop_mask_function(trend_heatwave)

cm_mean_burnedarea <- crop_mask_function(mean_burnedarea)
cm_mean_re <- crop_mask_function(mean_re)
cm_mean_at <- crop_mask_function(mean_at)
cm_mean_spei <- crop_mask_function(mean_spei)
cm_mean_heatwave <- crop_mask_function(mean_heatwave)

cm_mean_forest <- crop_mask_function(mean_forestpercentage)
cm_mean_grass <- crop_mask_function(mean_grasspercentage)
cm_mean_savanna <- crop_mask_function(mean_savannapercentage)

constantdrivers <- c(cm_anthropic_dist, cm_hand, 
                     cm_trend_burnedarea, cm_trend_re, cm_trend_at, cm_trend_spei, cm_trend_heatwave, 
                     cm_mean_burnedarea, cm_mean_re, cm_mean_at, cm_mean_spei, cm_mean_heatwave)

all_vars <- c(ndvi_agg_count, constantdrivers, cm_mean_savanna, cm_mean_grass, cm_mean_forest)
analyses_df <- terra::as.data.frame(all_vars, xy = TRUE)
names(analyses_df) <- c("x", "y", "decrease", 
                    "increase",
                    "notrend",
                    "anthropic_dist", 
                    "hand", 
                    "trend_burnedarea",
                    "trend_re", 
                    "trend_annualtemp", 
                    "trend_spei",
                    "trend_heatwave", 
                    "mean_burnedarea",
                    "mean_re",
                    "mean_at",
                    "mean_spei",
                    "mean_heatwave",
                    "mean_savanna_percentage",
                    "mean_grass_percentage",
                    "mean_forest_percentage")

remove(anthropic_dist, hand, trend_burnedarea, trend_re, trend_at, trend_spei, trend_heatwave,
             mean_burnedarea, mean_re, mean_at, mean_spei, mean_heatwave,
             mean_savannapercentage, mean_grasspercentage, mean_forestpercentage)
remove(cm_anthropic_dist, cm_hand, cm_trend_burnedarea, cm_trend_re, cm_trend_at, cm_trend_spei, cm_trend_heatwave,
             cm_mean_burnedarea, cm_mean_re, cm_mean_at, cm_mean_spei, cm_mean_heatwave,
             cm_mean_savanna, cm_mean_grass, cm_mean_forest)
remove(ndvi_agg_count)
remove(crop_mask_function)
```

#Step 3- eda - understanding the correlations and distributions of all the variables 
```{r}
summary(analyses_df) 

remove_NA <- function (df_analyses){
  analyses_df_noNA <- df_analyses %>% drop_na() 
  analyses_df_noNA
}
analyses_df_NA <- remove_NA(analyses_df)

remove_HAND_outliers <- function (df_analyses_NA){
  no_outliers_sample_df <- df_analyses_NA %>% 
          mutate (IQR = IQR(hand),
                  O_upper = quantile (hand, probs= c(0.75), na.rm= FALSE)+ 1.5*IQR,
                  O_lower = quantile(hand, probs= c(0.25), na.rm= FALSE) - 1.5*IQR
                  ) %>% 
          filter(O_lower <= hand & hand <= O_upper) %>%
          dplyr::select(-c(IQR, O_upper, O_lower))
  no_outliers_sample_df
}
analyses_df_noNA_nooutliers <- remove_HAND_outliers(analyses_df_NA)

plot_df_function <- function (df_noNA_nooutliers){
  pivot_df <- df_noNA_nooutliers %>% 
  dplyr::select(-c(x,y)) %>%
  pivot_longer(1:18)
  
distribution_plot <- ggplot(data = pivot_df, aes(value)) +
  geom_histogram() +facet_wrap(~name, scales = "free", labeller = label_wrap_gen(4)) +
  theme_classic(base_size = 16)
distribution_plot
}
analyses_df_plot <- plot_df_function (analyses_df_noNA_nooutliers)

remove(plot_df_function, remove_HAND_outliers, remove_NA)
write_rds(analyses_df_noNA_nooutliers, here("Scripts", "Final_Scripts", "analyses", "analyses_df_noNA_nooutliers.rds"))

```

#Step 4- one model for all variables seperated as step inc and dec
```{r}
Sys.time(); step_inc_model <- mgcv::bam( cbind(increase, 25- increase) ~ s(anthropic_dist, bs= "ts") +
                                          s(hand, bs= "ts") +
                                          s(trend_re, bs= "ts") +
                                          s(trend_annualtemp, bs= "ts") +
                                          s(trend_heatwave, bs ="ts") +
                                          s(trend_spei, bs= "ts") +
                                          s(trend_burnedarea, bs = "ts") +
                                        
                                          s(mean_re, bs= "ts") +
                                          s(mean_at, bs= "ts") +
                                          s(mean_heatwave,  bs= "ts") +
                                          s(mean_spei, bs= "ts") +
                                          s(mean_burnedarea, bs= "ts") +
                                          s(mean_savanna_percentage, bs= "ts") +
                                          s(mean_grass_percentage, bs= "ts") +
                                          s(mean_forest_percentage, bs= "ts")+
                                          
                                          s(x,y, bs= "ts") +
                                          ti(mean_at, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          ti(trend_annualtemp, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          
                                          ti(trend_annualtemp, trend_re, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(trend_heatwave, trend_spei, bs=c("ts", "ts"), k=c(5,5)) +
                                          
                                          ti(anthropic_dist, mean_savanna_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(anthropic_dist, mean_grass_percentage, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(anthropic_dist, mean_forest_percentage, bs=c("ts", "ts"), k=c(5,5)) +  
                                           
                                          ti(anthropic_dist, trend_burnedarea, bs=c("ts", "ts"), k=c(5,5)) +
                                          
                                          ti(trend_burnedarea, mean_savanna_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(trend_burnedarea, mean_grass_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(trend_burnedarea, mean_forest_percentage, bs=c("ts", "ts"), k=c(5,5)) +  
                                          
                                          ti(mean_savanna_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_savanna_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_grass_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_grass_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_forest_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_forest_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                           
                                          ti(trend_burnedarea, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(trend_burnedarea, trend_heatwave, trend_spei, bs=c("ts", "ts", "ts"), k=c(3,3,3)) ,
                                         
                                        data = analyses_df_noNA_nooutliers %>% dplyr::select(-c(decrease, notrend)), 
                                        method = "fREML", 
                                        family = quasibinomial(link = "logit")); Sys.time() 
write_rds(step_inc_model, here("Scripts", "Final_Scripts", "analyses", "onemodel_inc.rds"))

Sys.time(); step_dec_model <- mgcv::bam( cbind(decrease, 25- decrease) ~ s(anthropic_dist, bs= "ts") +
                                          s(hand, bs= "ts") +
                                          s(trend_re, bs= "ts") +
                                          s(trend_annualtemp, bs= "ts") +
                                          s(trend_heatwave, bs ="ts") +
                                          s(trend_spei, bs= "ts") +
                                          s(trend_burnedarea, bs = "ts") +
                                        
                                          s(mean_re, bs= "ts") +
                                          s(mean_at, bs= "ts") +
                                          s(mean_heatwave,  bs= "ts") +
                                          s(mean_spei, bs= "ts") +
                                          s(mean_burnedarea, bs= "ts") +
                                          s(mean_savanna_percentage, bs= "ts") +
                                          s(mean_grass_percentage, bs= "ts") +
                                          s(mean_forest_percentage, bs= "ts")+
                                          
                                          s(x,y, bs= "ts") +
                                          ti(mean_at, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          ti(trend_annualtemp, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          
                                          ti(trend_annualtemp, trend_re, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(trend_heatwave, trend_spei, bs=c("ts", "ts"), k=c(5,5)) +
                                          
                                          ti(anthropic_dist, mean_savanna_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(anthropic_dist, mean_grass_percentage, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(anthropic_dist, mean_forest_percentage, bs=c("ts", "ts"), k=c(5,5)) +  
                                           
                                          ti(anthropic_dist, trend_burnedarea, bs=c("ts", "ts"), k=c(5,5)) +
                                          
                                          ti(trend_burnedarea, mean_savanna_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(trend_burnedarea, mean_grass_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(trend_burnedarea, mean_forest_percentage, bs=c("ts", "ts"), k=c(5,5)) +  
                                          
                                          ti(mean_savanna_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_savanna_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_grass_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_grass_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_forest_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_forest_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                           
                                          ti(trend_burnedarea, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(trend_burnedarea, trend_heatwave, trend_spei, bs=c("ts", "ts", "ts"), k=c(3,3,3)),
                                         
                                        data = analyses_df_noNA_nooutliers %>% dplyr::select(-c(increase, notrend)), 
                                        method = "fREML", 
                                        family = quasibinomial(link = "logit")); Sys.time()
write_rds(step_dec_model, here("Scripts", "Final_Scripts", "analyses", "onemodel_dec.rds"))

step_inc_model$converged
step_dec_model$converged
step_inc_model$mgcv.conv$message
step_dec_model$mgcv.conv$message
step_inc_model$boundary
step_dec_model$boundary

appraise(step_dec_model)
appraise(step_inc_model)

summary(step_inc_model)
summary(step_dec_model)
```

#Step 5a (i) Mean anthropic distance and mean veg formation
```{r}
inc_gam <- read_rds(here("Scripts", "Final_Scripts", "analyses", "onemodel_inc.rds"))
dec_gam <- read_rds(here("Scripts", "Final_Scripts", "analyses" ,"onemodel_dec.rds"))


# location
x1 <- -43.2781
y1 <- -4.0213
xaxis_range_len <- 200

grid_creation_prediction <- function (df_analyses, 
                                      xaxis_variable_in_quotes, 
                                      line_variable_in_quotes, 
                                      gam_model,
                                      line_lower_plotting_in_quotes_name,
                                      line_middle_plotting_in_quotes_name,
                                      line_higher_plotting_in_quotes_name){
  #Creating new data and running model
  df_select <- df_analyses %>% dplyr::select(-c(notrend))
  
  var_x <- subset( df_select, select = xaxis_variable_in_quotes)
  var_line <- subset( df_select, select = line_variable_in_quotes)
  var_line <- as.vector(var_line) %>% unlist()
  
  xaxis_range <- seq(min(var_x),max(var_x),len = xaxis_range_len)
  line_range <- c((mean(var_line) - sd(var_line)),mean(var_line), (mean(var_line) + sd(var_line))) #changed middle scenario to be mean of veg formation area
  
  df_means<- df_select %>% dplyr::select(-c(x,y,xaxis_variable_in_quotes, line_variable_in_quotes)) %>%
    summarise(across(where(is.numeric), ~mean(.x, na.rm= T)))
  
  newd <- data.frame(expand.grid(xaxis_range, line_range))
  names(newd) <- c(xaxis_variable_in_quotes, line_variable_in_quotes)
  newd <- newd %>% bind_cols(df_means) %>% mutate(x= x1, y=y1)
  pred <- mgcv::predict.bam(gam_model, newdata = newd, type="terms") 
  pred <- as.data.frame(pred)
  
  #Selecting the coefficients
  ind <- 1:xaxis_range_len
  ind2 <- (xaxis_range_len + 1):(xaxis_range_len*2)
  ind3 <- ((xaxis_range_len*2)+1):(xaxis_range_len*3)
  
  xy_interaction_effects <- grep("x,y",names(pred),fixed = T)
  pred_without_xy_interaction_effects <- (subset(pred, select = -xy_interaction_effects))
  
  coef_index_trial1 <- grep(paste0("s(",xaxis_variable_in_quotes, ")"),names(pred_without_xy_interaction_effects),fixed = T )
  coef_index_trial2 <- grep(paste0("s(",line_variable_in_quotes, ")"),names(pred_without_xy_interaction_effects),fixed = T )
  coef_index_trial3 <- grep(paste0("ti(", xaxis_variable_in_quotes, ",", line_variable_in_quotes, ")"),names(pred_without_xy_interaction_effects),fixed = T)
  
  effects_cols_indices <- c(coef_index_trial1, coef_index_trial2, coef_index_trial3)
  
  x1Eff <- rowSums(pred_without_xy_interaction_effects [ind, effects_cols_indices])
  x1Eff_inv <- inv.logit(x1Eff + gam_model$coefficients[1])
  x2Eff <- rowSums(pred_without_xy_interaction_effects [ind2, effects_cols_indices])
  x2Eff_inv <- inv.logit(x2Eff + gam_model$coefficients[1])
  x3Eff <- rowSums(pred_without_xy_interaction_effects [ind3, effects_cols_indices])
  x3Eff_inv <- inv.logit(x3Eff + gam_model$coefficients[1])
  
  #Estimating 95% CI uncertainty
  X <- mgcv::predict.bam(gam_model, newdata = newd, type ="lpmatrix")
  n.sims <- 1000
  b_sims <- rmvn(n.sims,coef(gam_model), gam_model$Vp) #beta unceratinty
  
  smooth_index_trial1 <- grep(paste0("s(",xaxis_variable_in_quotes, ")"),names(coef(gam_model)),fixed = T) #selecting smooths
  smooth_index_trial2 <- grep(paste0("s(",line_variable_in_quotes, ")"),names(coef(gam_model)),fixed = T )
  smooth_index_trial3 <- grep(paste0("ti(", xaxis_variable_in_quotes, ",", line_variable_in_quotes, ")"),names(coef(gam_model)),fixed = T )

  smooth_index <- c(smooth_index_trial1, smooth_index_trial2, smooth_index_trial3)
  
  X1Eff_without_latlong <- tcrossprod( X[,smooth_index] , b_sims[,smooth_index] ) #spline computation
  
  calc_lower_XEff_1<- apply(X1Eff_without_latlong[1:200,], 1, quantile,probs = 0.025)
  invlogit_lower_xEff_1 <- inv.logit(calc_lower_XEff_1 + gam_model$coefficients[1])
  lower_xEff_1<- as.data.frame(invlogit_lower_xEff_1)
  calc_higher_xEff_1 <- apply(X1Eff_without_latlong[1:200,], 1, quantile,probs = 0.975)
  invlogit_higher_xEff_1 <- inv.logit(calc_higher_xEff_1 + gam_model$coefficients[1])
  higher_xEff_1 <- as.data.frame(invlogit_higher_xEff_1)
  ci_xEff <- bind_cols(lower_xEff_1, higher_xEff_1, xaxis_range)
  names(ci_xEff)<- c("lower.ci", "upper.ci", xaxis_variable_in_quotes)
  
  calc_lower_XEff_2<- apply(X1Eff_without_latlong[201:400,], 1, quantile,probs = 0.025)
  invlogit_lower_xEff_2 <- inv.logit(calc_lower_XEff_2 + gam_model$coefficients[1])
  lower_xEff_2 <- as.data.frame(invlogit_lower_xEff_2)
  calc_higher_xEff_2 <- apply(X1Eff_without_latlong[201:400,], 1, quantile,probs = 0.975)
  invlogit_higher_xEff_2 <- inv.logit(calc_higher_xEff_2 + gam_model$coefficients[1])
  higher_xEff_2 <- as.data.frame(invlogit_higher_xEff_2)
  ci_xEff_2 <- bind_cols(lower_xEff_2, higher_xEff_2, xaxis_range)
  names(ci_xEff_2)<- c("lower.ci", "upper.ci", xaxis_variable_in_quotes)
  
  calc_lower_XEff_3 <- apply(X1Eff_without_latlong[401:600,], 1, quantile,probs = 0.025)
  invlogit_lower_xEff_3 <- inv.logit(calc_lower_XEff_3 + gam_model$coefficients[1])
  lower_xEff_3 <- as.data.frame(invlogit_lower_xEff_3)
  calc_higher_xEff_3 <- apply(X1Eff_without_latlong[401:600,], 1, quantile,probs = 0.975)
  invlogit_higher_xEff_3 <- inv.logit(calc_higher_xEff_3 + gam_model$coefficients[1])
  higher_xEff_3 <- as.data.frame(invlogit_higher_xEff_3)
  ci_xEff_3 <- bind_cols(lower_xEff_3, higher_xEff_3, xaxis_range)
  names(ci_xEff_3)<- c("lower.ci", "upper.ci", xaxis_variable_in_quotes)
  
  plot_df <- data.frame(xaxis_colname = xaxis_range)
  low_plot_df <- plot_df %>% mutate(x1Eff_colname = x1Eff_inv, line_variable_type = line_lower_plotting_in_quotes_name)
  names(low_plot_df)<- c(xaxis_variable_in_quotes, "main_effect", "line_variable_type")
  low_plot_df <- left_join(low_plot_df, ci_xEff, by = xaxis_variable_in_quotes)
  
  average_plot_df <- plot_df %>% mutate(x1Eff_colname = x2Eff_inv, line_variable_type = line_middle_plotting_in_quotes_name)
  names(average_plot_df)<- c(xaxis_variable_in_quotes, "main_effect", "line_variable_type")
  average_plot_df <- left_join(average_plot_df, ci_xEff_2, by = xaxis_variable_in_quotes)
  
  high_plot_df <- plot_df %>% mutate(x1Eff_colname = x3Eff_inv, line_variable_type = line_higher_plotting_in_quotes_name)
  names(high_plot_df)<- c(xaxis_variable_in_quotes, "main_effect", "line_variable_type")
  high_plot_df <- left_join(high_plot_df, ci_xEff_3, by = xaxis_variable_in_quotes)
  
  
  final_plot_df <- bind_rows(low_plot_df, average_plot_df, high_plot_df)
  final_plot_df 
}

greening_anthropicdist_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "anthropic_dist", 
                                                           "mean_savanna_percentage",
                                                           inc_gam,
                                                           "low", "average", "high")
browning_anthropicdist_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "anthropic_dist", 
                                                           "mean_savanna_percentage",
                                                           dec_gam,
                                                           "low", "average", "high")

greening_anthropicdist_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "anthropic_dist", 
                                                           "mean_forest_percentage",
                                                           inc_gam,
                                                           "low", "average", "high")
browning_anthropicdist_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "anthropic_dist", 
                                                           "mean_forest_percentage",
                                                           dec_gam,
                                                           "low", "average", "high")
greening_anthropicdist_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "anthropic_dist", 
                                                           "mean_grass_percentage",
                                                           inc_gam,
                                                           "low", "average", "high")
browning_anthropicdist_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "anthropic_dist", 
                                                           "mean_grass_percentage",
                                                           dec_gam,
                                                           "low", "average", "high")

combined_plot_df_prep <- function (greening_results, browning_results, veg_formation_in_quotes){
  greening_results <- greening_results %>% mutate(TrajType = "Greening")
  browning_results <- browning_results %>% mutate(TrajType = "Browning")
  plot_df <- bind_rows (greening_results, browning_results)
  plot_df <- plot_df %>% mutate(VegFormation = veg_formation_in_quotes)
  plot_df
}

savanna_plot_df <- combined_plot_df_prep(greening_anthropicdist_savanna , browning_anthropicdist_savanna, "Savanna")
forest_plot_df <- combined_plot_df_prep(greening_anthropicdist_forest , browning_anthropicdist_forest, "Forest")
grass_plot_df <- combined_plot_df_prep(greening_anthropicdist_grass , browning_anthropicdist_grass, "Grass")


plot_interaction <- function (savanna_df, forest_df, grass_df, xaxis_variable, title){
  savanna_plot<- ggplot(savanna_df, aes(x = .data[[xaxis_variable]], y = main_effect,
                                          color = TrajType, fill =TrajType,
                                          group = interaction(line_variable_type, TrajType))) +
    geom_line(aes(color = TrajType), linewidth = 1) + 
    geom_ribbon(aes(ymin = lower.ci, ymax = upper.ci), alpha = 0.1) +
    facet_wrap(~factor(line_variable_type, c("low", "average", "high")), ncol=1)+
    theme_classic() +
    scale_fill_manual(values = c("#996633", "#669900"))+
    scale_color_manual(values=c("#663300", "#61A36A")) + 
    ylab ("Probability of trajectory type") + theme(legend.position="none")
  
  forest_plot<- ggplot(forest_df, aes(x = .data[[xaxis_variable]], y = main_effect,
                                          color = TrajType, fill =TrajType,
                                          group = interaction(line_variable_type, TrajType))) +
    geom_line(aes(color = TrajType), linewidth = 1) + 
    geom_ribbon(aes(ymin = lower.ci, ymax = upper.ci), alpha = 0.1) +
    facet_wrap(~factor(line_variable_type, c("low", "average", "high")), ncol=1)+
    theme_classic() +
    scale_fill_manual(values = c("#996633", "#669900"))+
    scale_color_manual(values=c("#663300", "#61A36A")) + 
    ylab ("Probability of trajectory type") + theme(legend.position="none")
  
  grass_plot<- ggplot(grass_df, aes(x = .data[[xaxis_variable]], y = main_effect,
                                          color = TrajType, fill =TrajType,
                                          group = interaction(line_variable_type, TrajType))) +
    geom_line(aes(color = TrajType), linewidth = 1) + 
    geom_ribbon(aes(ymin = lower.ci, ymax = upper.ci), alpha = 0.1) +
    facet_wrap(~factor(line_variable_type, c("low", "average", "high")), ncol=1)+
    theme_classic() +
    scale_fill_manual(values = c("#996633", "#669900"))+
    scale_color_manual(values=c("#663300", "#61A36A")) + 
    ylab ("Probability of trajectory type") + theme(legend.position="none")
  
    x <- ggpubr::ggarrange(forest_plot, grass_plot, savanna_plot, nrow = 1, ncol = 3, 
                           labels = c("Forest", "Grass", "Savanna"))
    x<- annotate_figure(x, top = text_grob(title, 
               color = "red", face = "bold", size = 14))
  x
}

anthropicdist_vegformation<- plot_interaction(savanna_plot_df, forest_plot_df, grass_plot_df, "anthropic_dist", "Anthropic Distance x Vegetation")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "TwoWay_InteractionResults", "anthropicdist_vegformation_probability.png"), anthropicdist_vegformation,
        dpi = 700, height = 25, width=25, units = "cm")

remove(savanna_plot_df, grass_plot_df, forest_plot_df, 
      greening_anthropicdist_forest, greening_anthropicdist_grass, greening_anthropicdist_savanna,
      browning_anthropicdist_forest, browning_anthropicdist_grass, browning_anthropicdist_savanna)     
```

#Step 5a (ii) Trend in burnedarea and mean veg formation
```{r}

greening_trendburnedarea_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_burnedarea", 
                                                           "mean_savanna_percentage",
                                                           inc_gam,
                                                           "low", "average", "high")
browning_trendburnedarea_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_burnedarea", 
                                                           "mean_savanna_percentage",
                                                           dec_gam,
                                                           "low", "average", "high")

greening_trendburnedarea_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_burnedarea", 
                                                           "mean_forest_percentage",
                                                           inc_gam,
                                                           "low", "average", "high")
browning_trendburnedarea_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_burnedarea", 
                                                           "mean_forest_percentage",
                                                           dec_gam,
                                                           "low", "average", "high")

greening_trendburnedarea_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_burnedarea", 
                                                           "mean_grass_percentage",
                                                           inc_gam,
                                                           "low", "average", "high")
browning_trendburnedarea_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_burnedarea", 
                                                           "mean_grass_percentage",
                                                           dec_gam,
                                                           "low", "average", "high")

savanna_plot_df <- combined_plot_df_prep(greening_trendburnedarea_savanna , browning_trendburnedarea_savanna, "Savanna")
forest_plot_df <- combined_plot_df_prep(greening_trendburnedarea_forest , browning_trendburnedarea_forest, "Forest")
grass_plot_df <- combined_plot_df_prep(greening_trendburnedarea_grass , browning_trendburnedarea_grass, "Grass")

trendburnedarea_vegformation<- plot_interaction(savanna_plot_df, forest_plot_df, grass_plot_df, "trend_burnedarea", "Trend in burned area x Vegetation")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "TwoWay_InteractionResults", "trend_burnedarea_vegformation_probability.png"), trendburnedarea_vegformation,
        dpi = 700, height = 25, width=25, units = "cm")

remove(savanna_plot_df, grass_plot_df, forest_plot_df, 
      greening_trendburnedarea_forest, greening_trendburnedarea_grass, greening_trendburnedarea_savanna,
      browning_trendburnedarea_forest, browning_trendburnedarea_grass, browning_trendburnedarea_savanna)

```

#Step 5c (iii) Trend in at and trend in re
```{r}
trend_grid_creation_prediction <- function (df_analyses, 
                                      xaxis_variable_in_quotes, 
                                      line_variable_in_quotes, 
                                      gam_model,
                                      line_lower_plotting_in_quotes_name,
                                      line_middle_plotting_in_quotes_name,
                                      line_higher_plotting_in_quotes_name){
  #Creating new data and running model
  df_select <- df_analyses %>% dplyr::select(-c(notrend))
  
  var_x <- subset( df_select, select = xaxis_variable_in_quotes)
  var_line <- subset( df_select, select = line_variable_in_quotes)
  var_line <- as.vector(var_line) %>% unlist()
  
  xaxis_range <- seq(min(var_x),max(var_x),len = xaxis_range_len)
  line_range <- c((mean(var_line) - sd(var_line)), 0 , (mean(var_line) + sd(var_line))) #changed middle scenario to be 0, so no change in trend
  
  df_means<- df_select %>% dplyr::select(-c(x,y,xaxis_variable_in_quotes, line_variable_in_quotes)) %>%
    summarise(across(where(is.numeric), ~mean(.x, na.rm= T)))
  
  newd <- data.frame(expand.grid(xaxis_range, line_range))
  names(newd) <- c(xaxis_variable_in_quotes, line_variable_in_quotes)
  newd <- newd %>% bind_cols(df_means) %>% mutate(x= x1, y=y1)
  pred <- mgcv::predict.bam(gam_model, newdata = newd, type="terms") 
  pred <- as.data.frame(pred)
  
  #Selecting the coefficients
  ind <- 1:xaxis_range_len
  ind2 <- (xaxis_range_len + 1):(xaxis_range_len*2)
  ind3 <- ((xaxis_range_len*2)+1):(xaxis_range_len*3)
  
  xy_interaction_effects <- grep("x,y",names(pred),fixed = T)
  pred_without_xy_interaction_effects <- (subset(pred, select = -xy_interaction_effects))
  
  coef_index_trial1 <- grep(paste0("s(",xaxis_variable_in_quotes, ")"),names(pred_without_xy_interaction_effects),fixed = T )
  coef_index_trial2 <- grep(paste0("s(",line_variable_in_quotes, ")"),names(pred_without_xy_interaction_effects),fixed = T )
  coef_index_trial3 <- grep(paste0("ti(", xaxis_variable_in_quotes, ",", line_variable_in_quotes, ")"),names(pred_without_xy_interaction_effects),fixed = T)
  
  effects_cols_indices <- c(coef_index_trial1, coef_index_trial2, coef_index_trial3)
  
  x1Eff <- rowSums(pred_without_xy_interaction_effects [ind, effects_cols_indices])
  x1Eff_inv <- inv.logit(x1Eff + gam_model$coefficients[1])
  x2Eff <- rowSums(pred_without_xy_interaction_effects [ind2, effects_cols_indices])
  x2Eff_inv <- inv.logit(x2Eff + gam_model$coefficients[1])
  x3Eff <- rowSums(pred_without_xy_interaction_effects [ind3, effects_cols_indices])
  x3Eff_inv <- inv.logit(x3Eff + gam_model$coefficients[1])
  
  #Estimating 95% CI uncertainty
  X <- mgcv::predict.bam(gam_model, newdata = newd, type ="lpmatrix")
  n.sims <- 1000
  b_sims <- rmvn(n.sims,coef(gam_model), gam_model$Vp) #beta unceratinty
  
  smooth_index_trial1 <- grep(paste0("s(",xaxis_variable_in_quotes, ")"),names(coef(gam_model)),fixed = T) #selecting smooths
  smooth_index_trial2 <- grep(paste0("s(",line_variable_in_quotes, ")"),names(coef(gam_model)),fixed = T )
  smooth_index_trial3 <- grep(paste0("ti(", xaxis_variable_in_quotes, ",", line_variable_in_quotes, ")"),names(coef(gam_model)),fixed = T )

  smooth_index <- c(smooth_index_trial1, smooth_index_trial2, smooth_index_trial3)
  
  X1Eff_without_latlong <- tcrossprod( X[,smooth_index] , b_sims[,smooth_index] ) #spline computation
  
  calc_lower_XEff_1<- apply(X1Eff_without_latlong[1:200,], 1, quantile,probs = 0.025)
  invlogit_lower_xEff_1 <- inv.logit(calc_lower_XEff_1 + gam_model$coefficients[1])
  lower_xEff_1<- as.data.frame(invlogit_lower_xEff_1)
  calc_higher_xEff_1 <- apply(X1Eff_without_latlong[1:200,], 1, quantile,probs = 0.975)
  invlogit_higher_xEff_1 <- inv.logit(calc_higher_xEff_1 + gam_model$coefficients[1])
  higher_xEff_1 <- as.data.frame(invlogit_higher_xEff_1)
  ci_xEff <- bind_cols(lower_xEff_1, higher_xEff_1, xaxis_range)
  names(ci_xEff)<- c("lower.ci", "upper.ci", xaxis_variable_in_quotes)
  
  calc_lower_XEff_2<- apply(X1Eff_without_latlong[201:400,], 1, quantile,probs = 0.025)
  invlogit_lower_xEff_2 <- inv.logit(calc_lower_XEff_2 + gam_model$coefficients[1])
  lower_xEff_2 <- as.data.frame(invlogit_lower_xEff_2)
  calc_higher_xEff_2 <- apply(X1Eff_without_latlong[201:400,], 1, quantile,probs = 0.975)
  invlogit_higher_xEff_2 <- inv.logit(calc_higher_xEff_2 + gam_model$coefficients[1])
  higher_xEff_2 <- as.data.frame(invlogit_higher_xEff_2)
  ci_xEff_2 <- bind_cols(lower_xEff_2, higher_xEff_2, xaxis_range)
  names(ci_xEff_2)<- c("lower.ci", "upper.ci", xaxis_variable_in_quotes)
  
  calc_lower_XEff_3 <- apply(X1Eff_without_latlong[401:600,], 1, quantile,probs = 0.025)
  invlogit_lower_xEff_3 <- inv.logit(calc_lower_XEff_3 + gam_model$coefficients[1])
  lower_xEff_3 <- as.data.frame(invlogit_lower_xEff_3)
  calc_higher_xEff_3 <- apply(X1Eff_without_latlong[401:600,], 1, quantile,probs = 0.975)
  invlogit_higher_xEff_3 <- inv.logit(calc_higher_xEff_3 + gam_model$coefficients[1])
  higher_xEff_3 <- as.data.frame(invlogit_higher_xEff_3)
  ci_xEff_3 <- bind_cols(lower_xEff_3, higher_xEff_3, xaxis_range)
  names(ci_xEff_3)<- c("lower.ci", "upper.ci", xaxis_variable_in_quotes)
  
  plot_df <- data.frame(xaxis_colname = xaxis_range)
  low_plot_df <- plot_df %>% mutate(x1Eff_colname = x1Eff_inv, line_variable_type = line_lower_plotting_in_quotes_name)
  names(low_plot_df)<- c(xaxis_variable_in_quotes, "main_effect", "line_variable_type")
  low_plot_df <- left_join(low_plot_df, ci_xEff, by = xaxis_variable_in_quotes)
  
  average_plot_df <- plot_df %>% mutate(x1Eff_colname = x2Eff_inv, line_variable_type = line_middle_plotting_in_quotes_name)
  names(average_plot_df)<- c(xaxis_variable_in_quotes, "main_effect", "line_variable_type")
  average_plot_df <- left_join(average_plot_df, ci_xEff_2, by = xaxis_variable_in_quotes)
  
  high_plot_df <- plot_df %>% mutate(x1Eff_colname = x3Eff_inv, line_variable_type = line_higher_plotting_in_quotes_name)
  names(high_plot_df)<- c(xaxis_variable_in_quotes, "main_effect", "line_variable_type")
  high_plot_df <- left_join(high_plot_df, ci_xEff_3, by = xaxis_variable_in_quotes)
  
  
  final_plot_df <- bind_rows(low_plot_df, average_plot_df, high_plot_df)
  final_plot_df 
}

greening_trend_at_re <- trend_grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_annualtemp", 
                                                           "trend_re",
                                                           inc_gam,
                                                           "low", "no change", "high")
browning_trend_at_re <- trend_grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_annualtemp", 
                                                           "trend_re",
                                                           dec_gam,
                                                           "low", "no change", "high")

trend_combined_plot_df_prep <- function (greening_results, browning_results){
  greening_results <- greening_results %>% mutate(TrajType = "Greening")
  browning_results <- browning_results %>% mutate(TrajType = "Browning")
  plot_df <- bind_rows (greening_results, browning_results)
  plot_df
}

trend_at_re_plot_df <- trend_combined_plot_df_prep(greening_trend_at_re, browning_trend_at_re)

plot_trend_interaction <- function (interaction_trend_df, xaxis_variable){
  x_plot<- ggplot(interaction_trend_df, aes(x = .data[[xaxis_variable]], y = main_effect,
                                          color = TrajType, fill =TrajType,
                                          group = interaction(line_variable_type, TrajType))) +
    geom_line(aes(color = TrajType), linewidth = 1) + 
    geom_ribbon(aes(ymin = lower.ci, ymax = upper.ci), alpha = 0.1) +
    facet_wrap(~factor(line_variable_type, c("low", "no change", "high")), nrow=1)+
    theme_classic() +
    scale_fill_manual(values = c("#996633", "#669900"))+
    scale_color_manual(values=c("#663300", "#61A36A")) + 
    ylab ("Probability of trajectory type") + theme(legend.position="none")
  x_plot
}

plot_trend_at_re <- plot_trend_interaction(trend_at_re_plot_df, "trend_annualtemp")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "TwoWay_InteractionResults", "trend_at_re_probability.png"), plot_trend_at_re,
        dpi = 700, height = 25, width=25, units = "cm")

```

#Step 5c (iv) Trend in spei and trend in heatwave
```{r}
greening_trend_heatwave_spei <- trend_grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_heatwave", 
                                                           "trend_spei",
                                                           inc_gam,
                                                           "low", "no change", "high")
browning_trend_heatwave_spei <- trend_grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_heatwave", 
                                                           "trend_spei",
                                                           dec_gam,
                                                           "low", "no change", "high")

trend_heatwave_spei_plot_df <- trend_combined_plot_df_prep(greening_trend_heatwave_spei, browning_trend_heatwave_spei)

plot_trend_heatwave_spei <- plot_trend_interaction(trend_heatwave_spei_plot_df, "trend_heatwave")

ggsave (here("Outputs", "AnalysesResults", "GAMResults", "TwoWay_InteractionResults", "trend_heatwave_spei_probability.png"), plot_trend_heatwave_spei,
        dpi = 700, height = 25, width=25, units = "cm")

```

#Step 5b (i) - Trends in heatwaves, SPEI across veg formations
```{r}
# location
x1 <- -43.2781
y1 <- -4.0213
xaxis_range_len <- 200


inc_gam <- read_rds(here("Scripts", "Final_Scripts", "analyses", "onemodel_inc.rds"))
dec_gam <- read_rds(here("Scripts", "Final_Scripts", "analyses" ,"onemodel_dec.rds"))


grid_creation_prediction <- function (df_analyses, 
                                      xaxis_variable_in_quotes, 
                                      line_variable_in_quotes,
                                      panel_variable_in_quotes,
                                      panel_variable_type_dec_nochange_inc_quotes,
                                      gam_model,
                                      line_lower_plotting_in_quotes_name,
                                      line_middle_plotting_in_quotes_name,
                                      line_higher_plotting_in_quotes_name){
  #Creating new data and running model
  df_select <- df_analyses %>% dplyr::select(-c(notrend))
  
  var_x <- subset( df_select, select = xaxis_variable_in_quotes)
  var_line <- subset( df_select, select = line_variable_in_quotes)
  var_line <- as.vector(var_line) %>% unlist()
  
  xaxis_range <- seq(min(var_x),max(var_x),len = xaxis_range_len)
  line_range <- c((mean(var_line) - sd(var_line)),mean(var_line), (mean(var_line) + sd(var_line))) #changed middle scenario to be mean of veg formation area
  
  df_means<- df_select %>% dplyr::select(-c(x,y,increase, decrease, xaxis_variable_in_quotes, line_variable_in_quotes, panel_variable_in_quotes)) %>%
    summarise(across(where(is.numeric), ~mean(.x, na.rm= T)))
  
  var_panel <- subset( df_select, select = panel_variable_in_quotes)
  var_panel <- as.vector(var_panel) %>% unlist()
  panel_variable_value <- if(panel_variable_type_dec_nochange_inc_quotes=="dec"){
    mean(var_panel) -sd(var_panel)
  } else{
    if(panel_variable_type_dec_nochange_inc_quotes=="nochange"){
      0
    } else {
      mean(var_panel) + sd(var_panel)
    }
  }
  
  newd <- data.frame(expand.grid(xaxis_range, line_range))
  names(newd) <- c(xaxis_variable_in_quotes, line_variable_in_quotes)
  newd <- newd %>% bind_cols(df_means) %>% mutate(x= x1, y=y1)
  newd <- newd %>% mutate(panel_variable_in_quotes=panel_variable_value)
  names(newd)[17]<- panel_variable_in_quotes
  
  
  pred <- mgcv::predict.bam(gam_model, newdata = newd, type="terms") 
  pred <- as.data.frame(pred)
  
  #Selecting the coefficients
  ind <- 1:xaxis_range_len
  ind2 <- (xaxis_range_len + 1):(xaxis_range_len*2)
  ind3 <- ((xaxis_range_len*2)+1):(xaxis_range_len*3)
  
  xy_interaction_effects <- grep("x,y",names(pred),fixed = T)
  pred_without_xy_interaction_effects <- (subset(pred, select = -xy_interaction_effects))
  
  coef_index_trial1 <- grep(paste0("s(", xaxis_variable_in_quotes, ")"),names(pred_without_xy_interaction_effects),fixed = T )
  coef_index_trial2 <- grep(paste0("s(", line_variable_in_quotes, ")"),names(pred_without_xy_interaction_effects),fixed = T )
  coef_index_trial3 <- grep(paste0("s(", panel_variable_in_quotes, ")"),names(pred_without_xy_interaction_effects),fixed = T )
  coef_index_trial4 <- grep(paste0("ti(", xaxis_variable_in_quotes, ",", panel_variable_in_quotes, ")"),names(pred_without_xy_interaction_effects),fixed = T)
  coef_index_trial5 <- grep(paste0("ti(", line_variable_in_quotes, "," , panel_variable_in_quotes, ",", xaxis_variable_in_quotes, ")"),names(pred_without_xy_interaction_effects),fixed = T)
  
  effects_cols_indices <- c(coef_index_trial1, coef_index_trial2, coef_index_trial3, coef_index_trial4, coef_index_trial5)
  
  x1Eff <- rowSums(pred_without_xy_interaction_effects [ind, effects_cols_indices])
  x1Eff_inv <- inv.logit(x1Eff + gam_model$coefficients[1])
  x2Eff <- rowSums(pred_without_xy_interaction_effects [ind2, effects_cols_indices])
  x2Eff_inv <- inv.logit(x2Eff + gam_model$coefficients[1])
  x3Eff <- rowSums(pred_without_xy_interaction_effects [ind3, effects_cols_indices])
  x3Eff_inv <- inv.logit(x3Eff + gam_model$coefficients[1])
  
  #Estimating 95% CI uncertainty
  X <- mgcv::predict.bam(gam_model, newdata = newd, type ="lpmatrix")
  n.sims <- 1000
  b_sims <- rmvn(n.sims,coef(gam_model), gam_model$Vp) #beta unceratinty
  
  smooth_index_trial1 <- grep(paste0("s(", xaxis_variable_in_quotes, ")"), names(coef(gam_model)),fixed = T) #selecting smooths
  smooth_index_trial2 <- grep(paste0("s(", line_variable_in_quotes, ")"), names(coef(gam_model)),fixed = T )
  smooth_index_trial3 <- grep(paste0("s(", panel_variable_in_quotes, ")"), names(coef(gam_model)),fixed = T )
  smooth_index_trial4 <- grep(paste0("ti(", xaxis_variable_in_quotes, ",", panel_variable_in_quotes, ")"), names(coef(gam_model)),fixed = T)
  smooth_index_trial5 <- grep(paste0("ti(", line_variable_in_quotes, "," , panel_variable_in_quotes, ",", xaxis_variable_in_quotes, ")"),names(coef(gam_model)),fixed = T)

  smooth_index <- c(smooth_index_trial1, smooth_index_trial2, smooth_index_trial3, smooth_index_trial4, smooth_index_trial5)
  
  X1Eff_without_latlong <- tcrossprod( X[,smooth_index] , b_sims[,smooth_index] ) #spline computation
  
  calc_lower_XEff_1<- apply(X1Eff_without_latlong[1:200,], 1, quantile,probs = 0.025)
  invlogit_lower_xEff_1 <- inv.logit(calc_lower_XEff_1 + gam_model$coefficients[1])
  lower_xEff_1<- as.data.frame(invlogit_lower_xEff_1)
  calc_higher_xEff_1 <- apply(X1Eff_without_latlong[1:200,], 1, quantile,probs = 0.975)
  invlogit_higher_xEff_1 <- inv.logit(calc_higher_xEff_1 + gam_model$coefficients[1])
  higher_xEff_1 <- as.data.frame(invlogit_higher_xEff_1)
  ci_xEff <- bind_cols(lower_xEff_1, higher_xEff_1, xaxis_range)
  names(ci_xEff)<- c("lower.ci", "upper.ci", xaxis_variable_in_quotes)
  
  calc_lower_XEff_2<- apply(X1Eff_without_latlong[201:400,], 1, quantile,probs = 0.025)
  invlogit_lower_xEff_2 <- inv.logit(calc_lower_XEff_2 + gam_model$coefficients[1])
  lower_xEff_2 <- as.data.frame(invlogit_lower_xEff_2)
  calc_higher_xEff_2 <- apply(X1Eff_without_latlong[201:400,], 1, quantile,probs = 0.975)
  invlogit_higher_xEff_2 <- inv.logit(calc_higher_xEff_2 + gam_model$coefficients[1])
  higher_xEff_2 <- as.data.frame(invlogit_higher_xEff_2)
  ci_xEff_2 <- bind_cols(lower_xEff_2, higher_xEff_2, xaxis_range)
  names(ci_xEff_2)<- c("lower.ci", "upper.ci", xaxis_variable_in_quotes)
  
  calc_lower_XEff_3<- apply(X1Eff_without_latlong[401:600,], 1, quantile,probs = 0.025)
  invlogit_lower_xEff_3 <- inv.logit(calc_lower_XEff_3 + gam_model$coefficients[1])
  lower_xEff_3 <- as.data.frame(invlogit_lower_xEff_3)
  calc_higher_xEff_3 <- apply(X1Eff_without_latlong[401:600,], 1, quantile,probs = 0.975)
  invlogit_higher_xEff_3 <- inv.logit(calc_higher_xEff_3 + gam_model$coefficients[1])
  higher_xEff_3 <- as.data.frame(invlogit_higher_xEff_3)
  ci_xEff_3 <- bind_cols(lower_xEff_3, higher_xEff_3, xaxis_range)
  names(ci_xEff_3)<- c("lower.ci", "upper.ci", xaxis_variable_in_quotes)
  
  plot_df <- data.frame(xaxis_colname = xaxis_range)
  low_plot_df <- plot_df %>% mutate(x1Eff_colname = x1Eff_inv, line_variable_type = line_lower_plotting_in_quotes_name)
  names(low_plot_df)<- c(xaxis_variable_in_quotes, "main_effect", "line_variable_type")
  low_plot_df <- left_join(low_plot_df, ci_xEff, by = xaxis_variable_in_quotes)
  
  average_plot_df <- plot_df %>% mutate(x1Eff_colname = x2Eff_inv, line_variable_type = line_middle_plotting_in_quotes_name)
  names(average_plot_df)<- c(xaxis_variable_in_quotes, "main_effect", "line_variable_type")
  average_plot_df <- left_join(average_plot_df, ci_xEff_2, by = xaxis_variable_in_quotes)
  
  high_plot_df <- plot_df %>% mutate(x1Eff_colname = x3Eff_inv, line_variable_type = line_higher_plotting_in_quotes_name)
  names(high_plot_df)<- c(xaxis_variable_in_quotes, "main_effect", "line_variable_type")
  high_plot_df <- left_join(high_plot_df, ci_xEff_3, by = xaxis_variable_in_quotes)
  
  
  final_plot_df <- bind_rows(low_plot_df, average_plot_df, high_plot_df)
  final_plot_df 
}


greening_nochangespei_heatwave_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_savanna_percentage",
                                 "trend_spei",
                                 "nochange",
                                 inc_gam,
                                 "low", "average", "high")
browning_nochangespei_heatwave_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_savanna_percentage",
                                 "trend_spei",
                                 "nochange",
                                 dec_gam,
                                 "low", "average", "high")

greening_nochangespei_heatwave_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_forest_percentage",
                                 "trend_spei",
                                 "nochange",
                                 inc_gam,
                                 "low", "average", "high")
browning_nochangespei_heatwave_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_forest_percentage",
                                 "trend_spei",
                                 "nochange",
                                 dec_gam,
                                 "low", "average", "high")
greening_nochangespei_heatwave_grass<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_grass_percentage",
                                 "trend_spei",
                                 "nochange",
                                 inc_gam,
                                 "low", "average", "high")
browning_nochangespei_heatwave_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_grass_percentage",
                                 "trend_spei",
                                 "nochange",
                                 dec_gam,
                                 "low", "average", "high")

savanna_plot_df <- combined_plot_df_prep(greening_nochangespei_heatwave_savanna, browning_nochangespei_heatwave_savanna, "Savanna")
forest_plot_df <- combined_plot_df_prep(greening_nochangespei_heatwave_forest , browning_nochangespei_heatwave_forest, "Forest")
grass_plot_df <- combined_plot_df_prep(greening_nochangespei_heatwave_grass , browning_nochangespei_heatwave_grass, "Grass")

nochangespei_heatwave_vegetation <- plot_interaction(savanna_plot_df, forest_plot_df, grass_plot_df, "trend_heatwave", "No trend in SPEI")

remove(savanna_plot_df, forest_plot_df, grass_plot_df,
       greening_nochangespei_heatwave_forest, greening_nochangespei_heatwave_grass, greening_nochangespei_heatwave_savanna,
       browning_nochangespei_heatwave_forest, browning_nochangespei_heatwave_grass, browning_nochangespei_heatwave_savanna)

greening_decspei_heatwave_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_savanna_percentage",
                                 "trend_spei",
                                 "dec",
                                 inc_gam,
                                 "low", "average", "high")
browning_decspei_heatwave_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_savanna_percentage",
                                 "trend_spei",
                                 "dec",
                                 dec_gam,
                                 "low", "average", "high")

greening_decspei_heatwave_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_forest_percentage",
                                 "trend_spei",
                                 "dec",
                                 inc_gam,
                                 "low", "average", "high")
browning_decspei_heatwave_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_forest_percentage",
                                 "trend_spei",
                                 "dec",
                                 dec_gam,
                                 "low", "average", "high")
greening_decspei_heatwave_grass<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_grass_percentage",
                                 "trend_spei",
                                 "dec",
                                 inc_gam,
                                 "low", "average", "high")
browning_decspei_heatwave_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_grass_percentage",
                                 "trend_spei",
                                 "dec",
                                 dec_gam,
                                 "low", "average", "high")

savanna_plot_df <- combined_plot_df_prep(greening_decspei_heatwave_savanna, browning_decspei_heatwave_savanna, "Savanna")
forest_plot_df <- combined_plot_df_prep(greening_decspei_heatwave_forest , browning_decspei_heatwave_forest, "Forest")
grass_plot_df <- combined_plot_df_prep(greening_decspei_heatwave_grass , browning_decspei_heatwave_grass, "Grass")

decspei_heatwave_vegetation <- plot_interaction(savanna_plot_df, forest_plot_df, grass_plot_df, "trend_heatwave", "Decreasing trend in SPEI")

remove(savanna_plot_df, forest_plot_df, grass_plot_df,
       greening_decspei_heatwave_forest, greening_decspei_heatwave_grass, greening_decspei_heatwave_savanna,
       browning_decspei_heatwave_forest, browning_decspei_heatwave_grass, browning_decspei_heatwave_savanna)

greening_incspei_heatwave_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_savanna_percentage",
                                 "trend_spei",
                                 "inc",
                                 inc_gam,
                                 "low", "average", "high")
browning_incspei_heatwave_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_savanna_percentage",
                                 "trend_spei",
                                 "inc",
                                 dec_gam,
                                 "low", "average", "high")

greening_incspei_heatwave_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_forest_percentage",
                                 "trend_spei",
                                 "inc",
                                 inc_gam,
                                 "low", "average", "high")
browning_incspei_heatwave_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_forest_percentage",
                                 "trend_spei",
                                 "inc",
                                 dec_gam,
                                 "low", "average", "high")
greening_incspei_heatwave_grass<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_grass_percentage",
                                 "trend_spei",
                                 "inc",
                                 inc_gam,
                                 "low", "average", "high")
browning_incspei_heatwave_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_grass_percentage",
                                 "trend_spei",
                                 "inc",
                                 dec_gam,
                                 "low", "average", "high")

savanna_plot_df <- combined_plot_df_prep(greening_incspei_heatwave_savanna, browning_incspei_heatwave_savanna, "Savanna")
forest_plot_df <- combined_plot_df_prep(greening_incspei_heatwave_forest , browning_incspei_heatwave_forest, "Forest")
grass_plot_df <- combined_plot_df_prep(greening_incspei_heatwave_grass , browning_incspei_heatwave_grass, "Grass")

incspei_heatwave_vegetation <- plot_interaction(savanna_plot_df, forest_plot_df, grass_plot_df, "trend_heatwave", "Increasing trend in SPEI")

remove(savanna_plot_df, forest_plot_df, grass_plot_df,
       greening_incspei_heatwave_forest, greening_incspei_heatwave_grass, greening_incspei_heatwave_savanna,
       browning_incspei_heatwave_forest, browning_incspei_heatwave_grass, browning_incspei_heatwave_savanna)

nochangespei_heatwave_vegetation
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "ThreeWay_InteractionResults", "nochangespei_heatwave_vegetation_probability.png"), nochangespei_heatwave_vegetation,
        dpi = 700, height = 40, width=40, units = "cm")
decspei_heatwave_vegetation
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "ThreeWay_InteractionResults", "decspei_heatwave_vegetation_probability.png"), decspei_heatwave_vegetation,
        dpi = 700, height = 40, width=40, units = "cm")
incspei_heatwave_vegetation
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "ThreeWay_InteractionResults", "incspei_heatwave_vegetation_probability.png"), incspei_heatwave_vegetation,
        dpi = 700, height = 40, width= 40, units = "cm")

```

#Step 5b (ii) - Trends in annual temp, RE across veg formations
```{r}
greening_nochangere_at_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_savanna_percentage",
                                 "trend_re",
                                 "nochange",
                                 inc_gam,
                                 "low", "average", "high")
browning_nochangere_at_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_savanna_percentage",
                                 "trend_re",
                                 "nochange",
                                 dec_gam,
                                 "low", "average", "high")

greening_nochangere_at_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_forest_percentage",
                                 "trend_re",
                                 "nochange",
                                 inc_gam,
                                 "low", "average", "high")
browning_nochangere_at_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_forest_percentage",
                                 "trend_re",
                                 "nochange",
                                 dec_gam,
                                 "low", "average", "high")
greening_nochangere_at_grass<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_grass_percentage",
                                 "trend_re",
                                 "nochange",
                                 inc_gam,
                                 "low", "average", "high")
browning_nochangere_at_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_grass_percentage",
                                 "trend_re",
                                 "nochange",
                                 dec_gam,
                                 "low", "average", "high")

savanna_plot_df <- combined_plot_df_prep(greening_nochangere_at_savanna, browning_nochangere_at_savanna, "Savanna")
forest_plot_df <- combined_plot_df_prep(greening_nochangere_at_forest , browning_nochangere_at_forest, "Forest")
grass_plot_df <- combined_plot_df_prep(greening_nochangere_at_grass , browning_nochangere_at_grass, "Grass")

nochangere_annualtemp_vegetation <- plot_interaction(savanna_plot_df, forest_plot_df, grass_plot_df, "trend_annualtemp", "No trend in RE")

remove(savanna_plot_df, grass_plot_df, forest_plot_df,
       greening_nochangere_at_forest, greening_nochangere_at_grass, greening_nochangere_at_savanna,
       browning_nochangere_at_forest, browning_nochangere_at_grass, browning_nochangere_at_savanna)

greening_decre_at_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_savanna_percentage",
                                 "trend_re",
                                 "dec",
                                 inc_gam,
                                 "low", "average", "high")
browning_decre_at_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_savanna_percentage",
                                 "trend_re",
                                 "dec",
                                 dec_gam,
                                 "low", "average", "high")

greening_decre_at_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_forest_percentage",
                                 "trend_re",
                                 "dec",
                                 inc_gam,
                                 "low", "average", "high")
browning_decre_at_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_forest_percentage",
                                 "trend_re",
                                 "dec",
                                 dec_gam,
                                 "low", "average", "high")

greening_decre_at_grass<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_grass_percentage",
                                 "trend_re",
                                 "dec",
                                 inc_gam,
                                 "low", "average", "high")
browning_decre_at_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_grass_percentage",
                                 "trend_re",
                                 "dec",
                                 dec_gam,
                                 "low", "average", "high")

savanna_plot_df <- combined_plot_df_prep(greening_decre_at_savanna, browning_decre_at_savanna, "Savanna")
forest_plot_df <- combined_plot_df_prep(greening_decre_at_forest , browning_decre_at_forest, "Forest")
grass_plot_df <- combined_plot_df_prep(greening_decre_at_grass , browning_decre_at_grass, "Grass")

decre_annualtemp_vegetation <- plot_interaction(savanna_plot_df, forest_plot_df, grass_plot_df, "trend_annualtemp", "Decreasing trend in RE")

remove(savanna_plot_df, grass_plot_df, forest_plot_df,
       greening_decre_at_forest, greening_decre_at_grass, greening_decre_at_savanna,
       browning_decre_at_forest, browning_decre_at_grass, browning_decre_at_savanna)

greening_incre_at_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_savanna_percentage",
                                 "trend_re",
                                 "inc",
                                 inc_gam,
                                 "low", "average", "high")
browning_incre_at_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_savanna_percentage",
                                 "trend_re",
                                 "inc",
                                 dec_gam,
                                 "low", "average", "high")

greening_incre_at_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_forest_percentage",
                                 "trend_re",
                                 "inc",
                                 inc_gam,
                                 "low", "average", "high")
browning_incre_at_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_forest_percentage",
                                 "trend_re",
                                 "inc",
                                 dec_gam,
                                 "low", "average", "high")

greening_incre_at_grass<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_grass_percentage",
                                 "trend_re",
                                 "inc",
                                 inc_gam,
                                 "low", "average", "high")
browning_incre_at_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_grass_percentage",
                                 "trend_re",
                                 "inc",
                                 dec_gam,
                                 "low", "average", "high")

savanna_plot_df <- combined_plot_df_prep(greening_incre_at_savanna, browning_incre_at_savanna, "Savanna")
forest_plot_df <- combined_plot_df_prep(greening_incre_at_forest , browning_incre_at_forest, "Forest")
grass_plot_df <- combined_plot_df_prep(greening_incre_at_grass , browning_incre_at_grass, "Grass")

incre_annualtemp_vegetation <- plot_interaction(savanna_plot_df, forest_plot_df, grass_plot_df, "trend_annualtemp", "Increasing trend in RE")

remove(savanna_plot_df, grass_plot_df, forest_plot_df,
       greening_incre_at_forest, greening_incre_at_grass, greening_incre_at_savanna,
       browning_incre_at_forest, browning_incre_at_grass, browning_incre_at_savanna)

nochangere_annualtemp_vegetation
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "ThreeWay_InteractionResults", "nochangere_annualtemp_vegetation_probability.png"), nochangere_annualtemp_vegetation,
        dpi = 700, height = 40, width=40, units = "cm")
decre_annualtemp_vegetation
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "ThreeWay_InteractionResults", "decre_annualtemp_vegetation_probability.png"), decre_annualtemp_vegetation,
        dpi = 700, height = 40, width=40, units = "cm")
incre_annualtemp_vegetation
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "ThreeWay_InteractionResults", "incre_annualtemp_vegetation_probability.png"), incre_annualtemp_vegetation,
        dpi = 700, height = 40, width= 40, units = "cm")


```

#Step 5c - Visualization of univariate relationships considering predict.gam methodology similar to plotting of 2 and 3 way interactions
```{r}
# location
x1 <- -43.2781
y1 <- -4.0213
xaxis_range_len <- 200

grid_creation_prediction <- function (df_analyses, 
                                      xaxis_variable_in_quotes, 
                                      gam_model){
  #Creating new data and running model
  df_select <- df_analyses %>% dplyr::select(-c(notrend))
  
  var_x <- subset( df_select, select = xaxis_variable_in_quotes)
  
  xaxis_range <- seq(min(var_x),max(var_x),len = xaxis_range_len)
   
  df_means<- df_select %>% dplyr::select(-c(x,y,xaxis_variable_in_quotes)) %>%
    summarise(across(where(is.numeric), ~mean(.x, na.rm= T)))
  
  newd <- data.frame(expand.grid(xaxis_range))
  names(newd) <- c(xaxis_variable_in_quotes)
  newd <- newd %>% bind_cols(df_means) %>% mutate(x= x1, y=y1)
  pred <- mgcv::predict.bam(gam_model, newdata = newd, type="terms") 
  pred <- as.data.frame(pred)
  
  #Selecting the coefficients
  x1Eff_inv <- inv.logit(pred[[paste0("s(",xaxis_variable_in_quotes, ")")]] + gam_model$coefficients[1])
  
  #Estimating 95% CI uncertainty
  X <- mgcv::predict.bam(gam_model, newdata = newd, type ="lpmatrix")
  n.sims <- 1000
  b_sims <- rmvn(n.sims,coef(gam_model), gam_model$Vp) #beta unceratinty
  
  smooth_index_trial1 <- grep(paste0("s(",xaxis_variable_in_quotes, ")"),names(coef(gam_model)),fixed = T) #selecting smooths
  smooth_index <- c(smooth_index_trial1)
  
  X1Eff_without_latlong <- tcrossprod( X[,smooth_index] , b_sims[,smooth_index] ) #spline computation
  
  calc_lower_XEff_1<- apply(X1Eff_without_latlong[1:200,], 1, quantile,probs = 0.025)
  invlogit_lower_xEff_1 <- inv.logit(calc_lower_XEff_1 + gam_model$coefficients[1])
  lower_xEff_1<- as.data.frame(invlogit_lower_xEff_1)
  calc_higher_xEff_1 <- apply(X1Eff_without_latlong[1:200,], 1, quantile,probs = 0.975)
  invlogit_higher_xEff_1 <- inv.logit(calc_higher_xEff_1 + gam_model$coefficients[1])
  higher_xEff_1 <- as.data.frame(invlogit_higher_xEff_1)
  ci_xEff <- bind_cols(lower_xEff_1, higher_xEff_1, xaxis_range)
  names(ci_xEff)<- c("lower.ci", "upper.ci", xaxis_variable_in_quotes)
  
  plot_df <- data.frame(xaxis_colname = xaxis_range)
 
  average_plot_df <- plot_df %>% mutate(x1Eff_colname = x1Eff_inv)
  names(average_plot_df)<- c(xaxis_variable_in_quotes, "main_effect")
  average_plot_df <- left_join(average_plot_df, ci_xEff, by = xaxis_variable_in_quotes)
  
  final_plot_df <- bind_rows( average_plot_df)
  final_plot_df 
}

#Mean variables
greening_mean_at <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "mean_at", inc_gam)
greening_mean_re <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "mean_re", inc_gam)
greening_mean_burnedarea <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "mean_burnedarea", inc_gam)
greening_mean_spei <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "mean_spei", inc_gam)
greening_mean_heatwave <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "mean_heatwave", inc_gam)
greening_mean_savanna<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "mean_savanna_percentage", inc_gam)
greening_mean_grass<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "mean_grass_percentage", inc_gam)
greening_mean_forest<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "mean_forest_percentage", inc_gam)

browning_mean_at <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "mean_at", dec_gam)
browning_mean_re <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "mean_re", dec_gam)
browning_mean_burnedarea <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "mean_burnedarea", dec_gam)
browning_mean_spei <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "mean_spei", dec_gam)
browning_mean_heatwave <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "mean_heatwave", dec_gam)
browning_mean_savanna<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "mean_savanna_percentage", dec_gam)
browning_mean_grass<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "mean_grass_percentage", dec_gam)
browning_mean_forest<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "mean_forest_percentage", dec_gam)
#Trend variables
greening_trend_ba <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_burnedarea", inc_gam)
greening_trend_re <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_re", inc_gam)
greening_trend_at <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_annualtemp", inc_gam)
greening_trend_spei <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_spei", inc_gam)
greening_trend_heatwave <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_heatwave", inc_gam)

browning_trend_ba <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_burnedarea", dec_gam)
browning_trend_re <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_re", dec_gam)
browning_trend_at <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_annualtemp", dec_gam)
browning_trend_spei <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_spei", dec_gam)
browning_trend_heatwave <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_heatwave", dec_gam)

browning_anthropicdist <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "anthropic_dist", dec_gam)
greening_anthropicdist <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "anthropic_dist", inc_gam)

combined_plot_df_prep <- function (greening_results, browning_results){
  greening_results <- greening_results %>% mutate(TrajType = "Greening")
  browning_results <- browning_results %>% mutate(TrajType = "Browning")
  plot_df <- bind_rows (greening_results, browning_results)
  plot_df
}

#Mean variables
mean_at_plot_df <- combined_plot_df_prep(greening_mean_at, browning_mean_at)
mean_re_plot_df <- combined_plot_df_prep(greening_mean_re, browning_mean_re)
mean_burnedarea_plot_df <- combined_plot_df_prep(greening_mean_burnedarea, browning_mean_burnedarea)
mean_spei_plot_df <- combined_plot_df_prep(greening_mean_spei, browning_mean_spei)
mean_heatwave_plot_df <- combined_plot_df_prep(greening_mean_heatwave, browning_mean_heatwave)
mean_savanna_plot_df <- combined_plot_df_prep(greening_mean_savanna, browning_mean_savanna)
mean_forest_plot_df <- combined_plot_df_prep(greening_mean_forest, browning_mean_forest)
mean_grass_plot_df <- combined_plot_df_prep(greening_mean_grass, browning_mean_grass)

#Trend variables
trend_at_plot_df <- combined_plot_df_prep(greening_trend_at, browning_trend_at)
trend_re_plot_df <- combined_plot_df_prep(greening_trend_re, browning_trend_re)
trend_ba_plot_df <- combined_plot_df_prep(greening_trend_ba, browning_trend_ba)
trend_spei_plot_df <- combined_plot_df_prep(greening_trend_spei, browning_trend_spei)
trend_heatwave_plot_df <- combined_plot_df_prep(greening_trend_heatwave, browning_trend_heatwave)
anthropic_dist_plot_df <- combined_plot_df_prep(greening_anthropicdist, browning_anthropicdist)


univariate_relationships_list <- list(mean_at_plot_df, mean_re_plot_df, mean_burnedarea_plot_df, mean_spei_plot_df, 
                                      mean_heatwave_plot_df, mean_savanna_plot_df, mean_forest_plot_df, mean_grass_plot_df,
                                     trend_at_plot_df, trend_re_plot_df, trend_ba_plot_df, trend_spei_plot_df, trend_heatwave_plot_df,anthropic_dist_plot_df)
write_rds(univariate_relationships_list, here("Outputs", "TrendsResults", "Figures", "univariate_partialeffects.rds"))

remove(mean_at_plot_df,mean_re_plot_df,mean_burnedarea_plot_df,mean_spei_plot_df, mean_heatwave_plot_df, mean_savanna_plot_df, mean_forest_plot_df, mean_grass_plot_df, trend_at_plot_df, trend_re_plot_df, trend_ba_plot_df, trend_spei_plot_df, trend_heatwave_plot_df, anthropic_dist_plot_df)

remove(greening_mean_at, greening_mean_re, greening_mean_burnedarea, greening_mean_spei, greening_mean_heatwave, greening_mean_savanna, greening_mean_forest, greening_mean_grass, greening_trend_at, greening_trend_re, greening_trend_ba, greening_trend_spei, greening_trend_heatwave, greening_anthropicdist, browning_mean_at, browning_mean_re, browning_mean_burnedarea, browning_mean_spei, browning_mean_heatwave, browning_mean_savanna, browning_mean_forest, browning_mean_grass, browning_trend_at, browning_trend_re, browning_trend_ba, browning_trend_spei, browning_trend_heatwave, browning_anthropicdist)


univariate_plotting <- function (var, x_label, univariate_relationship_df){
  
  data_df <- analyses_df_noNA_nooutliers %>%
      dplyr::select(all_of(var)) %>%
      dplyr::rename(z = 1)
  density <- ggplot(data_df, aes(x = z)) +
    geom_density(colour = "grey70", fill = "grey90", alpha = 0.6) +
    geom_vline(xintercept = quantile(data_df$z, probs=0.1), linetype="dashed") +
    geom_vline(xintercept = quantile(data_df$z, probs=0.9), linetype="dashed") +
      theme_void()
  
  plot <- ggplot(univariate_relationship_df, aes(x = .data[[var]], y = main_effect, group = TrajType, colour = TrajType, fill = TrajType)) +
    geom_ribbon(aes(ymin = lower.ci, ymax = upper.ci), alpha = 0.2) + 
    geom_line(alpha = 0.8, lwd = 0.6) +
    coord_cartesian(xlim = c(quantile(univariate_relationship_df$var, probs=0.1),quantile(univariate_relationship_df$var, probs=0.9)), ylim = c(0,1)) +
  scale_fill_manual(values = c("#996633", "#669900")) + 
  scale_color_manual(values = c("#663300", "#61A36A")) +
  scale_x_continuous( labels = label_number()) +
  labs(x = x_label,
         y = "Probability of trajectory type") +
    theme_classic() + theme(legend.position="none")
  
  x<-density + plot +
    patchwork::plot_layout(ncol = 1, nrow = 2, widths = 4, heights = c(1, 4))
  x

}

mean_re_plot <- univariate_plotting("mean_re", "mean relative entropy (unitless)", univariate_relationships_list[[2]])
mean_ba_plot <- univariate_plotting("mean_burnedarea", "mean burned area proportion (%)", univariate_relationships_list[[3]])
mean_spei_plot <- univariate_plotting("mean_spei", "mean SPEI (unitless)", univariate_relationships_list[[4]])
mean_heatwave_browning_plot <- univariate_plotting("mean_heatwave", "mean number of heatwaves", 
                                                   (univariate_relationships_list[[5]]) %>% filter(TrajType=="Browning"))
mean_savanna_greening_plot <- univariate_plotting("mean_savanna_percentage", "mean savanna formation proportion (%)", 
                                                   (univariate_relationships_list[[6]]) %>% filter(TrajType=="Greening"))
mean_forest_greening_plot <- univariate_plotting("mean_forest_percentage", "mean forest formation proportion (%)", univariate_relationships_list[[7]])
mean_grass_greening_plot <- univariate_plotting("mean_grass_percentage", "mean grass formation proportion (%)", univariate_relationships_list[[8]])
trend_at_plot <- univariate_plotting("trend_annualtemp", "trend in annual temperature (degree centigrade/year)", univariate_relationships_list[[9]])
trend_re_plot <- univariate_plotting("trend_re", "trend in relative entropy (per year)", univariate_relationships_list[[10]])
trend_ba_plot <- univariate_plotting("trend_burnedarea", "trend in burnedarea proportion (%/yr)", univariate_relationships_list[[11]])
trend_spei_plot <- univariate_plotting("trend_spei", "trend in SPEI (per year)", univariate_relationships_list[[12]])
trend_heatwave_greening_plot <- univariate_plotting("trend_heatwave", "trend in heatwaves", univariate_relationships_list[[13]])
anthropicdist_plot <- univariate_plotting("anthropic_dist", "distance to closest anthropic land use/cover(m)", univariate_relationships_list[[14]])

mean_at_univariate_plotting <- function (var, x_label, univariate_relationship_df){
  data_df <- analyses_df_noNA_nooutliers %>%
      dplyr::select(all_of(var)) %>%
      dplyr::rename(z = 1)
  density <- ggplot(data_df, aes(x = z)) +
    geom_density(colour = "grey70", fill = "grey90", alpha = 0.6) +
    geom_vline(xintercept = quantile(data_df$z, probs=0.1), linetype="dashed") +
    geom_vline(xintercept = quantile(data_df$z, probs=0.9), linetype="dashed") +
      theme_void()
  
  plot <- ggplot(univariate_relationship_df, aes(x = .data[[var]], y = main_effect, group = TrajType, colour = TrajType, fill = TrajType)) +
    geom_ribbon(aes(ymin = lower.ci, ymax = upper.ci), alpha = 0.2) + 
    geom_line(alpha = 0.8, lwd = 0.6) + ylim()
    coord_cartesian(xlim = c(quantile(univariate_relationship_df$var, probs=0.1),quantile(univariate_relationship_df$var, probs=0.9)), ylim = c(0,1)) +
  scale_fill_manual(values = c("#996633", "#669900"), name ="Trajectory Type") + 
  scale_color_manual(values = c("#663300", "#61A36A")) +
  scale_x_continuous(breaks= c(295,296,297,298,299), labels = c(21.85, 22.85, 23.85, 24.85, 25.85))  +
  labs(x = x_label,
         y = "Probability of trajectory type") +
    theme_classic() + theme(legend.position="none")
  
  x<-density + plot +
    patchwork::plot_layout(ncol = 1, nrow = 2, widths = 4, heights = c(1, 4))
}
mean_at_plot <- univariate_plotting("mean_at", "mean annual temperature (degrees centigrade)", univariate_relationships_list[[1]])


gam_plot1 <- ggpubr::ggarrange(plotlist = list(mean_savanna_greening_plot, mean_forest_greening_plot, mean_grass_greening_plot, 
                                               mean_at_plot, mean_re_plot, mean_spei_plot,
                                               mean_heatwave_browning_plot, mean_ba_plot, anthropicdist_plot),
                                             labels=c("a)", "b)", "c)", "d)", "e)", "f)", "g)", "h)", "i)"),
                               ncol = 3, nrow = 3)
gam_plot2 <- ggpubr::ggarrange(plotlist = list(trend_at_plot, trend_re_plot, trend_spei_plot,
                                               trend_heatwave_greening_plot, trend_ba_plot),
                               labels=c("a)", "b)", "c)", "d)", "e)"),
                      ncol = 3, nrow = 3)

ggsave(here("Outputs", "AnalysesResults", "GAMResults", "oneway_variablepartialeffects_means_probability2.png"),
       gam_plot1,dpi = 700, height = 40, width=40, units = "cm")
ggsave(here("Outputs", "AnalysesResults", "GAMResults", "oneway_variablepartialeffects_trends_others_probability2.png"),
       gam_plot2,dpi = 700, height = 40, width=40, units = "cm")



```

#Step 5d- Density plot of variables with the values of different variables to make 2 way and 3 way interaction plots
```{r}
analyses_df_noNA_nooutliers

density_df <- analyses_df_noNA_nooutliers %>% mutate(mean_savanna = mean(mean_savanna_percentage), sd_savanna = sd(mean_savanna_percentage),
                                                     mean_forest = mean(mean_forest_percentage), sd_forest = sd(mean_forest_percentage),
                                                     mean_grass = mean(mean_grass_percentage), sd_grass= sd(mean_grass_percentage),
                                                     mean_re = mean(trend_re), sd_re= sd(trend_re),
                                                     mean_spei = mean(trend_spei), sd_spei= sd(trend_spei))
density_plot_line1 <- function (variable_to_plot, mean1, sd1){
  density <- ggplot(data = density_df, aes(x = .data[[variable_to_plot]])) +
    geom_density(colour = "grey70", fill = "grey90", alpha = 0.6) +
    geom_vline(data = density_df, aes(xintercept = .data[[mean1]]), color= "blue") +
    geom_vline(data = density_df, aes(xintercept = .data[[mean1]] + .data[[sd1]]), color= "red", linetype ="dashed") +
    geom_vline(data = density_df, aes(xintercept = .data[[mean1]] - .data[[sd1]]), linetype ="dashed") +
    theme_minimal()
}

savanna_plot<- density_plot_line1("mean_savanna_percentage", "mean_savanna", "sd_savanna")
ggsave(here("Outputs", "AnalysesResults", "GAMResults", "savanna_plotting_values.png"),
       savanna_plot,dpi = 700, height = 5, width=5, units = "cm")
grass_plot<- density_plot_line1("mean_grass_percentage", "mean_grass", "sd_grass")
ggsave(here("Outputs", "AnalysesResults", "GAMResults", "grass_plotting_values.png"),
       grass_plot,dpi = 700, height = 5, width=5, units = "cm")
forest_plot<- density_plot_line1("mean_forest_percentage", "mean_forest", "sd_forest")
ggsave(here("Outputs", "AnalysesResults", "GAMResults", "forest_plotting_values.png"),
       forest_plot,dpi = 700, height = 5, width=5, units = "cm")


density_plot_line2 <- function (variable_to_plot, mean1, sd1){
  density <- ggplot(data = density_df, aes(x = .data[[variable_to_plot]])) +
    geom_density(colour = "grey70", fill = "grey90", alpha = 0.6) +
    geom_vline(data = density_df, aes(xintercept = 0), color= "blue") +
    geom_vline(data = density_df, aes(xintercept = .data[[mean1]] + .data[[sd1]]), color= "red", linetype ="dashed") +
    geom_vline(data = density_df, aes(xintercept = .data[[mean1]] - .data[[sd1]]), linetype ="dashed") +
    theme_minimal()
}

re_plot<- density_plot_line2("trend_re", "mean_re", "sd_re")
ggsave(here("Outputs", "AnalysesResults", "GAMResults", "re_plotting_values.png"),
       re_plot,dpi = 700, height = 5, width=5, units = "cm")
spei_plot<- density_plot_line2("trend_spei", "mean_spei", "sd_spei")
ggsave(here("Outputs", "AnalysesResults", "GAMResults", "spei_plotting_values.png"),
       spei_plot,dpi = 700, height = 5, width=5, units = "cm")

```

#Step 5e (i) - Plotting maps of probability of greening/browning for a single predictor variable while other predictors are at their mean value
Excluding s(x,y) effect but retaining s(x,y, mean_at) & s(x,y, trend_at) when plotting effect of remaining predictor variables
The reasoning is that then the map of probability of greening/browning is accounting for N-S temperature gradient 
```{r}
mapping_probability_function <- function (driver_variable, gam_model, greening_or_browning){
  df_means <- analyses_df_noNA_nooutliers %>% 
    dplyr::select(-c(x, y, driver_variable)) %>% 
    summarise(across(where(is.numeric), ~mean(.x, na.rm= T)))
  
  df_to_predict<- analyses_df_noNA_nooutliers %>% 
    dplyr::select(c(x, y, driver_variable)) %>% 
    bind_cols(df_means)
  
  pred <- mgcv::predict.bam(gam_model, newdata = df_to_predict, type="terms") 
  pred <- as.data.frame(pred)
  pred <- pred %>% bind_cols(analyses_df_noNA_nooutliers %>% 
    dplyr::select(c(x, y, driver_variable)))
  
  coef_index_trial1 <- grep(paste0("s(",driver_variable,")"),names(pred),fixed = T)
  coef_index_trial2 <- grep(paste0("ti(mean_at,x,y)"),names(pred),fixed = T)
  coef_index_trial3 <- grep(paste0("ti(trend_annualtemp,x,y)"),names(pred),fixed = T)

  effects_cols_indices <- c(coef_index_trial1, coef_index_trial2, coef_index_trial3)
  
  x1Eff <- rowSums(pred [effects_cols_indices])
  x1Eff_inv <- inv.logit(x1Eff + gam_model$coefficients[1])
  x1Eff_inv <- as.data.frame(x1Eff_inv)
  x1Eff_inv <- x1Eff_inv %>% bind_cols(analyses_df_noNA_nooutliers %>% 
    dplyr::select(c(x, y)))
  names(x1Eff_inv)[1]<- "main_effect"
  x1Eff_inv <- x1Eff_inv %>% dplyr::select(x,y, main_effect)
  x_rast <- rast(as.data.frame(x1Eff_inv %>% drop_na()), type="xyz")
  
  writeRaster(x_rast, paste0(here("Outputs", "AnalysesResults", "GAMResults", "SinglePartialEffects_ResultsRasters", greening_or_browning), "/", driver_variable, ".tif"))
}

Sys.time(); mapping_probability_function("mean_at", inc_gam, "Greening"); Sys.time()
Sys.time(); mapping_probability_function("trend_annualtemp", inc_gam, "Greening"); Sys.time()
Sys.time(); mapping_probability_function("mean_re", inc_gam, "Greening"); Sys.time()
Sys.time(); mapping_probability_function("trend_re", inc_gam, "Greening"); Sys.time()
Sys.time(); mapping_probability_function("mean_heatwave", inc_gam, "Greening"); Sys.time()
Sys.time(); mapping_probability_function("trend_heatwave", inc_gam, "Greening"); Sys.time()
Sys.time(); mapping_probability_function("mean_spei", inc_gam, "Greening"); Sys.time()
Sys.time(); mapping_probability_function("trend_spei", inc_gam, "Greening"); Sys.time()
Sys.time(); mapping_probability_function("mean_burnedarea", inc_gam, "Greening"); Sys.time()
Sys.time(); mapping_probability_function("trend_burnedarea", inc_gam, "Greening"); Sys.time()
Sys.time(); mapping_probability_function("mean_savanna_percentage", inc_gam, "Greening"); Sys.time()
Sys.time(); mapping_probability_function("mean_grass_percentage", inc_gam, "Greening"); Sys.time()
Sys.time(); mapping_probability_function("mean_forest_percentage", inc_gam, "Greening"); Sys.time()
Sys.time(); mapping_probability_function("anthropic_dist", inc_gam, "Greening"); Sys.time()

Sys.time(); mapping_probability_function("mean_at", dec_gam, "Browning"); Sys.time()
Sys.time(); mapping_probability_function("trend_annualtemp", dec_gam, "Browning"); Sys.time()
Sys.time(); mapping_probability_function("mean_re", dec_gam, "Browning"); Sys.time()
Sys.time(); mapping_probability_function("trend_re", dec_gam, "Browning"); Sys.time()
Sys.time(); mapping_probability_function("mean_heatwave", dec_gam, "Browning"); Sys.time()
Sys.time(); mapping_probability_function("trend_heatwave", dec_gam, "Browning"); Sys.time()
Sys.time(); mapping_probability_function("mean_spei", dec_gam, "Browning"); Sys.time()
Sys.time(); mapping_probability_function("trend_spei", dec_gam, "Browning"); Sys.time()
Sys.time(); mapping_probability_function("mean_burnedarea", dec_gam, "Browning"); Sys.time()
Sys.time(); mapping_probability_function("trend_burnedarea", dec_gam, "Browning"); Sys.time()
Sys.time(); mapping_probability_function("mean_savanna_percentage", dec_gam, "Browning"); Sys.time()
Sys.time(); mapping_probability_function("mean_grass_percentage", dec_gam, "Browning"); Sys.time()
Sys.time(); mapping_probability_function("mean_forest_percentage", dec_gam, "Browning"); Sys.time()
Sys.time(); mapping_probability_function("anthropic_dist", dec_gam, "Browning"); Sys.time()





```

#Step 5e (ii) - Plotting maps of probability of greening/browning for a combination drivres of climae (trend_at, trend_re and trend_heatwaves, trend_spei). Including s(x,y, mean_at) & s(trend_at, x,y)
```{r}

mapping_probability_function2 <- function (driver_variable1, driver_variable2, gam_model, greening_or_browning){
  df_means <- analyses_df_noNA_nooutliers %>% 
    dplyr::select(-c(x, y, driver_variable1, driver_variable2)) %>% 
    summarise(across(where(is.numeric), ~mean(.x, na.rm= T)))
  
  df_to_predict<- analyses_df_noNA_nooutliers %>% 
    dplyr::select(c(x, y, driver_variable1, driver_variable2)) %>% 
    bind_cols(df_means)
  
  pred <- mgcv::predict.bam(gam_model, newdata = df_to_predict, type="terms") 
  pred <- as.data.frame(pred)
  pred <- pred %>% bind_cols(analyses_df_noNA_nooutliers %>% 
    dplyr::select(c(x, y, driver_variable1, driver_variable2)))
  
  coef_index_trial1 <- grep(paste0("s(",driver_variable1,")"),names(pred),fixed = T)
  coef_index_trial2 <- grep(paste0("s(",driver_variable2,")"),names(pred),fixed = T)
  coef_index_trial3 <- grep(paste0("ti(",driver_variable1, driver_variable2,")"),names(pred),fixed = T)
  coef_index_trial4 <- grep(paste0("ti(mean_at,x,y)"),names(pred),fixed = T)
  coef_index_trial5 <- grep(paste0("ti(trend_annualtemp,x,y)"),names(pred),fixed = T)

  effects_cols_indices <- c(coef_index_trial1, coef_index_trial2, coef_index_trial3, coef_index_trial4, coef_index_trial5)
  
  x1Eff <- rowSums(pred [effects_cols_indices])
  x1Eff_inv <- inv.logit(x1Eff + gam_model$coefficients[1])
  x1Eff_inv <- as.data.frame(x1Eff_inv)
  x1Eff_inv <- x1Eff_inv %>% bind_cols(analyses_df_noNA_nooutliers %>% 
    dplyr::select(c(x, y)))
  names(x1Eff_inv)[1]<- "main_effect"
  x1Eff_inv <- x1Eff_inv %>% dplyr::select(x,y, main_effect)
  x_rast <- rast(as.data.frame(x1Eff_inv %>% drop_na()), type="xyz")
  
  writeRaster(x_rast, paste0(here("Outputs", "AnalysesResults", "GAMResults", "TwoWay_InteractionResults", "ResultsRasters", greening_or_browning), "/", driver_variable1, "_", driver_variable2, ".tif"))
}

Sys.time(); mapping_probability_function2("trend_annualtemp", "trend_re", inc_gam, "Greening"); Sys.time()
Sys.time(); mapping_probability_function2("trend_annualtemp", "trend_re", dec_gam, "Browning"); Sys.time()

Sys.time(); mapping_probability_function2("trend_heatwave", "trend_spei", inc_gam, "Greening"); Sys.time()
Sys.time(); mapping_probability_function2("trend_heatwave", "trend_spei", dec_gam, "Browning"); Sys.time()

```
