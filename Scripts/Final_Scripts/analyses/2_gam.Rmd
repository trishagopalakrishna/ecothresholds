```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, include=FALSE}
library(RColorBrewer)
library(terra)
library(tidyverse)
library(tidyr)
library(here)
library(ggplot2)
library(mgcv)
library(mgcViz)
library(rgl)
library(gratia)
library(gtools)
library(scales)
library(patchwork)
library(purrr)
library(dplyr)
library(ggpubr)

```

##Introduction
In this script, I do GAMs to understand the relationship between different trajectories (from NDVI stl swindow = 11 primarily) and 
various predictor variables. 
(1) Data input of NDVI derived %area of pixel of aggregate trajectories and predictors at 5km
(2) Data processing and structuring for analyses
(3) Exploratory data plots
(4) GAM modeling
(5) Plotting of GAM results

#Step 1- data input
```{r}
#response- binary trajectory (aggregated trajectory types) from NDVI monthly swin 11 stl setting
ndvi_agg_count <- rast (here("Outputs", "TrendsResults", "aggregate_trajectory_results", "monthly_ndvi_agg_count_5km.tif"))

#static drivers
anthropic_dist<- rast(here("Outputs", "OtherVariables", "AnthropicDist", "5km_meandist_20thresholdsanthropicpixel.tif"))
hand<- rast(here("Outputs", "OtherVariables","HAND", "cerrado_hand_5km.tif"))

#trend variables
trend_burnedarea<- rast(here("Outputs", "OtherVariables", "Fire", "theilsen_burnedarea_5km.tif"))
trend_re<- rast(here("Outputs", "OtherVariables", "Climate", "theilsen_re.tif"))
trend_at<- rast(here("Outputs", "OtherVariables", "Climate", "theilsen_at_5km.tif"))
trend_spei<-rast(here("Outputs", "OtherVariables", "Climate", "theilsen_spei.tif"))
trend_heatwave<- rast(here("Outputs", "OtherVariables", "Climate", "theilsen_heatwaves.tif"))

#mean variables
mean_burnedarea<- rast(here("Outputs", "OtherVariables", "Fire", "mean_burnedarea_5km_2002_2021.tif"))
mean_re <- rast(here("Outputs", "OtherVariables", "Climate","mean_annual_relative_entropy_1981_2021.tif") )
mean_at <- rast(here("Outputs", "OtherVariables", "Climate", "mat_1981_2021_5km.tif"))
mean_spei <- rast( here("Outputs", "OtherVariables", "Climate", "mean_annualspei.tif")) 
mean_heatwave <- rast(here("Outputs", "OtherVariables", "Climate", "mean_annual_heatwaves_2002_2021.tif"))

#mean %area of veg formation
mean_savannapercentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "mean_savanna_percentage_5km_2002_2021.tif"))
mean_grasspercentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "mean_grass_percentage_5km_2002_2021.tif"))
mean_forestpercentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "mean_forest_percentage_5km_2002_2021.tif"))

```

#Step 2- data structuring, applying anthropic threshold mask to predictors
```{r}
crop_mask_function <- function(raster_to_be_cropmask){
  x_mask <- terra::mask(raster_to_be_cropmask, ndvi_agg_count[[1]])
  x_mask
}

cm_anthropic_dist <- crop_mask_function(anthropic_dist)
cm_hand <- crop_mask_function(hand)

cm_trend_burnedarea <- crop_mask_function(trend_burnedarea)
cm_trend_re <- crop_mask_function(trend_re)
cm_trend_at <- crop_mask_function(trend_at)
cm_trend_spei <- crop_mask_function(trend_spei)
cm_trend_heatwave <- crop_mask_function(trend_heatwave)

cm_mean_burnedarea <- crop_mask_function(mean_burnedarea)
cm_mean_re <- crop_mask_function(mean_re)
cm_mean_at <- crop_mask_function(mean_at)
cm_mean_spei <- crop_mask_function(mean_spei)
cm_mean_heatwave <- crop_mask_function(mean_heatwave)

cm_mean_forest <- crop_mask_function(mean_forestpercentage)
cm_mean_grass <- crop_mask_function(mean_grasspercentage)
cm_mean_savanna <- crop_mask_function(mean_savannapercentage)

constantdrivers <- c(cm_anthropic_dist, cm_hand, 
                     cm_trend_burnedarea, cm_trend_re, cm_trend_at, cm_trend_spei, cm_trend_heatwave, 
                     cm_mean_burnedarea, cm_mean_re, cm_mean_at, cm_mean_spei, cm_mean_heatwave)

all_vars <- c(ndvi_agg_count, constantdrivers, cm_mean_savanna, cm_mean_grass, cm_mean_forest)
analyses_df <- terra::as.data.frame(all_vars, xy = TRUE)
names(analyses_df) <- c("x", "y", "decrease", 
                    "increase",
                    "notrend",
                    "anthropic_dist", 
                    "hand", 
                    "trend_burnedarea",
                    "trend_re", 
                    "trend_annualtemp", 
                    "trend_spei",
                    "trend_heatwave", 
                    "mean_burnedarea",
                    "mean_re",
                    "mean_at",
                    "mean_spei",
                    "mean_heatwave",
                    "mean_savanna_percentage",
                    "mean_grass_percentage",
                    "mean_forest_percentage")

remove(anthropic_dist, hand, trend_burnedarea, trend_re, trend_at, trend_spei, trend_heatwave,
             mean_burnedarea, mean_re, mean_at, mean_spei, mean_heatwave,
             mean_savannapercentage, mean_grasspercentage, mean_forestpercentage)
remove(cm_anthropic_dist, cm_hand, cm_trend_burnedarea, cm_trend_re, cm_trend_at, cm_trend_spei, cm_trend_heatwave,
             cm_mean_burnedarea, cm_mean_re, cm_mean_at, cm_mean_spei, cm_mean_heatwave,
             cm_mean_savanna, cm_mean_grass, cm_mean_forest)
remove(ndvi_agg_count)
remove(crop_mask_function)
```

#Step 3- eda - understanding the correlations and distributions of all the variables 
```{r}
summary(analyses_df) 

remove_NA <- function (df_analyses){
  analyses_df_noNA <- df_analyses %>% drop_na() 
  analyses_df_noNA
}
analyses_df_NA <- remove_NA(analyses_df)

remove_HAND_outliers <- function (df_analyses_NA){
  no_outliers_sample_df <- df_analyses_NA %>% 
          mutate (IQR = IQR(hand),
                  O_upper = quantile (hand, probs= c(0.75), na.rm= FALSE)+ 1.5*IQR,
                  O_lower = quantile(hand, probs= c(0.25), na.rm= FALSE) - 1.5*IQR
                  ) %>% 
          filter(O_lower <= hand & hand <= O_upper) %>%
          dplyr::select(-c(IQR, O_upper, O_lower))
  no_outliers_sample_df
}
analyses_df_noNA_nooutliers <- remove_HAND_outliers(analyses_df_NA)

plot_df_function <- function (df_noNA_nooutliers){
  pivot_df <- df_noNA_nooutliers %>% 
  dplyr::select(-c(x,y)) %>%
  pivot_longer(1:18)
  
distribution_plot <- ggplot(data = pivot_df, aes(value)) +
  geom_histogram() +facet_wrap(~name, scales = "free", labeller = label_wrap_gen(4)) +
  theme_classic(base_size = 16)
distribution_plot
}
analyses_df_plot <- plot_df_function (analyses_df_noNA_nooutliers)

remove(plot_df_function, remove_HAND_outliers, remove_NA)

```

#Step 4- one model for all variables seperated as step inc and dec
```{r}
Sys.time(); step_inc_model <- mgcv::bam( cbind(increase, 25- increase) ~ s(anthropic_dist, bs= "ts") +
                                          s(hand, bs= "ts") +
                                          s(trend_re, bs= "ts") +
                                          s(trend_annualtemp, bs= "ts") +
                                          s(trend_heatwave, bs ="ts") +
                                          s(trend_spei, bs= "ts") +
                                          s(trend_burnedarea, bs = "ts") +
                                        
                                          s(mean_re, bs= "ts") +
                                          s(mean_at, bs= "ts") +
                                          s(mean_heatwave,  bs= "ts") +
                                          s(mean_spei, bs= "ts") +
                                          s(mean_burnedarea, bs= "ts") +
                                          s(mean_savanna_percentage, bs= "ts") +
                                          s(mean_grass_percentage, bs= "ts") +
                                          s(mean_forest_percentage, bs= "ts")+
                                          
                                          s(x,y, bs= "ts") +
                                          ti(mean_at, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          ti(trend_annualtemp, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          
                                          ti(trend_annualtemp, trend_re, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(trend_heatwave, trend_spei, bs=c("ts", "ts"), k=c(5,5)) +
                                          
                                          ti(anthropic_dist, mean_savanna_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(anthropic_dist, mean_grass_percentage, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(anthropic_dist, mean_forest_percentage, bs=c("ts", "ts"), k=c(5,5)) +  
                                           
                                          ti(anthropic_dist, trend_burnedarea, bs=c("ts", "ts"), k=c(5,5)) +
                                          
                                          ti(trend_burnedarea, mean_savanna_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(trend_burnedarea, mean_grass_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(trend_burnedarea, mean_forest_percentage, bs=c("ts", "ts"), k=c(5,5)) +  
                                          
                                          ti(mean_savanna_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_savanna_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_grass_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_grass_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_forest_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_forest_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                           
                                          ti(trend_burnedarea, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(trend_burnedarea, trend_heatwave, trend_spei, bs=c("ts", "ts", "ts"), k=c(3,3,3)) ,
                                         
                                        data = analyses_df_noNA_nooutliers %>% dplyr::select(-c(decrease, notrend)), 
                                        method = "fREML", 
                                        family = quasibinomial(link = "logit")); Sys.time() 
write_rds(step_inc_model, here("Scripts", "Final_Scripts", "analyses", "onemodel_inc.rds"))

Sys.time(); step_dec_model <- mgcv::bam( cbind(decrease, 25- decrease) ~ s(anthropic_dist, bs= "ts") +
                                          s(hand, bs= "ts") +
                                          s(trend_re, bs= "ts") +
                                          s(trend_annualtemp, bs= "ts") +
                                          s(trend_heatwave, bs ="ts") +
                                          s(trend_spei, bs= "ts") +
                                          s(trend_burnedarea, bs = "ts") +
                                        
                                          s(mean_re, bs= "ts") +
                                          s(mean_at, bs= "ts") +
                                          s(mean_heatwave,  bs= "ts") +
                                          s(mean_spei, bs= "ts") +
                                          s(mean_burnedarea, bs= "ts") +
                                          s(mean_savanna_percentage, bs= "ts") +
                                          s(mean_grass_percentage, bs= "ts") +
                                          s(mean_forest_percentage, bs= "ts")+
                                          
                                          s(x,y, bs= "ts") +
                                          ti(mean_at, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          ti(trend_annualtemp, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          
                                          ti(trend_annualtemp, trend_re, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(trend_heatwave, trend_spei, bs=c("ts", "ts"), k=c(5,5)) +
                                          
                                          ti(anthropic_dist, mean_savanna_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(anthropic_dist, mean_grass_percentage, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(anthropic_dist, mean_forest_percentage, bs=c("ts", "ts"), k=c(5,5)) +  
                                           
                                          ti(anthropic_dist, trend_burnedarea, bs=c("ts", "ts"), k=c(5,5)) +
                                          
                                          ti(trend_burnedarea, mean_savanna_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(trend_burnedarea, mean_grass_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(trend_burnedarea, mean_forest_percentage, bs=c("ts", "ts"), k=c(5,5)) +  
                                          
                                          ti(mean_savanna_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_savanna_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_grass_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_grass_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_forest_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(mean_forest_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                           
                                          ti(trend_burnedarea, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(3,3,3)) +
                                          ti(trend_burnedarea, trend_heatwave, trend_spei, bs=c("ts", "ts", "ts"), k=c(3,3,3)),
                                         
                                        data = analyses_df_noNA_nooutliers %>% dplyr::select(-c(increase, notrend)), 
                                        method = "fREML", 
                                        family = quasibinomial(link = "logit")); Sys.time()
write_rds(step_dec_model, here("Scripts", "Final_Scripts", "analyses", "onemodel_dec.rds"))

step_inc_model$converged
step_dec_model$converged
step_inc_model$mgcv.conv$message
step_dec_model$mgcv.conv$message
step_inc_model$boundary
step_dec_model$boundary

appraise(step_dec_model)
appraise(step_inc_model)

summary(step_inc_model)
summary(step_dec_model)
```

#Step 5a (i) Trends in annual temp and RE across veg formations ### DO NOT RUN 
```{r}
# location
x1 <- -43.2781
y1 <- -4.0213
xaxis_range_len <- 200


inc_pred_trend_at_re <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_annualtemp", "trend_re", 
                                                         inc_gam)
dec_pred_trend_at_re <- grid_creation_prediction(analyses_df, 
                                                         "trend_annualtemp", "trend_re", 
                                                         dec_gam)


plot_inc_trend_at_re <- select_effects_function(analyses_df, 
                                                        "trend_annualtemp", 
                                                        inc_pred_trend_at_re, 
                                                        c(4,16), #4,16 are column indices after removing s(x,y), ti (mean_at, x,y) and ti(trend_annualtemp, x,y)
                                                        "more_uniform_seasonality", "nochange", "less_uniform_seasonality")

plot_dec_trend_at_re <- select_effects_function(analyses_df, 
                                                        "trend_annualtemp", 
                                                        dec_pred_trend_at_re,
                                                        c(4,16),
                                                        "more_uniform_seasonality", "nochange", "less_uniform_seasonality")

combined_plot_df_prep <- function (inc_df, dec_df){
  inc_df <- inc_df %>% mutate(TrajType = "Step_Inc")
  dec_df <- dec_df %>% mutate(TrajType = "Step_Dec")
  plot_df <- bind_rows (inc_df, dec_df)
  plot_df
}

plot_df <- combined_plot_df_prep(plot_inc_trend_at_re, plot_dec_trend_at_re)

plot_function <- function (plot_df, xaxis_var){
  plot_interaction <- ggplot(plot_df, aes(x = .data[[xaxis_var]], y = value,
                                          color = name, linetype = TrajType,
                                          group = interaction(name, TrajType))) +
    geom_line(aes(color = name), linewidth = 1) + 
    theme_classic() +
    scale_color_manual(values=c("#990066", "#333333", "#336600")) + 
    ylab ("Partial Effect") + theme(legend.title=element_blank())
  plot_interaction
}

annualtemp_re <- plot_function(plot_df , "trend_annualtemp")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "TwoWay_InteractionResults", "trend_annualtemp_re.png"), annualtemp_re,
        dpi = 700, height = 25, width=25, units = "cm")

#remove(savanna_plot_df, grass_plot_df, forest_plot_df, plot_dec_grass_trend_at_re, plot_dec_forest_trend_at_re,plot_dec_savanna_trend_at_re,
#      plot_inc_grass_trend_at_re, plot_inc_forest_trend_at_re, plot_inc_savanna_trend_at_re,dec_pred_forest_trend_at_re, inc_pred_forest_trend_at_re,
#      dec_pred_grass_trend_at_re, inc_pred_grass_trend_at_re, dec_pred_savanna_trend_at_re, inc_pred_savanna_trend_at_re)
remove(plot_df, plot_dec_trend_at_re, plot_inc_trend_at_re, dec_pred_trend_at_re, inc_pred_trend_at_re)

```

#Step 5a (ii) Trends in heatwaves and SPEI across veg formations ### DO NOT RUN 
```{r}
inc_pred_trend_heatwave_spei <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_heatwave", "trend_spei", 
                                                         inc_gam)
dec_pred_trend_heatwave_spei <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_heatwave", "trend_spei", 
                                                         dec_gam)

plot_inc_trend_heatwave_spei <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                        "trend_heatwave", 
                                                        inc_pred_trend_heatwave_spei, 
                                                        c(5,17),
                                                        "more_dry", "nochange", "more_wet")

plot_dec_trend_heatwave_spei <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                        "trend_heatwave", 
                                                        dec_pred_trend_heatwave_spei,
                                                        c(5,17),
                                                        "more_dry", "nochange", "more_wet")


plot_df <- combined_plot_df_prep(plot_inc_trend_heatwave_spei , plot_dec_trend_heatwave_spei)


heatwave_spei_vegformation <- plot_function(plot_df , "trend_heatwave")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "TwoWay_InteractionResults", "trend_heatwaves_spei.png"), heatwave_spei_vegformation,
        dpi = 700, height = 25, width=25, units = "cm")
remove(plot_df, plot_dec_trend_heatwave_spei, plot_inc_trend_heatwave_spei, inc_pred_trend_heatwave_spei, dec_pred_trend_heatwave_spei)

```

#Step 5a (iii) Mean anthropic distance and trend in burnedarea ### DO NOT RUN 
```{r}
inc_pred_trend_anthropicdist_burnedarea <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "anthropic_dist", "trend_burnedarea", 
                                                         inc_gam)
dec_pred_trend_anthropicdist_burnedarea <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "anthropic_dist", "trend_burnedarea", 
                                                         dec_gam)



plot_inc_trend_anthropicdist_burnedarea <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                        "anthropic_dist", 
                                                        inc_pred_trend_anthropicdist_burnedarea , 
                                                        c(1,21),
                                                        "more_burnedarea", "nochange", "less_burnedarea")
plot_dec_trend_anthropicdist_burnedarea<- select_effects_function(analyses_df_noNA_nooutliers, 
                                                        "anthropic_dist", 
                                                        dec_pred_trend_anthropicdist_burnedarea,
                                                        c(1,21),
                                                        "more_burnedarea", "nochange", "less_burnedarea")


plot_df <- combined_plot_df_prep(plot_inc_trend_anthropicdist_burnedarea, plot_dec_trend_anthropicdist_burnedarea)

anthropicdist_burnedarea_vegformation <- plot_function(plot_df , "anthropic_dist")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "TwoWay_InteractionResults", "anthropicdist_trend_burnedarea.png"), anthropicdist_burnedarea_vegformation  ,
        dpi = 700, height = 25, width=25, units = "cm")

remove(plot_df, plot_inc_trend_anthropicdist_burnedarea , plot_dec_trend_anthropicdist_burnedarea, inc_pred_trend_anthropicdist_burnedarea , dec_pred_trend_anthropicdist_burnedarea)
```

#Step 5a (iv) Mean anthropic distance and mean veg formation
```{r}
inc_gam <- read_rds(here("Scripts", "Final_Scripts", "analyses", "onemodel_inc.rds"))
dec_gam <- read_rds(here("Scripts", "Final_Scripts", "analyses" ,"onemodel_dec.rds"))


# location
x1 <- -43.2781
y1 <- -4.0213
xaxis_range_len <- 200

grid_creation_prediction <- function (df_analyses, 
                                      xaxis_variable_in_quotes, 
                                      line_variable_in_quotes, 
                                      gam_model,
                                      line_lower_plotting_in_quotes_name,
                                      line_middle_plotting_in_quotes_name,
                                      line_higher_plotting_in_quotes_name){
  #Creating new data and running model
  df_select <- df_analyses %>% dplyr::select(-c(notrend))
  
  var_x <- subset( df_select, select = xaxis_variable_in_quotes)
  var_line <- subset( df_select, select = line_variable_in_quotes)
  var_line <- as.vector(var_line) %>% unlist()
  
  xaxis_range <- seq(min(var_x),max(var_x),len = xaxis_range_len)
  line_range <- c((mean(var_line) - sd(var_line)),mean(var_line), (mean(var_line) + sd(var_line))) #changed middle scenario to be mean of veg formation area
  
  df_means<- df_select %>% dplyr::select(-c(x,y,xaxis_variable_in_quotes, line_variable_in_quotes)) %>%
    summarise(across(where(is.numeric), ~mean(.x, na.rm= T)))
  
  newd <- data.frame(expand.grid(xaxis_range, line_range))
  names(newd) <- c(xaxis_variable_in_quotes, line_variable_in_quotes)
  newd <- newd %>% bind_cols(df_means) %>% mutate(x= x1, y=y1)
  pred <- mgcv::predict.bam(gam_model, newdata = newd, type="terms") 
  pred <- as.data.frame(pred)
  
  #Selecting the coefficients
  ind <- 1:xaxis_range_len
  ind2 <- (xaxis_range_len + 1):(xaxis_range_len*2)
  ind3 <- ((xaxis_range_len*2)+1):(xaxis_range_len*3)
  
  xy_interaction_effects <- grep("x,y",names(pred),fixed = T)
  pred_without_xy_interaction_effects <- (subset(pred, select = -xy_interaction_effects))
  
  coef_index_trial1 <- grep(paste0("s(",xaxis_variable_in_quotes, ")"),names(pred_without_xy_interaction_effects),fixed = T )
  coef_index_trial2 <- grep(paste0("s(",line_variable_in_quotes, ")"),names(pred_without_xy_interaction_effects),fixed = T )
  coef_index_trial3 <- grep(paste0("ti(", xaxis_variable_in_quotes, ",", line_variable_in_quotes, ")"),names(pred_without_xy_interaction_effects),fixed = T)
  
  effects_cols_indices <- c(coef_index_trial1, coef_index_trial2, coef_index_trial3)
  
  x1Eff <- rowSums(pred_without_xy_interaction_effects [ind, effects_cols_indices])
  x2Eff <- rowSums(pred_without_xy_interaction_effects [ind2, effects_cols_indices])
  x3Eff <- rowSums(pred_without_xy_interaction_effects [ind3, effects_cols_indices])
  
  #Estimating 95% CI uncertainty
  X <- mgcv::predict.bam(gam_model, newdata = newd, type ="lpmatrix")
  n.sims <- 1000
  b_sims <- rmvn(n.sims,coef(gam_model), gam_model$Vp) #beta unceratinty
  
  smooth_index_trial1 <- grep(paste0("s(",xaxis_variable_in_quotes, ")"),names(coef(gam_model)),fixed = T) #selecting smooths
  smooth_index_trial2 <- grep(paste0("s(",line_variable_in_quotes, ")"),names(coef(gam_model)),fixed = T )
  smooth_index_trial3 <- grep(paste0("ti(", xaxis_variable_in_quotes, ",", line_variable_in_quotes, ")"),names(coef(gam_model)),fixed = T )

  smooth_index <- c(smooth_index_trial1, smooth_index_trial2, smooth_index_trial3)
  
  X1Eff_without_latlong <- tcrossprod( X[,smooth_index] , b_sims[,smooth_index] ) #spline computation
  
  lower_xEff_1<- as.data.frame(apply(X1Eff_without_latlong[1:200,], 1, quantile,probs = 0.025))
  higher_xEff_1 <- as.data.frame(apply(X1Eff_without_latlong[1:200,], 1, quantile,probs = 0.975))
  ci_xEff <- bind_cols(lower_xEff_1, higher_xEff_1, xaxis_range)
  names(ci_xEff)<- c("lower.ci", "upper.ci", xaxis_variable_in_quotes)
  
  lower_xEff_2 <- as.data.frame(apply(X1Eff_without_latlong[201:400,], 1, quantile,probs = 0.025))
  higher_xEff_2 <- as.data.frame(apply(X1Eff_without_latlong[201:400,], 1, quantile,probs = 0.975))
  ci_xEff_2 <- bind_cols(lower_xEff_2, higher_xEff_2, xaxis_range)
  names(ci_xEff_2)<- c("lower.ci", "upper.ci", xaxis_variable_in_quotes)
  
  lower_xEff_3 <- as.data.frame(apply(X1Eff_without_latlong[401:600,], 1, quantile,probs = 0.025))
  higher_xEff_3 <- as.data.frame(apply(X1Eff_without_latlong[401:600,], 1, quantile,probs = 0.975))
  ci_xEff_3 <- bind_cols(lower_xEff_3, higher_xEff_3, xaxis_range)
  names(ci_xEff_3)<- c("lower.ci", "upper.ci", xaxis_variable_in_quotes)
  
  plot_df <- data.frame(xaxis_colname = xaxis_range)
  low_plot_df <- plot_df %>% mutate(x1Eff_colname = x1Eff, line_variable_type = line_lower_plotting_in_quotes_name)
  names(low_plot_df)<- c(xaxis_variable_in_quotes, "main_effect", "line_variable_type")
  low_plot_df <- left_join(low_plot_df, ci_xEff, by = xaxis_variable_in_quotes)
  
  average_plot_df <- plot_df %>% mutate(x1Eff_colname = x2Eff, line_variable_type = line_middle_plotting_in_quotes_name)
  names(average_plot_df)<- c(xaxis_variable_in_quotes, "main_effect", "line_variable_type")
  average_plot_df <- left_join(average_plot_df, ci_xEff_2, by = xaxis_variable_in_quotes)
  
  high_plot_df <- plot_df %>% mutate(x1Eff_colname = x3Eff, line_variable_type = line_higher_plotting_in_quotes_name)
  names(high_plot_df)<- c(xaxis_variable_in_quotes, "main_effect", "line_variable_type")
  high_plot_df <- left_join(high_plot_df, ci_xEff_3, by = xaxis_variable_in_quotes)
  
  
  final_plot_df <- bind_rows(low_plot_df, average_plot_df, high_plot_df)
  final_plot_df 
}

greening_anthropicdist_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "anthropic_dist", 
                                                           "mean_savanna_percentage",
                                                           inc_gam,
                                                           "low", "average", "high")
browning_anthropicdist_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "anthropic_dist", 
                                                           "mean_savanna_percentage",
                                                           dec_gam,
                                                           "low", "average", "high")

greening_anthropicdist_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "anthropic_dist", 
                                                           "mean_forest_percentage",
                                                           inc_gam,
                                                           "low", "average", "high")
browning_anthropicdist_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "anthropic_dist", 
                                                           "mean_forest_percentage",
                                                           dec_gam,
                                                           "low", "average", "high")
greening_anthropicdist_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "anthropic_dist", 
                                                           "mean_grass_percentage",
                                                           inc_gam,
                                                           "low", "average", "high")
browning_anthropicdist_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "anthropic_dist", 
                                                           "mean_grass_percentage",
                                                           dec_gam,
                                                           "low", "average", "high")

combined_plot_df_prep <- function (greening_results, browning_results, veg_formation_in_quotes){
  greening_results <- greening_results %>% mutate(TrajType = "Greening")
  browning_results <- browning_results %>% mutate(TrajType = "Browning")
  plot_df <- bind_rows (greening_results, browning_results)
  plot_df <- plot_df %>% mutate(VegFormation = veg_formation_in_quotes)
  plot_df
}

savanna_plot_df <- combined_plot_df_prep(greening_anthropicdist_savanna , browning_anthropicdist_savanna, "Savanna")
forest_plot_df <- combined_plot_df_prep(greening_anthropicdist_forest , browning_anthropicdist_forest, "Forest")
grass_plot_df <- combined_plot_df_prep(greening_anthropicdist_grass , browning_anthropicdist_grass, "Grass")


plot_interaction <- function (savanna_df, forest_df, grass_df, xaxis_variable, title){
  savanna_plot<- ggplot(savanna_df, aes(x = .data[[xaxis_variable]], y = main_effect,
                                          color = TrajType, fill =TrajType,
                                          group = interaction(line_variable_type, TrajType))) +
    geom_line(aes(color = TrajType), linewidth = 1) + 
    geom_ribbon(aes(ymin = lower.ci, ymax = upper.ci), alpha = 0.1) +
    facet_wrap(~factor(line_variable_type, c("low", "average", "high")), ncol=1)+
    theme_classic() +
    scale_fill_manual(values = c("#996633", "#669900"))+
    scale_color_manual(values=c("#663300", "#61A36A")) + 
    ylab ("Partial Effect") + theme(legend.position="none")
  
  forest_plot<- ggplot(forest_df, aes(x = .data[[xaxis_variable]], y = main_effect,
                                          color = TrajType, fill =TrajType,
                                          group = interaction(line_variable_type, TrajType))) +
    geom_line(aes(color = TrajType), linewidth = 1) + 
    geom_ribbon(aes(ymin = lower.ci, ymax = upper.ci), alpha = 0.1) +
    facet_wrap(~factor(line_variable_type, c("low", "average", "high")), ncol=1)+
    theme_classic() +
    scale_fill_manual(values = c("#996633", "#669900"))+
    scale_color_manual(values=c("#663300", "#61A36A")) + 
    ylab ("Partial Effect") + theme(legend.position="none")
  
  grass_plot<- ggplot(grass_df, aes(x = .data[[xaxis_variable]], y = main_effect,
                                          color = TrajType, fill =TrajType,
                                          group = interaction(line_variable_type, TrajType))) +
    geom_line(aes(color = TrajType), linewidth = 1) + 
    geom_ribbon(aes(ymin = lower.ci, ymax = upper.ci), alpha = 0.1) +
    facet_wrap(~factor(line_variable_type, c("low", "average", "high")), ncol=1)+
    theme_classic() +
    scale_fill_manual(values = c("#996633", "#669900"))+
    scale_color_manual(values=c("#663300", "#61A36A")) + 
    ylab ("Partial Effect") + theme(legend.position="none")
  
    x <- ggpubr::ggarrange(forest_plot, grass_plot, savanna_plot, nrow = 1, ncol = 3, 
                           labels = c("Forest", "Grass", "Savanna"))
    x<- annotate_figure(x, top = text_grob(title, 
               color = "red", face = "bold", size = 14))
  x
}

anthropicdist_vegformation<- plot_interaction(savanna_plot_df, forest_plot_df, grass_plot_df, "anthropic_dist", "Anthropic Distance x Vegetation")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "TwoWay_InteractionResults", "anthropicdist_vegformation4.png"), anthropicdist_vegformation,
        dpi = 700, height = 25, width=25, units = "cm")

remove(savanna_plot_df, grass_plot_df, forest_plot_df, 
      greening_anthropicdist_forest, greening_anthropicdist_grass, greening_anthropicdist_savanna,
      browning_anthropicdist_forest, browning_anthropicdist_grass, browning_anthropicdist_savanna)     
```


#Step 5a (v) Trend in burnedarea and mean veg formation
```{r}

greening_trendburnedarea_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_burnedarea", 
                                                           "mean_savanna_percentage",
                                                           inc_gam,
                                                           "low", "average", "high")
browning_trendburnedarea_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_burnedarea", 
                                                           "mean_savanna_percentage",
                                                           dec_gam,
                                                           "low", "average", "high")

greening_trendburnedarea_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_burnedarea", 
                                                           "mean_forest_percentage",
                                                           inc_gam,
                                                           "low", "average", "high")
browning_trendburnedarea_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_burnedarea", 
                                                           "mean_forest_percentage",
                                                           dec_gam,
                                                           "low", "average", "high")

greening_trendburnedarea_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_burnedarea", 
                                                           "mean_grass_percentage",
                                                           inc_gam,
                                                           "low", "average", "high")
browning_trendburnedarea_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                           "trend_burnedarea", 
                                                           "mean_grass_percentage",
                                                           dec_gam,
                                                           "low", "average", "high")

savanna_plot_df <- combined_plot_df_prep(greening_trendburnedarea_savanna , browning_trendburnedarea_savanna, "Savanna")
forest_plot_df <- combined_plot_df_prep(greening_trendburnedarea_forest , browning_trendburnedarea_forest, "Forest")
grass_plot_df <- combined_plot_df_prep(greening_trendburnedarea_grass , browning_trendburnedarea_grass, "Grass")

trendburnedarea_vegformation<- plot_interaction(savanna_plot_df, forest_plot_df, grass_plot_df, "trend_burnedarea", "Trend in burned area x Vegetation")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "TwoWay_InteractionResults", "trend_burnedarea_vegformation4.png"), trendburnedarea_vegformation,
        dpi = 700, height = 25, width=25, units = "cm")

remove(savanna_plot_df, grass_plot_df, forest_plot_df, 
      greening_trendburnedarea_forest, greening_trendburnedarea_grass, greening_trendburnedarea_savanna,
      browning_trendburnedarea_forest, browning_trendburnedarea_grass, browning_trendburnedarea_savanna)

```

 #Step 5b (i) - Trends in heatwaves, SPEI across veg formations
```{r}
# location
x1 <- -43.2781
y1 <- -4.0213
xaxis_range_len <- 200


inc_gam <- read_rds(here("Scripts", "Final_Scripts", "analyses", "onemodel_inc.rds"))
dec_gam <- read_rds(here("Scripts", "Final_Scripts", "analyses" ,"onemodel_dec.rds"))


grid_creation_prediction <- function (df_analyses, 
                                      xaxis_variable_in_quotes, 
                                      line_variable_in_quotes,
                                      panel_variable_in_quotes,
                                      panel_variable_type_dec_nochange_inc_quotes,
                                      gam_model,
                                      line_lower_plotting_in_quotes_name,
                                      line_middle_plotting_in_quotes_name,
                                      line_higher_plotting_in_quotes_name){
  #Creating new data and running model
  df_select <- df_analyses %>% dplyr::select(-c(notrend))
  
  var_x <- subset( df_select, select = xaxis_variable_in_quotes)
  var_line <- subset( df_select, select = line_variable_in_quotes)
  var_line <- as.vector(var_line) %>% unlist()
  
  xaxis_range <- seq(min(var_x),max(var_x),len = xaxis_range_len)
  line_range <- c((mean(var_line) - sd(var_line)),mean(var_line), (mean(var_line) + sd(var_line))) #changed middle scenario to be mean of veg formation area
  
  df_means<- df_select %>% dplyr::select(-c(x,y,increase, decrease, xaxis_variable_in_quotes, line_variable_in_quotes, panel_variable_in_quotes)) %>%
    summarise(across(where(is.numeric), ~mean(.x, na.rm= T)))
  
  var_panel <- subset( df_select, select = panel_variable_in_quotes)
  var_panel <- as.vector(var_panel) %>% unlist()
  panel_variable_value <- if(panel_variable_type_dec_nochange_inc_quotes=="dec"){
    mean(var_panel) -sd(var_panel)
  } else{
    if(panel_variable_type_dec_nochange_inc_quotes=="nochange"){
      0
    } else {
      mean(var_panel) + sd(var_panel)
    }
  }
  
  newd <- data.frame(expand.grid(xaxis_range, line_range))
  names(newd) <- c(xaxis_variable_in_quotes, line_variable_in_quotes)
  newd <- newd %>% bind_cols(df_means) %>% mutate(x= x1, y=y1)
  newd <- newd %>% mutate(panel_variable_in_quotes=panel_variable_value)
  names(newd)[17]<- panel_variable_in_quotes
  
  
  pred <- mgcv::predict.bam(gam_model, newdata = newd, type="terms") 
  pred <- as.data.frame(pred)
  
  #Selecting the coefficients
  ind <- 1:xaxis_range_len
  ind2 <- (xaxis_range_len + 1):(xaxis_range_len*2)
  ind3 <- ((xaxis_range_len*2)+1):(xaxis_range_len*3)
  
  xy_interaction_effects <- grep("x,y",names(pred),fixed = T)
  pred_without_xy_interaction_effects <- (subset(pred, select = -xy_interaction_effects))
  
  coef_index_trial1 <- grep(paste0("s(", xaxis_variable_in_quotes, ")"),names(pred_without_xy_interaction_effects),fixed = T )
  coef_index_trial2 <- grep(paste0("s(", line_variable_in_quotes, ")"),names(pred_without_xy_interaction_effects),fixed = T )
  coef_index_trial3 <- grep(paste0("s(", panel_variable_in_quotes, ")"),names(pred_without_xy_interaction_effects),fixed = T )
  coef_index_trial4 <- grep(paste0("ti(", xaxis_variable_in_quotes, ",", panel_variable_in_quotes, ")"),names(pred_without_xy_interaction_effects),fixed = T)
  coef_index_trial5 <- grep(paste0("ti(", line_variable_in_quotes, "," , panel_variable_in_quotes, ",", xaxis_variable_in_quotes, ")"),names(pred_without_xy_interaction_effects),fixed = T)
  
  effects_cols_indices <- c(coef_index_trial1, coef_index_trial2, coef_index_trial3, coef_index_trial4, coef_index_trial5)
  
  x1Eff <- rowSums(pred_without_xy_interaction_effects [ind, effects_cols_indices])
  x2Eff <- rowSums(pred_without_xy_interaction_effects [ind2, effects_cols_indices])
  x3Eff <- rowSums(pred_without_xy_interaction_effects [ind3, effects_cols_indices])
  
  #Estimating 95% CI uncertainty
  X <- mgcv::predict.bam(gam_model, newdata = newd, type ="lpmatrix")
  n.sims <- 1000
  b_sims <- rmvn(n.sims,coef(gam_model), gam_model$Vp) #beta unceratinty
  
  smooth_index_trial1 <- grep(paste0("s(", xaxis_variable_in_quotes, ")"), names(coef(gam_model)),fixed = T) #selecting smooths
  smooth_index_trial2 <- grep(paste0("s(", line_variable_in_quotes, ")"), names(coef(gam_model)),fixed = T )
  smooth_index_trial3 <- grep(paste0("s(", panel_variable_in_quotes, ")"), names(coef(gam_model)),fixed = T )
  smooth_index_trial4 <- grep(paste0("ti(", xaxis_variable_in_quotes, ",", panel_variable_in_quotes, ")"), names(coef(gam_model)),fixed = T)
  smooth_index_trial5 <- grep(paste0("ti(", line_variable_in_quotes, "," , panel_variable_in_quotes, ",", xaxis_variable_in_quotes, ")"),names(coef(gam_model)),fixed = T)

  smooth_index <- c(smooth_index_trial1, smooth_index_trial2, smooth_index_trial3, smooth_index_trial4, smooth_index_trial5)
  
  X1Eff_without_latlong <- tcrossprod( X[,smooth_index] , b_sims[,smooth_index] ) #spline computation
  
  lower_xEff_1<- as.data.frame(apply(X1Eff_without_latlong[1:200,], 1, quantile,probs = 0.025))
  higher_xEff_1 <- as.data.frame(apply(X1Eff_without_latlong[1:200,], 1, quantile,probs = 0.975))
  ci_xEff <- bind_cols(lower_xEff_1, higher_xEff_1, xaxis_range)
  names(ci_xEff)<- c("lower.ci", "upper.ci", xaxis_variable_in_quotes)
  
  lower_xEff_2 <- as.data.frame(apply(X1Eff_without_latlong[201:400,], 1, quantile,probs = 0.025))
  higher_xEff_2 <- as.data.frame(apply(X1Eff_without_latlong[201:400,], 1, quantile,probs = 0.975))
  ci_xEff_2 <- bind_cols(lower_xEff_2, higher_xEff_2, xaxis_range)
  names(ci_xEff_2)<- c("lower.ci", "upper.ci", xaxis_variable_in_quotes)
  
  lower_xEff_3 <- as.data.frame(apply(X1Eff_without_latlong[401:600,], 1, quantile,probs = 0.025))
  higher_xEff_3 <- as.data.frame(apply(X1Eff_without_latlong[401:600,], 1, quantile,probs = 0.975))
  ci_xEff_3 <- bind_cols(lower_xEff_3, higher_xEff_3, xaxis_range)
  names(ci_xEff_3)<- c("lower.ci", "upper.ci", xaxis_variable_in_quotes)
  
  plot_df <- data.frame(xaxis_colname = xaxis_range)
  low_plot_df <- plot_df %>% mutate(x1Eff_colname = x1Eff, line_variable_type = line_lower_plotting_in_quotes_name)
  names(low_plot_df)<- c(xaxis_variable_in_quotes, "main_effect", "line_variable_type")
  low_plot_df <- left_join(low_plot_df, ci_xEff, by = xaxis_variable_in_quotes)
  
  average_plot_df <- plot_df %>% mutate(x1Eff_colname = x2Eff, line_variable_type = line_middle_plotting_in_quotes_name)
  names(average_plot_df)<- c(xaxis_variable_in_quotes, "main_effect", "line_variable_type")
  average_plot_df <- left_join(average_plot_df, ci_xEff_2, by = xaxis_variable_in_quotes)
  
  high_plot_df <- plot_df %>% mutate(x1Eff_colname = x3Eff, line_variable_type = line_higher_plotting_in_quotes_name)
  names(high_plot_df)<- c(xaxis_variable_in_quotes, "main_effect", "line_variable_type")
  high_plot_df <- left_join(high_plot_df, ci_xEff_3, by = xaxis_variable_in_quotes)
  
  
  final_plot_df <- bind_rows(low_plot_df, average_plot_df, high_plot_df)
  final_plot_df 
}


greening_nochangespei_heatwave_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_savanna_percentage",
                                 "trend_spei",
                                 "nochange",
                                 inc_gam,
                                 "low", "average", "high")
browning_nochangespei_heatwave_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_savanna_percentage",
                                 "trend_spei",
                                 "nochange",
                                 dec_gam,
                                 "low", "average", "high")

greening_nochangespei_heatwave_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_forest_percentage",
                                 "trend_spei",
                                 "nochange",
                                 inc_gam,
                                 "low", "average", "high")
browning_nochangespei_heatwave_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_forest_percentage",
                                 "trend_spei",
                                 "nochange",
                                 dec_gam,
                                 "low", "average", "high")
greening_nochangespei_heatwave_grass<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_grass_percentage",
                                 "trend_spei",
                                 "nochange",
                                 inc_gam,
                                 "low", "average", "high")
browning_nochangespei_heatwave_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_grass_percentage",
                                 "trend_spei",
                                 "nochange",
                                 dec_gam,
                                 "low", "average", "high")

savanna_plot_df <- combined_plot_df_prep(greening_nochangespei_heatwave_savanna, browning_nochangespei_heatwave_savanna, "Savanna")
forest_plot_df <- combined_plot_df_prep(greening_nochangespei_heatwave_forest , browning_nochangespei_heatwave_forest, "Forest")
grass_plot_df <- combined_plot_df_prep(greening_nochangespei_heatwave_grass , browning_nochangespei_heatwave_grass, "Grass")

nochangespei_heatwave_vegetation <- plot_interaction(savanna_plot_df, forest_plot_df, grass_plot_df, "trend_heatwave", "No trend in SPEI")

remove(savanna_plot_df, forest_plot_df, grass_plot_df,
       greening_nochangespei_heatwave_forest, greening_nochangespei_heatwave_grass, greening_nochangespei_heatwave_savanna,
       browning_nochangespei_heatwave_forest, browning_nochangespei_heatwave_grass, browning_nochangespei_heatwave_savanna)

greening_decspei_heatwave_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_savanna_percentage",
                                 "trend_spei",
                                 "dec",
                                 inc_gam,
                                 "low", "average", "high")
browning_decspei_heatwave_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_savanna_percentage",
                                 "trend_spei",
                                 "dec",
                                 dec_gam,
                                 "low", "average", "high")

greening_decspei_heatwave_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_forest_percentage",
                                 "trend_spei",
                                 "dec",
                                 inc_gam,
                                 "low", "average", "high")
browning_decspei_heatwave_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_forest_percentage",
                                 "trend_spei",
                                 "dec",
                                 dec_gam,
                                 "low", "average", "high")
greening_decspei_heatwave_grass<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_grass_percentage",
                                 "trend_spei",
                                 "dec",
                                 inc_gam,
                                 "low", "average", "high")
browning_decspei_heatwave_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_grass_percentage",
                                 "trend_spei",
                                 "dec",
                                 dec_gam,
                                 "low", "average", "high")

savanna_plot_df <- combined_plot_df_prep(greening_decspei_heatwave_savanna, browning_decspei_heatwave_savanna, "Savanna")
forest_plot_df <- combined_plot_df_prep(greening_decspei_heatwave_forest , browning_decspei_heatwave_forest, "Forest")
grass_plot_df <- combined_plot_df_prep(greening_decspei_heatwave_grass , browning_decspei_heatwave_grass, "Grass")


decspei_heatwave_vegetation <- plot_interaction(savanna_plot_df, forest_plot_df, grass_plot_df, "trend_heatwave", "Decreasing trend in SPEI")

remove(savanna_plot_df, forest_plot_df, grass_plot_df,
       greening_decspei_heatwave_forest, greening_decspei_heatwave_grass, greening_decspei_heatwave_savanna,
       browning_decspei_heatwave_forest, browning_decpei_heatwave_grass, browning_decspei_heatwave_savanna)

greening_incspei_heatwave_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_savanna_percentage",
                                 "trend_spei",
                                 "inc",
                                 inc_gam,
                                 "low", "average", "high")
browning_incspei_heatwave_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_savanna_percentage",
                                 "trend_spei",
                                 "inc",
                                 dec_gam,
                                 "low", "average", "high")

greening_incspei_heatwave_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_forest_percentage",
                                 "trend_spei",
                                 "inc",
                                 inc_gam,
                                 "low", "average", "high")
browning_incspei_heatwave_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_forest_percentage",
                                 "trend_spei",
                                 "inc",
                                 dec_gam,
                                 "low", "average", "high")
greening_incspei_heatwave_grass<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_grass_percentage",
                                 "trend_spei",
                                 "inc",
                                 inc_gam,
                                 "low", "average", "high")
browning_incspei_heatwave_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_heatwave",
                                 "mean_grass_percentage",
                                 "trend_spei",
                                 "inc",
                                 dec_gam,
                                 "low", "average", "high")

savanna_plot_df <- combined_plot_df_prep(greening_incspei_heatwave_savanna, browning_incspei_heatwave_savanna, "Savanna")
forest_plot_df <- combined_plot_df_prep(greening_incspei_heatwave_forest , browning_incspei_heatwave_forest, "Forest")
grass_plot_df <- combined_plot_df_prep(greening_incspei_heatwave_grass , browning_incspei_heatwave_grass, "Grass")

incspei_heatwave_vegetation <- plot_interaction(savanna_plot_df, forest_plot_df, grass_plot_df, "trend_heatwave", "Increasing trend in SPEI")

remove(savanna_plot_df, forest_plot_df, grass_plot_df,
       greening_incspei_heatwave_forest, greening_incspei_heatwave_grass, greening_incspei_heatwave_savanna,
       browning_incspei_heatwave_forest, browning_incspei_heatwave_grass, browning_incspei_heatwave_savanna)

nochangespei_heatwave_vegetation
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "ThreeWay_InteractionResults", "nochangespei_heatwave_vegetation.png"), nochangespei_heatwave_vegetation,
        dpi = 700, height = 40, width=40, units = "cm")
decspei_heatwave_vegetation
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "ThreeWay_InteractionResults", "decspei_heatwave_vegetation.png"), decspei_heatwave_vegetation,
        dpi = 700, height = 40, width=40, units = "cm")
incspei_heatwave_vegetation
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "ThreeWay_InteractionResults", "incspei_heatwave_vegetation.png"), incspei_heatwave_vegetation,
        dpi = 700, height = 40, width= 40, units = "cm")

```

#Step 5b (ii) - Trends in annual temp, RE across veg formations
```{r}
greening_nochangere_at_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_savanna_percentage",
                                 "trend_re",
                                 "nochange",
                                 inc_gam,
                                 "low", "average", "high")
browning_nochangere_at_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_savanna_percentage",
                                 "trend_re",
                                 "nochange",
                                 dec_gam,
                                 "low", "average", "high")

greening_nochangere_at_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_forest_percentage",
                                 "trend_re",
                                 "nochange",
                                 inc_gam,
                                 "low", "average", "high")
browning_nochangere_at_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_forest_percentage",
                                 "trend_re",
                                 "nochange",
                                 dec_gam,
                                 "low", "average", "high")
greening_nochangere_at_grass<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_grass_percentage",
                                 "trend_re",
                                 "nochange",
                                 inc_gam,
                                 "low", "average", "high")
browning_nochangere_at_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_grass_percentage",
                                 "trend_re",
                                 "nochange",
                                 dec_gam,
                                 "low", "average", "high")

savanna_plot_df <- combined_plot_df_prep(greening_nochangere_at_savanna, browning_nochangere_at_savanna, "Savanna")
forest_plot_df <- combined_plot_df_prep(greening_nochangere_at_forest , browning_nochangere_at_forest, "Forest")
grass_plot_df <- combined_plot_df_prep(greening_nochangere_at_grass , browning_nochangere_at_grass, "Grass")

nochangere_annualtemp_vegetation <- plot_interaction(savanna_plot_df, forest_plot_df, grass_plot_df, "trend_annualtemp", "No trend in RE")

remove(savanna_plot_df, grass_plot_df, forest_plot_df,
       greening_nochangere_at_forest, greening_nochangere_at_grass, greening_nochangere_at_savanna,
       browning_nochangere_at_forest, browning_nochangere_at_grass, browning_nochangere_at_savanna)

greening_decre_at_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_savanna_percentage",
                                 "trend_re",
                                 "dec",
                                 inc_gam,
                                 "low", "average", "high")
browning_decre_at_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_savanna_percentage",
                                 "trend_re",
                                 "dec",
                                 dec_gam,
                                 "low", "average", "high")

greening_decre_at_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_forest_percentage",
                                 "trend_re",
                                 "dec",
                                 inc_gam,
                                 "low", "average", "high")
browning_decre_at_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_forest_percentage",
                                 "trend_re",
                                 "dec",
                                 dec_gam,
                                 "low", "average", "high")

greening_decre_at_grass<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_grass_percentage",
                                 "trend_re",
                                 "dec",
                                 inc_gam,
                                 "low", "average", "high")
browning_decre_at_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_grass_percentage",
                                 "trend_re",
                                 "dec",
                                 dec_gam,
                                 "low", "average", "high")

savanna_plot_df <- combined_plot_df_prep(greening_decre_at_savanna, browning_decre_at_savanna, "Savanna")
forest_plot_df <- combined_plot_df_prep(greening_decre_at_forest , browning_decre_at_forest, "Forest")
grass_plot_df <- combined_plot_df_prep(greening_decre_at_grass , browning_decre_at_grass, "Grass")

decre_annualtemp_vegetation <- plot_interaction(savanna_plot_df, forest_plot_df, grass_plot_df, "trend_annualtemp", "Decreasing trend in RE")

remove(savanna_plot_df, grass_plot_df, forest_plot_df,
       greening_decre_at_forest, greening_decre_at_grass, greening_decre_at_savanna,
       browning_decre_at_forest, browning_decre_at_grass, browning_decre_at_savanna)

greening_incre_at_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_savanna_percentage",
                                 "trend_re",
                                 "inc",
                                 inc_gam,
                                 "low", "average", "high")
browning_incre_at_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_savanna_percentage",
                                 "trend_re",
                                 "inc",
                                 dec_gam,
                                 "low", "average", "high")

greening_incre_at_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_forest_percentage",
                                 "trend_re",
                                 "inc",
                                 inc_gam,
                                 "low", "average", "high")
browning_incre_at_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_forest_percentage",
                                 "trend_re",
                                 "inc",
                                 dec_gam,
                                 "low", "average", "high")

greening_incre_at_grass<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_grass_percentage",
                                 "trend_re",
                                 "inc",
                                 inc_gam,
                                 "low", "average", "high")
browning_incre_at_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                 "trend_annualtemp",
                                 "mean_grass_percentage",
                                 "trend_re",
                                 "inc",
                                 dec_gam,
                                 "low", "average", "high")

savanna_plot_df <- combined_plot_df_prep(greening_incre_at_savanna, browning_incre_at_savanna, "Savanna")
forest_plot_df <- combined_plot_df_prep(greening_incre_at_forest , browning_incre_at_forest, "Forest")
grass_plot_df <- combined_plot_df_prep(greening_incre_at_grass , browning_incre_at_grass, "Grass")

incre_annualtemp_vegetation <- plot_interaction(savanna_plot_df, forest_plot_df, grass_plot_df, "trend_annualtemp", "Increasing trend in RE")

remove(savanna_plot_df, grass_plot_df, forest_plot_df,
       greening_incre_at_forest, greening_incre_at_grass, greening_incre_at_savanna,
       browning_incre_at_forest, browning_incre_at_grass, browning_incre_at_savanna)

nochangere_annualtemp_vegetation
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "ThreeWay_InteractionResults", "nochangere_annualtemp_vegetation.png"), nochangere_annualtemp_vegetation,
        dpi = 700, height = 40, width=40, units = "cm")
decre_annualtemp_vegetation
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "ThreeWay_InteractionResults", "decre_annualtemp_vegetation.png"), decre_annualtemp_vegetation,
        dpi = 700, height = 40, width=40, units = "cm")
incre_annualtemp_vegetation
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "ThreeWay_InteractionResults", "incre_annualtemp_vegetation.png"), incre_annualtemp_vegetation,
        dpi = 700, height = 40, width= 40, units = "cm")


```

#Step 5b (iii) - Trends in burned area, annual temp and re  ### DO NOT RUN 

#Step 5c - Visualization of univariate relationships considering only data of the driver within 90% percentile 
```{r}
increase_model_extractsmooths <- function (gam_model, outputsmooth_file_name_in_quotes){
  significant_onevariable_smooths <- gratia::smooth_estimates(gam_model,
                                                select = c("s(anthropic_dist)", "s(trend_re)",
                                                           "s(trend_annualtemp)",  "s(trend_heatwave)", 
                                                           "s(trend_spei)", "s(trend_burnedarea)",
                                                           "s(mean_re)", "s(mean_at)", "s(mean_spei)", 
                                                           "s(mean_burnedarea)", "s(mean_savanna_percentage)",
                                                           "s(mean_grass_percentage)", "s(mean_forest_percentage)"),
                                                n=100, unconditional = TRUE) %>%
  mutate(intercept_no_uncertainty = gam_model$coefficients[1],
         intercept_add_estimate = .estimate + intercept_no_uncertainty,
         
         intercept_estimate_ci_low = intercept_add_estimate - .se*1.96,
         intercept_estimate_ci_high = intercept_add_estimate + .se*1.96,
         
         se_low_inv = inv.logit(intercept_estimate_ci_low),
         se_high_inv = inv.logit(intercept_estimate_ci_high),
         estimate_inv = inv.logit(intercept_add_estimate))
  significant_onevariable_smooths 
}
increase_significant_onevariablesmooths <- increase_model_extractsmooths(inc_gam)
increase_significant_onevariablesmooths <- increase_significant_onevariablesmooths %>% mutate(TrajType ="Greening")

decrease_model_extractsmooths <- function (gam_model, outputsmooth_file_name_in_quotes){
  significant_onevariable_smooths <- gratia::smooth_estimates(gam_model,
                                                select = c("s(anthropic_dist)", "s(trend_re)",
                                                           "s(trend_annualtemp)", "s(trend_spei)", "s(trend_burnedarea)",
                                                           "s(mean_re)", "s(mean_at)", "s(mean_heatwave)",
                                                           "s(mean_spei)", "s(mean_burnedarea)",
                                                           "s(mean_grass_percentage)", "s(mean_forest_percentage)"),
                                                n=100, unconditional = TRUE) %>%
  mutate(intercept_no_uncertainty = gam_model$coefficients[1],
         intercept_add_estimate = .estimate + intercept_no_uncertainty,
         
         intercept_estimate_ci_low = intercept_add_estimate - .se*1.96,
         intercept_estimate_ci_high = intercept_add_estimate + .se*1.96,
         
         se_low_inv = inv.logit(intercept_estimate_ci_low),
         se_high_inv = inv.logit(intercept_estimate_ci_high),
         estimate_inv = inv.logit(intercept_add_estimate))
  significant_onevariable_smooths
}
decrease_significant_onevariablesmooths <- decrease_model_extractsmooths(dec_gam)
decrease_significant_onevariablesmooths <- decrease_significant_onevariablesmooths %>% mutate(TrajType ="Browning")

bothmodels_all_commonvar_labels <- read_csv(here("Outputs", "AnalysesResults", "GAMResults", "both_model_common_var_labels.csv"))
bothmodels_all_commonvar_list <- bothmodels_all_commonvar_labels$vars
bothmodels_all_commonvar_plots <- list(length = length(bothmodels_all_commonvar_list))

commonvar_plots <- purrr::map(bothmodels_all_commonvar_list, function(var){
  
     x_label <- bothmodels_all_commonvar_labels$label[bothmodels_all_commonvar_labels$vars == var]
    if (bothmodels_all_commonvar_labels$parse[bothmodels_all_commonvar_labels$vars == var]) {
      x_label <- parse(text = x_label)
    }
  
  data_df <- analyses_df_noNA_nooutliers %>%
      dplyr::select(all_of(var)) %>%
      dplyr::rename(z = 1)
  density <- ggplot(data_df, aes(x = z)) +
    geom_density(colour = "grey70", fill = "grey90", alpha = 0.6) +
    geom_vline(xintercept = quantile(data_df$z, probs=0.1), linetype="dashed") +
    geom_vline(xintercept = quantile(data_df$z, probs=0.9), linetype="dashed") +
      theme_void()
  
  increase_smooth_df <- increase_significant_onevariablesmooths  %>%
    dplyr::select(.smooth, .type, estimate_inv, se_low_inv, se_high_inv, all_of(var), TrajType) %>%
    rename(var0 = 6) %>%
    drop_na() %>% 
    filter(var0 > quantile(var0, probs=0.1) & var0 < quantile (var0, probs =0.9))
    
  decrease_smooth_df <- decrease_significant_onevariablesmooths  %>%
    dplyr::select(.smooth, .type, estimate_inv, se_low_inv, se_high_inv, all_of(var), TrajType) %>%
    rename(var0 = 6) %>%
    drop_na() %>%
    filter(var0 > quantile(var0, probs=0.1) & var0 < quantile (var0, probs =0.9))
  smooth_df <- bind_rows(increase_smooth_df, decrease_smooth_df)  
  
  plot <- ggplot(smooth_df, aes(x = var0, y = estimate_inv, group = TrajType, colour = TrajType, fill = TrajType)) +
    geom_ribbon(aes(ymin = se_low_inv, ymax = se_high_inv), alpha = 0.2) + 
    geom_line(alpha = 0.8, lwd = 0.6) + 
    coord_cartesian(xlim = c(quantile(smooth_df$var0, probs=0.1),quantile(smooth_df$var0, probs=0.9)), ylim = c(0,1)) +
  scale_fill_manual(values = c("#996633", "#669900"), name ="Trajectory Type") + 
  scale_color_manual(values = c("#663300", "#61A36A")) +
  scale_x_continuous( labels = label_number()) +
  labs(x = x_label,
         y = "Probability of trajectory type") +
    theme_classic() + theme(legend.position="none")
  
  x<-density + plot +
    patchwork::plot_layout(ncol = 1, nrow = 2, widths = 4, heights = c(1, 4))
})

#additional plots of variables significant only in one model
additional_plots <- function (var, model_smooth_df, x_label, fill_color, line_color){
  data_df <- analyses_df_noNA_nooutliers %>%
      dplyr::select(var) %>%
      dplyr::rename(z = 1)
  density <- ggplot(data_df, aes(x = z)) +
      geom_density(colour = "grey70", fill = "grey90", alpha = 0.6) +
    geom_vline(xintercept = quantile(data_df$z, probs=0.1), linetype="dashed") +
    geom_vline(xintercept = quantile(data_df$z, probs=0.9), linetype="dashed") +
      theme_void() 
  
  smooth_df <- model_smooth_df  %>%
      dplyr::select(.smooth, .type, estimate_inv, se_low_inv, se_high_inv, all_of(var), TrajType) %>%
      rename(var0 = 6) %>%
      drop_na() %>%
     filter(var0 > quantile(var0, probs=0.1) & var0 < quantile (var0, probs =0.9))
  
  plot <- ggplot(smooth_df, aes(x = var0, y = estimate_inv, group = TrajType, colour = TrajType, fill = TrajType)) +
    geom_ribbon(aes(ymin = se_low_inv, ymax = se_high_inv), alpha = 0.2) + 
    geom_line(alpha = 0.8, lwd = 0.6) + 
    coord_cartesian(xlim = c(quantile(smooth_df$var0, probs=0.1),quantile(smooth_df$var0, probs=0.9)), ylim = c(0,1)) +
  scale_fill_manual(values = fill_color, name ="Trajectory Type") + 
  scale_color_manual(values = line_color) +
  scale_x_continuous( labels = label_number()) +
  labs(x = x_label,
         y = "Probability of trajectory type") +
    theme_classic() + theme(legend.position="none")
  
  x <- density + plot +
    patchwork::plot_layout(ncol = 1, nrow = 2, widths = 4, heights = c(1, 4))
  x
}
mean_savanna_increase <- additional_plots("mean_savanna_percentage", increase_significant_onevariablesmooths, "mean savanna formation proportion (%)", "#669900", "#61A36A")
trend_heatwave_increase <- additional_plots("trend_heatwave", increase_significant_onevariablesmooths, "trend in heatwaves","#669900", "#61A36A")
mean_heatwave_decrease <- additional_plots("mean_heatwave", decrease_significant_onevariablesmooths, "mean number of heatwaves", "#996633", "#663300")


mean_annual_temp <- function (var, x_label){
  data_df <- analyses_df_noNA_nooutliers %>%
      dplyr::select(all_of(var)) %>%
      dplyr::rename(z = 1)
  density <- ggplot(data_df, aes(x = z)) +
    geom_density(colour = "grey70", fill = "grey90", alpha = 0.6) +
    geom_vline(xintercept = quantile(data_df$z, probs=0.1), linetype="dashed") +
    geom_vline(xintercept = quantile(data_df$z, probs=0.9), linetype="dashed") +
      theme_void()
  
  increase_smooth_df <- increase_significant_onevariablesmooths  %>%
    dplyr::select(.smooth, .type, estimate_inv, se_low_inv, se_high_inv, all_of(var), TrajType) %>%
    rename(var0 = 6) %>%
    drop_na() %>% 
    filter(var0 > quantile(var0, probs=0.1) & var0 < quantile (var0, probs =0.9))
    
  decrease_smooth_df <- decrease_significant_onevariablesmooths  %>%
    dplyr::select(.smooth, .type, estimate_inv, se_low_inv, se_high_inv, all_of(var), TrajType) %>%
    rename(var0 = 6) %>%
    drop_na() %>%
    filter(var0 > quantile(var0, probs=0.1) & var0 < quantile (var0, probs =0.9))
  smooth_df <- bind_rows(increase_smooth_df, decrease_smooth_df)  
  
  plot <- ggplot(smooth_df, aes(x = var0, y = estimate_inv, group = TrajType, colour = TrajType, fill = TrajType)) +
    geom_ribbon(aes(ymin = se_low_inv, ymax = se_high_inv), alpha = 0.2) + 
    geom_line(alpha = 0.8, lwd = 0.6) + 
    coord_cartesian(xlim = c(quantile(smooth_df$var0, probs=0.1),quantile(smooth_df$var0, probs=0.9)), ylim = c(0,1)) +
  scale_fill_manual(values = c("#996633", "#669900"), name ="Trajectory Type") + 
  scale_color_manual(values = c("#663300", "#61A36A")) +
  scale_x_continuous(breaks= c(295,296,297,298,299), labels = c(21.85, 22.85, 23.85, 24.85, 25.85))  +
  labs(x = x_label,
         y = "Probability of trajectory type") +
    theme_classic() + theme(legend.position="none")
  
  x<-density + plot +
    patchwork::plot_layout(ncol = 1, nrow = 2, widths = 4, heights = c(1, 4))
}
mean_at_plot <- mean_annual_temp ("mean_at", "mean annual temperature (degrees centigrade)")


gam_plot1 <- ggpubr::ggarrange(plotlist = commonvar_plots[c(1,6:10)], mean_savanna_increase, mean_at_plot, mean_heatwave_decrease, labels=c("a)", "b)", "c)", "d)", "e)", "f)", "g)", "h)", "i)"),ncol = 3, nrow = 3, common.legend = TRUE)
gam_plot2 <- ggpubr::ggarrange(plotlist = commonvar_plots[c(2:5)], trend_heatwave_increase, 
                               labels=c("a)", "b)", "c)", "d)", "e)"),
                      ncol = 3, nrow = 3, common.legend = TRUE)

ggsave(here("Outputs", "AnalysesResults", "GAMResults", "oneway_variablepartialeffects_means_probability.png"),
       gam_plot1,dpi = 700, height = 40, width=40, units = "cm")
ggsave(here("Outputs", "AnalysesResults", "GAMResults", "oneway_variablepartialeffects_trends_others_probability.png"),
       gam_plot2,dpi = 700, height = 40, width=40, units = "cm")

```

#Step 5d- Density plot of variables with the values of different variables to make plots
```{r}
analyses_df_noNA_nooutliers

density_df <- analyses_df_noNA_nooutliers %>% mutate(mean_savanna = mean(mean_savanna_percentage), sd_savanna = sd(mean_savanna_percentage),
                                                     mean_forest = mean(mean_forest_percentage), sd_forest = sd(mean_forest_percentage),
                                                     mean_grass = mean(mean_grass_percentage), sd_grass= sd(mean_grass_percentage),
                                                     mean_re = mean(trend_re), sd_re= sd(trend_re),
                                                     mean_spei = mean(trend_spei), sd_spei= sd(trend_spei))
density_plot_line1 <- function (variable_to_plot, mean1, sd1){
  density <- ggplot(data = density_df, aes(x = .data[[variable_to_plot]])) +
    geom_density(colour = "grey70", fill = "grey90", alpha = 0.6) +
    geom_vline(data = density_df, aes(xintercept = .data[[mean1]]), color= "blue") +
    geom_vline(data = density_df, aes(xintercept = .data[[mean1]] + .data[[sd1]]), color= "red", linetype ="dashed") +
    geom_vline(data = density_df, aes(xintercept = .data[[mean1]] - .data[[sd1]]), linetype ="dashed") +
    theme_minimal()
}

savanna_plot<- density_plot_line1("mean_savanna_percentage", "mean_savanna", "sd_savanna")
ggsave(here("Outputs", "AnalysesResults", "GAMResults", "savanna_plotting_values.png"),
       savanna_plot,dpi = 700, height = 5, width=5, units = "cm")
grass_plot<- density_plot_line1("mean_grass_percentage", "mean_grass", "sd_grass")
ggsave(here("Outputs", "AnalysesResults", "GAMResults", "grass_plotting_values.png"),
       grass_plot,dpi = 700, height = 5, width=5, units = "cm")
forest_plot<- density_plot_line1("mean_forest_percentage", "mean_forest", "sd_forest")
ggsave(here("Outputs", "AnalysesResults", "GAMResults", "forest_plotting_values.png"),
       forest_plot,dpi = 700, height = 5, width=5, units = "cm")


density_plot_line2 <- function (variable_to_plot, mean1, sd1){
  density <- ggplot(data = density_df, aes(x = .data[[variable_to_plot]])) +
    geom_density(colour = "grey70", fill = "grey90", alpha = 0.6) +
    geom_vline(data = density_df, aes(xintercept = 0), color= "blue") +
    geom_vline(data = density_df, aes(xintercept = .data[[mean1]] + .data[[sd1]]), color= "red", linetype ="dashed") +
    geom_vline(data = density_df, aes(xintercept = .data[[mean1]] - .data[[sd1]]), linetype ="dashed") +
    theme_minimal()
}

re_plot<- density_plot_line2("trend_re", "mean_re", "sd_re")
ggsave(here("Outputs", "AnalysesResults", "GAMResults", "re_plotting_values.png"),
       re_plot,dpi = 700, height = 5, width=5, units = "cm")
spei_plot<- density_plot_line2("trend_spei", "mean_spei", "sd_spei")
ggsave(here("Outputs", "AnalysesResults", "GAMResults", "spei_plotting_values.png"),
       spei_plot,dpi = 700, height = 5, width=5, units = "cm")

```