```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, include=FALSE}
library(RColorBrewer)
library(terra)
library(lattice)
library(tidyverse)
library(here)
library(ggplot2)
library(mgcv)
library(mgcViz)
library(rgl)
library(gratia)
library(gtools)

```

##Introduction
In this script, I do GAMs to understand the relationship between different trajectories (from NDVI stl swindow = 11) and 
various predictor variables. 

#Step 1- data input- predictors
```{r}
#response- binary trajectory (all 9) from NDVI swin 11 stl setting
monthly_input_file_path <- here("Outputs", "TrendsResults", "results_rasters", "monthly", "binary_count_5km")
monthly_file_list<- list.files(path = monthly_input_file_path, pattern = paste0("*","ndvi_","*"), all.files = T, full.names = T)
monthly_file_list <- gtools::mixedsort(monthly_file_list)
monthly_ndvi_trajectories<- lapply(monthly_file_list, rast)

#drivers
anthropic_dist<- rast(here("Outputs", "OtherVariables", "AnthropicDist", "5km_meandist_20thresholdsanthropicpixel.tif"))
burnedarea<- rast(here("Outputs", "OtherVariables", "Fire", "theilsen_burnedarea_5km.tif"))
hand<- rast(here("Outputs", "OtherVariables","HAND", "cerrado_hand_5km.tif"))
re<- rast(here("Outputs", "OtherVariables", "Climate", "theilsen_re.tif"))
at<- rast(here("Outputs", "OtherVariables", "Climate", "theilsen_at_5km.tif"))
spei<-rast(here("Outputs", "OtherVariables", "Climate", "theilsen_spei.tif"))
heatwave<- rast(here("Outputs", "OtherVariables", "Climate", "theilsen_heatwaves.tif"))
forestpercentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "theilsen_forestpercentage.tif"))
savannapercentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "theilsen_savannapercentage.tif"))
grasspercentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "theilsen_grasspercentage.tif"))
mat <- rast(here("Outputs", "OtherVariables", "Climate", "mat_1981_2021_5km.tif"))
mean_heatwave <- rast(here("Outputs", "OtherVariables", "Climate", "mean_annual_heatwaves_2002_2021.tif"))
mean_burnedarea<- rast(here("Outputs", "OtherVariables", "Fire", "mean_burnedarea_5km_2002_2021.tif"))
mean_annual_re <- rast(here("Outputs", "OtherVariables", "Climate","mean_annual_relative_entropy_1981_2021.tif") )
mean_savannaperentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "mean_savanna_percentage_5km_2002_2021.tif"))
mean_spei <- rast( here("Outputs", "OtherVariables", "Climate", "mean_annualspei.tif")) 
```

#Step 2- data structuring and applying anthropic threshold mask to predictors
```{r}
drivers<- c(anthropic_dist, burnedarea, hand, re, at, spei,  heatwave, forestpercentage, savannapercentage, grasspercentage, mat, mean_heatwave, mean_burnedarea, mean_annual_re, mean_savannaperentage, mean_spei )

drivers_masked <- terra::mask(drivers, monthly_ndvi_trajectories[[1]])

all_data<- c(monthly_ndvi_trajectories[[1]], drivers_masked)
names(all_data)<- c("ndvi_monthly_lin_dec", 
                    "ndvi_monthly_lin_inc",
                    "ndvi_monthly_stable",
                    "ndvi_monthly_step_dec",
                    "ndvi_monthly_step_inc",
                    "ndvi_monthly_quad_dec_acc",
                    "ndvi_monthly_quad_dec_decc",
                    "ndvi_monthly_quad_inc_acc",
                    "ndvi_monthly_quad_inc_dec",
                    "anthropic_dist", 
                    "trend_burnedarea", 
                    "hand", 
                    "trend_re", 
                    "trend_annualtemp", 
                    "trend_spei",
                    "trend_heatwave", 
                    "trend_forestpercentage", 
                    "trend_savannapercentage", 
                    "trend_grasspercentage",
                    "mat",
                    "mean_heatwave",
                    "mean_burnedarea",
                    "mean_re",
                    "mean_savannapercentage",
                    "mean_spei")

analyses_df<- terra::as.data.frame(all_data, xy = TRUE)

remove(monthly_ndvi_trajectories, anthropic_dist, burnedarea, hand, re, mat,at, spei, heatwave, forestpercentage, savannapercentage, grasspercentage)
remove(drivers_masked, drivers)
remove(monthly_file_list, monthly_input_file_path)
remove(mean_annual_re, mean_burnedarea, mean_heatwave, mean_savannaperentage, mean_spei)
```

#Step 3- eda - understanding the correlations and distributions of all the variables 
```{r}
analyses_df
summary(analyses_df)
analyses_df_noNA <- analyses_df %>% drop_na() #Removing rows with NA values
summary(analyses_df_noNA)

library(PerformanceAnalytics)
chart.Correlation(analyses_df_noNA, histogram = TRUE, method = "spearman", pch= 19)


#Removing outliers considering distribution of HAND
no_outliers_sample_df <- analyses_df_noNA %>% 
          mutate (IQR = IQR(hand),
                  O_upper = quantile (hand, probs= c(0.75), na.rm= FALSE)+ 1.5*IQR,
                  O_lower = quantile(hand, probs= c(0.25), na.rm= FALSE) - 1.5*IQR
                  ) %>% 
          filter(O_lower <= hand & hand <= O_upper) %>%
          dplyr::select(-c(IQR, O_upper, O_lower))

chart.Correlation(no_outliers_sample_df %>% dplyr::select(-c(trend_forestpercentage, trend_grasspercentage)), histogram = TRUE, method = "spearman",  pch= 19)

#plot
pivot_df <- no_outliers_sample_df %>% dplyr::select(-c(x,y, trend_forestpercentage, trend_grasspercentage)) %>%
  pivot_longer(1:23)
distribution_plot <- ggplot(data = pivot_df, aes(value)) +
  geom_histogram() +facet_wrap(~name, scales = "free", labeller = label_wrap_gen(4)) +
  theme_classic(base_size = 16)

#for_theo_pivot <-  no_outliers_sample_df %>% dplyr::select(c(ndvi_monthly_step_inc, anthropic_dist,
#                                                             trend_burnedarea, hand, re, trend_annualtemp,
#                                                             trend_heatwave, trend_savannapercentage, mat)) %>%
#  pivot_longer(1:9)
#for_theo_fig <- ggplot(data = for_theo_pivot, aes(value)) +
#  geom_histogram() +facet_wrap(~name, scales = "free", labeller = label_wrap_gen(4)) +
#  theme_classic(base_size = 16)

```
Firstly, the response variable instability % area (from NDVI) is right skewed. There are significant large correlations (>0.7) between predictor variables anthropic distance and trends in annual temperature, trends in burned area% and forest area%m HAND and RE, HAND and MAT, RE and trends in heatwaves, RE and trends in grass area%, trends in annual temperature and heatwaves, trends in forest area% and grass area%. 


#Step 4- data partitioning to testing and training (OPTIONAL FOR NOW- DO NOT RUN)
```{r}
#set.seed(1234)
###1 Data partition
#fractionTraining   <- 0.80
#fractionTest       <- 0.20

###2 Compute sample sizes.
#sampleSizeTraining_all   <- floor(fractionTraining   * nrow(no_outliers_sample_df))
#sampleSizeTest_all       <- floor(fractionTest       * nrow(no_outliers_sample_df))

###3 Create the randomly-sampled indices for the dataframe. Use setdiff() to
# avoid overlapping subsets of indices.
#indicesTraining_all    <- sort(sample(seq_len(nrow(no_outliers_sample_df)), size=sampleSizeTraining_all))
#indicesTest_all <- setdiff(seq_len(nrow(no_outliers_sample_df)), indicesTraining_all)

###4 Finally, output the dataframes for training, validation and test.
#set.seed(12345)
#dfTraining_all   <- no_outliers_sample_df[indicesTraining_all, ] 
#dfTest_all       <- no_outliers_sample_df[indicesTest_all, ]

#remove(fractionTraining, fractionTest, indicesTraining_all, indicesTest_all, sampleSizeTraining_all, sampleSizeTest_all)
```

#Step 5- regression analyses
The response variables are the trajectory counts i.e. the count is basically the number of pixels 
within a 5x5km pixel that is a particular trajectory (range 0-25). So this can be considered
to be a binomial distribution with the overarching question being what is the probability of the selected
trajectory or not. 

So I will use binomial distribution (logit link) with a two column integer matrix of 
count of that trajectory, count of not that trajectory i.e. count r, 25-r because
25 is the highest possible number of cells having the selected trajectory.

(a) considering "no trend" response
```{r}

############################################# No trend analyses ######################################################
library(mgcv)
#basic model without xy
Sys.time(); model_no_xy<- mgcv::bam( cbind(ndvi_monthly_stable, 25- ndvi_monthly_stable) ~ 
                             s(re, bs = "ts") +
                             s(trend_annualtemp, bs= "ts") +
                             s(heatwave, bs= "ts") +
                             s(burnedarea,  bs= "ts") +
                             s(anthropic_dist, bs= "ts") +
                             s(savannapercentage, bs= "ts"), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_step_inc,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              forestpercentage, grasspercentage, mat)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time() #dev explained = 11.5%

summary(model_no_xy)
plot(model_no_xy, pages = 1, all.terms = TRUE, rug = TRUE, shade = TRUE)
gam.check(model_no_xy)
concurvity(model_no_xy)

#basic model with xy
Sys.time(); model_with_xy <- mgcv::bam( cbind(ndvi_monthly_stable, 25- ndvi_monthly_stable) ~ 
                             s(re, bs = "ts") +
                             s(trend_annualtemp, bs= "ts") +
                             s(heatwave, bs= "ts") +
                             s(burnedarea,  bs= "ts") +
                             s(anthropic_dist, bs= "ts") +
                             s(savannapercentage,  bs= "ts") +
                             te(x,y, bs= "ts"),
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_step_inc,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              forestpercentage, grasspercentage, mat)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time() #default

summary(model_with_xy)
plot(model_with_xy, pages = 1, all.terms = TRUE, rug = TRUE, shade = TRUE)
gam.check(model_with_xy)
concurvity(model_with_xy)
concurvity(model_with_xy, full = FALSE)

#basic model with xy with k=12
Sys.time(); model2 <- mgcv::bam( cbind(ndvi_monthly_stable, 25- ndvi_monthly_stable) ~ 
                             s(re, bs = "ts") +
                             s(trend_annualtemp, bs= "ts") +
                             s(heatwave, bs= "ts") +
                             s(burnedarea,  bs= "ts") +
                             s(anthropic_dist, bs= "ts") +
                             s(savannapercentage,  bs= "ts") +
                             te(x,y, k= c(12,12), bs= "ts"),
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_step_inc,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              forestpercentage, grasspercentage, mat)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time() #medium k values for x,y

summary(model2)
plot(model2, pages = 1, all.terms = TRUE, rug = TRUE, shade = TRUE)
gam.check(model2)

#basic model with xy with k=20
Sys.time(); model3 <- mgcv::bam( cbind(ndvi_monthly_stable, 25- ndvi_monthly_stable) ~ 
                             s(re, bs = "ts") +
                             s(trend_annualtemp, bs= "ts") +
                             s(heatwave, bs= "ts") +
                             s(burnedarea,  bs= "ts") +
                             s(anthropic_dist, bs= "ts") +
                             s(savannapercentage,  bs= "ts") +
                             te(x,y, k= c(20, 20), bs= "ts"),
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_step_inc,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              forestpercentage, grasspercentage, mat)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time() #high k values for x,y

summary(model3)
plot(model3, pages = 1, all.terms = TRUE, rug = TRUE, shade = TRUE)
gam.check(model3)

#basic model with xy with k=5
Sys.time(); model4 <- mgcv::bam( cbind(ndvi_monthly_stable, 25- ndvi_monthly_stable) ~ 
                             s(re, bs = "ts") +
                             s(trend_annualtemp,  bs= "ts") +
                             s(heatwave, bs= "ts") +
                             s(burnedarea,  bs= "ts") +
                             s(anthropic_dist, bs= "ts") +
                             s(savannapercentage,  bs= "ts") +
                             te(x,y, k= c(5,5), bs= "ts"),
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_step_inc,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              forestpercentage, grasspercentage, mat)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time() #low k values for x,y

summary(model4)
plot(model4, pages = 1, all.terms = TRUE, rug = TRUE, shade = TRUE)
gam.check(model4)

#interaction 1 - annual temperature, no xy
Sys.time(); model_interact_mat_trend <- mgcv::bam( cbind(ndvi_monthly_stable, 25- ndvi_monthly_stable) ~ 
                             s(re, bs = "ts") +
                             s(trend_annualtemp) + s(mat, bs= "ts") +
                             ti(trend_annualtemp,mat, bs= "ts") +
                             s(heatwave, bs= "ts") +
                             s(burnedarea,  bs= "ts") +
                             s(anthropic_dist, bs= "ts") +
                             s(savannapercentage,  bs= "ts"),
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_step_inc,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              forestpercentage, grasspercentage)),
                 method = "fREML",
                 family = binomial(link = "logit")); Sys.time() #low k values for x,y

summary(model_interact_mat_trend)
plot(model_interact_mat_trend, pages = 1, all.terms = TRUE, rug = TRUE, shade = TRUE)
gam.check(model_interact_mat_trend)



```

(b) considering "step increase" response
```{r}
################################################ Considering means
#basic model without xy and no interactions
Sys.time(); model_no_interaction_xy<- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ 
                             s(trend_re,  bs = "ts") +
                             s(trend_annualtemp,  bs= "ts") +
                               s(trend_spei, bs= "ts")+
                             s(trend_heatwave, bs= "ts") +
                             s(trend_burnedarea,  bs= "ts") +
                             s(anthropic_dist , bs= "ts") +
                             s(hand, bs= "ts")+
                             s(trend_savannapercentage,  bs= "ts")+
                               s(mat, bs= "ts") +
                               s(mean_heatwave,  bs= "ts")+
                               s(mean_burnedarea, bs= "ts") +
                               s(mean_re, bs= "ts")+
                               s(mean_savannapercentage, bs= "ts")+
                               s(mean_spei, bs= "ts"), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML",
                 family = quasibinomial(link = "logit")); Sys.time()
summary(model_no_interaction_xy) 
gam.check(model_no_interaction_xy)
gratia::draw(model_no_interaction_xy, rug= F)
concurvity(model_no_interaction_xy, full= F)

##basic model without interactions
Sys.time(); model_no_interactions<- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ 
                             s(trend_re,  bs = "ts") +
                             s(trend_annualtemp,  bs= "ts") +
                               s(trend_spei, bs ="ts")+
                             s(trend_heatwave, bs= "ts") +
                             s(trend_burnedarea, bs= "ts") +
                             s(anthropic_dist, bs= "ts") +
                             s(hand,  bs= "ts")+
                             s(trend_savannapercentage, bs= "ts")+
                               s(mat, bs= "ts") +
                               s(mean_heatwave,  bs= "ts")+
                               s(mean_burnedarea, bs= "ts") +
                               s(mean_re, bs= "ts")+
                               s(mean_savannapercentage, bs= "ts") +
                               s(mean_spei, bs= "ts") +
                               ti(x,y), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML",
                 family = quasibinomial(link = "logit")); Sys.time()
summary(model_no_interactions)
#1-pchisq((model_no_interactions$deviance/8.2282),model_no_interactions$df.residual) #check with Theo
gratia::draw(model_no_interactions, rug= F)
mgcv::gam.check(model_no_interactions)

#basic model without interactions and only means- TAKIN TOO LONG
Sys.time(); model_no_interactions_onlymeans<- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ 
                             s(anthropic_dist,   bs= "ts") +
                                s(hand, bs= "ts") +
                             s(mean_savannapercentage,  bs= "ts")+
                               s(mean_re, bs= "ts")+
                               s(mat, bs= "ts") +
                               s(mean_heatwave, bs ="ts")+
                               s(mean_spei, bs= "ts")+
                               s(mean_burnedarea, bs = "ts")+
                               ti(x,y, bs= "ts"), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(trend_burnedarea, trend_re, trend_annualtemp, trend_spei, trend_heatwave,
                                              ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec,
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML",
                 family = quasibinomial(link = "logit")); Sys.time()
summary(model_no_interactions_onlymeans) 
gratia::draw(model_no_interactions_onlymeans, rug= F)
mgcv::gam.check(model_no_interactions_onlymeans)

#basic model without interactions and only trends
Sys.time(); model_no_interactions_onlytrends<- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ 
                             s(anthropic_dist,   bs= "ts") +
                                s(hand, bs= "ts") +
                             s(trend_savannapercentage,  bs= "ts")+
                               s(trend_re, bs= "ts")+
                               s(trend_annualtemp, bs= "ts") +
                               s(trend_heatwave, bs ="ts")+
                               s(trend_spei, bs= "ts")+
                               s(trend_burnedarea, bs = "ts")+
                               ti(x,y, bs= "ts"), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(mean_burnedarea, mean_re, mat, mean_spei, mean_heatwave,
                                              ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec, mean_savannapercentage, 
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML",
                 family = quasibinomial(link = "logit")); Sys.time()
summary(model_no_interactions_onlytrends) #~15.3%
gratia::draw(model_no_interactions_onlytrends, rug= F)
mgcv::gam.check(model_no_interactions_onlytrends)

#Interaction 1- considering only trends, trends in temp with x,y
Sys.time(); model_onlytrends_tempxy<- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ 
                             s(anthropic_dist,   bs= "ts") +
                                s(hand, bs= "ts") +
                             s(trend_savannapercentage,  bs= "ts")+
                               s(trend_re, bs= "ts")+
                               s(trend_annualtemp, bs= "ts") +
                               s(trend_heatwave, bs ="ts")+
                               s(trend_spei, bs= "ts")+
                               s(trend_burnedarea, bs = "ts")+
                              s(x,y, bs= "ts") +
                               ti(trend_annualtemp, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(mean_burnedarea, mean_re, mat, mean_spei, mean_heatwave,
                                              ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec, mean_savannapercentage, 
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML",
                 family = quasibinomial(link = "logit")); Sys.time()
summary(model_onlytrends_tempxy) #DID NOT CONVERGE
gratia::draw(model_onlytrends_tempxy, rug= F)
mgcv::gam.check(model_onlytrends_tempxy)


#To solve above convergence problems I included fx= TRUE according to mgcv guidance
#https://www.rdocumentation.org/packages/mgcv/versions/1.1-7/topics/gam.convergence
Sys.time(); model_onlytrends_tempxy2<- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ 
                             s(anthropic_dist,   bs= "ts", fx= TRUE) +
                                s(hand, bs= "ts", fx= TRUE) +
                             s(trend_savannapercentage,  bs= "ts", fx= TRUE)+
                               s(trend_re, bs= "ts", fx= TRUE)+
                               s(trend_annualtemp, bs= "ts", fx= TRUE) +
                               s(trend_heatwave, bs ="ts", fx= TRUE)+
                               s(trend_spei, bs= "ts", fx= TRUE)+
                               s(trend_burnedarea, bs = "ts", fx= TRUE)+
                              s(x,y, bs= "ts", fx= TRUE) +
                               ti(trend_annualtemp, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12), fx= TRUE), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(mean_burnedarea, mean_re, mat, mean_spei, mean_heatwave,
                                              ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec, mean_savannapercentage, 
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML",
                 family = quasibinomial(link = "logit")); Sys.time()
summary(model_onlytrends_tempxy) 
gratia::draw(model_onlytrends_tempxy, rug= F)
mgcv::gam.check(model_onlytrends_tempxy)

#Interaction 2- considering only trends, interaction in trends in temp with x,y and interaction in temp, re
Sys.time(); model_onlytrends_tempxy2_tempretrend<- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ 
                             s(anthropic_dist,   bs= "ts", fx= TRUE) +
                                s(hand, bs= "ts", fx= TRUE) +
                             s(trend_savannapercentage,  bs= "ts", fx= TRUE)+
                               s(trend_re, bs= "ts", fx= TRUE)+
                               s(trend_annualtemp, bs= "ts", fx= TRUE) +
                               s(trend_heatwave, bs ="ts", fx= TRUE)+
                               s(trend_spei, bs= "ts", fx= TRUE)+
                               s(trend_burnedarea, bs = "ts", fx= TRUE)+
                              s(x,y, bs= "ts", fx= TRUE) +
                               ti(trend_annualtemp, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12), fx= TRUE) +
                               ti(trend_annualtemp, trend_re, bs=c("ts", "ts"), k=c(5,12), fx= TRUE), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(mean_burnedarea, mean_re, mat, mean_spei, mean_heatwave,
                                              ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec, mean_savannapercentage, 
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML",
                 family = quasibinomial(link = "logit")); Sys.time()
summary( model_onlytrends_tempxy2_tempretrend) 
gratia::draw (model_onlytrends_tempxy2_tempretrend, rug= F)
mgcv::gam.check( model_onlytrends_tempxy2_tempretrend)

#Interaction 3- considering only trends, interaction in trends in temp with x,y and interaction in heatwaves spei
Sys.time(); model_onlytrends_tempxy2_heatwavespeitrend<- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ 
                             s(anthropic_dist,   bs= "ts", fx= TRUE) +
                                s(hand, bs= "ts", fx= TRUE) +
                             s(trend_savannapercentage,  bs= "ts", fx= TRUE)+
                               s(trend_re, bs= "ts", fx= TRUE)+
                               s(trend_annualtemp, bs= "ts", fx= TRUE) +
                               s(trend_heatwave, bs ="ts", fx= TRUE)+
                               s(trend_spei, bs= "ts", fx= TRUE)+
                               s(trend_burnedarea, bs = "ts", fx= TRUE)+
                              s(x,y, bs= "ts", fx= TRUE) +
                               ti(trend_annualtemp, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12), fx= TRUE) +
                               ti(trend_annualtemp, trend_re, bs=c("ts", "ts"), k=c(5,5), fx= TRUE) +
                               ti(trend_heatwave, trend_spei, bs=c("ts", "ts"), k=c(5,5), fx= TRUE), 
                           data = no_outliers_sample_df %>% 
                             dplyr::select(-c(mean_burnedarea, mean_re, mat, mean_spei, mean_heatwave,
                                              ndvi_monthly_lin_dec, ndvi_monthly_lin_inc,
                                              ndvi_monthly_step_dec, ndvi_monthly_stable,
                                              ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                                              ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec, mean_savannapercentage, 
                                              trend_forestpercentage, trend_grasspercentage)),
                 method = "fREML",
                 family = quasibinomial(link = "logit")); Sys.time()
summary( model_onlytrends_tempxy2_heatwavespeitrend) 
gratia::draw (model_onlytrends_tempxy2_heatwavespeitrend, rug= F)
mgcv::gam.check( model_onlytrends_tempxy2_heatwavespeitrend)
model_onlytrends_tempxy2_heatwavespeitrend <- mgcViz::getViz(model_onlytrends_tempxy2_heatwavespeitrend)
mgcViz::plotRGL(sm(model_onlytrends_tempxy2_heatwavespeitrend, 12), fix = c("z" = 0), residuals = TRUE)
vis.gam(model_onlytrends_tempxy2_heatwavespeitrend, view = c("trend_re", "trend_annualtemp"), theta = 120, plot.type = "persp")
vis.gam(model_onlytrends_tempxy2_heatwavespeitrend, view = c("trend_heatwave", "trend_spei"), theta = 120, plot.type = "persp")





```
