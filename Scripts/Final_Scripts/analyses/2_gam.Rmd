```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, include=FALSE}
library(RColorBrewer)
library(terra)
library(tidyverse)
library(here)
library(ggplot2)
library(mgcv)
library(mgcViz)
library(rgl)
library(gratia)
library(gtools)

```

##Introduction
In this script, I do GAMs to understand the relationship between different trajectories (from NDVI stl swindow = 11 primarily) and 
various predictor variables. 
(1) Data input of NDVI derived %area of pixel of different trajectories and predictors at 5km
(2) Data processing and structuring for analyses
(3) Exploratory data plots
(4) GAM modeling
(5) Plotting of GAM results

#Step 1- data input
```{r}
#response- binary trajectory (all 9) from NDVI swin 11 stl setting
monthly_input_file_path <- here("Outputs", "TrendsResults", "results_rasters", "monthly", "binary_count_5km")
monthly_file_list<- list.files(path = monthly_input_file_path, pattern = paste0("*","ndvi_","*"), all.files = T, full.names = T)
monthly_file_list <- gtools::mixedsort(monthly_file_list)
monthly_ndvi_trajectories<- lapply(monthly_file_list, rast)
remove(monthly_file_list, monthly_input_file_path)

#static drivers
anthropic_dist<- rast(here("Outputs", "OtherVariables", "AnthropicDist", "5km_meandist_20thresholdsanthropicpixel.tif"))
hand<- rast(here("Outputs", "OtherVariables","HAND", "cerrado_hand_5km.tif"))

#trend variables
trend_burnedarea<- rast(here("Outputs", "OtherVariables", "Fire", "theilsen_burnedarea_5km.tif"))
trend_re<- rast(here("Outputs", "OtherVariables", "Climate", "theilsen_re.tif"))
trend_at<- rast(here("Outputs", "OtherVariables", "Climate", "theilsen_at_5km.tif"))
trend_spei<-rast(here("Outputs", "OtherVariables", "Climate", "theilsen_spei.tif"))
trend_heatwave<- rast(here("Outputs", "OtherVariables", "Climate", "theilsen_heatwaves.tif"))

#mean variables
mean_burnedarea<- rast(here("Outputs", "OtherVariables", "Fire", "mean_burnedarea_5km_2002_2021.tif"))
mean_re <- rast(here("Outputs", "OtherVariables", "Climate","mean_annual_relative_entropy_1981_2021.tif") )
mean_at <- rast(here("Outputs", "OtherVariables", "Climate", "mat_1981_2021_5km.tif"))
mean_spei <- rast( here("Outputs", "OtherVariables", "Climate", "mean_annualspei.tif")) 
mean_heatwave <- rast(here("Outputs", "OtherVariables", "Climate", "mean_annual_heatwaves_2002_2021.tif"))

#trend in % area of veg formations
#trend_forestpercentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "theilsen_forestpercentage_5km.tif"))
#trend_savannapercentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "theilsen_savannapercentage_5km.tif"))
#trend_grasspercentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "theilsen_grasspercentage_5km.tif"))

#mean %area of veg formation
mean_savannapercentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "mean_savanna_percentage_5km_2002_2021.tif"))
mean_grasspercentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "mean_grass_percentage_5km_2002_2021.tif"))
mean_forestpercentage <- rast(here("Outputs", "OtherVariables", "Formations_Heterogeniety", "mean_forest_percentage_5km_2002_2021.tif"))

```


#Step 2- data structuring and applying anthropic threshold mask to predictors
```{r}
crop_mask_function <- function(raster_to_be_cropmask){
  x_mask <- terra::mask(raster_to_be_cropmask, monthly_ndvi_trajectories[[1]][[1]])
  x_mask
}

cm_anthropic_dist <- crop_mask_function(anthropic_dist)
cm_hand <- crop_mask_function(hand)

cm_trend_burnedarea <- crop_mask_function(trend_burnedarea)
cm_trend_re <- crop_mask_function(trend_re)
cm_trend_at <- crop_mask_function(trend_at)
cm_trend_spei <- crop_mask_function(trend_spei)
cm_trend_heatwave <- crop_mask_function(trend_heatwave)

cm_mean_burnedarea <- crop_mask_function(mean_burnedarea)
cm_mean_re <- crop_mask_function(mean_re)
cm_mean_at <- crop_mask_function(mean_at)
cm_mean_spei <- crop_mask_function(mean_spei)
cm_mean_heatwave <- crop_mask_function(mean_heatwave)

#cm_trend_forest <- crop_mask_function(trend_forestpercentage)
#cm_trend_savanna <- crop_mask_function(trend_savannapercentage)
#cm_trend_grass <- crop_mask_function(trend_grasspercentage)
cm_mean_forest <- crop_mask_function(mean_forestpercentage)
cm_mean_grass <- crop_mask_function(mean_grasspercentage)
cm_mean_savanna <- crop_mask_function(mean_savannapercentage)

constantdrivers <- c(cm_anthropic_dist, cm_hand, 
                     cm_trend_burnedarea, cm_trend_re, cm_trend_at, cm_trend_spei, cm_trend_heatwave, 
                     cm_mean_burnedarea, cm_mean_re, cm_mean_at, cm_mean_spei, cm_mean_heatwave)

df_prep <- function (mean_veg_formation, colname_mean){ #colname_trend
  x_stack <- c(monthly_ndvi_trajectories[[1]], constantdrivers, mean_veg_formation) #trend_veg_formation
  names(x_stack) <- c("ndvi_monthly_lin_dec", 
                    "ndvi_monthly_lin_inc",
                    "ndvi_monthly_stable",
                    "ndvi_monthly_step_dec",
                    "ndvi_monthly_step_inc",
                    "ndvi_monthly_quad_dec_acc",
                    "ndvi_monthly_quad_dec_decc",
                    "ndvi_monthly_quad_inc_acc",
                    "ndvi_monthly_quad_inc_dec",
                    "anthropic_dist", 
                    "hand", 
                    "trend_burnedarea",
                    "trend_re", 
                    "trend_annualtemp", 
                    "trend_spei",
                    "trend_heatwave", 
                    "mean_burnedarea",
                    "mean_re",
                    "mean_at",
                    "mean_spei",
                    "mean_heatwave",
                    #colname_trend,
                    colname_mean
                   )
  analyses_df<- terra::as.data.frame(x_stack, xy = TRUE)
  analyses_df
}

grass_df <- df_prep(mean_grasspercentage, "mean_grasspercentage")
forest_df <- df_prep(mean_forestpercentage, "mean_forestpercentage")
savanna_df <- df_prep(mean_savannapercentage, "mean_savannapercentage")

all_vars <- c(monthly_ndvi_trajectories[[1]], constantdrivers, cm_mean_savanna, cm_mean_grass, cm_mean_forest)
analyses_df <- terra::as.data.frame(all_vars, xy = TRUE)
names(analyses_df) <- c("x", "y", "ndvi_monthly_lin_dec", 
                    "ndvi_monthly_lin_inc",
                    "ndvi_monthly_stable",
                    "ndvi_monthly_step_dec",
                    "ndvi_monthly_step_inc",
                    "ndvi_monthly_quad_dec_acc",
                    "ndvi_monthly_quad_dec_decc",
                    "ndvi_monthly_quad_inc_acc",
                    "ndvi_monthly_quad_inc_dec",
                    "anthropic_dist", 
                    "hand", 
                    "trend_burnedarea",
                    "trend_re", 
                    "trend_annualtemp", 
                    "trend_spei",
                    "trend_heatwave", 
                    "mean_burnedarea",
                    "mean_re",
                    "mean_at",
                    "mean_spei",
                    "mean_heatwave",
                    "mean_savanna_percentage",
                    "mean_grass_percentage",
                    "mean_forest_percentage")


remove(anthropic_dist, hand, trend_burnedarea, trend_re, trend_at, trend_spei, trend_heatwave,
             mean_burnedarea, mean_re, mean_at, mean_spei, mean_heatwave,
             mean_savannapercentage, mean_grasspercentage, mean_forestpercentage)
remove(cm_anthropic_dist, cm_hand, cm_trend_burnedarea, cm_trend_re, cm_trend_at, cm_trend_spei, cm_trend_heatwave,
             cm_mean_burnedarea, cm_mean_re, cm_mean_at, cm_mean_spei, cm_mean_heatwave,
             cm_mean_savanna, cm_mean_grass, cm_mean_forest)
```


#Step 3- eda - understanding the correlations and distributions of all the variables 
```{r}
#summary statistics
summary(grass_df)
summary(forest_df)
summary(savanna_df)

summary(analyses_df)

remove_NA <- function (df_analyses){
  analyses_df_noNA <- df_analyses %>% drop_na() 
  analyses_df_noNA
}
grass_df_NA <- remove_NA(grass_df)
forest_df_NA <-remove_NA(forest_df)
savanna_df_NA <- remove_NA(savanna_df)
analyses_df_NA <- remove_NA(analyses_df)

#library(PerformanceAnalytics)
#chart.Correlation(grass_df_NA, histogram = TRUE, method = "spearman", pch= 19)
#chart.Correlation(forest_df_NA, histogram = TRUE, method = "spearman", pch= 19)
#chart.Correlation(savanna_df_NA, histogram = TRUE, method = "spearman", pch= 19)

remove_HAND_outliers <- function (df_analyses_NA){
  no_outliers_sample_df <- df_analyses_NA %>% 
          mutate (IQR = IQR(hand),
                  O_upper = quantile (hand, probs= c(0.75), na.rm= FALSE)+ 1.5*IQR,
                  O_lower = quantile(hand, probs= c(0.25), na.rm= FALSE) - 1.5*IQR
                  ) %>% 
          filter(O_lower <= hand & hand <= O_upper) %>%
          dplyr::select(-c(IQR, O_upper, O_lower))
  no_outliers_sample_df
}
grass_df_noNA_nooutliers <- remove_HAND_outliers(grass_df_NA)
forest_df_noNA_nooutliers <- remove_HAND_outliers(forest_df_NA)
savanna_df_noNA_nooutliers <- remove_HAND_outliers(savanna_df_NA)
analyses_df_noNA_nooutliers <- remove_HAND_outliers(analyses_df_NA)

plot_df_function <- function (df_noNA_nooutliers){
  pivot_df <- df_noNA_nooutliers %>% 
  dplyr::select(-c(x,y, ndvi_monthly_stable,
                   ndvi_monthly_step_dec, ndvi_monthly_lin_dec, ndvi_monthly_lin_inc, 
                   ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc, 
                   ndvi_monthly_quad_inc_acc, ndvi_monthly_quad_inc_dec)) %>%
  pivot_longer(1:14)
  
distribution_plot <- ggplot(data = pivot_df, aes(value)) +
  geom_histogram() +facet_wrap(~name, scales = "free", labeller = label_wrap_gen(4)) +
  theme_classic(base_size = 16)
distribution_plot
}

grass_df_plot <- plot_df_function(grass_df_noNA_nooutliers)
forest_df_plot <- plot_df_function(forest_df_noNA_nooutliers)
savanna_df_plot <- plot_df_function(savanna_df_noNA_nooutliers)
analyses_df_plot <- plot_df_function (analyses_df_noNA_nooutliers)

remove(grass_df_NA, savanna_df_NA, forest_df_NA)
remove(grass_df_plot, forest_df_plot, savanna_df_plot)
remove(crop_mask_function, df_prep, plot_df_function, remove_HAND_outliers, remove_NA)
```

#Step 4a- GAM modelling for step increase pixels ###### DO NOT RUN
```{r}
#savanna analyses
Sys.time(); savanna_model <- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ s(anthropic_dist, bs= "ts") +
                                          s(hand, bs= "ts") +
                                          s(trend_re, bs= "ts") +
                                          s(trend_annualtemp, bs= "ts") +
                                          s(trend_heatwave, bs ="ts") +
                                          s(trend_spei, bs= "ts") +
                                          s(trend_burnedarea, bs = "ts") +
                                        
                                          s(mean_re, bs= "ts") +
                                          s(mean_at, bs= "ts") +
                                          s(mean_heatwave,  bs= "ts") +
                                          s(mean_spei, bs= "ts") +
                                          s(mean_burnedarea, bs= "ts") +
                                          s(mean_savannapercentage, bs= "ts") +
                                          
                                          s(x,y, bs= "ts") +
                                          
                                          ti(mean_at, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          ti(trend_annualtemp, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          ti(trend_annualtemp, trend_re, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(trend_heatwave, trend_spei, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(anthropic_dist, trend_burnedarea, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(anthropic_dist, mean_savannapercentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(trend_burnedarea, mean_savannapercentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          
                                          ti(trend_burnedarea, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(trend_burnedarea, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_savannapercentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_savannapercentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(5,5,5)), 
                                        data = savanna_df_noNA_nooutliers %>% dplyr::select(-c(ndvi_monthly_lin_dec, 
                                                                                               ndvi_monthly_lin_inc,
                                                                                               ndvi_monthly_step_dec, 
                                                                                               ndvi_monthly_stable,
                                                                                               ndvi_monthly_quad_dec_acc,
                                                                                               ndvi_monthly_quad_dec_decc,
                                                                                               ndvi_monthly_quad_inc_acc,
                                                                                               ndvi_monthly_quad_inc_dec)), 
                                        method = "fREML", 
                                        family = quasibinomial(link = "logit")); Sys.time() 
savanna_model$converged #TRUE
savanna_model$mgcv.conv$message #full convergence
savanna_model$boundary #FALSE
appraise(savanna_model)


#grass analyses
Sys.time(); grass_model <- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ s(anthropic_dist, bs= "ts") +
                                          s(hand, bs= "ts") +
                                          s(trend_re, bs= "ts") +
                                          s(trend_annualtemp, bs= "ts") +
                                          s(trend_heatwave, bs ="ts") +
                                          s(trend_spei, bs= "ts") +
                                          s(trend_burnedarea, bs = "ts") +
                                          
                                          s(mean_re, bs= "ts") +
                                          s(mean_at, bs= "ts") +
                                          s(mean_heatwave,  bs= "ts") +
                                          s(mean_spei, bs= "ts") +
                                          s(mean_burnedarea, bs= "ts") +
                                          s(mean_grasspercentage, bs= "ts") +
                                          
                                          s(x,y, bs= "ts") +
                                          
                                          ti(mean_at, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          ti(trend_annualtemp, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          ti(trend_annualtemp, trend_re, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(trend_heatwave, trend_spei, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(anthropic_dist, trend_burnedarea, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(anthropic_dist, mean_grasspercentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(trend_burnedarea, mean_grasspercentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                        
                                          ti(trend_burnedarea, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(trend_burnedarea, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_grasspercentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_grasspercentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(5,5,5)), 
                                        data = grass_df_noNA_nooutliers %>% dplyr::select(-c(ndvi_monthly_lin_dec, 
                                                                                               ndvi_monthly_lin_inc,
                                                                                               ndvi_monthly_step_dec, 
                                                                                               ndvi_monthly_stable,
                                                                                               ndvi_monthly_quad_dec_acc,
                                                                                               ndvi_monthly_quad_dec_decc,
                                                                                               ndvi_monthly_quad_inc_acc,
                                                                                               ndvi_monthly_quad_inc_dec)), 
                                        method = "fREML", 
                                        family = quasibinomial(link = "logit")); Sys.time() #10min
grass_model$converged #TRUE
grass_model$mgcv.conv$message #full convergence
grass_model$boundary #FALSE
appraise(grass_model)


#forest analyses
Sys.time(); forest_model <- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ s(anthropic_dist, bs= "ts") +
                                          s(hand, bs= "ts") +
                                          s(trend_re, bs= "ts") +
                                          s(trend_annualtemp, bs= "ts") +
                                          s(trend_heatwave, bs ="ts") +
                                          s(trend_spei, bs= "ts") +
                                          s(trend_burnedarea, bs = "ts") +
                                          
                                          s(mean_re, bs= "ts") +
                                          s(mean_at, bs= "ts") +
                                          s(mean_heatwave,  bs= "ts") +
                                          s(mean_spei, bs= "ts") +
                                          s(mean_burnedarea, bs= "ts") +
                                          s(mean_forestpercentage, bs= "ts") +
                                          
                                          s(x,y, bs= "ts") +
                                          
                                          ti(mean_at, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          ti(trend_annualtemp, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          ti(trend_annualtemp, trend_re, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(trend_heatwave, trend_spei, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(anthropic_dist, trend_burnedarea, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(anthropic_dist, mean_forestpercentage, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(trend_burnedarea, mean_forestpercentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                         
                                          ti(trend_burnedarea, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(trend_burnedarea, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_forestpercentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_forestpercentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(5,5,5)), 
                                        data = forest_df_noNA_nooutliers %>% dplyr::select(-c(ndvi_monthly_lin_dec, 
                                                                                               ndvi_monthly_lin_inc,
                                                                                               ndvi_monthly_step_dec, 
                                                                                               ndvi_monthly_stable,
                                                                                               ndvi_monthly_quad_dec_acc,
                                                                                               ndvi_monthly_quad_dec_decc,
                                                                                               ndvi_monthly_quad_inc_acc,
                                                                                               ndvi_monthly_quad_inc_dec)), 
                                        method = "fREML", 
                                        family = quasibinomial(link = "logit")); Sys.time()
forest_model$converged #TRUE
forest_model$mgcv.conv$message #full convergence
forest_model$boundary #FALSE
appraise(forest_model)
write_rds(savanna_model, here("Scripts","Final_Scripts", "analyses", "savanna_gam_model.rds"))
write_rds(grass_model, here("Scripts","Final_Scripts", "analyses", "grass_gam_model.rds"))
write_rds(forest_model, here("Scripts","Final_Scripts", "analyses", "forest_gam_model.rds"))

summary(savanna_model)
summary(grass_model)
summary(forest_model)

par(mfrow = c(2, 2))
mgcv::gam.check(savanna_model)
par(mfrow = c(2, 2))
mgcv::gam.check(grass_model)
par(mfrow = c(2, 2))
mgcv::gam.check(forest_model)

gratia::draw (savanna_model, rug= F)
gratia::draw (grass_model, rug= F)
gratia::draw (forest_model, rug= F)

```


#Step 4b- GAM modelling for step decrease pixels ###### DO NOT RUN
```{r}
#savanna analyses
Sys.time(); savanna_model_dec <- mgcv::bam( cbind(ndvi_monthly_step_dec, 25- ndvi_monthly_step_dec) ~ s(anthropic_dist, bs= "ts") +
                                          s(hand, bs= "ts") +
                                          s(trend_re, bs= "ts") +
                                          s(trend_annualtemp, bs= "ts") +
                                          s(trend_heatwave, bs ="ts") +
                                          s(trend_spei, bs= "ts") +
                                          s(trend_burnedarea, bs = "ts") +
                                        
                                          s(mean_re, bs= "ts") +
                                          s(mean_at, bs= "ts") +
                                          s(mean_heatwave,  bs= "ts") +
                                          s(mean_spei, bs= "ts") +
                                          s(mean_burnedarea, bs= "ts") +
                                          s(mean_savannapercentage, bs= "ts") +
                                          
                                          s(x,y, bs= "ts") +
                                          
                                          ti(mean_at, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          ti(trend_annualtemp, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          ti(trend_annualtemp, trend_re, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(trend_heatwave, trend_spei, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(anthropic_dist, trend_burnedarea, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(anthropic_dist, mean_savannapercentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(trend_burnedarea, mean_savannapercentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          
                                          ti(trend_burnedarea, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(trend_burnedarea, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_savannapercentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_savannapercentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(5,5,5)), 
                                        data = savanna_df_noNA_nooutliers %>% dplyr::select(-c(ndvi_monthly_lin_dec, 
                                                                                               ndvi_monthly_lin_inc,
                                                                                               ndvi_monthly_step_inc, 
                                                                                               ndvi_monthly_stable,
                                                                                               ndvi_monthly_quad_dec_acc,
                                                                                               ndvi_monthly_quad_dec_decc,
                                                                                               ndvi_monthly_quad_inc_acc,
                                                                                               ndvi_monthly_quad_inc_dec)), 
                                        method = "fREML", 
                                        family = quasibinomial(link = "logit")); Sys.time() 
savanna_model_dec$converged #TRUE
savanna_model_dec$mgcv.conv$message #full convergence
savanna_model_dec$boundary #FALSE



#grass analyses
Sys.time(); grass_model_dec <- mgcv::bam( cbind(ndvi_monthly_step_dec, 25- ndvi_monthly_step_dec) ~ s(anthropic_dist, bs= "ts") +
                                          s(hand, bs= "ts") +
                                          s(trend_re, bs= "ts") +
                                          s(trend_annualtemp, bs= "ts") +
                                          s(trend_heatwave, bs ="ts") +
                                          s(trend_spei, bs= "ts") +
                                          s(trend_burnedarea, bs = "ts") +
                                          
                                          s(mean_re, bs= "ts") +
                                          s(mean_at, bs= "ts") +
                                          s(mean_heatwave,  bs= "ts") +
                                          s(mean_spei, bs= "ts") +
                                          s(mean_burnedarea, bs= "ts") +
                                          s(mean_grasspercentage, bs= "ts") +
                                          
                                          s(x,y, bs= "ts") +
                                          
                                          ti(mean_at, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          ti(trend_annualtemp, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          ti(trend_annualtemp, trend_re, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(trend_heatwave, trend_spei, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(anthropic_dist, trend_burnedarea, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(anthropic_dist, mean_grasspercentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(trend_burnedarea, mean_grasspercentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                        
                                          ti(trend_burnedarea, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(trend_burnedarea, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_grasspercentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_grasspercentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(5,5,5)), 
                                        data = grass_df_noNA_nooutliers %>% dplyr::select(-c(ndvi_monthly_lin_dec, 
                                                                                               ndvi_monthly_lin_inc,
                                                                                               ndvi_monthly_step_inc, 
                                                                                               ndvi_monthly_stable,
                                                                                               ndvi_monthly_quad_dec_acc,
                                                                                               ndvi_monthly_quad_dec_decc,
                                                                                               ndvi_monthly_quad_inc_acc,
                                                                                               ndvi_monthly_quad_inc_dec)), 
                                        method = "fREML", 
                                        family = quasibinomial(link = "logit")); Sys.time() #10min
grass_model_dec$converged #TRUE
grass_model_dec$mgcv.conv$message #full convergence
grass_model_dec$boundary #FALSE



#forest analyses
Sys.time(); forest_model_dec <- mgcv::bam( cbind(ndvi_monthly_step_dec, 25- ndvi_monthly_step_dec) ~ s(anthropic_dist, bs= "ts") +
                                          s(hand, bs= "ts") +
                                          s(trend_re, bs= "ts") +
                                          s(trend_annualtemp, bs= "ts") +
                                          s(trend_heatwave, bs ="ts") +
                                          s(trend_spei, bs= "ts") +
                                          s(trend_burnedarea, bs = "ts") +
                                          
                                          s(mean_re, bs= "ts") +
                                          s(mean_at, bs= "ts") +
                                          s(mean_heatwave,  bs= "ts") +
                                          s(mean_spei, bs= "ts") +
                                          s(mean_burnedarea, bs= "ts") +
                                          s(mean_forestpercentage, bs= "ts") +
                                          
                                          s(x,y, bs= "ts") +
                                          
                                          ti(mean_at, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          ti(trend_annualtemp, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          ti(trend_annualtemp, trend_re, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(trend_heatwave, trend_spei, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(anthropic_dist, trend_burnedarea, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(anthropic_dist, mean_forestpercentage, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(trend_burnedarea, mean_forestpercentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                         
                                          ti(trend_burnedarea, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(trend_burnedarea, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_forestpercentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_forestpercentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(5,5,5)), 
                                        data = forest_df_noNA_nooutliers %>% dplyr::select(-c(ndvi_monthly_lin_dec, 
                                                                                               ndvi_monthly_lin_inc,
                                                                                               ndvi_monthly_step_inc, 
                                                                                               ndvi_monthly_stable,
                                                                                               ndvi_monthly_quad_dec_acc,
                                                                                               ndvi_monthly_quad_dec_decc,
                                                                                               ndvi_monthly_quad_inc_acc,
                                                                                               ndvi_monthly_quad_inc_dec)), 
                                        method = "fREML", 
                                        family = quasibinomial(link = "logit")); Sys.time()
forest_model_dec$converged #TRUE
forest_model_dec$mgcv.conv$message #full convergence
forest_model_dec$boundary #FALSE


```


#Step 4c- one model for all variables seperated as step inc and dec
```{r}
Sys.time(); step_inc_model <- mgcv::bam( cbind(ndvi_monthly_step_inc, 25- ndvi_monthly_step_inc) ~ s(anthropic_dist, bs= "ts") +
                                          s(hand, bs= "ts") +
                                          s(trend_re, bs= "ts") +
                                          s(trend_annualtemp, bs= "ts") +
                                          s(trend_heatwave, bs ="ts") +
                                          s(trend_spei, bs= "ts") +
                                          s(trend_burnedarea, bs = "ts") +
                                        
                                          s(mean_re, bs= "ts") +
                                          s(mean_at, bs= "ts") +
                                          s(mean_heatwave,  bs= "ts") +
                                          s(mean_spei, bs= "ts") +
                                          s(mean_burnedarea, bs= "ts") +
                                          s(mean_savanna_percentage, bs= "ts") +
                                          s(mean_grass_percentage, bs= "ts") +
                                          s(mean_forest_percentage, bs= "ts")+
                                          
                                          s(x,y, bs= "ts") +
                                          ti(mean_at, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          ti(trend_annualtemp, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          
                                          ti(trend_annualtemp, trend_re, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(trend_heatwave, trend_spei, bs=c("ts", "ts"), k=c(5,5)) +
                                          
                                          ti(anthropic_dist, mean_savanna_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(anthropic_dist, mean_grass_percentage, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(anthropic_dist, mean_forest_percentage, bs=c("ts", "ts"), k=c(5,5)) +  
                                           
                                          ti(anthropic_dist, trend_burnedarea, bs=c("ts", "ts"), k=c(5,5)) +
                                          
                                          ti(trend_burnedarea, mean_savanna_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(trend_burnedarea, mean_grass_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(trend_burnedarea, mean_forest_percentage, bs=c("ts", "ts"), k=c(5,5)) +  
                                          
                                          ti(mean_savanna_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_savanna_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_grass_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_grass_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_forest_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_forest_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                           
                                          ti(trend_burnedarea, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(trend_burnedarea, trend_heatwave, trend_spei, bs=c("ts", "ts", "ts"), k=c(5,5,5)) ,
                                         
                                        data = analyses_df_noNA_nooutliers %>% dplyr::select(-c(ndvi_monthly_lin_dec, 
                                                                                               ndvi_monthly_lin_inc,
                                                                                               ndvi_monthly_step_dec, 
                                                                                               ndvi_monthly_stable,
                                                                                               ndvi_monthly_quad_dec_acc,
                                                                                               ndvi_monthly_quad_dec_decc,
                                                                                               ndvi_monthly_quad_inc_acc,
                                                                                               ndvi_monthly_quad_inc_dec)), 
                                        method = "fREML", 
                                        family = quasibinomial(link = "logit")); Sys.time() 
write_rds(step_inc_model, here("Scripts", "Final_Scripts", "analyses", "onemodel_inc.rds"))

Sys.time(); step_dec_model <- mgcv::bam( cbind(ndvi_monthly_step_dec, 25- ndvi_monthly_step_dec) ~ s(anthropic_dist, bs= "ts") +
                                          s(hand, bs= "ts") +
                                          s(trend_re, bs= "ts") +
                                          s(trend_annualtemp, bs= "ts") +
                                          s(trend_heatwave, bs ="ts") +
                                          s(trend_spei, bs= "ts") +
                                          s(trend_burnedarea, bs = "ts") +
                                        
                                          s(mean_re, bs= "ts") +
                                          s(mean_at, bs= "ts") +
                                          s(mean_heatwave,  bs= "ts") +
                                          s(mean_spei, bs= "ts") +
                                          s(mean_burnedarea, bs= "ts") +
                                          s(mean_savanna_percentage, bs= "ts") +
                                          s(mean_grass_percentage, bs= "ts") +
                                          s(mean_forest_percentage, bs= "ts")+
                                          
                                          s(x,y, bs= "ts") +
                                          ti(mean_at, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          ti(trend_annualtemp, x,y, d=c(1,2), bs=c("ts", "ts"), k=c(5,12)) +
                                          
                                          ti(trend_annualtemp, trend_re, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(trend_heatwave, trend_spei, bs=c("ts", "ts"), k=c(5,5)) +
                                          
                                          ti(anthropic_dist, mean_savanna_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(anthropic_dist, mean_grass_percentage, bs=c("ts", "ts"), k=c(5,5)) +
                                          ti(anthropic_dist, mean_forest_percentage, bs=c("ts", "ts"), k=c(5,5)) +  
                                           
                                          ti(anthropic_dist, trend_burnedarea, bs=c("ts", "ts"), k=c(5,5)) +
                                          
                                          ti(trend_burnedarea, mean_savanna_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(trend_burnedarea, mean_grass_percentage, bs=c("ts", "ts"), k=c(5,5)) + 
                                          ti(trend_burnedarea, mean_forest_percentage, bs=c("ts", "ts"), k=c(5,5)) +  
                                          
                                          ti(mean_savanna_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_savanna_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_grass_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_grass_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_forest_percentage, trend_spei, trend_heatwave, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(mean_forest_percentage, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                           
                                          ti(trend_burnedarea, trend_annualtemp, trend_re, bs=c("ts", "ts", "ts"), k=c(5,5,5)) +
                                          ti(trend_burnedarea, trend_heatwave, trend_spei, bs=c("ts", "ts", "ts"), k=c(5,5,5)),
                                         
                                        data = analyses_df_noNA_nooutliers %>% dplyr::select(-c(ndvi_monthly_lin_dec, 
                                                                                               ndvi_monthly_lin_inc,
                                                                                               ndvi_monthly_step_inc, 
                                                                                               ndvi_monthly_stable,
                                                                                               ndvi_monthly_quad_dec_acc,
                                                                                               ndvi_monthly_quad_dec_decc,
                                                                                               ndvi_monthly_quad_inc_acc,
                                                                                               ndvi_monthly_quad_inc_dec)), 
                                        method = "fREML", 
                                        family = quasibinomial(link = "logit")); Sys.time()
write_rds(step_dec_model, here("Scripts", "Final_Scripts", "analyses", "onemodel_dec.rds"))

step_inc_model$converged
step_dec_model$converged
step_inc_model$mgcv.conv$message
step_dec_model$mgcv.conv$message
step_inc_model$boundary
step_dec_model$boundary


appraise(step_dec_model)
appraise(step_inc_model)

summary(step_inc_model)
summary(step_dec_model)
```


#Step 5a - Functions to visualize 2 way interactions
```{r}


#savanna_gam_step_inc <- read_rds(here("Scripts", "Final_Scripts", "analyses", "savanna_gam_model.rds"))
#savanna_gam_step_dec <- read_rds(here("Scripts", "Final_Scripts", "analyses", "savanna_gam_stepdecrease.rds"))

#grass_gam_step_inc <- read_rds(here("Scripts", "Final_Scripts", "analyses", "grass_gam_model.rds"))
#grass_gam_step_dec <- read_rds(here("Scripts", "Final_Scripts", "analyses", "grass_gam_stepdecrease.rds"))

#forest_gam_step_inc <- read_rds(here("Scripts", "Final_Scripts", "analyses", "forest_gam_model.rds"))
#forest_gam_step_dec <- read_rds(here("Scripts", "Final_Scripts", "analyses", "forest_gam_stepdecrease.rds"))

inc_gam <- read_rds(here("Scripts", "Final_Scripts", "analyses", "onemodel_inc.rds"))
dec_gam <- read_rds(here("Scripts", "Final_Scripts", "analyses" ,"onemodel_dec.rds"))


grid_creation_prediction <- function (df_analyses, xaxis_variable_in_quotes, 
                                              line_variable_in_quotes, 
                                              gam_model){
  df_select <- df_analyses %>% dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc, 
                                                ndvi_monthly_stable, ndvi_monthly_step_dec, 
                                                ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc,
                                                ndvi_monthly_quad_inc_acc,ndvi_monthly_quad_inc_dec))
  
  var_x <- subset( df_select, select = xaxis_variable_in_quotes)
  var_line <- subset( df_select, select = line_variable_in_quotes)
  var_line <- as.vector(var_line) %>% unlist()
  
  xaxis_range <- seq(min(var_x),max(var_x),len = xaxis_range_len)
  line_range <- c((mean(var_line) - sd(var_line)),0, (mean(var_line) + sd(var_line)))
  
  df_means<- df_select %>% dplyr::select(-c(x,y,xaxis_variable_in_quotes, line_variable_in_quotes)) %>%
    summarise(across(where(is.numeric), ~mean(.x, na.rm= T)))
  
  newd <- data.frame(expand.grid(xaxis_range, line_range))
  names(newd) <- c(xaxis_variable_in_quotes, line_variable_in_quotes)
  newd <- newd %>% bind_cols(df_means) %>% mutate(x= x1, y=y1)
  pred <- mgcv::predict.bam(gam_model, newdata = newd, type="terms") 
  pred <- as.data.frame(pred)
  pred
}

select_effects_function <- function (df_analyses, xaxis_variable_in_quotes, 
                                     prediction_df, 
                                     effects_cols_indices,
                                     line_lower_plotting_in_quotes_name, 
                                     line_middle_plotting_in_quotes_name, 
                                     line_higher_plotting_in_quotes_name){
  
  df_select <- df_analyses %>% dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc, 
                                                ndvi_monthly_stable, ndvi_monthly_step_dec, 
                                                ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc,
                                                ndvi_monthly_quad_inc_acc,ndvi_monthly_quad_inc_dec))
  
  var_x <- subset( df_select, select = xaxis_variable_in_quotes)
  xaxis_range <- seq(min(var_x),max(var_x),len = xaxis_range_len)
  
  ind <- 1:xaxis_range_len
  ind2 <- (xaxis_range_len + 1):(xaxis_range_len*2)
  ind3 <- ((xaxis_range_len*2)+1):(xaxis_range_len*3)
  
  xy_interaction_effects <- grep("x,y",names(prediction_df),fixed = T)
  pred_without_xy_interaction_effects <- (subset(prediction_df, select = -xy_interaction_effects))
  
  x1Eff <- rowSums(pred_without_xy_interaction_effects [ind, effects_cols_indices] )
  x2Eff <- rowSums(pred_without_xy_interaction_effects [ind2, effects_cols_indices] )
  x3Eff <- rowSums(pred_without_xy_interaction_effects [ind3, effects_cols_indices] )
  
  plot_df <- data.frame(xaxis_colname = xaxis_range)
  plot_df <- plot_df %>% mutate(x1Eff_colname = x1Eff,
                              x2Eff_colname = x2Eff,
                              x3Eff_colname = x3Eff)
  
  names(plot_df)<- c(xaxis_variable_in_quotes,
                     line_lower_plotting_in_quotes_name,
                     line_middle_plotting_in_quotes_name, 
                     line_higher_plotting_in_quotes_name)
  pivot_plot_df <- plot_df %>% pivot_longer(2:4)
  pivot_plot_df
  
}


```


#Step 5a (i) Trends in annual temp and RE across veg formations
```{r}
# location
x1 <- -43.2781
y1 <- -4.0213
xaxis_range_len <- 200


inc_pred_trend_at_re <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_annualtemp", "trend_re", 
                                                         inc_gam)
dec_pred_trend_at_re <- grid_creation_prediction(analyses_df, 
                                                         "trend_annualtemp", "trend_re", 
                                                         dec_gam)


plot_inc_trend_at_re <- select_effects_function(analyses_df, 
                                                        "trend_annualtemp", 
                                                        inc_pred_trend_at_re, 
                                                        c(4,16), #4,16 are column indices after removing s(x,y), ti (mean_at, x,y) and ti(trend_annualtemp, x,y)
                                                        "more_uniform_seasonality", "nochange", "less_uniform_seasonality")

plot_dec_trend_at_re <- select_effects_function(analyses_df, 
                                                        "trend_annualtemp", 
                                                        dec_pred_trend_at_re,
                                                        c(4,16),
                                                        "more_uniform_seasonality", "nochange", "less_uniform_seasonality")

combined_plot_df_prep <- function (inc_df, dec_df){
  inc_df <- inc_df %>% mutate(TrajType = "Step_Inc")
  dec_df <- dec_df %>% mutate(TrajType = "Step_Dec")
  plot_df <- bind_rows (inc_df, dec_df)
  plot_df
}

plot_df <- combined_plot_df_prep(plot_inc_trend_at_re, plot_dec_trend_at_re)

plot_function <- function (plot_df, xaxis_var){
  plot_interaction <- ggplot(plot_df, aes(x = .data[[xaxis_var]], y = value,
                                          color = name, linetype = TrajType,
                                          group = interaction(name, TrajType))) +
    geom_line(aes(color = name), linewidth = 1) + 
    theme_classic() +
    scale_color_manual(values=c("#990066", "#333333", "#336600")) + 
    ylab ("Partial Effect") + theme(legend.title=element_blank())
  plot_interaction
}

annualtemp_re <- plot_function(plot_df , "trend_annualtemp")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "TwoWay_InteractionResults", "trend_annualtemp_re.png"), annualtemp_re,
        dpi = 700, height = 25, width=25, units = "cm")

#remove(savanna_plot_df, grass_plot_df, forest_plot_df, plot_dec_grass_trend_at_re, plot_dec_forest_trend_at_re,plot_dec_savanna_trend_at_re,
#      plot_inc_grass_trend_at_re, plot_inc_forest_trend_at_re, plot_inc_savanna_trend_at_re,dec_pred_forest_trend_at_re, inc_pred_forest_trend_at_re,
#      dec_pred_grass_trend_at_re, inc_pred_grass_trend_at_re, dec_pred_savanna_trend_at_re, inc_pred_savanna_trend_at_re)
remove(plot_df, plot_dec_trend_at_re, plot_inc_trend_at_re, dec_pred_trend_at_re, inc_pred_trend_at_re)

```

#Step 5a (ii) Trends in heatwaves and SPEI across veg formations
```{r}
inc_pred_trend_heatwave_spei <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_heatwave", "trend_spei", 
                                                         inc_gam)
dec_pred_trend_heatwave_spei <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_heatwave", "trend_spei", 
                                                         dec_gam)

plot_inc_trend_heatwave_spei <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                        "trend_heatwave", 
                                                        inc_pred_trend_heatwave_spei, 
                                                        c(5,17),
                                                        "more_dry", "nochange", "more_wet")

plot_dec_trend_heatwave_spei <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                        "trend_heatwave", 
                                                        dec_pred_trend_heatwave_spei,
                                                        c(5,17),
                                                        "more_dry", "nochange", "more_wet")


plot_df <- combined_plot_df_prep(plot_inc_trend_heatwave_spei , plot_dec_trend_heatwave_spei)


heatwave_spei_vegformation <- plot_function(plot_df , "trend_heatwave")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "TwoWay_InteractionResults", "trend_heatwaves_spei.png"), heatwave_spei_vegformation,
        dpi = 700, height = 25, width=25, units = "cm")
remove(plot_df, plot_dec_trend_heatwave_spei, plot_inc_trend_heatwave_spei, inc_pred_trend_heatwave_spei, dec_pred_trend_heatwave_spei)

```

#Step 5a (iii) Mean anthropic distance and trend in burnedarea 
```{r}
inc_pred_trend_anthropicdist_burnedarea <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "anthropic_dist", "trend_burnedarea", 
                                                         inc_gam)
dec_pred_trend_anthropicdist_burnedarea <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "anthropic_dist", "trend_burnedarea", 
                                                         dec_gam)



plot_inc_trend_anthropicdist_burnedarea <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                        "anthropic_dist", 
                                                        inc_pred_trend_anthropicdist_burnedarea , 
                                                        c(1,21),
                                                        "more_burnedarea", "nochange", "less_burnedarea")
plot_dec_trend_anthropicdist_burnedarea<- select_effects_function(analyses_df_noNA_nooutliers, 
                                                        "anthropic_dist", 
                                                        dec_pred_trend_anthropicdist_burnedarea,
                                                        c(1,21),
                                                        "more_burnedarea", "nochange", "less_burnedarea")


plot_df <- combined_plot_df_prep(plot_inc_trend_anthropicdist_burnedarea, plot_dec_trend_anthropicdist_burnedarea)

anthropicdist_burnedarea_vegformation <- plot_function(plot_df , "anthropic_dist")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "TwoWay_InteractionResults", "anthropicdist_trend_burnedarea.png"), anthropicdist_burnedarea_vegformation  ,
        dpi = 700, height = 25, width=25, units = "cm")

remove(plot_df, plot_inc_trend_anthropicdist_burnedarea , plot_dec_trend_anthropicdist_burnedarea, inc_pred_trend_anthropicdist_burnedarea , dec_pred_trend_anthropicdist_burnedarea)
```

#Step 5a (iv) Mean anthropic distance and mean veg formation
```{r}
grid_creation_prediction <- function (df_analyses, xaxis_variable_in_quotes, 
                                              line_variable_in_quotes, 
                                              gam_model){
  df_select <- df_analyses %>% dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc, 
                                                ndvi_monthly_stable, ndvi_monthly_step_dec, 
                                                ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc,
                                                ndvi_monthly_quad_inc_acc,ndvi_monthly_quad_inc_dec))
  
  var_x <- subset( df_select, select = xaxis_variable_in_quotes)
  var_line <- subset( df_select, select = line_variable_in_quotes)
  var_line <- as.vector(var_line) %>% unlist()
  
  xaxis_range <- seq(min(var_x),max(var_x),len = xaxis_range_len)
  line_range <- c((mean(var_line) - sd(var_line)),mean(var_line), (mean(var_line) + sd(var_line))) #changed middle scenario to be mean of veg formation area
  
  df_means<- df_select %>% dplyr::select(-c(x,y,xaxis_variable_in_quotes, line_variable_in_quotes)) %>%
    summarise(across(where(is.numeric), ~mean(.x, na.rm= T)))
  
  newd <- data.frame(expand.grid(xaxis_range, line_range))
  names(newd) <- c(xaxis_variable_in_quotes, line_variable_in_quotes)
  newd <- newd %>% bind_cols(df_means) %>% mutate(x= x1, y=y1)
  pred <- mgcv::predict.bam(gam_model, newdata = newd, type="terms") 
  pred <- as.data.frame(pred)
  pred
}

inc_pred_anthropicdist_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "anthropic_dist", "mean_savanna_percentage", 
                                                         inc_gam)
dec_pred_anthropicdist_savanna  <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "anthropic_dist", "mean_savanna_percentage", 
                                                         dec_gam)
inc_pred_anthropicdist_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "anthropic_dist", "mean_forest_percentage", 
                                                         inc_gam)
dec_pred_anthropicdist_forest  <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "anthropic_dist", "mean_forest_percentage", 
                                                         dec_gam)
inc_pred_anthropicdist_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "anthropic_dist", "mean_grass_percentage", 
                                                         inc_gam)
dec_pred_anthropicdist_grass  <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "anthropic_dist", "mean_grass_percentage", 
                                                         dec_gam)


plot_inc_savanna_anthropicdist <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                        "anthropic_dist", 
                                                        inc_pred_anthropicdist_savanna , 
                                                        c(1,18),
                                                        "low", "medium", "high")
plot_dec_savanna_anthropicdist <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                        "anthropic_dist", 
                                                        dec_pred_anthropicdist_savanna,
                                                        c(1,18),
                                                        "low", "medium", "high")
plot_inc_forest_anthropicdist <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                       "anthropic_dist", inc_pred_anthropicdist_forest,
                                                       c(1,20),
                                                       "low", "medium", "high")
plot_dec_forest_anthropicdist <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                       "anthropic_dist", 
                                                       dec_pred_anthropicdist_forest , 
                                                      c(1,20),
                                                       "low", "medium", "high")
plot_inc_grass_anthropicdist <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                      "anthropic_dist", 
                                                      inc_pred_anthropicdist_grass, 
                                                     c(1,19),
                                                      "low", "medium", "high")
plot_dec_grass_anthropicdist <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                      "anthropic_dist", 
                                                      dec_pred_anthropicdist_grass, 
                                                      c(1,19),
                                                      "low", "medium", "high")
combined_plot_df_prep <- function (inc_df, dec_df, veg_formation_in_quotes){
  inc_df <- inc_df %>% mutate(TrajType = "Step_Inc")
  dec_df <- dec_df %>% mutate(TrajType = "Step_Dec")
  plot_df <- bind_rows (inc_df, dec_df)
  plot_df <- plot_df %>% mutate(VegFormation = veg_formation_in_quotes)
  plot_df
}

savanna_plot_df <- combined_plot_df_prep(plot_inc_savanna_anthropicdist , plot_dec_savanna_anthropicdist, "Savanna")
grass_plot_df <- combined_plot_df_prep(plot_inc_grass_anthropicdist , plot_dec_grass_anthropicdist, "Grass")
forest_plot_df <- combined_plot_df_prep(plot_inc_forest_anthropicdist  , plot_dec_forest_anthropicdist , "Forest")

anthropicdist_vegformation_plot_df <- bind_rows(savanna_plot_df, grass_plot_df, forest_plot_df)

plot_function <- function (plot_df, xaxis_var){
  plot_interaction <- ggplot(plot_df, aes(x = .data[[xaxis_var]], y = value,
                                          color = name, linetype = TrajType,
                                          group = interaction(name, TrajType))) +
    geom_line(aes(color = name), linewidth = 1) + facet_wrap(~VegFormation)+
    theme_classic() +
    scale_color_manual(values=c("#990066", "#333333", "#336600")) + 
    ylab ("Partial Effect") + theme(legend.title=element_blank())
  plot_interaction
}


anthropicdist_vegformation_vegformation <- plot_function(anthropicdist_vegformation_plot_df , "anthropic_dist")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "TwoWay_InteractionResults", "anthropicdist_meanvegformation2.png"), anthropicdist_vegformation_vegformation,
        dpi = 700, height = 25, width=25, units = "cm")

remove(savanna_plot_df, grass_plot_df, forest_plot_df, 
       inc_pred_anthropicdist_savanna, dec_pred_anthropicdist_savanna, inc_pred_anthropicdist_forest, dec_pred_anthropicdist_forest,inc_pred_anthropicdist_grass,dec_pred_anthropicdist_grass, plot_inc_savanna_anthropicdist, plot_dec_savanna_anthropicdist, plot_inc_forest_anthropicdist, plot_dec_forest_anthropicdist, plot_inc_grass_anthropicdist, plot_dec_grass_anthropicdist)     
```

#Step 5a (v) Trend in burnedarea and mean veg formation
```{r}
grid_creation_prediction <- function (df_analyses, xaxis_variable_in_quotes, 
                                              line_variable_in_quotes, 
                                              gam_model){
  df_select <- df_analyses %>% dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc, 
                                                ndvi_monthly_stable, ndvi_monthly_step_dec, 
                                                ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc,
                                                ndvi_monthly_quad_inc_acc,ndvi_monthly_quad_inc_dec))
  
  var_x <- subset( df_select, select = xaxis_variable_in_quotes)
  var_line <- subset( df_select, select = line_variable_in_quotes)
  var_line <- as.vector(var_line) %>% unlist()
  
  xaxis_range <- seq(min(var_x),max(var_x),len = xaxis_range_len)
  line_range <- c((mean(var_line) - sd(var_line)),mean(var_line), (mean(var_line) + sd(var_line))) #changed middle scenario to be mean of veg formation area
  
  df_means<- df_select %>% dplyr::select(-c(x,y,xaxis_variable_in_quotes, line_variable_in_quotes)) %>%
    summarise(across(where(is.numeric), ~mean(.x, na.rm= T)))
  
  newd <- data.frame(expand.grid(xaxis_range, line_range))
  names(newd) <- c(xaxis_variable_in_quotes, line_variable_in_quotes)
  newd <- newd %>% bind_cols(df_means) %>% mutate(x= x1, y=y1)
  pred <- mgcv::predict.bam(gam_model, newdata = newd, type="terms") 
  pred <- as.data.frame(pred)
  pred
}

inc_pred_trend_burnedarea_savanna <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_burnedarea", "mean_savanna_percentage", 
                                                         inc_gam)
dec_pred_trend_burnedarea_savanna  <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_burnedarea", "mean_savanna_percentage", 
                                                         dec_gam)
inc_pred_trend_burnedarea_forest <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_burnedarea", "mean_forest_percentage", 
                                                         inc_gam)
dec_pred_trend_burnedarea_forest  <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_burnedarea", "mean_forest_percentage", 
                                                         dec_gam)
inc_pred_trend_burnedarea_grass <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_burnedarea", "mean_grass_percentage", 
                                                         inc_gam)
dec_pred_trend_burnedarea_grass  <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_burnedarea", "mean_grass_percentage", 
                                                         dec_gam)

plot_inc_savanna_trend_burnedarea <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                        "trend_burnedarea", 
                                                        inc_pred_trend_burnedarea_savanna , 
                                                        c(7,22),
                                                        "low", "medium", "high")
plot_dec_savanna_trend_burnedarea <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                        "trend_burnedarea", 
                                                        dec_pred_trend_burnedarea_savanna,
                                                        c(7,22),
                                                        "low", "medium", "high")
plot_inc_forest_trend_burnedarea <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                       "trend_burnedarea", inc_pred_trend_burnedarea_forest,
                                                       c(7,24),
                                                       "low", "medium", "high")
plot_dec_forest_trend_burnedarea <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                       "trend_burnedarea", 
                                                       dec_pred_trend_burnedarea_forest , 
                                                      c(7,24),
                                                       "low", "medium", "high")
plot_inc_grass_trend_burnedarea <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                      "trend_burnedarea", 
                                                      inc_pred_trend_burnedarea_grass, 
                                                     c(7,23),
                                                      "low", "medium", "high")
plot_dec_grass_trend_burnedarea <- select_effects_function(analyses_df_noNA_nooutliers, 
                                                      "trend_burnedarea", 
                                                      dec_pred_trend_burnedarea_grass, 
                                                      c(7,23),
                                                      "low", "medium", "high")

savanna_plot_df <- combined_plot_df_prep(plot_inc_savanna_trend_burnedarea , plot_dec_savanna_trend_burnedarea , "Savanna")
grass_plot_df <- combined_plot_df_prep(plot_inc_grass_trend_burnedarea , plot_dec_grass_trend_burnedarea, "Grass")
forest_plot_df <- combined_plot_df_prep(plot_inc_forest_trend_burnedarea  , plot_dec_forest_trend_burnedarea , "Forest")

trend_burnedarea_vegformation_plot_df <- bind_rows(savanna_plot_df, grass_plot_df, forest_plot_df)

trend_burnedarea_vegformation_vegformation <- plot_function(trend_burnedarea_vegformation_plot_df , "trend_burnedarea")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "TwoWay_InteractionResults", "trend_burnedarea_meanvegformation2.png"), trend_burnedarea_vegformation_vegformation,
        dpi = 700, height = 25, width=25, units = "cm")

remove(savanna_plot_df, grass_plot_df, forest_plot_df, 
       inc_pred_trend_burnedarea_savanna, dec_pred_trend_burnedarea_savanna, inc_pred_trend_burnedarea_forest, dec_pred_trend_burnedarea_forest,inc_pred_trend_burnedarea_grass,dec_pred_trend_burnedarea_grass, plot_inc_savanna_trend_burnedarea, plot_dec_savanna_trend_burnedarea, plot_inc_forest_trend_burnedarea, plot_dec_forest_trend_burnedarea, plot_inc_grass_trend_burnedarea, plot_dec_grass_trend_burnedarea) 
```

#Step 5b - Functions to visualize 3 way interactions
```{r}
# location
x1 <- -43.2781
y1 <- -4.0213
xaxis_range_len <- 200

#savanna_gam_step_inc <- read_rds(here("Scripts", "Final_Scripts", "analyses", "savanna_gam_model.rds"))
#savanna_gam_step_dec <- read_rds(here("Scripts", "Final_Scripts", "analyses", "savanna_gam_stepdecrease.rds"))

#grass_gam_step_inc <- read_rds(here("Scripts", "Final_Scripts", "analyses", "grass_gam_model.rds"))
#grass_gam_step_dec <- read_rds(here("Scripts", "Final_Scripts", "analyses", "grass_gam_stepdecrease.rds"))

#forest_gam_step_inc <- read_rds(here("Scripts", "Final_Scripts", "analyses", "forest_gam_model.rds"))
#forest_gam_step_dec <- read_rds(here("Scripts", "Final_Scripts", "analyses", "forest_gam_stepdecrease.rds"))

inc_gam <- read_rds(here("Scripts", "Final_Scripts", "analyses", "onemodel_inc.rds"))
dec_gam <- read_rds(here("Scripts", "Final_Scripts", "analyses" ,"onemodel_dec.rds"))


grid_creation_prediction <- function (df_analyses, xaxis_variable_in_quotes, 
                                      line_variable_in_quotes, 
                                      panel_variable_in_quotes,
                                      gam_model){
  df_select <- df_analyses %>% dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc, 
                                                ndvi_monthly_stable, ndvi_monthly_step_dec, 
                                                ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc,
                                                ndvi_monthly_quad_inc_acc,ndvi_monthly_quad_inc_dec))
  
  var_x <- subset( df_select, select = xaxis_variable_in_quotes)
  var_line <- subset( df_select, select = line_variable_in_quotes)
  var_line <- as.vector(var_line) %>% unlist()
  
  xaxis_range <- seq(min(var_x),max(var_x),len = xaxis_range_len)
  line_range <- c((mean(var_line) - sd(var_line)), mean(var_line), (mean(var_line) + sd(var_line)))
  
  panel_decreasing <- mean(df_select[[panel_variable_in_quotes]]) +sd(df_select[[panel_variable_in_quotes]])
  panel_nochange <- 0
  panel_increasing <- mean(df_select[[panel_variable_in_quotes]]) - sd(df_select[[panel_variable_in_quotes]])
  
  df_means<- df_select %>% dplyr::select(-c(x,y,xaxis_variable_in_quotes, line_variable_in_quotes, panel_variable_in_quotes)) %>%
    summarise(across(where(is.numeric), ~mean(.x, na.rm= T)))
  
  df_panel_dec <- data.frame(expand.grid(xaxis_range, line_range))
  names(df_panel_dec) <- c(xaxis_variable_in_quotes, line_variable_in_quotes)
  df_panel_dec <- df_panel_dec %>% bind_cols(df_means) %>% mutate(x= x1, y=y1, panel_variable_in_quotes = panel_decreasing)
  names(df_panel_dec)[dim(df_panel_dec)[2]]<- panel_variable_in_quotes
  df_panel_nochange <- data.frame(expand.grid(xaxis_range, line_range))
  names(df_panel_nochange) <- c(xaxis_variable_in_quotes, line_variable_in_quotes)
  df_panel_nochange <- df_panel_nochange %>% bind_cols(df_means) %>% mutate(x= x1, y=y1, panel_variable_in_quotes = panel_nochange)
  names(df_panel_nochange)[dim(df_panel_nochange)[2]]<- panel_variable_in_quotes
  df_panel_inc <- data.frame(expand.grid(xaxis_range, line_range))
  names(df_panel_inc) <- c(xaxis_variable_in_quotes, line_variable_in_quotes)
  df_panel_inc <- df_panel_inc %>% bind_cols(df_means) %>% mutate(x= x1, y=y1, panel_variable_in_quotes = panel_increasing)
  names(df_panel_inc)[dim(df_panel_inc)[2]]<- panel_variable_in_quotes

  pred_dec <- mgcv::predict.bam(gam_model, newdata = df_panel_dec, type="terms")
  pred_dec <- as.data.frame(pred_dec)
  pred_nochange <- mgcv::predict.bam(gam_model, newdata = df_panel_nochange, type="terms")
  pred_nochange <- as.data.frame(pred_nochange)
  pred_inc <- mgcv::predict.bam(gam_model, newdata = df_panel_inc, type="terms")
  pred_inc <- as.data.frame(pred_inc)
  
  pred_list <- list(pred_dec, pred_nochange, pred_inc)
  pred_list
}


select_effects_function <- function (df_analyses, xaxis_variable_in_quotes, 
                                     prediction_inc_df, prediction_nochange_df, prediction_dec_df, 
                                     effects_cols_indices,
                                     paneldec_line_lower_plotting_in_quotes_name,
                     paneldec_line_middle_plotting_in_quotes_name, 
                     paneldec_line_higher_plotting_in_quotes_name,
                     panelnochange_line_lower_plotting_in_quotes_name,
                     panelnochange_line_middle_plotting_in_quotes_name, 
                     panelnochange_line_higher_plotting_in_quotes_name,
                     panelinc_line_lower_plotting_in_quotes_name,
                     panelinc_line_middle_plotting_in_quotes_name, 
                     panelinc_line_higher_plotting_in_quotes_name){
  
  df_select <- df_analyses %>% dplyr::select(-c(ndvi_monthly_lin_dec, ndvi_monthly_lin_inc, 
                                                ndvi_monthly_stable, ndvi_monthly_step_dec, 
                                                ndvi_monthly_quad_dec_acc, ndvi_monthly_quad_dec_decc,
                                                ndvi_monthly_quad_inc_acc,ndvi_monthly_quad_inc_dec))
  
  var_x <- subset( df_select, select = xaxis_variable_in_quotes)
  xaxis_range <- seq(min(var_x),max(var_x),len = xaxis_range_len)
  
  ind <- 1:xaxis_range_len
  ind2 <- (xaxis_range_len + 1):(xaxis_range_len*2)
  ind3 <- ((xaxis_range_len*2)+1):(xaxis_range_len*3)
  
  xy_interaction_effects <- grep("x,y",names(prediction_inc_df),fixed = T)
  inc_pred_without_xy_interaction_effects <- (subset(prediction_inc_df, select = -xy_interaction_effects))
  nochange_pred_without_xy_interaction_effects <- (subset(prediction_dec_df, select = -xy_interaction_effects))
  dec_pred_without_xy_interaction_effects <- (subset(prediction_nochange_df, select = -xy_interaction_effects))
  
  x1Eff <- rowSums(dec_pred_without_xy_interaction_effects [ind, effects_cols_indices] )
  x2Eff <- rowSums(dec_pred_without_xy_interaction_effects [ind2, effects_cols_indices] )
  x3Eff <- rowSums(dec_pred_without_xy_interaction_effects [ind3, effects_cols_indices] )
  
  x4Eff <- rowSums(nochange_pred_without_xy_interaction_effects [ind, effects_cols_indices] )
  x5Eff <- rowSums(nochange_pred_without_xy_interaction_effects [ind2, effects_cols_indices] )
  x6Eff <- rowSums(nochange_pred_without_xy_interaction_effects [ind3, effects_cols_indices] )
  
  x7Eff <- rowSums(inc_pred_without_xy_interaction_effects [ind, effects_cols_indices] )
  x8Eff <- rowSums(inc_pred_without_xy_interaction_effects [ind2, effects_cols_indices] )
  x9Eff <- rowSums(inc_pred_without_xy_interaction_effects [ind3, effects_cols_indices] )
  
  plot_df <- data.frame(xaxis_colname = xaxis_range)
  plot_df <- plot_df %>% mutate(x1Eff_colname = x1Eff,
                              x2Eff_colname = x2Eff,
                              x3Eff_colname = x3Eff,
                              x4Eff_colname = x4Eff,
                              x5Eff_colname = x5Eff,
                              x6Eff_colname = x6Eff,
                              x7Eff_colname = x7Eff,
                              x8Eff_colname = x8Eff,
                              x9Eff_colname = x9Eff)
  
  names(plot_df)<- c(xaxis_variable_in_quotes,
                     paneldec_line_lower_plotting_in_quotes_name,
                     paneldec_line_middle_plotting_in_quotes_name, 
                     paneldec_line_higher_plotting_in_quotes_name,
                     panelnochange_line_lower_plotting_in_quotes_name,
                     panelnochange_line_middle_plotting_in_quotes_name, 
                     panelnochange_line_higher_plotting_in_quotes_name,
                     panelinc_line_lower_plotting_in_quotes_name,
                     panelinc_line_middle_plotting_in_quotes_name, 
                     panelinc_line_higher_plotting_in_quotes_name)
  pivot_plot_df <- plot_df %>% pivot_longer(-1)
  pivot_plot_df <- pivot_plot_df %>% separate(name, into =c("lines_var_type", "panel_var_type"), sep = "_" )
  pivot_plot_df
}

combined_plot_df_prep <- function (inc_df, dec_df, veg_formation_in_quotes){
  inc_df <- inc_df %>% mutate(TrajType = "Step_Inc")
  dec_df <- dec_df %>% mutate(TrajType = "Step_Dec")
  plot_df <- bind_rows (inc_df, dec_df)
  plot_df
}

plot_function <- function (plot_df, xaxis_var){
  plot_interaction <- ggplot(plot_df, aes(x = .data[[xaxis_var]], y = value,
                                          color = lines_var_type, linetype = TrajType,
                                          group = interaction(lines_var_type, TrajType))) +
    geom_line(aes(color = lines_var_type), linewidth = 1) + facet_wrap(~panel_var_type)+
    theme_classic() +
    scale_color_manual(values=c("#990066", "#333333", "#336600")) + 
    ylab ("Partial Effect") + theme(legend.title=element_blank())
  plot_interaction
}


```

#Step 5b (i) - Trends in annual temp, RE across veg formations
```{r}
inc_pred_savanna_trend_at_re <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_annualtemp", "mean_savanna_percentage", "trend_re",
                                                         inc_gam)
dec_pred_savanna_trend_at_re <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_annualtemp", "mean_savanna_percentage", "trend_re",
                                                         dec_gam)
inc_pred_forest_trend_at_re<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_annualtemp", "mean_forest_percentage", "trend_re", 
                                                         inc_gam)
dec_pred_forest_trend_at_re <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_annualtemp", "mean_forest_percentage", "trend_re",
                                                         dec_gam)
inc_pred_grass_trend_at_re<- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_annualtemp", "mean_grass_percentage", "trend_re", 
                                                         inc_gam)
dec_pred_grass_trend_at_re <- grid_creation_prediction(analyses_df_noNA_nooutliers, 
                                                         "trend_annualtemp", "mean_grass_percentage", "trend_re",
                                                         dec_gam)


plot_inc_savanna_trend_at_re <- select_effects_function(analyses_df_noNA_nooutliers, "trend_annualtemp", 
                                 inc_pred_savanna_trend_at_re[[3]], inc_pred_savanna_trend_at_re[[2]], inc_pred_savanna_trend_at_re[[1]],
                                 c(4,16,26),
                                "low_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall",
                                "low_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall",
                                "low_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall")
plot_dec_savanna_trend_at_re <- select_effects_function(analyses_df_noNA_nooutliers, "trend_annualtemp", 
                                 dec_pred_savanna_trend_at_re[[3]],dec_pred_savanna_trend_at_re[[2]], dec_pred_savanna_trend_at_re[[1]],
                                 c(4,16,26),
                                "low_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall",
                                "low_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall",
                                "low_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall")
plot_inc_forest_trend_at_re <- select_effects_function(analyses_df_noNA_nooutliers, "trend_annualtemp", 
                                 inc_pred_forest_trend_at_re[[3]], inc_pred_forest_trend_at_re[[2]], inc_pred_forest_trend_at_re[[1]],
                                 c(4,16,30),
                                "low_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall",
                                "low_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall",
                                "low_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall")
plot_dec_forest_trend_at_re <- select_effects_function(analyses_df_noNA_nooutliers, "trend_annualtemp", 
                                 dec_pred_forest_trend_at_re[[3]], dec_pred_forest_trend_at_re[[2]], dec_pred_forest_trend_at_re[[1]],
                                 c(4,16,30),
                                "low_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall",
                                "low_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall",
                                "low_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall")
plot_inc_grass_trend_at_re <- select_effects_function(analyses_df_noNA_nooutliers, "trend_annualtemp", 
                                 inc_pred_grass_trend_at_re[[3]], inc_pred_grass_trend_at_re[[2]], inc_pred_grass_trend_at_re[[1]],
                                 c(4,16,28),
                                "low_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall",
                                "low_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall",
                                "low_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall")
plot_dec_grass_trend_at_re <- select_effects_function(analyses_df_noNA_nooutliers, "trend_annualtemp", 
                                 dec_pred_grass_trend_at_re[[3]], dec_pred_grass_trend_at_re[[2]], dec_pred_grass_trend_at_re[[1]],
                                 c(4,16,28),
                                "low_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall",
                                "low_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall",
                                "low_more.uniform.rainfall", "average_no.trend.rainfall.seasonality", "high_more.seasonal.rainfall")

savanna_plot_df <- combined_plot_df_prep(plot_inc_savanna_trend_at_re , plot_dec_savanna_trend_at_re, "Savanna")
grass_plot_df <- combined_plot_df_prep(plot_inc_forest_trend_at_re, plot_dec_forest_trend_at_re, "Grass")
forest_plot_df <- combined_plot_df_prep(plot_inc_grass_trend_at_re, plot_dec_grass_trend_at_re, "Forest")


annualtemp_re_plot_df <- bind_rows(savanna_plot_df, grass_plot_df, forest_plot_df)

annualtemp_re_vegformation <- plot_function(annualtemp_re_plot_df , "trend_annualtemp")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "ThreeWay_InteractionResults", "trend_annualtemp_re_burnedarea.png"), annualtemp_re_vegformation,
        dpi = 700, height = 25, width=25, units = "cm")

remove(savanna_plot_df, grass_plot_df, forest_plot_df,plot_dec_grass_trend_at_re_burnedarea, plot_dec_forest_trend_at_re_burnedarea, plot_dec_savanna_trend_at_re_burnedarea ,
       plot_inc_grass_trend_at_re_burnedarea, plot_inc_forest_trend_at_re_burnedarea, plot_inc_savanna_trend_at_re_burnedarea, dec_pred_grass_trend_at_re_burnedarea,
       dec_pred_forest_trend_at_re_burnedarea, dec_pred_savanna_trend_at_re_burnedarea, inc_pred_grass_trend_at_re_burnedarea, inc_pred_forest_trend_at_re_burnedarea, inc_pred_savanna_trend_at_re_burnedarea   )

```

#Step 5b (ii) - Trends in heatwaves, SPEI across veg formations

```{r}
inc_pred_savanna_trend_heatwaves_spei_burnedarea <- grid_creation_prediction(savanna_df_noNA_nooutliers, 
                                                         "trend_heatwave", "trend_spei", "trend_burnedarea",
                                                         savanna_gam_step_inc)
inc_pred_forest_trend_heatwaves_spei_burnedarea <- grid_creation_prediction(forest_df_noNA_nooutliers, 
                                                         "trend_heatwave", "trend_spei", "trend_burnedarea",
                                                         forest_gam_step_inc)
inc_pred_grass_trend_heatwaves_spei_burnedarea <- grid_creation_prediction(grass_df_noNA_nooutliers, 
                                                         "trend_heatwave", "trend_spei", "trend_burnedarea",
                                                         grass_gam_step_inc)
dec_pred_savanna_trend_heatwaves_spei_burnedarea <- grid_creation_prediction(savanna_df_noNA_nooutliers, 
                                                         "trend_heatwave", "trend_spei", "trend_burnedarea",
                                                         savanna_gam_step_dec)
dec_pred_forest_trend_heatwaves_spei_burnedarea <- grid_creation_prediction(forest_df_noNA_nooutliers, 
                                                         "trend_heatwave", "trend_spei", "trend_burnedarea",
                                                         forest_gam_step_dec)
dec_pred_grass_trend_heatwaves_spei_burnedarea <- grid_creation_prediction(grass_df_noNA_nooutliers, 
                                                         "trend_heatwave", "trend_spei", "trend_burnedarea",
                                                         grass_gam_step_dec)

plot_inc_savanna_trend_heatwaves_spei_burnedarea <- select_effects_function(savanna_df_noNA_nooutliers, "trend_heatwave", 
                                 inc_pred_savanna_trend_heatwaves_spei_burnedarea[[3]],
                                 inc_pred_savanna_trend_heatwaves_spei_burnedarea[[2]],
                                 inc_pred_savanna_trend_heatwaves_spei_burnedarea[[1]],
                                 c(5,15,20),
                                "dec.droughts_decburn", "no.trend.droughts_decburn", "inc.droughts_decburn",
                                "dec.droughts_nochange", "no.trend.droughts_nochange", "inc.droughts_nochange",
                                "dec.droughts_incburn", "no.trend.droughts_incburn", "inc.droughts_incburn")
plot_inc_forest_trend_heatwaves_spei_burnedarea <- select_effects_function(savanna_df_noNA_nooutliers, "trend_heatwave", 
                                 inc_pred_forest_trend_heatwaves_spei_burnedarea[[3]],
                                 inc_pred_forest_trend_heatwaves_spei_burnedarea[[2]],
                                 inc_pred_forest_trend_heatwaves_spei_burnedarea[[1]],
                                 c(5,15,20),
                                "dec.droughts_decburn", "no.trend.droughts_decburn", "inc.droughts_decburn",
                                "dec.droughts_nochange", "no.trend.droughts_nochange", "inc.droughts_nochange",
                                "dec.droughts_incburn", "no.trend.droughts_incburn", "inc.droughts_incburn")
plot_inc_grass_trend_heatwaves_spei_burnedarea <- select_effects_function(savanna_df_noNA_nooutliers, "trend_heatwave", 
                                 inc_pred_grass_trend_heatwaves_spei_burnedarea[[3]],
                                 inc_pred_grass_trend_heatwaves_spei_burnedarea[[2]],
                                 inc_pred_grass_trend_heatwaves_spei_burnedarea[[1]],
                                c(5,15,20),
                                "dec.droughts_decburn", "no.trend.droughts_decburn", "inc.droughts_decburn",
                                "dec.droughts_nochange", "no.trend.droughts_nochange", "inc.droughts_nochange",
                                "dec.droughts_incburn", "no.trend.droughts_incburn", "inc.droughts_incburn")
plot_dec_savanna_trend_heatwaves_spei_burnedarea <- select_effects_function(savanna_df_noNA_nooutliers, "trend_heatwave", 
                                 dec_pred_savanna_trend_heatwaves_spei_burnedarea[[3]],
                                 dec_pred_savanna_trend_heatwaves_spei_burnedarea[[2]],
                                 dec_pred_savanna_trend_heatwaves_spei_burnedarea[[1]],
                                 c(5,15,20),
                                "dec.droughts_decburn", "no.trend.droughts_decburn", "inc.droughts_decburn",
                                "dec.droughts_nochange", "no.trend.droughts_nochange", "inc.droughts_nochange",
                                "dec.droughts_incburn", "no.trend.droughts_incburn", "inc.droughts_incburn")
plot_dec_forest_trend_heatwaves_spei_burnedarea <- select_effects_function(savanna_df_noNA_nooutliers, "trend_heatwave", 
                                 dec_pred_forest_trend_heatwaves_spei_burnedarea[[3]],
                                 dec_pred_forest_trend_heatwaves_spei_burnedarea[[2]],
                                 dec_pred_forest_trend_heatwaves_spei_burnedarea[[1]],
                                 c(5,15,20),
                                "dec.droughts_decburn", "no.trend.droughts_decburn", "inc.droughts_decburn",
                                "dec.droughts_nochange", "no.trend.droughts_nochange", "inc.droughts_nochange",
                                "dec.droughts_incburn", "no.trend.droughts_incburn", "inc.droughts_incburn")
plot_dec_grass_trend_heatwaves_spei_burnedarea <- select_effects_function(savanna_df_noNA_nooutliers, "trend_heatwave", 
                                 dec_pred_grass_trend_heatwaves_spei_burnedarea[[3]],
                                 dec_pred_grass_trend_heatwaves_spei_burnedarea[[2]],
                                 dec_pred_grass_trend_heatwaves_spei_burnedarea[[1]],
                                 c(5,15,20),
                                "dec.droughts_decburn", "no.trend.droughts_decburn", "inc.droughts_decburn",
                                "dec.droughts_nochange", "no.trend.droughts_nochange", "inc.droughts_nochange",
                                "dec.droughts_incburn", "no.trend.droughts_incburn", "inc.droughts_incburn")

savanna_plot_df <- combined_plot_df_prep(plot_inc_savanna_trend_heatwaves_spei_burnedarea , plot_dec_savanna_trend_heatwaves_spei_burnedarea, "Savanna")
grass_plot_df <- combined_plot_df_prep(plot_inc_forest_trend_heatwaves_spei_burnedarea, plot_dec_forest_trend_heatwaves_spei_burnedarea, "Grass")
forest_plot_df <- combined_plot_df_prep(plot_inc_grass_trend_heatwaves_spei_burnedarea , plot_dec_grass_trend_heatwaves_spei_burnedarea, "Forest")

heatwaves_spei_burnedarea_plot_df <- bind_rows(savanna_plot_df, grass_plot_df, forest_plot_df)

heatwaves_spei_burnedarea_vegformation <- plot_function(heatwaves_spei_burnedarea_plot_df ,"trend_heatwave")
ggsave (here("Outputs", "AnalysesResults", "GAMResults", "ThreeWay_InteractionResults", "trend_heatwaves_spei_burnedarea.png"), heatwaves_spei_burnedarea_vegformation,
        dpi = 700, height = 25, width=25, units = "cm")

remove(savanna_plot_df, grass_plot_df, forest_plot_df,plot_dec_grass_trend_heatwaves_spei_burnedarea, plot_dec_forest_trend_heatwaves_spei_burnedarea, plot_dec_savanna_trend_heatwaves_spei_burnedarea ,
       plot_inc_grass_trend_heatwaves_spei_burnedarea, plot_inc_forest_trend_heatwaves_spei_burnedarea, plot_inc_savanna_trend_heatwaves_spei_burnedarea, dec_pred_grass_trend_heatwaves_spei_burnedarea,
       dec_pred_forest_trend_heatwaves_spei_burnedarea, dec_pred_savanna_trend_heatwaves_spei_burnedarea, inc_pred_grass_trend_heatwaves_spei_burnedarea, inc_pred_forest_trend_heatwaves_spei_burnedarea, inc_pred_savanna_trend_heatwaves_spei_burnedarea   )

```

#Step 5b (iii) - Trends in burned area, annual temp and re