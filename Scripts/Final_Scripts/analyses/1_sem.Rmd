```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, include=FALSE}
library(RColorBrewer)
library(lattice)
library(tidyverse)
library(here)
library(tictoc)

library(ggplot2)
library(ggpubr)
library(sf)
library(terra)

library(tmap)
library(tmaptools)
library(RColorBrewer)
library(viridis)

terraOptions(memfrac=0.8, tempdir = here("Scratch"), progress=10)
```

##Introduction
In this script, I do structural equation modeling to understand causal relationships between 
environmental drives and stability at the biome scale.

##Data input
```{r}
#response- stable area from all three indices
aniso_stable<- rast(here("Outputs", "Final_TrajShape_Models", "Annual", "agg_stability_am_11_trajresults.tif"))
evi_stable<- rast(here("Outputs", "Final_TrajShape_Models", "Annual_EVI", "agg_stability_masked_evi_11_trajresults.tif"))
ndvi_stable<- rast(here("Outputs", "Final_TrajShape_Models", "Annual_NDVI", "agg_stability_masked_ndvi_11_trajresults.tif"))

#drivers
anthropic_dist<- rast(here("Outputs", "OtherVariables", "AnthropicDist", "5km_meandist_20thresholdsanthropicpixel.tif"))
burnedarea<- rast(here("Outputs", "OtherVariables", "Fire", "burnedarea_5km_2002_2021.tif"))
pixelheterogeniety<- rast(here ("Outputs", "OtherVariables", "PixelHeterogeniety", "cerrado_diversity_2002_2021.tif"))
hand<- rast(here("Outputs", "OtherVariables","HAND", "cerrado_hand_5km.tif"))
re<- rast(here("Outputs", "OtherVariables", "Climate", "annual_relative_entropy_1981_2021.tif"))
mat<- rast(here("Outputs", "OtherVariables", "Climate", "mat_1981_2021.tif"))
spei<- rast(here("Outputs", "OtherVariables", "Climate", "annualspei_2002_2021.tif"))
heatwave<- rast(here("Outputs", "OtherVariables", "Climate", "heatwaves_2002_2021.tif"))

#mask- 20% anthropic mask
threshold<- rast(here("Data", "Masks_to_define_pixelsofinterest", "mapbiomas_anthropic_mask", "5km_thresholded_mapbiomas_mask_20.tif"))
```

##Preprocessing of all data- applying 20%threshold mask, aligning CRS/extent/cell size
and some preprocessing of driver data.

For the "dynamic" drivers ie time series drivers, for the SEM modeling I use mean across all years.
Hence for MAT, I have already processed the mean. But for pixel heterogeniety, I have not. 
```{r}
#dynamics rasters ie time series drivers, I calcualte mean
mean_driver<- function(annualraster){
  terra::app(annualraster, fun= "mean")
}

mean_ba<- mean_driver(burnedarea)
mean_bio<- mean_driver(pixelheterogeniety)
mean_re<- mean_driver(re)
mean_spei<-mean_driver(spei)
remove(burnedarea, pixelheterogeniety, re, spei)

drivers<- c(anthropic_dist, mean_ba, mean_bio, hand, mean_re, mat, mean_spei, heatwave)
drivers
names(drivers)<- c("anthropic_dist", "burnedarea", "biodiversity", "hand", "re", "mat", "spei", "heatwave")

#masking predictors
masked_drivers<- terra::mask(drivers, threshold)

stability<- c(aniso_stable, evi_stable, ndvi_stable)
#masking response
masked_stability<- terra::mask(stability, threshold)
names(masked_stability)<- c("aniso_stability", "evi_stability", "ndvi_stability")

all_data<- c(masked_stability, masked_drivers)
analyses_df<- terra::as.data.frame(all_data)
remove(mean_driver)
remove(aniso_stable, evi_stable, ndvi_stable, threshold, anthropic_dist, burnedarea, pixelheterogeniety, hand, re, mat, spei, heatwave)
remove(mean_ba, mean_bio, mean_re, mean_spei)
remove(drivers, stability)
```


##SEM
#EDA
First because the sample size is the population, I know that all test statistics will
be unreliable, especially statistics like chi sq that are dependent on sample size. 
Hence I sample a % of the total data. I then do EDA because SEM usually
is run on Gaussian distributed data
```{r}
analyses_df

set.seed(1000)
sample_df<- analyses_df %>% slice_sample(prop=0.1, replace= FALSE) #10% randomly sampled
summary(sample_df)

#install.packages("PerformanceAnalytics")
library(PerformanceAnalytics)
chart.Correlation(sample_df, histogram = TRUE, pch= 19)

#Removing outliers considering distribution of HAND
no_outliers_sample_df <- sample_df %>% 
          mutate (IQR = IQR(hand),
                  O_upper = quantile (hand, probs= c(0.75), na.rm= FALSE)+ 1.5*IQR,
                  O_lower = quantile(hand, probs= c(0.25), na.rm= FALSE) - 1.5*IQR
                  ) %>% 
          filter(O_lower <= hand & hand <= O_upper) %>%
          dplyr::select(-c(IQR, O_upper, O_lower))

chart.Correlation(no_outliers_sample_df, histogram = TRUE, pch= 19)

no_outliers_sample_df
summary(no_outliers_sample_df) #NAs in response/outcome and spei

no_outliers_sample_df2<- no_outliers_sample_df %>% drop_na()
summary(no_outliers_sample_df2)

analyses_ndvistability<- no_outliers_sample_df2 %>% dplyr::select(-c(aniso_stability, evi_stability))
scaled_analyses_ndvistability<- data.frame(scale(analyses_ndvistability, center= TRUE, scale= TRUE)) #n = 1852
```
All response variables of stable area by index are right skewed (because most of the Cerrado is stable).
Heatwaves# is normally distributed, while the remaining variables are not. I excluded outliers beyond the 
interquartile range for hand. After exclusion of outliers, most variables are still not normally distributed. 

#Analyses
I first consider on NDVI based stable area response variable
```{r}
scaled_analyses_ndvistability

#install.packages("lavaan", "piecewiseSEM")
library(lavaan)
library(piecewiseSEM)

model1<- psem (
  lm (ndvi_stability ~ hand, 
      data= analyses_ndvistability),
  data = analyses_ndvistability
)
summary(model1)

model2<- psem (
  lm(ndvi_stability ~ biodiversity + anthropic_dist, data = analyses_ndvistability),
  lm (biodiversity ~ anthropic_dist, data = analyses_ndvistability),
  data = analyses_ndvistability
)
summary(model2)

model3<- psem (
  lm(ndvi_stability ~ biodiversity + anthropic_dist + hand, data = analyses_ndvistability),
  lm (biodiversity ~ anthropic_dist, data = analyses_ndvistability),
  data = analyses_ndvistability
)
summary(model3)

model4<- psem (
  lm(ndvi_stability ~ biodiversity + anthropic_dist + hand + burnedarea, data = analyses_ndvistability),
  lm (biodiversity ~ anthropic_dist, data = analyses_ndvistability),
  data = analyses_ndvistability
)
summary(model4)

model5<- psem (
  lm(ndvi_stability ~ biodiversity + anthropic_dist + hand + burnedarea , data = analyses_ndvistability),
  lm (biodiversity ~ anthropic_dist, data = analyses_ndvistability),
  data = analyses_ndvistability
)
summary(model5)

### Modeling with composites of pulse stressors and background climate

# From https://jslefche.github.io/sem_book/composite-variables.html#grace-keeley-revisited-a-worked-example
composite_lm1<- lm (ndvi_stability ~ re + mat, scaled_analyses_ndvistability)
summary(composite_lm1) #all significant due to sample size
#beta_re<- summary(composite_lm1)$coefficients[2,1]
#beta_mat<- summary(composite_lm1)$coefficients[3,1]
#backgroundcliamte_composite<- beta_re*analyses_ndvistability$re + beta_mat*analyses_ndvistability$mat
#summary(lm(ndvi_stability ~ backgroundcliamte_composite, data= data.frame(analyses_ndvistability, backgroundcliamte_composite)))
#coefs(lm(ndvi_stability ~ backgroundcliamte_composite, data = data.frame(analyses_ndvistability, backgroundcliamte_composite)))

comp_background<- '
  backgroundclimate_composite <~ -0.420172*re + -0.028295*mat
  ndvi_stability ~ backgroundclimate_composite
'
modelcomp_background<- sem(comp_background, scaled_analyses_ndvistability, fixed.x= F)
summary(modelcomp_background, standardize = T)

composite_lm2<- lm (ndvi_stability ~ spei + heatwave, scaled_analyses_ndvistability)
summary(composite_lm2)

comp_pulsestressor<- '
  pulse_stressors <~ 0.4460979*spei + -0.0016303*heatwave
  ndvi_stability ~ pulse_stressors
'
modelcomp_pulse<- sem(comp_pulsestressor, scaled_analyses_ndvistability, fixed.x= F)
summary(modelcomp_pulse, standardize = T)

# From
# https://www.r-bloggers.com/2011/05/ecological-sems-and-composite-variables-what-why-and-how/
comp_trial1<- '
  backgroundclimate_composite <~ 1*re + mat
  backgroundclimate_composite ~~ 0*backgroundclimate_composite
  
  pulse_stressors <~ 1*spei + heatwave
  pulse_stressors ~~ 0*pulse_stressors
  
 
  ndvi_stability ~ 1*backgroundclimate_composite + 1*pulse_stressors + hand + biodiversity + anthropic_dist + burnedarea
  ndvi_stability ~~ 1*ndvi_stability
  
  pulse_stressors ~ backgroundclimate_composite
  biodiversity ~ pulse_stressors + backgroundclimate_composite + anthropic_dist
  burnedarea ~ pulse_stressors + backgroundclimate_composite 
  heatwave ~~ mat
'
modeltrial1<- sem(comp_trial1, scaled_analyses_ndvistability, se= "boot", test = "Satorra.Bentler", bootstrap = 1000, fixed.x= F)
summary(modeltrial1, standardize = T, fit.measures = TRUE)

bootstrap_modeltrial1<- bootstrapLavaan(modeltrial1, R= 1000, FUN = function (x){
  fitMeasures(x, c("cfi", "tli", "rmsea"))}, verbose= TRUE )



```
