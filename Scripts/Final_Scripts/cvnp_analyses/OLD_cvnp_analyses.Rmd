```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, include=FALSE}
library(RColorBrewer)
library(lattice)
library(tidyverse)
library(here)
library(tictoc)

library(ggplot2)
library(ggpubr)
library(sf)
library(terra)

library(tmap)
library(tmaptools)
library(RColorBrewer)
library(viridis)

terraOptions(memfrac=0.8, tempdir = here("Scratch"), progress=10)
```

##Introduction
In this script I do EDA and analyses of the trajectory shape results only considering Chapadas dos Vierdos National Park, which is protected area (hence we can assume pristine savanna physiognomies) in which Marina and her group extensively work in. We have a lot more contextual information for this national park which hopefully helps to make sense of the resilience results. 

#Data input and prelim EDA - area in CVNP classified as different trajectories from different indices
```{r}
#CVNP shp
cvnp_shp<- st_read(here("Data", "Admin", "WDPA_WDOECM_Jan2024_Public_59_shp","WDPA_WDOECM_Jan2024_Public_59_shp_0", "WDPA_WDOECM_Jan2024_Public_59_shp-polygons.shp")) #cannot remember where this polygon comes from, maybe GEE?

#Index traj results
anisoEVI_map_results<- rast(here("Outputs", "Final_TrajShape_Models", "Annual", "am_trends11_trajresults.tif"))
#1- Linear decrease, 2- linear increase, 3- no trend, 4- step decrease, 5- step increase
ndvi_map_results<- rast(here("Outputs", "Final_TrajShape_Models", "Annual_NDVI", "ndvi_amtrends11_trajresults.tif"))
#1-Linear decrease, 2- linear increase, 3- no trend, 4- step decrease, 5- step_increase, 6- quad decrease accelerated, 7- quad-decrease decelerated
evi_map_results<- rast(here("Outputs", "Final_TrajShape_Models", "Annual_EVI", "evi_amtrends11_trajresults.tif"))
#same legend as NDVI

#Extracting anisoEVI & NDVI results only for CVNP
Sys.time(); cvnp_aniso_trajshapes<- terra::crop(anisoEVI_map_results, vect(cvnp_shp))
cvnp_aniso_trajshapes<- terra::mask(cvnp_aniso_trajshapes, vect(cvnp_shp)); Sys.time()
#writeRaster(cvnp_aniso_trajshapes, here("Outputs", "Final_TrajShape_Models", "CVNP_results", "cvnp_anisoevi_trajshapes.tif"))

Sys.time(); cvnp_ndvi_trajshapes<- terra::crop(ndvi_map_results, vect(cvnp_shp))
cvnp_ndvi_trajshapes<- terra::mask( cvnp_ndvi_trajshapes, vect(cvnp_shp)); Sys.time()
#writeRaster(cvnp_ndvi_trajshapes, here("Outputs", "Final_TrajShape_Models", "CVNP_results", "cvnp_ndvi_trajshapes.tif"))

Sys.time(); cvnp_evi_trajshapes<- terra::crop(evi_map_results, vect(cvnp_shp))
cvnp_evi_trajshapes<- terra::mask( cvnp_evi_trajshapes, vect(cvnp_shp)); Sys.time()
#writeRaster(cvnp_evi_trajshapes, here("Outputs", "Final_TrajShape_Models", "CVNP_results", "cvnp_evi_trajshapes.tif"))

cvnp_indices<- c(cvnp_aniso_trajshapes, cvnp_evi_trajshapes, cvnp_ndvi_trajshapes)


#Barplot results of area of different trajectory shapes in CVNP for both indices
#df_cvnp_ndvi<- terra::as.data.frame(cvnp_ndvi_trajshapes, cells=TRUE, xy=TRUE)
#df_cvnp_aniso<- terra::as.data.frame(cvnp_aniso_trajshapes, cells=TRUE, xy=TRUE)
#df_cvnp_evi<- terra::as.data.frame(cvnp_evi_trajshapes, cells=TRUE, xy=TRUE)
# #### NDVI & EVI has 12 pixels more than anisoEVI! Checking on QGIS
# ndvi_cells<- df_cvnp_ndvi$cell
# anisoevi_cells<- df_cvnp_aniso$cell
# valuesinndvi_notinanisoevi<-setdiff(ndvi_cells,anisoevi_cells)
# ndvi_notinanisoevi_df<- df_cvnp_ndvi[df_cvnp_ndvi$cell %in% valuesinndvi_notinanisoevi,]
# ndvi_notinanisoevi_vector<- terra::vect(ndvi_notinanisoevi_df, geom=c("x", "y"), crs="epsg:4326")
# Sys.time(); ndvi_notinanisoevi_map_results<- terra::rasterize(ndvi_notinanisoevi_vector, anisoEVI_map_results, "max", fun="max"); Sys.time()
# writeRaster(ndvi_notinanisoevi_map_results, here("Scratch", "ndvi_notinanisoevi.tif"), overwrite=T)
# #I checked these 12 pixels in QGIS. 3 pixels are in the border, so that is fine. But the other
# #pixels are in the interior. So I do not understand why ndvi has results for the interior pixels
# #and not anisoEVI. Mayeb I excluded these pixels from anisoevi because of 3 consecutive missing values. 
# #So I keep only pixels that are in both results.
# remove(anisoevi_cells, ndvi_cells, valuesinndvi_notinanisoevi, ndvi_notinanisoevi_df, ndvi_notinanisoevi_vector, ndvi_notinanisoevi_map_results)
#remove(df_cvnp_aniso, df_cvnp_evi, df_cvnp_ndvi)
df_cvnp_indices<- terra::as.data.frame(cvnp_indices, cells=TRUE, xy=TRUE)
summary(df_cvnp_indices) #12 anisoEVI values missing, see explanation in comments above
df_cvnp_indices<- df_cvnp_indices %>% filter(!is.na(anisoEVI))
names(df_cvnp_indices)[4]<- ("anisoEVI")
names(df_cvnp_indices)[5]<- ("EVI")
names(df_cvnp_indices)[6]<- ("NDVI")

pivot_df<- df_cvnp_indices %>% pivot_longer(4:6)
pivot_df<- pivot_df %>% mutate(value=case_when(value==1~"Linear-decrease",
                                               value==2~"Linear-increase",
                                               value==4~"Step-decrease",
                                               value==5~"Step-increase",
                                               value==6~"Quad-decrease accelerated",
                                               value==7~"Quad-decrease deccelerated",
                                               TRUE~"No trend"))

##Comparison barplot reduced trajectories
comparison_barplot_df <- pivot_df %>% group_by(name, value) %>%
  summarise(count=n())
comparison_barplot_df <- comparison_barplot_df  %>% mutate(percentage=(count/nrow(df_cvnp_indices))*100)

comparison_barplot<- comparison_barplot_df %>% 
  ggplot(aes(value, percentage, fill = value, group=name, alpha=as.factor(name))) +
  geom_col(position = position_dodge(), color = "black") +
  theme_classic() +
  #facet_grid(~value, scales = "free_x", switch = "x") +
  xlab("Trajectory Shape")+ ylab ("% of study area")+
  theme(strip.placement  = "outside",
        panel.spacing    = unit(0, "points"),
        strip.background = element_blank(),
        strip.text       = element_text(size = 12, angle = 90),
        axis.text.x = element_text(size = 12, angle = 90))+
  xlab("Model Type")

comparisonpalette<- brewer.pal(n=5, "Set1")
comparisonpalette[[3]]<- "grey"
comparison_barplot<- comparison_barplot+ scale_fill_manual(values=comparisonpalette)
ggsave(here("Outputs", "Final_TrajShape_Models","CVNP_results", "cvnp_comparison_indices_am_swin11.png"),
       comparison_barplot,dpi = 700, height = 20, width=20, units = "cm")


##Comparison confusion matrices ie crosstab
df_cvnp_indices

trajectory_names<- function(index_name){
  
  indexnames<- case_when(index_name==1~"Linear decrease",
                                            index_name==2~"Linear increase",
                                            index_name==4~"Step decrease",
                                            index_name==5~"Step increase",
                                            index_name==6~"Quad decrease accelerated",
                                            index_name==7~"Quad decrease deccelerated",
                                               TRUE~"No trend")
  indexnames
}


df_cvnp_indices<- df_cvnp_indices %>% mutate(across(c("NDVI", "EVI", "anisoEVI"), trajectory_names))


trial_crosstab<- df_cvnp_indices %>% group_by(NDVI, EVI, anisoEVI) %>%
  summarise(percentage=(n()/nrow(df_cvnp_indices))*100)
#write.csv(trial_crosstab, here("Outputs", "Final_TrajShape_Models", "CVNP_results", "cvnp_anisoevi_ndvi_reducedtrajshape_percentage_crosstab.csv"))
a

remove(comparison_barplot_df, comparison_barplot, comparisonpalette, df_cvnp_aniso, df_cvnp_ndvi, df_join, ndvi_map_results, anisoEVI_map_results, evi_map_results, pivot_df, trial_crosstab)

#Maps of trajectory shapes in CVNP
mappalette<- brewer.pal(n=7, "Set1")
mappalette[[3]]<- "grey"
mappalette[[4]]<-  "#984EA3"
mappalette[[5]]<-  "#FF7F00"
mappalette[[6]]<- "#FFFF33"
mappalette[[7]]<- "#A65628"

aniso_cvnp_map<-#tm_shape(neighbors, bbox = map_extent)+ tm_borders()+
  tm_shape(cvnp_shp)+ tm_fill()+
  tm_shape (cvnp_aniso_trajshapes)+
  tm_raster(col = "max", style = "cat", palette =mappalette, legend.show = F) +
  tm_layout(main.title="anisoEVI",legend.text.size = 0.8)+
  tm_add_legend(type = "fill", 
                labels = c("Linear- Decrease, Constant", 
                           "Linear- Increase, Constant",
                           "No trend",
                           "Step- Decrease",
                           "Step- Increase",
                           "Quad- Decrease, Accelerated",
                           "Quad- Decrease, Decelerated"),
                col = mappalette)

ndvi_cvnp_map<-#tm_shape(neighbors, bbox = map_extent)+ tm_borders()+
  tm_shape(cvnp_shp)+ tm_fill()+
  tm_shape (cvnp_ndvi_trajshapes)+
  tm_raster(col = "max", style = "cat", palette =mappalette, legend.show = F) +
  tm_layout(main.title="NDVI",legend.text.size = 0.8)

evi_cvnp_map<-#tm_shape(neighbors, bbox = map_extent)+ tm_borders()+
  tm_shape(cvnp_shp)+ tm_fill()+
  tm_shape (cvnp_evi_trajshapes)+
  tm_raster(col = "max", style = "cat", palette =mappalette, legend.show = F)+
  tm_layout(main.title="EVI",legend.text.size = 0.8)

cvnp_maps<- tmap_arrange(aniso_cvnp_map, ndvi_cvnp_map, evi_cvnp_map)
tmap_save(cvnp_maps, here("Outputs", "Final_TrajShape_Models", "CVNP_results", "indices_map_results.png"),
        height = 30, width = 30, units = "cm", dpi=700)
remove(ndvi_cvnp_map, aniso_cvnp_map, evi_cvnp_map,cvnp_maps, mappalette)

```
The crosstab results basically shows that 0.9% of pixels in CVNP are classified to be step increase across all indices, 41.3% of pixels are classified to be no trend across all indices.

#EDA around the step change pixels from all indices
```{r}
#anisoEVI
aniso_central<- read_rds(here("Outputs", "Final_TrajShape_Models","Annual","finalshape_annuals11_central.rds"))
aniso_southern<- read_rds(here("Outputs", "Final_TrajShape_Models","Annual", "finalshape_annuals11_southern.rds"))
aniso_eastern<- read_rds(here("Outputs", "Final_TrajShape_Models","Annual","finalshape_annuals11_eastern.rds"))

aniso_df<- rbind(aniso_southern, aniso_eastern, aniso_central)
remove(aniso_central, aniso_southern, aniso_eastern)

aniso_final_model<- aniso_df %>% 
  dplyr::select(c(cell,x,y, model_order, shape_class, trend_name, loc_brk)) %>%
  rename(c("cell"="cell","x"="x", "y"="y", 
           "AnisoEVI_Detrended_ModelOrder"="model_order", "AnisoEVI_Detrended_ShapeClass"="shape_class",
           "AnisoEVI_Detrended_TrendName"="trend_name", "AnisoEVI_Detrended_LocBrk"="loc_brk"))
aniso_final_model<- aniso_final_model %>% 
                  mutate(AnisoEVI_DetrendedResults = paste0(AnisoEVI_Detrended_ModelOrder,"_", AnisoEVI_Detrended_ShapeClass,"_", AnisoEVI_Detrended_TrendName))
aniso_final_model2<- aniso_final_model %>% dplyr::select(c(x,y, cell, AnisoEVI_DetrendedResults, AnisoEVI_Detrended_LocBrk))
remove(aniso_final_model, aniso_df)

#ndvi
ndvi_southern<-read_rds(here("Outputs", "Final_TrajShape_Models","Annual_NDVI", "finalshape_annuals11_southern.rds"))
ndvi_eastern<- read_rds(here("Outputs", "Final_TrajShape_Models","Annual_NDVI", "finalshape_annuals11_eastern.rds"))
ndvi_central<- read_rds(here("Outputs", "Final_TrajShape_Models","Annual_NDVI", "finalshape_annuals11_central.rds"))

ndvi_df<- rbind(ndvi_southern, ndvi_eastern, ndvi_central)
remove(ndvi_central, ndvi_southern, ndvi_eastern)

ndvi_final_model<- ndvi_df %>% 
  dplyr::select(c(cell,x,y, model_order, shape_class, trend_name, loc_brk)) %>%
  rename(c("cell"="cell","x"="x", "y"="y", 
           "NDVI_Detrended_ModelOrder"="model_order", "NDVI_Detrended_ShapeClass"="shape_class",
           "NDVI_Detrended_TrendName"="trend_name", "NDVI_Detrended_LocBrk"="loc_brk"))
ndvi_final_model<- ndvi_final_model %>% 
                  mutate(NDVI_DetrendedResults = paste0(NDVI_Detrended_ModelOrder,"_", NDVI_Detrended_ShapeClass,"_", NDVI_Detrended_TrendName))
ndvi_final_model2<- ndvi_final_model %>% dplyr::select(c(x,y,cell, NDVI_DetrendedResults, NDVI_Detrended_LocBrk))
remove(ndvi_final_model, ndvi_df)

#evi
evi_southern<-read_rds(here("Outputs", "Final_TrajShape_Models","Annual_EVI", "finalshape_annuals11_southern.rds"))
evi_eastern<- read_rds(here("Outputs", "Final_TrajShape_Models","Annual_EVI", "finalshape_annuals11_eastern.rds"))
evi_central<- read_rds(here("Outputs", "Final_TrajShape_Models","Annual_EVI", "finalshape_annuals11_central.rds"))

evi_df<- rbind(evi_southern, evi_eastern, evi_central)
remove(evi_central, evi_southern, evi_eastern)

evi_final_model<- evi_df %>% 
  dplyr::select(c(cell,x,y, model_order, shape_class, trend_name, loc_brk)) %>%
  rename(c("cell"="cell","x"="x", "y"="y", 
           "EVI_Detrended_ModelOrder"="model_order", "EVI_Detrended_ShapeClass"="shape_class",
           "EVI_Detrended_TrendName"="trend_name", "EVI_Detrended_LocBrk"="loc_brk"))
evi_final_model<- evi_final_model %>% 
                  mutate(EVI_DetrendedResults = paste0(EVI_Detrended_ModelOrder,"_", EVI_Detrended_ShapeClass,"_", EVI_Detrended_TrendName))
evi_final_model2<- evi_final_model %>% dplyr::select(c(x,y,cell, EVI_DetrendedResults, EVI_Detrended_LocBrk))
remove(evi_final_model, evi_df)

#filtering to consider only step pixels
step_aniso<- aniso_final_model2 %>% filter(str_detect(AnisoEVI_DetrendedResults, 'Step'))
step_ndvi<- ndvi_final_model2 %>% filter(str_detect(NDVI_DetrendedResults, 'Step'))
step_evi<- evi_final_model2 %>% filter(str_detect(EVI_DetrendedResults, 'Step'))

insert_year<- function(index_name){
  indexnames<- case_when(index_name==1~2002,
                         index_name==2~2003,
                         index_name==3~2004,
                         index_name==4~2005,
                         index_name==5~2006,
                         index_name==6~2007,
                         index_name==7~2008,
                         index_name==8~2009,
                         index_name==9~2010,
                         index_name==10~2011,
                         index_name==11~2012,
                         index_name==12~2013,
                         index_name==13~2014,
                         index_name==14~2015,
                         index_name==15~2016,
                         index_name==16~2017,
                         index_name==17~2018,
                         index_name==18~2019,
                         index_name==19~2020,
                         index_name==20~2021)
  indexnames
}


step_aniso<- step_aniso %>% mutate(across(c("AnisoEVI_Detrended_LocBrk"), insert_year))
step_ndvi<- step_ndvi %>% mutate(across(c("NDVI_Detrended_LocBrk"), insert_year))
step_evi<- step_evi %>% mutate(across(c("EVI_Detrended_LocBrk"), insert_year))

step_aniso2<- step_aniso %>% separate(AnisoEVI_DetrendedResults, c("Step", "NA", "Type")) %>% dplyr::select(-c("Step", "NA"))
step_ndvi2<- step_ndvi %>% separate(NDVI_DetrendedResults, c("Step", "NA", "Type")) %>% dplyr::select(-c("Step", "NA"))
step_evi2<- step_evi %>% separate(EVI_DetrendedResults, c("Step", "NA", "Type")) %>% dplyr::select(-c("Step", "NA"))

# #reading line 34
# stepaniso_year_vector<- terra::vect(step_aniso2, geom=c("x", "y"), crs="epsg:4326")
# st_write(st_as_sf(stepaniso_year_vector),  here("Outputs", "Final_TrajShape_Models", "Annual", "aniso_steptype_year.shp"))
# Sys.time(); stepaniso_inc_year_raster<- terra::rasterize(stepaniso_year_vector[stepaniso_year_vector$Type=="increase",], anisoEVI_map_results, "AnisoEVI_Detrended_LocBrk", fun="max"); Sys.time()
# writeRaster(stepaniso_inc_year_raster, here("Outputs", "Final_TrajShape_Models", "Annual", "stepaniso_inc_year.tif"), overwrite=T)
# Sys.time(); stepaniso_dec_year_raster<- terra::rasterize(stepaniso_year_vector[stepaniso_year_vector$Type=="decrease",], anisoEVI_map_results, "AnisoEVI_Detrended_LocBrk", fun="max"); Sys.time()
# writeRaster(stepaniso_dec_year_raster, here("Outputs", "Final_TrajShape_Models", "Annual", "stepaniso_dec_year.tif"), overwrite=T)
 
# stepndvi_year_vector<- terra::vect(step_ndvi2, geom=c("x", "y"), crs="epsg:4326")
# st_write(st_as_sf(stepndvi_year_vector),  here("Outputs", "Final_TrajShape_Models", "Annual_NDVI", "ndvi_steptype_year.shp"))
# Sys.time(); stepndvi_inc_year_raster<- terra::rasterize(stepndvi_year_vector[stepndvi_year_vector$Type=="increase"], anisoEVI_map_results, "NDVI_Detrended_LocBrk", fun="max"); Sys.time()
# writeRaster(stepndvi_inc_year_raster, here("Outputs", "Final_TrajShape_Models", "Annual_NDVI", "stepndvi_inc_year.tif"), overwrite=T)
# Sys.time(); stepndvi_dec_year_raster<- terra::rasterize(stepndvi_year_vector[stepndvi_year_vector$Type=="decrease"], anisoEVI_map_results, "NDVI_Detrended_LocBrk", fun="max"); Sys.time()
# writeRaster(stepndvi_dec_year_raster, here("Outputs", "Final_TrajShape_Models", "Annual_NDVI", "stepndvi_dec_year.tif"), overwrite=T)


# stepevi_year_vector<- terra::vect(step_evi2, geom=c("x", "y"), crs="epsg:4326")
# st_write(st_as_sf(stepevi_year_vector),  here("Outputs", "Final_TrajShape_Models", "Annual_EVI", "evi_steptype_year.shp"))
# Sys.time(); stepevi_inc_year_raster<- terra::rasterize(stepevi_year_vector[stepevi_year_vector$Type=="increase"], anisoEVI_map_results, "EVI_Detrended_LocBrk", fun="max"); Sys.time()
# writeRaster(stepevi_inc_year_raster, here("Outputs", "Final_TrajShape_Models", "Annual_EVI", "stepevi_inc_year.tif"), overwrite=T)
#  Sys.time(); stepevi_dec_year_raster<- terra::rasterize(stepevi_year_vector[stepevi_year_vector$Type=="decrease"], anisoEVI_map_results, "EVI_Detrended_LocBrk", fun="max"); Sys.time()
# writeRaster(stepevi_dec_year_raster, here("Outputs", "Final_TrajShape_Models", "Annual_EVI", "stepevi_dec_year.tif"), overwrite=T)

remove(stepaniso_inc_year_raster,stepaniso_dec_year_raster, stepaniso_year_vector, stepndvi_inc_year_raster,stepndvi_dec_year_raster, stepndvi_year_vector, stepevi_year_vector, stepevi_inc_year_raster, stepevi_dec_year_raster)
remove(step_aniso, step_ndvi, step_evi, step_aniso2, step_ndvi2, step_evi2)
remove(anisoEVI_map_results)
remove(aniso_final_model2, evi_final_model2, ndvi_final_model2)
remove(insert_year)

stepaniso_inc_year_raster<- rast(here("Outputs", "Final_TrajShape_Models", "Annual", "stepaniso_inc_year.tif"))
stepaniso_dec_year_raster<- rast(here("Outputs", "Final_TrajShape_Models", "Annual", "stepaniso_dec_year.tif"))
stepndvi_inc_year_raster<- rast(here("Outputs", "Final_TrajShape_Models", "Annual_NDVI", "stepndvi_inc_year.tif"))
stepndvi_dec_year_raster<- rast(here("Outputs", "Final_TrajShape_Models", "Annual_NDVI", "stepndvi_dec_year.tif"))
stepevi_inc_year_raster<- rast(here("Outputs", "Final_TrajShape_Models", "Annual_EVI", "stepevi_inc_year.tif"))
stepevi_dec_year_raster<- rast(here("Outputs", "Final_TrajShape_Models", "Annual_EVI", "stepevi_dec_year.tif"))

crop_mask<- function(raster){
  x_crop<- terra::crop(raster, vect(cvnp_shp))
  x_mask<- terra::mask(x_crop, vect(cvnp_shp))
  x_mask
}

cvnp_stepaniso_inc_year<- crop_mask(stepaniso_inc_year_raster)
#writeRaster(cvnp_stepaniso_inc_year, here("Outputs", "Final_TrajShape_Models", "CVNP_Results", "cvnp_stepaniso_inc_year.tif"))
cvnp_stepaniso_dec_year<- crop_mask(stepaniso_dec_year_raster)
#writeRaster(cvnp_stepaniso_dec_year, here("Outputs", "Final_TrajShape_Models", "CVNP_Results", "cvnp_stepaniso_dec_year.tif"))
cvnp_stepndvi_inc_year<- crop_mask(stepndvi_inc_year_raster)
#writeRaster(cvnp_stepndvi_inc_year, here("Outputs", "Final_TrajShape_Models", "CVNP_Results", "cvnp_stepndvi_inc_year.tif"))
cvnp_stepndvi_dec_year<- crop_mask(stepndvi_dec_year_raster)
#writeRaster(cvnp_stepndvi_dec_year, here("Outputs", "Final_TrajShape_Models", "CVNP_Results", "cvnp_stepndvi_dec_year.tif"))
cvnp_stepevi_inc_year<- crop_mask(stepevi_inc_year_raster)
#writeRaster(cvnp_stepevi_inc_year, here("Outputs", "Final_TrajShape_Models", "CVNP_Results", "cvnp_stepevi_inc_year.tif"))
cvnp_stepevi_dec_year<- crop_mask(stepevi_dec_year_raster)
#writeRaster(cvnp_stepevi_dec_year, here("Outputs", "Final_TrajShape_Models", "CVNP_Results", "cvnp_stepevi_dec_year.tif"))

remove(stepaniso_dec_year_raster, stepaniso_inc_year_raster, stepevi_dec_year_raster, stepevi_inc_year_raster, stepndvi_dec_year_raster, stepndvi_inc_year_raster)

cvnp_step_inc<- c(cvnp_stepaniso_inc_year, cvnp_stepevi_inc_year, cvnp_stepndvi_inc_year)
cvnp_step_dec<- c(cvnp_stepaniso_dec_year, cvnp_stepevi_dec_year, cvnp_stepndvi_dec_year)

df_cvnp_step_inc<- terra::as.data.frame(cvnp_step_inc, cells=TRUE, xy=TRUE)
names(df_cvnp_step_inc)[4]<- "anisoEVI"
names(df_cvnp_step_inc)[5]<- "EVI"
names(df_cvnp_step_inc)[6]<- "NDVI"
df_cvnp_step_inc<- df_cvnp_step_inc %>% mutate(StepType="increase")
df_cvnp_step_dec<- terra::as.data.frame(cvnp_step_dec, cells=TRUE, xy=TRUE)
df_cvnp_step_dec<- df_cvnp_step_dec %>% mutate(StepType="decrease")
names(df_cvnp_step_dec)[4]<- "anisoEVI"
names(df_cvnp_step_dec)[5]<- "EVI"
names(df_cvnp_step_dec)[6]<- "NDVI"
df_cvnp_step_dec<- df_cvnp_step_dec %>% mutate(StepType="decrease")


df_cvnp_step<- bind_rows(df_cvnp_step_inc, df_cvnp_step_dec)
remove(df_cvnp_step_dec, df_cvnp_step_inc)

pivot_step<- df_cvnp_step %>% pivot_longer(4:6)

barplot_df<- pivot_step %>% group_by(name, value, StepType) %>%
  summarise (count=n())
number_steppixels_df<- pivot_step %>% group_by(name) %>% #Total pixels that are Step in an index irrespective of year
  summarise(total_step_pixels=sum(!is.na(value)))
barplot_df<- barplot_df %>% left_join(number_steppixels_df)
barplot_df<- barplot_df %>% mutate(percentage_totalstep=(count/total_step_pixels)*100)
summary(barplot_df) #there are many Years missing because these pixels were
#classified as inc/dec in various other indices and not the specific one which is NA
barplot_df<- barplot_df %>% filter(!is.na(value))

cvnp_step_year_barplot<- barplot_df %>% 
  ggplot(aes(x=percentage_totalstep, y=as.factor(value), fill= StepType)) +
  geom_bar(position="dodge", stat="identity") +
  theme_classic() +
  facet_grid(~name, switch = "x") +
  scale_fill_manual(values = c("#984EA3", "#FF7F00"))+
  xlab("% of step pixels")+ ylab ("Year of step change")+
  theme(strip.placement  = "outside",
        panel.spacing    = unit(0, "points"),
        strip.background = element_blank(),
        strip.text       = element_text(size = 12, angle = 90),
        axis.text.x = element_text(size = 12, angle = 90))
#ggsave(here("Outputs", "Final_TrajShape_Models","CVNP_results", "cvnp_stepchange_year_allindices.png"),
#       cvnp_step_year_barplot,dpi = 700, height = 20, width=20, units = "cm")

remove(barplot_df, cvnp_step_year_barplot, cvnp_stepaniso_year, cvnp_stepevi_year, cvnp_stepndvi_year, df_cvnp_indices, df_cvnp_step, number_steppixels_df, pivot_step, stepaniso_year_raster, stepevi_year_raster, stepndvi_year_raster)
remove(crop_mask, insert_year, trajectory_names)
#For step increase, irrespective of index the year 2017 was the year of increase. But this is not the case
#for step decrease- anisoEVI=2011, EVI=2020 and NDVI=2006

##############################################################Maps of step decrease and increase by year
#1.Map of step increase pixels in 2017, before 2017 and after 2017, gridded by index

m <- rbind(c(2002, 1), c(2003, 1), c(2004,1), c(2005,1), 
           c(2006,1), c(2007,1), c(2008,1), c(2009,1), c(2010,1), c(2011,1), c(2012,1), c(2013,1), c(2014,1),
           c(2015,1), c(2016,1), c(2017,2), c(2018,3), c(2019,3), c(2020,3), c(2021,3))
step_aniso_inc_2017<- terra::classify(cvnp_stepaniso_inc_year, m, others=NA)
step_ndvi_inc_2017<- terra::classify(cvnp_stepndvi_inc_year, m, others=NA)
step_evi_inc_2017<- terra::classify(cvnp_stepevi_inc_year, m, others=NA)

aniso_around2017_step_inc_map<-
  tm_shape(cvnp_shp)+ tm_fill()+
  tm_shape (step_aniso_inc_2017)+
  tm_raster(col = "max", style = "cat", palette =c("darkgreen","red", "darkblue"), alpha=0.5, legend.show = F) +
  tm_layout(main.title="AnisoEVI",legend.text.size = 0.8)+
  tm_add_legend(type = "fill", 
                labels = c("before 2017", 
                           "2017",
                           "after 2017"),
                col = c("darkgreen","red", "darkblue"))

ndvi_around2017_step_inc_map<-
  tm_shape(cvnp_shp)+ tm_fill()+
  tm_shape (step_ndvi_inc_2017)+
  tm_raster(col = "max", style = "cat", palette =c("darkgreen","red", "darkblue"), alpha=0.5, legend.show = F) +
  tm_layout(main.title="NDVI",legend.text.size = 0.8)

evi_around2017_step_inc_map<-
  tm_shape(cvnp_shp)+ tm_fill()+
  tm_shape (step_evi_inc_2017)+
  tm_raster(col = "max", style = "cat", palette =c("darkgreen","red", "darkblue"), alpha=0.5, legend.show = F) +
  tm_layout(main.title="EVI",legend.text.size = 0.8)

x<-tmap_arrange(aniso_around2017_step_inc_map,ndvi_around2017_step_inc_map,evi_around2017_step_inc_map)

#tmap_save(x, here("Outputs", "Final_TrajShape_Models", "CVNP_results", "cvnp_stepinc_around2017_allindices.png"),
#        height = 30, width = 30, units = "cm", dpi=700)
remove(m, aniso_around2017_step_inc_map, ndvi_around2017_step_inc_map, evi_around2017_step_inc_map, x)

#2. Map on only 2017 step increase pixels in every index
step_aniso_inc_only2017<- terra::classify(step_aniso_inc_2017, cbind(2,2017), others=NA)
step_ndvi_inc_only2017<- terra::classify(step_ndvi_inc_2017, cbind(2,2017), others=NA)
step_evi_inc_only2017<- terra::classify(step_evi_inc_2017, cbind(2,2017), others=NA)

only2017_step_inc_map<-
  tm_shape(cvnp_shp)+ tm_fill()+
  tm_shape (step_aniso_inc_only2017)+
  tm_raster(col = "max", style = "cat", palette ="#648FFF", alpha=0.5, legend.show = F) +
  tm_shape (step_ndvi_inc_only2017)+
  tm_raster(col = "max", style = "cat", palette ="#DC267F", alpha=0.5, legend.show = F) +
  tm_shape (step_evi_inc_only2017)+
  tm_raster(col = "max", style = "cat", palette ="#FE6100", alpha=0.5, legend.show = F) +
  tm_add_legend(type = "fill", 
                labels = c("anisoEVI", 
                           "NDVI",
                           "EVI"),
                col = c("#648FFF","#DC267F", "#FE6100"))+
  tm_layout(main.title="only 2017 step increase",legend.text.size = 1)
#tmap_save(only2017_step_inc_map, here("Outputs", "Final_TrajShape_Models", "CVNP_results", "ony2017_stepincrease_allindices.png"),
#        height = 30, width = 30, units = "cm", dpi=700)
remove(only2017_step_inc_map, step_aniso_inc_only2017, step_ndvi_inc_only2017, step_evi_inc_only2017)

#3. How much of the pixels with step increase in 2017 (any index) burned in 2017?
step_aniso_inc_only2017<- terra::classify(step_aniso_inc_2017, cbind(2,2017), others=0)
step_ndvi_inc_only2017<- terra::classify(step_ndvi_inc_2017, cbind(2,2017), others=0)
step_evi_inc_only2017<- terra::classify(step_evi_inc_2017, cbind(2,2017), others=0)

year2017_cvnp_fire<- rast(here("Outputs", "Final_TrajShape_Models", "CVNP_results", "modis_fire_only2017.tif"))
year2017_cvnp_fire<- terra::classify(year2017_cvnp_fire, cbind(NA,0))
year2017_cvnp_fire<- terra::mask(terra::crop(year2017_cvnp_fire, vect(cvnp_shp)), vect(cvnp_shp))

stepinc_fire_2017<- function(stepinc_2017_raster){
  x<- stepinc_2017_raster+year2017_cvnp_fire
  #0-no fire and step inc some other year, 1- 2017 fire but no step increase, 2017- step increase in 2017 but no fire in 2017, 2018- fire and step increase in 2017
  x_df<- as.data.frame(x, cell=TRUE, xy=TRUE)
  x_tally<- x_df %>% group_by(max) %>% tally()
  percentage_step2017_burn2017<- x_tally$n[x_tally$max==2018]/(x_tally$n[x_tally$max==2018]+x_tally$n[x_tally$max==2017])
  percentage_step2017_burn2017    
}

aniso_step_fire_2017<- stepinc_fire_2017(step_aniso_inc_only2017)
evi_step_fire_2017<- stepinc_fire_2017(step_evi_inc_only2017)
ndvi_step_fire_2017<- stepinc_fire_2017(step_ndvi_inc_only2017)

step_fire_df <- data.frame(matrix(ncol = 2, nrow = 3))
names(step_fire_df)<- c("Index", "Percentage_of_total2017step")
step_fire_df[1,1]<-"anisoEVI" 
step_fire_df[1,2]<- aniso_step_fire_2017
step_fire_df[2,1]<-"EVI" 
step_fire_df[2,2]<- evi_step_fire_2017
step_fire_df[3,1]<-"NDVI" 
step_fire_df[3,2]<- ndvi_step_fire_2017

remove(step_aniso_inc_only2017, step_ndvi_inc_only2017, step_evi_inc_only2017, aniso_step_fire_2017, evi_step_fire_2017, ndvi_step_fire_2017)
remove(stepinc_fire_2017)

p<-ggplot(step_fire_df, aes(x=Index, y=Percentage_of_total2017step)) +
  geom_bar(stat="identity") +theme_minimal()
#ggsave(here("Outputs", "Final_TrajShape_Models","CVNP_results", "cvnp_stepinc_only2017_fire2017_allindices.png"),
#       p,dpi = 700, height = 10, width=10, units = "cm")
#Basically for EVI & NDVI <30% of the pixels that have step change in 2017 , burned in 2017. This does not bode well! For anisoEVI, its about 41%, still <half


```


#EDA around the step change 2017 pixels using Mapbiomas LU classification rasters-
#1- Is there a difference is grass, savanna and forest area (from Mapbiomas) before, at and after 2017 only in the step inc pixels of 2017?
In GEE, I extracted at 30m resolution Mapbiomas clipped to CVNP for 2013-2021 annually keeping the legend ie no analyses done
in GEE. Legend details for colleciton 9- https://brasil.mapbiomas.org/wp-content/uploads/sites/4/2024/08/ATBD-Collection-9-v2.docx.pdf
```{r}

raster_filepath <- list.files(path = here("Data", "Mapbiomas_transitions","CVNP_Mapbiomas"), pattern= ".tif$", all.files=TRUE, full.names=TRUE)
raster_list<-lapply(raster_filepath, rast)
cvnp_mapbiomas<- rast(raster_list)

#0- is actually NA. Weird GEE export made every pixel outside of CVNp but within bounding box 0 instead of NA
cvnp_mapbiomas<-terra::classify(cvnp_mapbiomas, cbind(0, NA))

#looking at legend- retaining only 3- forest formation, 4- savanna formation, 12- grassland formation
m <- rbind(c(3,3), c(4,4), c(12,12))
cvnp_mapbiomas<-terra::classify(cvnp_mapbiomas, m, others=0)
remove(m)
cvnp_mapbiomas_time_map<-
  tm_shape(cvnp_shp)+ tm_fill()+
  tm_shape (cvnp_mapbiomas)+
  tm_raster(style = "cont", get_brewer_pal("YlGnBu"),title="3-forest, 4-savanna, 12-grass, 0-other ") +
  tm_layout (legend.position = c("left", "top"))+
              tm_facets(nrow=1, ncol=1, free.coords = FALSE)+
  tm_shape(cvnp_shp)+ tm_borders() 
tic();tmap_animation(cvnp_mapbiomas_time_map,filename = here("Outputs", "Final_TrajShape_Models", "CVNP_results", "cvnp_mapbiomas_time.gif"),
               delay = 50, loop = TRUE, restart.delay = 500,
               width = 900, height = 900, dpi = 150) ;toc() 

#resample to coarse resolution each formation seperately ie seperate stack for each formation, where
#each stack has year 2013-2021 excluding 2017
cvnp_stepndvi_inc_year<- rast(here("Outputs", "Final_TrajShape_Models", "CVNP_Results", "cvnp_stepndvi_inc_year.tif"))

prop_aggregate <- function(x) {
  terra::project(
    terra::segregate(x), cvnp_stepndvi_inc_year,# segregate()- binary (0/1) of classes 0,3,4,12
    method = "average", res = res(cvnp_stepndvi_inc_year)[1]
  )
}

cvnp_mapbiomas2013<-prop_aggregate(cvnp_mapbiomas[[1]])
cvnp_mapbiomas2014<-prop_aggregate(cvnp_mapbiomas[[2]])
cvnp_mapbiomas2015<-prop_aggregate(cvnp_mapbiomas[[3]])
cvnp_mapbiomas2016<-prop_aggregate(cvnp_mapbiomas[[4]])
cvnp_mapbiomas2017<-prop_aggregate(cvnp_mapbiomas[[5]])
cvnp_mapbiomas2018<-prop_aggregate(cvnp_mapbiomas[[6]])
cvnp_mapbiomas2019<-prop_aggregate(cvnp_mapbiomas[[7]])
cvnp_mapbiomas2020<-prop_aggregate(cvnp_mapbiomas[[8]])
cvnp_mapbiomas2021<-prop_aggregate(cvnp_mapbiomas[[9]])

x_grass<- c(cvnp_mapbiomas2013[[2]],cvnp_mapbiomas2014[[2]], cvnp_mapbiomas2015[[2]], cvnp_mapbiomas2016[[2]], cvnp_mapbiomas2017[[2]],
            cvnp_mapbiomas2018[[2]], cvnp_mapbiomas2019[[2]], cvnp_mapbiomas2020[[2]], cvnp_mapbiomas2021[[2]])
names(x_grass)<- c("grass_2013", "grass_2014", "grass_2015", "grass_2016", "grass_2017", "grass_2018", "grass_2019", "grass_2020", "grass_2021")
animation_map<- function (raster_time_stack){
  animation_x_time_map<-
  tm_shape(cvnp_shp)+ tm_fill()+
  tm_shape (raster_time_stack)+
  tm_raster(style = "cont", get_brewer_pal("YlGnBu"),title="%pixel that is respective formation") +
  tm_layout (legend.position = c("left", "top"))+
              tm_facets(nrow=1, ncol=1, free.coords = FALSE)+
  tm_shape(cvnp_shp)+ tm_borders() 
  animation_x_time_map  
}
animation_x_grass_time_map<- animation_map(x_grass)
tmap_animation(animation_x_grass_time_map, filename = here("Outputs", "Final_TrajShape_Models", "CVNP_results", "grass_proportion.gif"),
               delay = 50, loop = TRUE, restart.delay = 500,
               width = 900, height = 900, dpi = 150) ;toc() 
remove(animation_x_grass_time_map)

x_savanna<- c(cvnp_mapbiomas2013[[3]],cvnp_mapbiomas2014[[3]], cvnp_mapbiomas2015[[3]], cvnp_mapbiomas2016[[3]], cvnp_mapbiomas2017[[3]],
            cvnp_mapbiomas2018[[3]], cvnp_mapbiomas2019[[3]], cvnp_mapbiomas2020[[3]], cvnp_mapbiomas2021[[3]])
names(x_savanna)<- c("savanna_2013", "savanna_2014", "savanna_2015", "savanna_2016", "savanna_2017", "savanna_2018", "savanna_2019", "savanna_2020", "savanna_2021")
animation_x_savanna_time_map<- animation_map(x_savanna)
tic();tmap_animation(animation_x_savanna_time_map, filename = here("Outputs", "Final_TrajShape_Models", "CVNP_results", "savanna_proportion.gif"),
               delay = 50, loop = TRUE, restart.delay = 500,
               width = 900, height = 900, dpi = 150) ;toc() 
remove(animation_x_savanna_time_map)

x_forest<- c(cvnp_mapbiomas2013[[4]],cvnp_mapbiomas2014[[4]], cvnp_mapbiomas2015[[4]], cvnp_mapbiomas2016[[4]], cvnp_mapbiomas2017[[4]],
            cvnp_mapbiomas2018[[4]], cvnp_mapbiomas2019[[4]], cvnp_mapbiomas2020[[4]], cvnp_mapbiomas2021[[4]])
names(x_forest)<- c("forest_2013", "forest_2014", "forest_2015", "forest_2016", "forest_2017", "forest_2018", "forest_2019", "forest_2020", "forest_2021")
animation_x_forest_time_map<-animation_map(x_forest)
tic();tmap_animation(animation_x_forest_time_map, filename = here("Outputs", "Final_TrajShape_Models", "CVNP_results", "forest_proportion.gif"),
               delay = 50, loop = TRUE, restart.delay = 500,
               width = 900, height = 900, dpi = 150) ;toc() 
remove(animation_x_forest_time_map)
#seems like there is no change in grass, savanna or forest proportion across CVNP

#What is the range of formation in each of the above pixels?
stepinc_burn_formation<- function(stepinc_raster, title){
  x<- stepinc_raster+year2017_cvnp_fire #0-no fire and step inc some other year, 1- 2017 fire but no step increase, 2017- step increase in 2017 but no fire in 2017, 2018- fire and step increase in 2017
  x_reclass2017<- terra::classify(x, cbind(2018,1), others=NA)# retaining only pixels that burned and had a step change in 2017
  trial<- terra::mask(cvnp_mapbiomas2017, x_reclass2017)
  df_trial<- as.data.frame(trial)
  df_trial<- df_trial %>% dplyr::select(-c("0"))
  pivot_df_trial<- pivot_longer(df_trial, 1:3)
  pivot_df_trial<- pivot_df_trial %>% mutate(name=case_when(name=="3"~"forest formation",
                                                          name=="4"~"savanna formation",
                                                          name=="12"~"grass formation"))
  barplot<- ggplot(pivot_df_trial, aes(x=name, y=value)) +
  geom_boxplot() +theme_classic() + xlab("Formation type")+
  ylab("% of 1sqkm step inc pixel that burned in 2017")+ ggtitle(title)
  barplot
}

aniso<- stepinc_burn_formation(step_aniso_inc_only2017, "anisoEVI")
ndvi<- stepinc_burn_formation(step_ndvi_inc_only2017, "NDVI")
evi<- stepinc_burn_formation(step_evi_inc_only2017, "EVI")

together<- ggarrange(aniso, ndvi, evi)
#ggsave(here("Outputs", "Final_TrajShape_Models","CVNP_results", "cvnp_stepinc_only2017_fire2017_formationrange.png"),
#       together,dpi = 700, height = 30, width=30, units = "cm")
remove(together, aniso, evi, ndvi)

remove(cvnp_mapbiomas2013, cvnp_mapbiomas2014, cvnp_mapbiomas2015, cvnp_mapbiomas2016, cvnp_mapbiomas2018, cvnp_mapbiomas2019,
       cvnp_mapbiomas2020, cvnp_mapbiomas2021)

#Of the pixels that burned and had step inc in 2017, was there a significant difference is formation area before and after 2017
mean_grass_2013_2016<- terra::app(c(x_grass[[1]], x_grass[[2]], x_grass[[3]], x_grass[[4]]), fun="mean")
mean_grass_2018_2021<- terra::app(c(x_grass[[6]], x_grass[[7]], x_grass[[8]], x_grass[[9]]), fun="mean")
mean_savanna_2013_2016<- terra::app(c(x_savanna[[1]], x_savanna[[2]], x_savanna[[3]], x_savanna[[4]]), fun="mean")
mean_savanna_2018_2021<- terra::app(c(x_savanna[[6]], x_savanna[[7]], x_savanna[[8]], x_savanna[[9]]), fun="mean")
mean_forest_2013_2016<- terra::app(c(x_forest[[1]], x_forest[[2]], x_forest[[3]], x_forest[[4]]), fun="mean")
mean_forest_2018_2021<- terra::app(c(x_forest[[6]], x_forest[[7]], x_forest[[8]], x_forest[[9]]), fun="mean")

animation_map<- function (raster_time_stack){
  animation_x_time_map<-
  tm_shape(cvnp_shp)+ tm_fill()+
  tm_shape (raster_time_stack)+
  tm_raster(style = "cont", get_brewer_pal("YlGnBu"),title="%pixel that is respective formation") +
  tm_layout (legend.position = c("left", "top"))+
              tm_facets(nrow=1, ncol=1, free.coords = FALSE)+
  tm_shape(cvnp_shp)+ tm_borders() 
  animation_x_time_map  
}
grass2013_2021<- c(mean_grass_2013_2016, cvnp_mapbiomas2017[[2]],mean_grass_2018_2021)
x<-animation_map(grass2013_2021)
tmap_animation(x, filename = here("Outputs", "Final_TrajShape_Models", "CVNP_results", "mean_grass_time.gif"),
               delay = 50, loop = TRUE, restart.delay = 500,
               width = 900, height = 900, dpi = 150)
remove(x)

savanna2013_2021<- c(mean_savanna_2013_2016, cvnp_mapbiomas2017[[3]],mean_savanna_2018_2021)
x<-animation_map(savanna2013_2021)
tmap_animation(x, filename = here("Outputs", "Final_TrajShape_Models", "CVNP_results", "mean_savanna_time.gif"),
               delay = 50, loop = TRUE, restart.delay = 500,
               width = 900, height = 900, dpi = 150)
remove(x)
forest2013_2021<- c(mean_forest_2013_2016, cvnp_mapbiomas2017[[4]],mean_forest_2018_2021)
x<-animation_map(forest2013_2021)
tmap_animation(x, filename = here("Outputs", "Final_TrajShape_Models", "CVNP_results", "mean_forest_time.gif"),
               delay = 50, loop = TRUE, restart.delay = 500,
               width = 900, height = 900, dpi = 150)
remove(x)
#Some (very few) changes in grass and savanna cover, but no change in forest cover
remove(mean_grass_2013_2016, mean_grass_2018_2021, mean_forest_2013_2016, mean_forest_2018_2021, mean_savanna_2013_2016, mean_savanna_2018_2021)
remove(m, x_forest, x_grass, x_savanna)

remove(cvnp_stepaniso_inc_year, cvnp_stepevi_inc_year, cvnp_stepndvi_inc_year)
step_aniso_inc_2017
step_ndvi_inc_2017
step_evi_inc_2017 #values=2 are pixels where step change happened in 2017

step_aniso_inc_2017only<- terra::classify(step_aniso_inc_2017, cbind(2,1), others=NA)
step_ndvi_inc_2017only<- terra::classify(step_ndvi_inc_2017, cbind(2,1), others=NA)
step_evi_inc_2017only<- terra::classify(step_evi_inc_2017, cbind(2,1), others=NA)
remove(step_aniso_inc_2017, step_ndvi_inc_2017, step_evi_inc_2017)
year2017_cvnp_fire

df_prep<- function (formation_stack){
  aniso_burn_stepinc<-terra::mask(year2017_cvnp_fire, step_aniso_inc_2017only)
  evi_burn_stepinc<-terra::mask(year2017_cvnp_fire, step_evi_inc_2017only)
  ndvi_burn_stepinc<-terra::mask(year2017_cvnp_fire, step_ndvi_inc_2017only)
  
  
  formation<- c(formation_stack, aniso_burn_stepinc, evi_burn_stepinc, ndvi_burn_stepinc)
  names(formation)<- c("Mean_proportion_2013_2016", "Formation_proportion2017", "Mean_proportion_2018_2021", "aniso_stepinc_burn2017", "evi_stepinc_burn2017", "ndvi_stepinc_burn2017")
  df_formation_area2013_2021<- terra::as.data.frame(formation, cells= TRUE, xy=TRUE)
  pivot_df_formation_area2013_2021<- pivot_longer(df_formation_area2013_2021, 7:9)
  names(pivot_df_formation_area2013_2021)[7]<- "index"
  names(pivot_df_formation_area2013_2021)[8]<- "stepinc_burn"
  pivot_df_formation_area2013_2021<- pivot_longer(pivot_df_formation_area2013_2021, 4:6)
  pivot_df_formation_area2013_2021 <-pivot_df_formation_area2013_2021 %>% mutate(name = factor(name, levels = c("Mean_proportion_2013_2016", "Formation_proportion2017", "Mean_proportion_2018_2021")))
  pivot_df_formation_area2013_2021
}

grass_df<- df_prep(grass2013_2021)
savanna_df<- df_prep(savanna2013_2021)
forest_df<- df_prep(forest2013_2021)

boxplot_time<- function(pivot_formation_df){
  x_plot<- ggplot(pivot_formation_df %>% group_by(name) %>% filter(stepinc_burn==1),
               aes(x=name, y=value)) +geom_boxplot() +  theme_classic()+
    xlab("Timeperiod") +ylab("Proprotion of 1sqkm pixel")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  facet_wrap(~index)
  x_plot
}

mean_grass<-boxplot_time(grass_df)
mean_savanna<- boxplot_time(savanna_df)
mean_forest<- boxplot_time(forest_df)

x<-ggarrange(mean_grass, mean_savanna, mean_forest + rremove("x.text"), 
          labels = c("Grass", "Savanna", "Forest"),
          ncol = 1, nrow = 3)
ggsave(here("Outputs", "Final_TrajShape_Models","CVNP_results", "cvnp_stepinc_only2017_meanarea_formation.png"),
       x,dpi = 700, height = 35, width=35, units = "cm")
remove(x, mean_grass, mean_savanna, mean_forest)

evi_aov_grass<- aov(value~as.factor(name),
  grass_df %>% filter(index=="evi_stepinc_burn2017" & stepinc_burn==1))
aniso_aov_grass<- aov(value~as.factor(name),
  grass_df %>% filter(index=="aniso_stepinc_burn2017" & stepinc_burn==1))
ndvi_aov_grass<- aov(value~as.factor(name),
  grass_df %>% filter(index=="ndvi_stepinc_burn2017" & stepinc_burn==1))
summary(evi_aov_grass)
summary(aniso_aov_grass)
summary(ndvi_aov_grass)
#No significant difference in means of grass proportions, before, during and after 2017. Makes sense since
#the Mapbiomas rasters show no change at all
remove(evi_aov_grass, aniso_aov_grass, ndvi_aov_grass)

evi_aov_savanna<- aov(value~as.factor(name),
  savanna_df %>% filter(index=="evi_stepinc_2017" & !is.na(stepinc)))
aniso_aov_savanna<- aov(value~as.factor(name),
  savanna_df %>% filter(index=="aniso_stepinc2017" & !is.na(stepinc)))
ndvi_aov_savanna<- aov(value~as.factor(name),
  savanna_df %>% filter(index=="ndvi_stepinc2017" & !is.na(stepinc)))
summary(evi_aov_savanna)
summary(aniso_aov_savanna)
summary(ndvi_aov_savanna)
#No significant difference in means of savanna proportions, before, during and after 2017. 
remove(evi_aov_savanna, aniso_aov_savanna, ndvi_aov_savanna)

evi_aov_forest<- aov(value~as.factor(name),
  forest_df %>% filter(index=="evi_stepinc_2017" & !is.na(stepinc)))
aniso_aov_forest<- aov(value~as.factor(name),
  forest_df %>% filter(index=="aniso_stepinc2017" & !is.na(stepinc)))
ndvi_aov_forest<- aov(value~as.factor(name),
  forest_df %>% filter(index=="ndvi_stepinc2017" & !is.na(stepinc)))
summary(evi_aov_forest)
summary(aniso_aov_forest)
summary(ndvi_aov_forest)
#No significant difference in means of forest proportions, before, during and after 2017. 
remove(evi_aov_forest, aniso_aov_forest, ndvi_aov_forest)
```

#2. Does the landscape heterogeniety before, at and after 2017 only in the step inc pixels of 2017?
Landscape heterogeneity is calculated using Shannon Diversity index from vegan package
```{r}
#rerun lines 497-502
cvnp_mapbiomas

reclass_table<- read.csv(here("Data", "mapbiomas_legend_collection9_classification.csv"))
reclass_table<- reclass_table %>% dplyr::select(c("Pixel.value", "Reclass"))
#reclass_table<- reclass_table %>% mutate(Reclass=ifelse(Reclass==100| Reclass==101, NA, Reclass)) #excluding ag and urban classes

#reclass mapbiomas stack such that urban/man classes=101 and ag=100
reclass_cvnp_mapbiomas<- terra::classify(cvnp_mapbiomas, reclass_table, others=NA)

#4. Histogram of different land covers through time
calc_df<- tibble(year= 2013:2021)
list_rasters<- list()
for(i in 1:nlyr(reclass_cvnp_mapbiomas)){
  list_rasters[[i]]<- reclass_cvnp_mapbiomas[[i]]
}
calc_df<- calc_df %>% mutate(mapbiomas_raster= list_rasters)
remove(list_rasters,i)

area_calc<- function(landcover_raster){
  x<- terra::segregate(landcover_raster)
  layer_area<- terra::cellSize(x, mask=T, unit="km")
  area<- x*layer_area
  df_area<- as.data.frame(area, cells=TRUE, xy=TRUE)
  pivot_df_area<- df_area %>% pivot_longer(4:10)
  total_area<- pivot_df_area %>% group_by(name) %>% summarise(TotalArea_sqkm=sum(value))
  total_area
}
Sys.time(); calc_df<- calc_df %>% mutate(TotalArea_sqkm= purrr::map(mapbiomas_raster, area_calc)); Sys.time()

calc_df<- calc_df %>% dplyr::select(-c(mapbiomas_raster))
calc_df<- calc_df  %>% unnest(TotalArea_sqkm)
calc_df<- calc_df %>% mutate(name=case_when(name=="100"~"ag",
                                            name=="101"~"urban/manmade",
                                            name=="11"~"wetland",
                                            name=="12"~"grass",
                                            name=="29"~"rocky",
                                            name=="3"~"forest",
                                            TRUE~"savanna"))

library(gganimate)
r<- ggplot(calc_df, aes(x=name, y=TotalArea_sqkm, fill=name)) + 
  geom_bar(stat="identity", color="black") + 
  #scale_color_brewer(labels= c("Central", "Eastern", "Southern"), palette = "Dark2")+
  transition_time(year)+
  ylab("TotalArea_sqkm") +xlab("Landcovers")+
  labs(title = "Year: {frame_time}")
r<- r+scale_fill_brewer(palette = "Dark2") +
  theme_classic()+
  theme(legend.title=element_blank())+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) 
anim_save(here("Outputs", "Final_TrajShape_Models", "CVNP_results", "cvnp_totalarea_landcover.gif"),r)
remove(r, calc_df, area_calc )

#rerun line 511
cvnp_stepndvi_inc_year

prop_aggregate <- function(x) {
  terra::project(
    terra::segregate(x), cvnp_stepndvi_inc_year,# segregate()- binary (0/1) of classes 0,3,4,12
    method = "average", res = res(cvnp_stepndvi_inc_year)[1]
  )
}

reclass_mapbiomass_cvnp2013<- prop_aggregate(reclass_cvnp_mapbiomas[[1]])
reclass_mapbiomass_cvnp2014<- prop_aggregate(reclass_cvnp_mapbiomas[[2]])
reclass_mapbiomass_cvnp2015<- prop_aggregate(reclass_cvnp_mapbiomas[[3]])
reclass_mapbiomass_cvnp2016<- prop_aggregate(reclass_cvnp_mapbiomas[[4]])
reclass_mapbiomass_cvnp2017<- prop_aggregate(reclass_cvnp_mapbiomas[[5]])
reclass_mapbiomass_cvnp2018<- prop_aggregate(reclass_cvnp_mapbiomas[[6]])
reclass_mapbiomass_cvnp2019<- prop_aggregate(reclass_cvnp_mapbiomas[[7]])
reclass_mapbiomass_cvnp2020<- prop_aggregate(reclass_cvnp_mapbiomas[[8]])
reclass_mapbiomass_cvnp2021<- prop_aggregate(reclass_cvnp_mapbiomas[[9]])

#install.packages("vegan")
library(vegan)
shannon_diversity<- function (reclass_coarse_raster){
  x_df<- as.data.frame(reclass_coarse_raster, cells=TRUE, xy=TRUE)
  x_diversity<- vegan::diversity(x_df %>% dplyr::select(-c(cell,x,y)), index="shannon")
  x_diversity<- as.data.frame(x_diversity)
  x_df<- bind_cols(x_df, x_diversity)
  trial_vector<- terra::vect(x_df %>% dplyr::select(c("cell", "x", "y", "x_diversity")), geom=c("x", "y"), crs="epsg:4326")
   trial_raster<- terra::rasterize(trial_vector, reclass_coarse_raster, "x_diversity", fun="max")
   trial_raster
}
 
diversity2013<- shannon_diversity(reclass_mapbiomass_cvnp2013)  
diversity2014<- shannon_diversity(reclass_mapbiomass_cvnp2014)  
diversity2015<- shannon_diversity(reclass_mapbiomass_cvnp2015)  
diversity2016<- shannon_diversity(reclass_mapbiomass_cvnp2016)  
diversity2017<- shannon_diversity(reclass_mapbiomass_cvnp2017)  
diversity2018<- shannon_diversity(reclass_mapbiomass_cvnp2018)  
diversity2019<- shannon_diversity(reclass_mapbiomass_cvnp2019)  
diversity2020<- shannon_diversity(reclass_mapbiomass_cvnp2020)  
diversity2021<- shannon_diversity(reclass_mapbiomass_cvnp2021) 

diversity<- c(diversity2013, diversity2014, diversity2015, diversity2016, diversity2017, diversity2018, 
              diversity2019, diversity2020, diversity2021)
names(diversity)<- c("2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021")
#Seems all the same ie hardly any change in shannon diversity (without ag) through the years
#This means its unlikely that there will be a change in heterogeniety before, during and after 2017 in the step inc pixels

diversity_animation_x_time_map<-
  tm_shape(cvnp_shp)+ tm_fill()+
  tm_shape (diversity)+
  tm_raster(style = "cont", get_brewer_pal("YlGnBu"),title="Shannon Diversity of land covers") +
  tm_layout (legend.position = c("left", "top"))+
              tm_facets(nrow=1, ncol=1, free.coords = FALSE)+
  tm_shape(cvnp_shp)+ tm_borders() 
tmap_animation(diversity_animation_x_time_map, filename = here("Outputs", "Final_TrajShape_Models", "CVNP_results", "diversity_throughtime.gif"),
               delay = 50, loop = TRUE, restart.delay = 500,
               width = 900, height = 900, dpi = 150) 

remove(reclass_mapbiomass_cvnp2013, reclass_mapbiomass_cvnp2014, reclass_mapbiomass_cvnp2015, reclass_mapbiomass_cvnp2016, reclass_mapbiomass_cvnp2017, reclass_mapbiomass_cvnp2018, reclass_mapbiomass_cvnp2019, reclass_mapbiomass_cvnp2020, reclass_mapbiomass_cvnp2021)

step_aniso_inc_only2017# binary 1- step inc in 2017 else 0
step_ndvi_inc_only2017
step_evi_inc_only2017
year2017_cvnp_fire

#What is the range of landscape heterogeniety in each of the pixels that burned and had step inc in 2017?
stepinc_burn_formation<- function(stepinc_raster, title){
  x<- stepinc_raster+year2017_cvnp_fire #0-no fire and step inc some other year, 1- 2017 fire but no step increase, 2017- step increase in 2017 but no fire in 2017, 2018- fire and step increase in 2017
  x_reclass2017<- terra::classify(x, cbind(2018,1), others=NA)# retaining only pixels that burned and had a step change in 2017
  trial<- terra::mask(diversity2017, x_reclass2017)
  df_trial<- as.data.frame(trial)
  pivot_df_trial<- pivot_longer(df_trial, 1:dim(df_trial)[2])
  pivot_df_trial<- pivot_df_trial %>% mutate(index= title)
  pivot_df_trial<- pivot_df_trial %>% dplyr::select(-c(name))
}

aniso<- stepinc_burn_formation(step_aniso_inc_only2017, "anisoEVI")
ndvi<- stepinc_burn_formation(step_ndvi_inc_only2017, "NDVI")
evi<- stepinc_burn_formation(step_evi_inc_only2017, "EVI")
df<- bind_rows(aniso, ndvi, evi)

barplot<- ggplot(df, aes(x=index, y=value)) +
    geom_boxplot() +theme_classic() + xlab("Index")+
    ylab("Landscape heterogeniety in pixels that burned and step inc 2017")
  barplot
ggsave(here("Outputs", "Final_TrajShape_Models","CVNP_results", "cvnp_stepinc_only2017_fire2017_heterogeneityrange.png"),
       barplot,dpi = 700, height = 30, width=30, units = "cm")
remove(aniso, evi, ndvi, df, barplot, stepinc_burn_formation)

#Of the pixels that burned and had step inc in 2017, was there a significant difference in heterogeniety before and after 2017
meandiversity_2013_2016<- terra::app(c(diversity2013, diversity2014, diversity2015, diversity2016), fun="mean")
meandiversity_2018_2021<- terra::app(c(diversity2018, diversity2019, diversity2020, diversity2021), fun="mean")
diversity2013_2021<- c(meandiversity_2013_2016, diversity2017, meandiversity_2018_2021)
remove(diversity2013, diversity2014, diversity2015, diversity2016, diversity2018, diversity2019, diversity2020, diversity2021)
remove(reclass_mapbiomass_cvnp2013, reclass_mapbiomass_cvnp2014, reclass_mapbiomass_cvnp2015, reclass_mapbiomass_cvnp2016, reclass_mapbiomass_cvnp2017, reclass_mapbiomass_cvnp2018, reclass_mapbiomass_cvnp2019, reclass_mapbiomass_cvnp2020, reclass_mapbiomass_cvnp2021)

step_aniso_inc_2017only<- terra::classify(step_aniso_inc_only2017, cbind(2017,1), others=NA)
step_evi_inc_2017only<- terra::classify(step_evi_inc_only2017, cbind(2017,1), others=NA)
step_ndvi_inc_2017only<- terra::classify(step_ndvi_inc_only2017, cbind(2017,1), others=NA)

df_prep<- function (hetero_stack){
  aniso_burn_stepinc<-terra::mask(year2017_cvnp_fire, step_aniso_inc_2017only)
  evi_burn_stepinc<-terra::mask(year2017_cvnp_fire, step_evi_inc_2017only)
  ndvi_burn_stepinc<-terra::mask(year2017_cvnp_fire, step_ndvi_inc_2017only)
  
  
  hetero<- c(hetero_stack, aniso_burn_stepinc, evi_burn_stepinc, ndvi_burn_stepinc)
  names(hetero)<- c("Mean_proportion_2013_2016", "Heterogeniety_proportion2017", "Mean_proportion_2018_2021", "aniso_stepinc_burn2017", "evi_stepinc_burn2017", "ndvi_stepinc_burn2017")
  df_formation_area2013_2021<- terra::as.data.frame(hetero, cells= TRUE, xy=TRUE)
  pivot_df_formation_area2013_2021<- pivot_longer(df_formation_area2013_2021, 7:9)
  names(pivot_df_formation_area2013_2021)[7]<- "index"
  names(pivot_df_formation_area2013_2021)[8]<- "stepinc_burn"
  pivot_df_formation_area2013_2021<- pivot_longer(pivot_df_formation_area2013_2021, 4:6)
  pivot_df_formation_area2013_2021 <-pivot_df_formation_area2013_2021 %>% mutate(name = factor(name, levels = c("Mean_proportion_2013_2016", "Heterogeniety_proportion2017", "Mean_proportion_2018_2021")))
  pivot_df_formation_area2013_2021
}

diversity_df<- df_prep(diversity2013_2021)


boxplot_time<- function(pivot_formation_df){
  x_plot<- ggplot(pivot_formation_df %>% group_by(name) %>% filter(stepinc_burn==1),
               aes(x=name, y=value)) +geom_boxplot() +  theme_classic()+
    xlab("Timeperiod") +ylab("Proprotion of 1sqkm pixel")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  facet_wrap(~index)
  x_plot
}

mean_diversity<-boxplot_time(diversity_df)
ggsave(here("Outputs", "Final_TrajShape_Models","CVNP_results", "cvnp_stepinc_only2017_heterogeniety.png"),
       mean_diversity,dpi = 700, height = 35, width=35, units = "cm")
```


#############################################################################################################################################################################
#Processing CVNP physiognomy map from Lewis et al. 2020
In the below chunk I do exploratory analyses to check if there are significant differences in the % of level 1 physiognomies across trajectory shapes in CVNP (for aniso EVI and NDVI).

Following Guy's suggestion, I bin the %grass, %savanna, %woodland and %anthropic and then plot boxplots within each bin of the step increase and no trend (for the NDVI).
```{r}
veg_phy<- rast(here("Data", "Lewisetal2022_ChapadaNP_PhysiognomyMaps", "PNCV_vegMap_woText.tif"))
#0= campo umido, 1=campo sujo, 3=campu rupestre, 5=cerrado sensu stricto, 6=cerrado rupestre, 8=verada
#9=cerradao, 10=mata de galeria, 11-pasture, 12- water, 13- plantation, 14- agriculture, 15- nonvegetated

#Mask and crop
crop_veg_phy<- terra::crop(veg_phy, vect(cvnp_shp))
mask_veg_phy<- terra::mask(crop_veg_phy, vect(cvnp_shp))
remove(crop_veg_phy, veg_phy)

#Reclassifying to level 1 as all the campo are grasslands-1, both cerrado and verada are savannas-2
#and cerradao, mata de galeria is woodland-3. Remainder are anthropic-4, water is NA

m<- rbind(c(0,1), c(1,1), c(3,1), c(5,2), 
          c(6,2), c(8,2), c(9,3), c(10,3), 
          c(11,4), c(12,NA), c(13,4), c(14,4), c(15,4))

lev1_phy<- terra::classify(mask_veg_phy, m)
remove(m)

#Coarsening to obtain proportion of larger 1km pixel that is grassland, savannas, woodland, anthropic
m_grass_only<- rbind(c(1,1), c(2,0), c(3,0), c(4,0))
lev1_grassonly<- terra::classify(lev1_phy, m_grass_only)
remove(m_grass_only)

m_savanna_only<- rbind(c(1,0), c(2,1), c(3,0), c(4,0))
lev1_savannaonly<- terra::classify(lev1_phy, m_savanna_only)
remove(m_savanna_only)

m_woodland_only<- rbind(c(1,0), c(2,0), c(3,1), c(4,0))
lev1_woodlandonly<- terra::classify(lev1_phy, m_woodland_only)
remove(m_woodland_only)

m_anthropic_only<- rbind(c(1,0), c(2,0), c(3,0), c(4,1))
lev1_anthropiconly<- terra::classify(lev1_phy, m_anthropic_only)
remove(m_anthropic_only)

grass_percentage<- terra::resample(lev1_grassonly, cvnp_indices, method="average")
#writeRaster(grass_percentage, here("Scratch", "grass_prop.tif"))
savanna_percentage<- terra::resample(lev1_savannaonly, cvnp_indices, method="average")
#writeRaster(savanna_percentage, here("Scratch", "savanna_prop.tif"))
woodland_percentage<- terra::resample(lev1_woodlandonly, cvnp_indices, method="average")
#writeRaster(woodland_percentage, here("Scratch", "wood_prop.tif"))
anthropic_percentage<- terra::resample(lev1_anthropiconly, cvnp_indices, method="average")
#writeRaster(anthropic_percentage, here("Scratch", "anthropic_prop.tif"))
remove(lev1_anthropiconly, lev1_grassonly, lev1_savannaonly, lev1_woodlandonly)

lev1_proportion_indices<- c(cvnp_indices, grass_percentage, savanna_percentage, woodland_percentage, anthropic_percentage)
df_lev1_prop_indices<- terra::as.data.frame(lev1_proportion_indices, cells=TRUE, xy=TRUE)
names(df_lev1_prop_indices)<- c("cell", "x", "y", "anisoEVI_trajshape","EVI_trajshape","NDVI_trajshape", "grass_prop", "savanna_prop", "wood_prop", "anthropic_prop")
summary(df_lev1_prop_indices)
#there are a couple of cells that have NA traj shape, but have proportion of physiognomies. 
#hence checking these pixels in QGIS
#check1_aniso<- df_lev1_prop_aniso_ndvi %>% filter(is.na(anisoEVI_trajshape))
#check1_ndvi<- df_lev1_prop_aniso_ndvi %>% filter(is.na(NDVI_trajshape))
#anisoEVI_map_results #run line 34
#check1_aniso_vector<- terra::vect(check1_aniso, geom=c("x", "y"), crs="epsg:4326")
#check1_ndvi_vector<- terra::vect(check1_ndvi, geom=c("x", "y"), crs="epsg:4326")
#terra::writeVector(check1_aniso_vector, here("Scratch", "cvnp_NA_aniso.shp"))
#terra::writeVector(check1_ndvi_vector, here("Scratch", "cvnp_NA_ndvi.shp"))
#The 20 NA anisoEVI trajectory pixels and the 8 NA NDVI &EVI  trajectory pixels are in NA
#values when looking at the original anisoEVI & NDVI trajectory shape results, maybe
#because these pixels >20% anthropic or is water and has been masked out. Hence I exclude
#these 28 pixels
#remove(check1_aniso, check1_ndvi, check1_aniso_vector, check1_ndvi_vector)
df_lev1_prop_indices2<- df_lev1_prop_indices %>% filter(!is.na(anisoEVI_trajshape) & !is.na(NDVI_trajshape) & !is.na(EVI_trajshape))
summary(df_lev1_prop_indices2) #no NAs, see above commented explanation

#rerun lines 119-129 
#trajectory_names()
df_lev1_prop_indices2<- df_lev1_prop_indices2 %>% mutate(across(c("anisoEVI_trajshape", "EVI_trajshape", "NDVI_trajshape"), trajectory_names))
remove(grass_percentage, savanna_percentage, woodland_percentage, anthropic_percentage)
remove(trajectory_names)

#%grass
grass_bin<- df_lev1_prop_indices2 %>% dplyr::select(-c(savanna_prop, wood_prop, anthropic_prop))
grass_bin$bins <- cut(grass_bin$grass_prop, breaks=seq(0,1,0.02), ordered_result = TRUE)

number_pixels_bin<- grass_bin %>% group_by(bins) %>% summarise(count=n())

pivot_grass_bin<- grass_bin %>% pivot_longer(4:6)
#pivot_grass_bin<- pivot_grass_bin %>% filter(value=="Step-increase" | value=="No trend")

grass_trajectory_df<- pivot_grass_bin %>% 
  group_by(name, bins, value) %>%
  summarise(pixel_count=n())
  
grass_trajectory_df<- inner_join(grass_trajectory_df, number_pixels_bin)
grass_trajectory_df<- grass_trajectory_df %>% mutate(Proportion= (pixel_count/count)*100) #nrow 

larger_bins<- rep(c("1_20%", "21_40%", "41_60%", "61_80%", "81_100%"),each=10)
bin_lookup<- data.frame(bins=levels(grass_trajectory_df$bins), larger_bins=larger_bins)

grass_trajectory_df<- grass_trajectory_df %>% left_join(bin_lookup)
grass_trajectory_df<- grass_trajectory_df %>% mutate(bins=if_else(is.na(bins), "No grass", bins)) #there are pixels where %grass is 0 which I treat as a seperate category.
grass_trajectory_df<- grass_trajectory_df %>% mutate(larger_bins=if_else(is.na(larger_bins), "No grass", larger_bins))

evi_grass_variation<- ggplot(grass_trajectory_df %>% filter(name=="EVI_trajshape"),
                aes(x=larger_bins, y=Proportion, fill=value)) + 
  geom_boxplot() + scale_fill_manual(values=c("#E41A1C", "#377EB8", "grey", "#984EA3", "#FF7F00"))+
  theme_classic() +xlab("Grass proportion bins")+ ggtitle("EVI")+
  ylab("Proportion of pixels in grass bin")

ndvi_grass_variation<- ggplot(grass_trajectory_df %>% filter(name=="NDVI_trajshape"),
                aes(x=larger_bins, y=Proportion, fill=value)) + 
  geom_boxplot() +  scale_fill_manual(values=c("#E41A1C", "#377EB8", "grey", "#984EA3", "#FF7F00"))+
  theme_classic() +xlab("Grass proportion bins")+ ggtitle("NDVI")+
  ylab("Proportion of pixels in grass bin")

aniso_grass_variation<- ggplot(grass_trajectory_df%>% filter(name=="anisoEVI_trajshape"),
                aes(x=larger_bins, y=Proportion, fill=value)) + 
  geom_boxplot() + scale_fill_manual(values=c("#E41A1C", "#377EB8", "grey", "#984EA3", "#FF7F00"))+
  theme_classic() +xlab("Grass proportion bins")+ ggtitle("anisoEVI")+
  ylab("Proportion of pixels in grass bin")

x<-ggarrange(aniso_grass_variation,ndvi_grass_variation, evi_grass_variation,ncol=1, nrow = 3)
#ggsave(here("Outputs", "Final_TrajShape_Models", "CVNP_results",  "allindices_grassproportions_alltrajtypes.png"),
#       x, dpi = 700, height = 30, width=30, units = "cm")

remove(x, evi_grass_variation, ndvi_grass_variation, aniso_grass_variation, grass_stepinc_df2, grass_notrend_df2)
remove(larger_bins, number_pixels_bin, bin_lookup)

##################### ANOVA test-1 to evaluate if there is a significant difference 
#################### in the proportion of grass across the different trajectory types and grass proportions

#I assume a synergistic effect between grass proportion bin and trajectory shape
#because in the initial boxplot figure, across all indices and across all grass bins
#there pattern of the trajectory shapes is different, except for no trend which is
#significantly different (high) pixels across every bin.
#Tukey HSD for 2 factor interaction type anova cannot be made in 1 plot 
#I have to separately make plots considering each factor ie larger grass bin and trajectory type
library(multcompView)

anova_function<- function (index_type){
  model<- grass_trajectory_df %>% filter(name==index_type) %>% 
                                             aov(formula= Proportion~larger_bins*value)
  model
}
tukey_function<- function (anova_model, which_parameter){
  tukey<- TukeyHSD(anova_model, which=which_parameter)
  tukey
}

evi_anova<- anova_function("EVI_trajshape")
summary(evi_anova) #The two main effects of trajectory type and grass bin are statistically significant, not the interaction
evi_tukey_largerbins<- tukey_function(evi_anova, "larger_bins")
evi_tukey_trajtypes<- tukey_function(evi_anova, "value")

ndvi_anova<- anova_function("NDVI_trajshape")
summary(ndvi_anova) #The trajectory type and interaction effect are significant, not grass bin type
ndvi_tukey_largerbins<- tukey_function(ndvi_anova, "larger_bins")
ndvi_tukey_trajtypes<- tukey_function(ndvi_anova, "value") 

aniso_anova<- anova_function("anisoEVI_trajshape")
summary(aniso_anova) #The trajectory type, grass bin and interaction effect are significant
aniso_tukey_largerbins<- tukey_function(aniso_anova, "larger_bins")
aniso_tukey_trajtypes<- tukey_function(aniso_anova, "value") 

######################## Need to figure out how to plot above results

cld <- multcompLetters4(evi_anova, tukey)

Tk <- grass_trajectory_df %>% 
  filter()
  group_by(larger_bins,name,value) %>%
  summarise(mean = mean(Proportion), 
            quant = quantile(Proportion, probs = 0.75)) %>%
  mutate(cld = cld$larger_bins$Letters[larger_bins])


tukey <- TukeyHSD(evi_anova, which="larger_bins")
cld <- multcompLetters4(anova, tukey)

Tk <- grass_trajectory_df%>% group_by(larger_bins,name,value) %>%
  summarise(mean = mean(Proportion), 
            quant = quantile(Proportion, probs = 0.75)) %>%
  mutate(cld = cld$larger_bins$Letters[larger_bins])

trial<-ggplot(grass_trajectory_df, aes(larger_bins, Proportion, fill= value)) + 
  geom_boxplot(aes(fill = value, alpha = larger_bins)) +
  theme_test()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  facet_grid( ~ name) +
  scale_alpha_discrete(range = c(0.3, 0.9)) +
  scale_fill_manual(values=c("#E41A1C", "#377EB8", "grey", "#984EA3", "#FF7F00"))+
  #stat_compare_means(method = "anova", label.y = 100)+ 
  geom_text(data = Tk, aes(x = larger_bins, y = quant, label = cld), size = 4) +
  guides(alpha = guide_legend(override.aes = list(fill = "black")))
ggsave(here("Outputs", "Final_TrajShape_Models", "CVNP_results",  "aovtukey_grassproportions_trajtypes_allindices.png"),
       trial, dpi = 700, height = 30, width=30, units = "cm")


```


In the next chunk I do exploratory analyses to check for a relationship between pixel heterogeneity and trajectory shape in CVNP
```{r}
mask_veg_phy #from previous chunk
########## Excluding anthropic physiognomies and calculating richness of native physiognomies
#0= campo umido, 1=campo sujo, 3=campu rupestre, 5=cerrado sensu stricto, 6=cerrado rupestre, 8=verada
#9=cerradao, 10=mata de galeria, 11-pasture, 12- water, 13- plantation, 14- agriculture, 15- nonvegetated
m_nativephysiognomies_only<- rbind(c(0,0), c(1,1), c(3,3), c(5,5), c(6,6), c(8,8),
                                   c(9,9), c(10,10), c(11,NA), c(12,NA), c(13,NA), c(14,NA), c(15, NA))
reclass_lev2<- terra::classify(mask_veg_phy, m_nativephysiognomies_only)

library(exactextractr)
#The reason I have to use this pacakge is because terra package resample does not allow me
#to write a custom function. And I cannot use app() because cannot do a function whilst resampling
#to a coarser size. The exact_resample() in this package can resample by using a manual function
lev2_phy_richness<- exactextractr::exact_resample(reclass_lev2, cvnp_aniso_trajshapes, fun = 'variety', coverage_area=FALSE)
mask_lev2_phy_richness<- terra::mask(lev2_phy_richness, cvnp_shp)

map_lev2_phy_richness<-#tm_shape(neighbors, bbox = map_extent)+ tm_borders()+
  #tm_shape(d_trans)+ tm_fill()+
  tm_shape (mask_lev2_phy_richness)+
  tm_raster(col = "max", style = "cont", palette ="Reds", legend.show = F) 
tmap_save(map_lev2_phy_richness, here("Outputs", "Final_TrajShape_Models", "CVNP_results", "lev2_phy_richness.png"),
        height = 30, width = 30, units = "cm", dpi=700)

lev2_phy_richness_indices<- c(cvnp_aniso_trajshapes, cvnp_ndvi_trajshapes, cvnp_evi_trajshapes, lev2_phy_richness)
df_lev2_phy_richness_indices<- terra::as.data.frame(lev2_phy_richness_indices, cells=TRUE, xy=TRUE)
names(df_lev2_phy_richness_indices)<- c("cell", "x", "y", "anisoEVI_trajshape","NDVI_trajshape","EVI_trajshape", "Phy_richness")
#there are a couple of cells that have NA traj shape, but have proportion of physiognomies similar
#to previous chunk for physiognomy proportion
df_lev2_phy_richness_indices<- df_lev2_phy_richness_indices %>% filter(!is.na(anisoEVI_trajshape) & !is.na(NDVI_trajshape) | is.na(EVI_trajshape))

df_lev2_phy_richness_indices2<- df_lev2_phy_richness_indices %>% 
  mutate(anisoEVI_trajshape= case_when(anisoEVI_trajshape==1~"Linear-decrease",
                                       anisoEVI_trajshape==2~"Linear-increase",
                                       anisoEVI_trajshape==3~"No trend",
                                       anisoEVI_trajshape==4~"Step-decrease",
                                       anisoEVI_trajshape==5~"Step-increase"))
df_lev2_phy_richness_indices2<- df_lev2_phy_richness_indices %>% 
  mutate(NDVI_trajshape= case_when(NDVI_trajshape==1~"Linear-decrease",
                                       NDVI_trajshape==2~"Linear-increase",
                                       NDVI_trajshape==3~"No trend",
                                       NDVI_trajshape==4~"Step-decrease",
                                       NDVI_trajshape==5~"Step-increase",
                                      NDVI_trajshape==6~"Quad dec accelerated",
                                      NDVI_trajshape==7~"Quad dec decelerated"))
df_lev2_phy_richness_indices2<- df_lev2_phy_richness_indices %>% 
  mutate(NDVI_trajshape= case_when(EVI_trajshape==1~"Linear-decrease",
                                       EVI_trajshape==2~"Linear-increase",
                                       EVI_trajshape==3~"No trend",
                                       EVI_trajshape==4~"Step-decrease",
                                       EVI_trajshape==5~"Step-increase",
                                      EVI_trajshape==6~"Quad dec accelerated",
                                      EVI_trajshape==7~"Quad dec decelerated"))




#Boxplot- x-axis== different traj shapes, y-axis== Phy richness spread
#Ideally the stable pixels should show significantly different physiognomy richness compared to other trajectory shapes
plot_df3<- df_lev2_phy_richness_aniso_ndvi2 %>% pivot_longer(4:5)
names(plot_df3)[5]<- "Index" 
names(plot_df3)[6]<- "Trajectory_Shape"

phy_richness_aniso<-ggplot(plot_df3 %>% filter(Index=="anisoEVI_trajshape"), aes(x=Trajectory_Shape, y=Phy_richness)) + geom_boxplot(position=position_dodge(1)) +theme_classic() 

phy_richness_aniso<-phy_richness_aniso +ylab ("Pixel richness")+xlab("Trajectory shapes")

phy_richness_ndvi<-ggplot(plot_df3 %>% filter(Index=="NDVI_trajshape"), aes(x=Trajectory_Shape, y=Phy_richness)) + geom_boxplot(position=position_dodge(1)) +theme_classic() 

phy_richness_ndvi<-phy_richness_ndvi +ylab ("Pixel richness")+xlab("Trajectory shapes")

remove(lev2_phy_richness, lev2_phy_richness_aniso_ndvi,df_lev2_phy_richness_aniso_ndvi)

```
Considering anthropic covers or excluding these covers, it looks like for anisoEVI there is no significant different in pixel heterogeneity across trajectory shapes. But when considering NDVI, linear increase pixels significantly have the highest pixel heterogeneity.

But I think similar to previous chunk, I need to plot what are the percentage of step increase pixels that have pixel heterogeneity 1,2,3 where the percentage is number of step pixels with heterogeniety 1/ all pixels with heterogeniety 1. 

```{r}
df_lev2_phy_richness_aniso_ndvi2

#Phy richness
phyrichness<-df_lev2_phy_richness_aniso_ndvi2

phyrichness$bins <- cut(phyrichness$Phy_richness, breaks=seq(0,13,1))
#there are pixels where %grass in 0 which I treat as a seperate category.

number_pixels_bin<- phyrichness %>% group_by(bins) %>% summarise(count=n())

phyrichness2<- phyrichness %>% 
  dplyr::select(-c(anisoEVI_trajshape)) %>%
  filter(NDVI_trajshape=="Step-increase" | NDVI_trajshape=="No trend")

phyrichness_notrend_df<- phyrichness2 %>% 
  filter(NDVI_trajshape=="No trend") %>% 
  group_by(bins) %>%
  summarise(pixel_count=n())
  
phyrichness_notrend_df<- inner_join(phyrichness_notrend_df, number_pixels_bin)
larger_bins<- rep(c("1-3", "4-6", "7-9", "10-12"),each=3)
larger_bins<- c(larger_bins, ">13")
phyrichness_notrend_df<- phyrichness_notrend_df %>% mutate(LargerBins= larger_bins)
phyrichness_notrend_df$LargerBins <- factor(phyrichness_notrend_df$LargerBins, levels=c("1-3", "4-6", "7-9", "10-12", ">13"))
phyrichness_notrend_df<- phyrichness_notrend_df %>% mutate(Proportion= (pixel_count/count)*100) #nrow 

t<- ggplot(phyrichness_notrend_df, aes(x=LargerBins, y=Proportion)) + 
  geom_boxplot() + theme_classic() +xlab("Pixel heterogeniety bins")+
  ylab("Proportion of total pixels in each bin that are no trend")

phyrichness_stepinc_df<- phyrichness2 %>% 
  filter(NDVI_trajshape=="Step-increase") %>% 
  group_by(bins) %>%
  summarise(pixel_count=n())
  
phyrichness_stepinc_df<- inner_join(phyrichness_stepinc_df, number_pixels_bin)
phyrichness_stepinc_df<- phyrichness_stepinc_df %>% mutate(LargerBins= larger_bins)
phyrichness_stepinc_df$LargerBins <- factor(phyrichness_stepinc_df$LargerBins, levels=c("1-3", "4-6", "7-9", "10-12", ">13"))
phyrichness_stepinc_df<- phyrichness_stepinc_df %>% mutate(Proportion= (pixel_count/count)*100) #nrow 

phyrichness_notrend_df2<- phyrichness_notrend_df %>% dplyr::select(c(LargerBins, Proportion))
names(phyrichness_notrend_df2)[2]<- "NoTrendProportion"
phyrichness_stepinc_df2<- phyrichness_stepinc_df %>% dplyr::select(c(LargerBins, Proportion))
names(phyrichness_stepinc_df2)[2]<- "StepIncProportion"

heterogenity_df<- inner_join(phyrichness_stepinc_df2, phyrichness_notrend_df2)
pivot_hetero<- heterogenity_df %>% pivot_longer(c(2,3))

h<- ggplot(pivot_hetero, aes(x=LargerBins, y=value, fill=name)) + 
  geom_boxplot() + theme_classic() +xlab("Heterogenity bins")+
  ylab("Proportion of total pixels in each bin") +
  theme(legend.position="none")
h<- h+ scale_fill_manual(values=c("grey","#FF6600"))
ggsave(here("Outputs", "Final_TrajShape_Models", "CVNP_results",  "heterogeniety_stepincrease_notrend.png"),
       h, dpi = 700, height = 20, width=20, units = "cm")


```

Seems like there is trend nor significance 

Repeating above but considering only native vegetation
```{r}
########## Excluding anthropic physiognomies and calculating richness of native physiognomies
#0= campo umido, 1=campo sujo, 3=campu rupestre, 5=cerrado sensu stricto, 6=cerrado rupestre, 8=verada
#9=cerradao, 10=mata de galeria, 11-pasture, 12- water, 13- plantation, 14- agriculture, 15- nonvegetated
m_nativephysiognomies_only<- rbind(c(0,0), c(1,1), c(3,3), c(5,5), c(6,6), c(8,8),
                                   c(9,9), c(10,10), c(11,NA), c(12,NA), c(13,NA), c(14,NA), c(15, NA))

reclass_lev2<- terra::classify(mask_veg_phy, m_nativephysiognomies_only)#
reclass_lev2_phy_richness<- exactextractr::exact_resample(reclass_lev2, cvnp_aniso_trajshapes, 'variety')
reclass_lev2_phy_richness_aniso_ndvi<- c(cvnp_aniso_trajshapes,cvnp_ndvi_trajshapes, reclass_lev2_phy_richness)
df_reclass_lev2_richness_aniso_ndvi<- terra::as.data.frame(reclass_lev2_phy_richness_aniso_ndvi, cells=TRUE, xy=TRUE)
names(df_reclass_lev2_richness_aniso_ndvi)<- c("cell", "x", "y", "anisoEVI_trajshape","NDVI_trajshape", "excluding_anthropic_Phy_richness")

df_reclass_lev2_richness_aniso_ndvi3<-df_reclass_lev2_richness_aniso_ndvi %>% 
  mutate(anisoEVI_trajshape= case_when(anisoEVI_trajshape==1~"Linear-decrease",
                                       anisoEVI_trajshape==2~"Linear-increase",
                                       anisoEVI_trajshape==3~"No trend",
                                       anisoEVI_trajshape==4~"Step-decrease",
                                       anisoEVI_trajshape==5~"Step-increase"))
df_reclass_lev2_richness_aniso_ndvi3<- df_reclass_lev2_richness_aniso_ndvi3 %>% 
  mutate(NDVI_trajshape= case_when(NDVI_trajshape==1~"Linear-decrease",
                                       NDVI_trajshape==2~"Linear-increase",
                                       NDVI_trajshape==3~"No trend",
                                       NDVI_trajshape==4~"Step-decrease",
                                       NDVI_trajshape==5~"Step-increase",
                                      NDVI_trajshape==6~"Quad dec accelerated",
                                      NDVI_trajshape==7~"Quad dec decelerated"))

df_reclass_lev2_richness_aniso_ndvi4<- df_reclass_lev2_richness_aniso_ndvi3 %>% filter(!is.na(anisoEVI_trajshape) & !is.na(NDVI_trajshape))
names(df_reclass_lev2_richness_aniso_ndvi4)[4]<- "excluding_anisoEVI_trajshape"
names(df_reclass_lev2_richness_aniso_ndvi4)[5]<- "excluding_NDVI_trajshape"

###
df_reclass_lev2_richness_aniso_ndvi4

#Phy richness
excludeanthropic_phyrichness<-df_reclass_lev2_richness_aniso_ndvi4

ex_number_pixels_bin<- excludeanthropic_phyrichness %>% group_by(excluding_anthropic_Phy_richness) %>% summarise(count=n())

excludeanthropic_phyrichness2<- excludeanthropic_phyrichness %>% 
  dplyr::select(-c(excluding_anisoEVI_trajshape)) %>%
  filter(excluding_NDVI_trajshape=="Step-increase" | excluding_NDVI_trajshape=="No trend")

ex_phyrichness_notrend_df<- excludeanthropic_phyrichness2 %>% 
  filter(excluding_NDVI_trajshape=="No trend") %>% 
  group_by(excluding_anthropic_Phy_richness) %>%
  summarise(pixel_count=n())
  
ex_phyrichness_notrend_df<- inner_join(ex_phyrichness_notrend_df, ex_number_pixels_bin)
ex_phyrichness_notrend_df<- ex_phyrichness_notrend_df %>% mutate(Proportion= (pixel_count/count)*100) #nrow 

ext<- ggplot(ex_phyrichness_notrend_df, 
             aes(x=as.factor(excluding_anthropic_Phy_richness), y=Proportion)) + 
  geom_point() + theme_classic() +xlab("Pixel heterogeniety bins")+
  ylab("Proportion of total pixels in each bin that are no trend")

ex_phyrichness_stepinc_df<- excludeanthropic_phyrichness2 %>% 
  filter(excluding_NDVI_trajshape=="Step-increase") %>% 
  group_by(excluding_anthropic_Phy_richness) %>%
  summarise(pixel_count=n())
  
ex_phyrichness_stepinc_df<- inner_join(ex_phyrichness_stepinc_df, ex_number_pixels_bin)
ex_phyrichness_stepinc_df<-ex_phyrichness_stepinc_df %>% mutate(Proportion= (pixel_count/count)*100)


ex_phyrichness_stepinc_df2<- ex_phyrichness_stepinc_df %>% dplyr::select(c(excluding_anthropic_Phy_richness, Proportion))
names(ex_phyrichness_stepinc_df2)[2]<- "StepInc_Prop"
ex_phyrichness_notrend_df2<- ex_phyrichness_notrend_df %>% dplyr::select(c(excluding_anthropic_Phy_richness, Proportion))
names(ex_phyrichness_notrend_df2)[2]<- "NoTrend_Prop"

ex_heterogenity_df<- inner_join(ex_phyrichness_stepinc_df2, ex_phyrichness_notrend_df2)
pivot_ex_hetero<- ex_heterogenity_df %>% pivot_longer(c(2,3))

exh<- ggplot(pivot_ex_hetero, aes(x=excluding_anthropic_Phy_richness, y=value, shape=name, color=name)) + 
  geom_point() + theme_classic() +xlab("Heterogenity bins")+
  ylab("Proportion of total pixels in each bin") +
  theme(legend.position="none")
exh<- exh+ scale_color_manual(values=c("grey","#FF6600"))
ggsave(here("Outputs", "Final_TrajShape_Models", "CVNP_results",  "exanthropic_heterogeniety_stepincrease_notrend.png"),
       exh, dpi = 700, height = 20, width=20, units = "cm")

```
