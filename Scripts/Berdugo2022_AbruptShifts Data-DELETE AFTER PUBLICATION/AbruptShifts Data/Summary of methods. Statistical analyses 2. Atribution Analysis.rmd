---
title: "Attribution analysis"
author: "Miguel Berdugo"
date: "22/3/2022"
output: pdf_document
---

This code summarizes the steps necessary to perform NDVI trend attribution for the paper "Abrupt changes govern vegetation dynamics"

```{r charge.databases,eval=FALSE, include=FALSE}
library(reshape2)
library(ggplot2)
library(xgboost)
TSeries=read.csv("Time Series new.csv")
Climatic=read.csv("ClimaticVarsDryDin.csv")

```

## Attribution analysis

In short, the next chunk of code will run for all the pixels analyzed an attribution analysis of the trends of NDVI. We relate yearly NDVi data to yearly data on temperature, cloudiness, water availabitlity and CO2 trends. Temperature and water availability are taken from TERRACLIMATE, and cloudiness from xx. CO2 trends are fixed for all pixels (assuming a constant homogenous trend) and taken from Manua Loa CO2 concentration time series (Scripps CO2 Program).

```{r attribution.loop, echo=TRUE,eval=FALSE}
library(relaimpo)
RES=list()
for(i in 1:nrow(TSeries)){
  site=TSeries$Point.ID[i]
  dfi=Climatic[Climatic$Point.ID==site,]

  yy=2001:2019

  dfi=data.frame(NDVI=as.numeric(t(TSeries[TSeries$Point.ID==site,1:19])),
               Temp=dfi$Mt[match(yy,dfi$year)],
               AET=dfi$Mpdsi[match(yy,dfi$year)],
#               rad=dfi$Msrad[match(yy,dfi$year)],
               CO2=dfi$CO2[match(yy,dfi$year)])
  
  if(sum(complete.cases(dfi))>16){
    dfi=as.data.frame(lapply(dfi, function(v) return((v-mean(v,na.rm=T))/sd(v,na.rm = T))))
    if(sum(complete.cases(dfi))>16){
      mdl=lm(formula = NDVI~AET*CO2+Temp,data = dfi)
      if(sum(!duplicated(dfi$Temp))>5){
        fg=calc.relimp(mdl)
      resi=data.frame(vars=names(fg@lmg),relimp=fg@lmg,site=site)
      }else{
      resi=data.frame(vars=names(dfi)[-1],relimp=NA,site=site)
      }
    }else{
      resi=data.frame(vars=names(dfi)[-1],relimp=NA,site=site)
    }
  }else{
    resi=data.frame(vars=names(dfi)[-1],relimp=NA,site=site)
  }

  RES[[i]]=resi
}

RES=do.call(rbind,RES)
RES=dcast(RES,formula = site~vars,value.var = "relimp")
RES$unexplained=apply(RES,MARGIN = 1,FUN = function(x) 1-sum(x[-1]))
RES=melt(RES,id.vars = "site")
DF=read.csv("FinalDB3.csv")

RES$traj.type=DF$TrajSubtype[match(RES$site,DF$Site)]
RES=RES[!is.na(RES$traj.type),]
write.csv(RES,file = "Attributions4.csv",row.names = F)

```

After obtaining attributions let's plot them type by type

```{r BOXPLOT.per.type,eval=TRUE,echo=TRUE}
RES=read.csv("Attributions4.csv")



##solution for na.rm
calc_boxplot_stat <- function(x) {
  coef <- 1.5
  n <- sum(!is.na(x))
  # calculate quantiles
  stats <- quantile(x, probs = c(0.0, 0.25, 0.5, 0.75, 1.0))
  names(stats) <- c("ymin", "lower", "middle", "upper", "ymax")
  iqr <- diff(stats[c(2, 4)])
  # set whiskers
  outliers <- x < (stats[2] - coef * iqr) | x > (stats[4] + coef * iqr)
  if (any(outliers)) {
    stats[c(1, 5)] <- range(c(stats[2:4], x[!outliers]), na.rm = TRUE)
  }
  return(stats)
}

colorsSEL=c("red","#CC3333","darkred","#CCCC00","cyan","royalblue","darkblue","#999900")

p<-ggplot(data = RES,aes(x=as.factor(traj.type),y=value,fill=traj.type))+
  theme_classic()+
    stat_summary(fun.data = calc_boxplot_stat, geom="boxplot",lwd=0.1) + 
  coord_flip()+
  scale_fill_manual(values=colorsSEL)+
  facet_wrap(~variable,scales = "free")+
  theme(text = element_text(size = 7),
        axis.text.y = element_blank())

p

ggsave("AttributionAnalyses.pdf",plot = p,device = "pdf",width = 114,height = 100,units = "mm")
#To devise significance variable by variable do for i=1:5
i=5
unique(RES$variable)[i]
dfi=RES[RES$variable==unique(RES$variable)[i],]
amod <- aov(value ~ traj.type, data=dfi)
library(agricolae)
fg=HSD.test(amod, "traj.type", group=TRUE)
fg

```

## PCA analysis on attributions

Because these results compare variable by variable they do not offer a complete picture of the covariance of relative impotance of all variables as a whole. This is why we used a PCA approximation to devise general trends.

```{r PCA.analyses,eval=TRUE,echo=TRUE}
library("FactoMineR")
library("factoextra")
library(reshape2)

RES=read.csv("Attributions4.csv")
RES=dcast(RES,formula = site~variable,value.var = "value")

DF=read.csv("FinalDB3.csv")
RES$traj.type=DF$TrajSubtype[match(RES$site,DF$Site)]
RES=RES[!is.na(RES$traj.type),]

iris.pca <- PCA(RES[complete.cases(RES),-c(1,7)], graph = FALSE)


colorsSEL=c("red","#CC3333","darkred","#CCCC00","cyan","royalblue","darkblue","#999900")

fviz_pca_var(iris.pca,axes = c(1,2)) #this displays the axes and and their explanatory scores

DF$TrajType2=DF$TrajType
DF$TrajType2[DF$TrajType2=="notrend"]="Lineal"
DF$TrajType2=as.factor(as.character(DF$TrajType2))

dff=as.data.frame(iris.pca$ind$coord)
dff$site=RES$site[complete.cases(RES)]
dff$traj.type=RES$traj.type[complete.cases(RES)]
dff$trendtype=DF$trendtype[match(dff$site,DF$Site)]
dff$TrajType2=DF$TrajType2[match(dff$site,DF$Site)]

#plot one by one
#This plot separates points according to their dyamical typology and plot the resulting PCA loadings in order to asses how different attribution covary per dynamical type in conjunction. Note that all come from the same PCA
p<-ggplot(data = dff,aes(x = Dim.1,y=Dim.2,color=traj.type))+
  theme_bw()+
  geom_point(size=0.5)+
  scale_colour_manual(values = colorsSEL)+
  stat_density2d(aes(fill=..level..),alpha=0.3,geom="polygon")+
  scale_fill_continuous(low = "grey", high = "black", space = "Lab", name = "Density")+
  theme(legend.position = "none",
        panel.border = element_blank(),
        axis.title = element_blank())+
  geom_vline(xintercept = 0)+
  geom_hline(yintercept = 0)+
  facet_grid(trendtype~TrajType2)
p

```